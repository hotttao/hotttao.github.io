<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    

    
    <title>2.4 perf 的使用 | 宋涛的博客</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="Linux性能调优" />
    
    <meta name="description" content="上一节我们学习了 perf 的基本原理，对 perf 有了一个整体上的认识，本节我们来学如何使用 perf 进行性能分析。">
<meta name="keywords" content="Linux性能调优">
<meta property="og:type" content="article">
<meta property="og:title" content="2.4 perf 的使用">
<meta property="og:url" content="http://yoursite.com/2020/01/05/linux_perf/06_perf_use/index.html">
<meta property="og:site_name" content="宋涛的博客">
<meta property="og:description" content="上一节我们学习了 perf 的基本原理，对 perf 有了一个整体上的认识，本节我们来学如何使用 perf 进行性能分析。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/linux_pf/perf_events_flow.png">
<meta property="og:updated_time" content="2020-06-21T04:30:18.908Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2.4 perf 的使用">
<meta name="twitter:description" content="上一节我们学习了 perf 的基本原理，对 perf 有了一个整体上的认识，本节我们来学如何使用 perf 进行性能分析。">
<meta name="twitter:image" content="http://yoursite.com/images/linux_pf/perf_events_flow.png">
    

    
        <link rel="alternate" href="/" title="宋涛的博客" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/3.3.1/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    


</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">漫步在大陆上的海龟</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Go/">Go</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Python/">Python</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/分布式/">分布式</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/前端/">前端</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/存储/">存储</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/操作系统/">操作系统</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/运维/">运维</a></li></ul>
                                    
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/运维/">运维</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-linux_perf/06_perf_use" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        2.4 perf 的使用
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2020/01/05/linux_perf/06_perf_use/" class="article-date">
            <time datetime="2020-01-04T16:00:00.000Z" itemprop="datePublished">2020-01-05</time>
        </a>
    </div>

		

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Linux性能调优/">Linux性能调优<span class="tag-count">49</span></a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p>上一节我们学习了 perf 的基本原理，对 perf 有了一个整体上的认识，本节我们来学如何使用 perf 进行性能分析。<br><a id="more"></a></p>
<p>我们将按照如下几个部分来介绍 perf 的使用:</p>
<ol>
<li>perf 的辅助性命令，包括 perf list，perf probe 等</li>
<li>perf 的三种使用方式，计数模式，采样事件，以及事件上的 bp 程序</li>
<li>perf 提供的特殊用途的子命令，包括 perf sched，perf mem 等等</li>
<li>perf.data 的处理，这一部分命令用于格式化输出 perf.data 的内容便于生成类似火焰图等更复杂的图表</li>
</ol>
<p><img src="/images/linux_pf/perf_events_flow.png" alt="perf_events_flow"></p>
<h2 id="1-perf-命令概览"><a href="#1-perf-命令概览" class="headerlink" title="1. perf 命令概览"></a>1. perf 命令概览</h2><p>作为开始，我们先来回顾一下 perf 命令的一个概览</p>
<p><code>perf [--version] [--help] [OPTIONS] COMMAND [ARGS]</code></p>
<table>
<thead>
<tr>
<th style="text-align:left">子命令</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">list</td>
<td style="text-align:left">List all symbolic event types<br>列出当前系统支持的所有事件名,可分为三类：硬件事件、软件事件，检查点</td>
</tr>
<tr>
<td style="text-align:left">probe</td>
<td style="text-align:left">Define new dynamic tracepoints<br>用于定义动态检查点</td>
</tr>
<tr>
<td style="text-align:left">stat</td>
<td style="text-align:left">Run a command and gather performance counter statistics<br>对程序运行过程中的性能计数器进行统计</td>
</tr>
<tr>
<td style="text-align:left">record</td>
<td style="text-align:left">Run a command and record its profile into perf.data<br>    对程序运行过程中的事件进行分析和记录，并写入perf.data</td>
</tr>
<tr>
<td style="text-align:left">report</td>
<td style="text-align:left">Read perf.data (created by perf record) and display the profile<br>读取perf.data(由perf record生成) 并显示分析结果</td>
</tr>
<tr>
<td style="text-align:left">top</td>
<td style="text-align:left">System profiling tool.<br>对系统的性能进行分析，类似top命令</td>
</tr>
<tr>
<td style="text-align:left">sched</td>
<td style="text-align:left">Tool to trace/measure scheduler properties (latencies)<br>针对调度器子系统的分析工具</td>
</tr>
<tr>
<td style="text-align:left">lock</td>
<td style="text-align:left">Analyze lock events<br>分析内核中的锁信息，包括锁的争用情况，等待延迟等</td>
</tr>
<tr>
<td style="text-align:left">mem</td>
<td style="text-align:left">Profile memory accesses<br>分析内存访问</td>
</tr>
<tr>
<td style="text-align:left">kmem</td>
<td style="text-align:left">Tool to trace/measure kernel memory properties<br>分析内核内存的使用</td>
</tr>
<tr>
<td style="text-align:left">kvm</td>
<td style="text-align:left">Tool to trace/measure kvm guest os<br>分析kvm虚拟机上的guest os</td>
</tr>
<tr>
<td style="text-align:left">timechart</td>
<td style="text-align:left">Tool to visualize total system behavior during a workload<br>对record结果进行可视化分析输出，record命令需要加上timechart记录</td>
</tr>
<tr>
<td style="text-align:left">script</td>
<td style="text-align:left">Read perf.data (created by perf record) and display trace output<br>读取perf.data(由perf record生成)，生成trace记录，供其他分析工具使用</td>
</tr>
<tr>
<td style="text-align:left">data</td>
<td style="text-align:left">Data file related processing<br>把perf.data文件转换成其他格式</td>
</tr>
<tr>
<td style="text-align:left">diff</td>
<td style="text-align:left">Read perf.data files and display the differential profile<br>读取多个perf.data文件，并给出差异分析</td>
</tr>
<tr>
<td style="text-align:left">evlist</td>
<td style="text-align:left">List the event names in a perf.data file<br>列出perf.data中采集的事件列表</td>
</tr>
<tr>
<td style="text-align:left">bench</td>
<td style="text-align:left">General framework for benchmark suites<br>perf提供的基准套件的通用框架，可以对当前系统的调度，IPC，内存访问进行性能评估</td>
</tr>
<tr>
<td style="text-align:left">test</td>
<td style="text-align:left">Runs sanity tests.<br>    perf对当前软硬件平台进行健全性测试，可用此工具测试当前的软硬件平台是否能支持perf的所有功能</td>
</tr>
<tr>
<td style="text-align:left">trace</td>
<td style="text-align:left">strace inspired tool<br>类似于strace，跟踪目标的系统调用，但开销比strace小</td>
</tr>
<tr>
<td style="text-align:left">ftrace</td>
<td style="text-align:left">simple wrapper for kernel ftrace functionality<br></td>
</tr>
<tr>
<td style="text-align:left">annotate</td>
<td style="text-align:left">Read perf.data (created by perf record) and display annotated code<br>读取perf.data(由perf record生成)显示反汇编后的代码</td>
</tr>
<tr>
<td style="text-align:left">archive</td>
<td style="text-align:left">Create archive with object files with build-ids found in perf.data file<br>根据perf.data(由perf record生成)文件中的build-id将相关的目标文件打包</td>
</tr>
<tr>
<td style="text-align:left">buildid-cache</td>
<td style="text-align:left">Manage build-id cache.<br></td>
</tr>
<tr>
<td style="text-align:left">buildid-list</td>
<td style="text-align:left">List the buildids in a perf.data file<br></td>
</tr>
<tr>
<td style="text-align:left">c2c</td>
<td style="text-align:left">Shared Data C2C/HITM Analyzer.<br></td>
</tr>
<tr>
<td style="text-align:left">config</td>
<td style="text-align:left">Get and set variables in a configuration file.<br></td>
</tr>
<tr>
<td style="text-align:left">inject</td>
<td style="text-align:left">Filter to augment the events stream with additional information<br></td>
</tr>
<tr>
<td style="text-align:left">kallsyms</td>
<td style="text-align:left">Searches running kernel for symbols<br></td>
</tr>
<tr>
<td style="text-align:left">version</td>
<td style="text-align:left">display the version of perf binary<br></td>
</tr>
</tbody>
</table>
<h2 id="1-perf-辅助性命令"><a href="#1-perf-辅助性命令" class="headerlink" title="1. perf 辅助性命令"></a>1. perf 辅助性命令</h2><h3 id="1-1-perf-list"><a href="#1-1-perf-list" class="headerlink" title="1.1 perf list"></a>1.1 perf list</h3><p><code>perf list [--no-desc] [--long-desc] [event_class]</code></p>
<ul>
<li>作用: 列出perf可以支持的所有事件</li>
<li>event_class: 事件的分类，包括:<ul>
<li><code>hw|sw|cache|pmu|sdt|metric|metricgroup</code></li>
<li><code>tracepoint</code>: 静态探针</li>
<li><code>event_glob</code>: 事件的通配符</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">perf list</div><div class="line"></div><div class="line">List of pre-defined events (to be used <span class="keyword">in</span> -e):</div><div class="line"></div><div class="line">  alignment-faults                                   [Software event]</div><div class="line">  bpf-output                                         [Software event]</div><div class="line">  context-switches OR cs                             [Software event]</div><div class="line">  cpu-clock                                          [Software event]</div><div class="line">  cpu-migrations OR migrations                       [Software event]</div><div class="line">  ..........</div></pre></td></tr></table></figure>
<p>perf list给出的事件是厂家上传上去给Linux社区的，但有些厂家会有自己的事件统计，没有上传出去，这需要从厂家的用户手册中获得，这种事件称为原始事件，可以直接用编号表示，格式为:rUUEE，其中UU == umask, EE ==事件编号。比如在我们的芯片里面，0x13号表示跨芯片内存访问，你就可以用<code>-e r0013</code>来跟踪软件的跨片访问次数。</p>
<h3 id="1-2-perf-probe"><a href="#1-2-perf-probe" class="headerlink" title="1.2 perf probe"></a>1.2 perf probe</h3><p>perf probe 用来定义一个动态探针，定义的方式有如下几种:</p>
<ol>
<li>用户空间: 通过 -x 指定二进制文件的路径，可以为该二进制程序添加库函数的动态探针</li>
<li>内核:<ul>
<li>通过符号表和寄存器来添加，这种方式不需要内核调试信息(即 kernel-debuginfo)</li>
<li>通过 C 函数，C 函数中的特定行，并且可以附加函数上下文中的变量，这种方式需要内核调试信息。</li>
</ul>
</li>
</ol>
<h4 id="命令使用"><a href="#命令使用" class="headerlink" title="命令使用"></a>命令使用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">Usage: perf probe [&lt;options&gt;] <span class="string">'PROBEDEF'</span> [<span class="string">'PROBEDEF'</span> ...]</div><div class="line">    or: perf probe [&lt;options&gt;] --add <span class="string">'PROBEDEF'</span> [--add <span class="string">'PROBEDEF'</span> ...]</div><div class="line">    or: perf probe [&lt;options&gt;] --del <span class="string">'[GROUP:]EVENT'</span> ...</div><div class="line">    or: perf probe --list [GROUP:]EVENT ...</div><div class="line">    or: perf probe [&lt;options&gt;] --line <span class="string">'LINEDESC'</span></div><div class="line">    or: perf probe [&lt;options&gt;] --vars <span class="string">'PROBEPOINT'</span></div><div class="line">    or: perf probe [&lt;options&gt;] --funcs</div><div class="line"></div><div class="line">    -a, --add &lt;[EVENT=]FUNC[@SRC][+OFF|%<span class="built_in">return</span>|:RL|;PT]|SRC:AL|SRC;PT [[NAME=]ARG ...]&gt;</div><div class="line">                          probe point definition, <span class="built_in">where</span></div><div class="line">                GROUP:  Group name (optional)</div><div class="line">                EVENT:  Event name</div><div class="line">                FUNC:   Function name</div><div class="line">                OFF:    Offset from <span class="keyword">function</span> entry (<span class="keyword">in</span> byte)</div><div class="line">                %<span class="built_in">return</span>:        Put the probe at <span class="keyword">function</span> <span class="built_in">return</span></div><div class="line">                SRC:    Source code path</div><div class="line">                RL:     Relative line number from <span class="keyword">function</span> entry.</div><div class="line">                AL:     Absolute line number <span class="keyword">in</span> file.</div><div class="line">                PT:     Lazy expression of line code.</div><div class="line">                ARG:    Probe argument (<span class="built_in">local</span> variable name or</div><div class="line">                        kprobe-tracer argument format.)</div><div class="line"></div><div class="line">    -D, --definition &lt;[EVENT=]FUNC[@SRC][+OFF|%<span class="built_in">return</span>|:RL|;PT]|SRC:AL|SRC;PT [[NAME=]ARG ...]&gt;</div><div class="line">                          Show trace event definition of given traceevent <span class="keyword">for</span> k/uprobe_events.</div><div class="line">    -d, --del &lt;[GROUP:]EVENT&gt;</div><div class="line">                          delete a probe event.</div><div class="line">    -f, --force           forcibly add events with existing name</div><div class="line">    -F, --funcs &lt;[FILTER]&gt;</div><div class="line">                          Show potential probe-able <span class="built_in">functions</span>.</div><div class="line">    -L, --line &lt;FUNC[:RLN[+NUM|-RLN2]]|SRC:ALN[+NUM|-ALN2]&gt;</div><div class="line">    -V, --vars &lt;FUNC[@SRC][+OFF|%<span class="built_in">return</span>|:RL|;PT]|SRC:AL|SRC;PT&gt;</div><div class="line">                        Show accessible variables on PROBEDEF</div></pre></td></tr></table></figure>
<h4 id="添加动态探针"><a href="#添加动态探针" class="headerlink" title="添加动态探针"></a>添加动态探针</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 一: 基于 uprobes ，为用户空间库函数添加动态探针</span></div><div class="line"><span class="comment"># 想要查看普通应用的函数名称和参数，那么在应用程序的二进制文件中，同样需要包含调试信息。</span></div><div class="line"><span class="comment"># 为/bin/bash添加readline探针，获取其返回值，并作为 string 类型返回</span></div><div class="line">$ perf probe -x /bin/bash <span class="string">'readline'</span></div><div class="line">$ perf probe -x /bin/bash <span class="string">'readline%return +0($retval):string'</span></div><div class="line">Added new event:</div><div class="line">  probe_bash:readline__return (on readline%<span class="built_in">return</span> <span class="keyword">in</span> /usr/bin/bash with +0(<span class="variable">$retval</span>):string)</div><div class="line"></div><div class="line">You can now use it <span class="keyword">in</span> all perf tools, such as:</div><div class="line"></div><div class="line">        perf record -e probe_bash:readline__return -aR sleep 1</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 查询所有的函数</span></div><div class="line">$ perf probe -x /bin/bash --funcs</div><div class="line"></div><div class="line"><span class="comment"># 查询函数的参数</span></div><div class="line">$ perf probe -x /bin/bash -V readline</div><div class="line">Available variables at readline</div><div class="line">        @&lt;readline+0&gt;</div><div class="line">                char*   prompt</div><div class="line"></div><div class="line"><span class="comment"># 二: 基于 kprobes，为内核函数添加动态探针</span></div><div class="line"><span class="comment"># 1. 通过符号表和寄存器添加 malloc 探针</span></div><div class="line">$ perf probe -x /lib64/libc-2.17.so <span class="string">'--add=malloc'</span></div><div class="line">$ perf probe --del <span class="string">"malloc"</span></div><div class="line">$ perf probe -x /lib64/libc-2.17.so <span class="string">'--add=malloc size=%di'</span></div><div class="line"></div><div class="line"><span class="comment"># 2. 通过 C 扩展</span></div><div class="line">$ yum --enablerepo=base-debuginfo install -y kernel-debuginfo-$(uname -r)</div><div class="line">$ perf probe --add tcp_sendmsg</div><div class="line">Added new event:</div><div class="line">  probe:tcp_sendmsg    (on tcp_sendmsg)</div><div class="line"></div><div class="line">You can now use it <span class="keyword">in</span> all perf tools, such as:</div><div class="line">        <span class="comment"># 自动显示使用方式</span></div><div class="line">        perf record -e probe:tcp_sendmsg -aR sleep 1  </div><div class="line"></div><div class="line"><span class="comment"># 获取 tcp_sendmsg 的返回值</span></div><div class="line">$ perf probe <span class="string">'tcp_sendmsg%return $retval'</span></div><div class="line"></div><div class="line"><span class="comment"># 2.1 列出tcp_sendmsg()可用的变量</span></div><div class="line">$ perf probe -V tcp_sendmsg</div><div class="line">Available variables at tcp_sendmsg</div><div class="line">        @&lt;tcp_sendmsg+0&gt;</div><div class="line">                size_t  size</div><div class="line">                struct kiocb*   iocb</div><div class="line">                struct msghdr*  msg</div><div class="line">                struct sock*    sk</div><div class="line"></div><div class="line"><span class="comment"># 2.2 添加带参数的探针</span></div><div class="line">$ perf probe --add <span class="string">'tcp_sendmsg size'</span></div><div class="line"></div><div class="line"><span class="comment"># 2.3 列出tcp_sendmsg()可用的行探测:</span></div><div class="line">$ perf probe -L tcp_sendmsg</div><div class="line">&lt;tcp_sendmsg@/mnt/src/linux-3.14.5/net/ipv4/tcp.c:0&gt;</div><div class="line">      0  int tcp_sendmsg(struct kiocb *iocb, struct sock *sk, struct msghdr *msg,</div><div class="line">                        size_t size)</div><div class="line">      2  &#123;</div><div class="line">                struct iovec *iov;</div><div class="line">                struct tcp_sock *tp = tcp_sk(sk);</div><div class="line">                struct sk_buff *skb;</div><div class="line">      6         int iovlen, flags, err, copied = 0;</div><div class="line">      7         int mss_now = 0, size_goal, copied_syn = 0, offset = 0;</div><div class="line">                bool sg;</div><div class="line">                long timeo;</div><div class="line">[...]</div><div class="line"></div><div class="line"><span class="comment"># 2.4 检查在第81行有哪些变量可用</span></div><div class="line">$ perf probe -V tcp_sendmsg:81</div><div class="line">Available variables at tcp_sendmsg:81</div><div class="line">        @&lt;tcp_sendmsg+537&gt;</div><div class="line">                bool    sg</div><div class="line">                int     copied</div><div class="line">                int     copied_syn</div><div class="line">                int     flags</div><div class="line">                int     mss_now</div><div class="line">                int     offset</div><div class="line">                int     size_goal</div><div class="line">                long int        timeo</div><div class="line">                size_t  seglen</div><div class="line">                struct iovec*   iov</div><div class="line">                struct sock*    sk</div><div class="line">                unsigned char*  from</div><div class="line"></div><div class="line"><span class="comment"># 2.5. 跟踪第81行，并使用循环中的seglen变量</span></div><div class="line">$ perf probe --add <span class="string">'tcp_sendmsg:81 seglen'</span></div></pre></td></tr></table></figure>
<h2 id="2-perf-stat-计数模式"><a href="#2-perf-stat-计数模式" class="headerlink" title="2. perf stat(计数模式)"></a>2. perf stat(计数模式)</h2><p>perf stat 是 perf 三种使用模式中的第一种模式计数模式。</p>
<p>perf stat:</p>
<ul>
<li>命令格式:<ul>
<li><code>perf stat [-e &lt;EVENT&gt; | --event=EVENT] [-a] &lt;command&gt;</code></li>
<li><code>perf stat [-e &lt;EVENT&gt; | --event=EVENT] [-a] — &lt;command&gt; [&lt;options&gt;]</code></li>
<li><code>perf stat [-e &lt;EVENT&gt; | --event=EVENT] [-a] record [-o file] — &lt;command&gt; [&lt;options&gt;]</code></li>
<li><code>perf stat report [-i file]</code></li>
</ul>
</li>
<li>作用: 可以对程序运行过程中的性能计数器(包括Hardware，software counters)进行统计，分析程序的整体消耗情况</li>
<li>参数:<ul>
<li><code>-d, -dd, -ddd</code> 输出更详细的信息</li>
</ul>
</li>
</ul>
<h3 id="2-1-perf-stat-默认输出"><a href="#2-1-perf-stat-默认输出" class="headerlink" title="2.1 perf stat 默认输出"></a>2.1 perf stat 默认输出</h3><p>默认情况 perf stat 只会对 Software Events 和 Hardware Events 进行计数分析。下面是 perf stat 的使用示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ perf <span class="built_in">stat</span> ls</div><div class="line">Performance counter stats <span class="keyword">for</span> <span class="string">'ls'</span>:</div><div class="line"></div><div class="line">          2.164836      task-clock (msec)         <span class="comment">#    0.808 CPUs utilized</span></div><div class="line">                51      context-switches          <span class="comment">#    0.024 M/sec</span></div><div class="line">                 4      cpu-migrations            <span class="comment">#    0.002 M/sec</span></div><div class="line">               333      page-faults               <span class="comment">#    0.154 M/sec</span></div><div class="line">           5506056                                <span class="comment">#    2.543 GHz</span></div><div class="line">                 0      stalled-cycles-frontend   <span class="comment">#    0.00% frontend cycles idle</span></div><div class="line">                 0      stalled-cycles-backend    <span class="comment">#    0.00% backend  cycles idle</span></div><div class="line">           6100570      instructions              <span class="comment">#    1.11  insns per cycle</span></div><div class="line">           1298744      branches                  <span class="comment">#  599.927 M/sec</span></div><div class="line">             18509      branch-misses             <span class="comment">#    1.43% of all branches</span></div><div class="line"></div><div class="line">       0.002679758 seconds time elapsed</div></pre></td></tr></table></figure>
<p>指标含义:</p>
<ol>
<li>task-clock (msec): <ul>
<li>cpu处理task所消耗的时间，单位ms</li>
<li>0.808 CPUs utilized的表示cpu使用率为80.8%，该值越高代表程序是CPU bound而非IO bound 类型</li>
</ul>
</li>
<li>instructions：<ul>
<li>执行的指令条数， </li>
<li>insns per cycle: 即IPC，每个cpu周期执行的指令条数，IPC比上面的CPU使用率更能说明CPU的使用情况</li>
<li>更高的IPC值意味着更高的指令吞吐量，更低的值表示更多的停顿周期。</li>
<li>一般来说，我认为IPC值越高(例如，超过1.0)就越好，表示工作的最佳处理。但是，需要检查执行指令是什么，以防这是一个旋转循环: 指令率高，但实际完成的工作率低。</li>
</ul>
</li>
<li>stalled-cycles-frontend和stalled-cycles-backend: 表示CPU停滞统计<ul>
<li>前端和后端指标指的是CPU管道，统计的是它们的停顿次数</li>
<li>前端按顺序处理CPU指令。它包括指令获取，以及分支预测和解码。</li>
<li>解码后的指令成为后端处理的微操作(uops)，并且可能会乱序地执行。</li>
<li>每条指令的停滞周期类似于IPC(反向)，但是，只计算停滞周期，这将用于内存或资源总线访问。</li>
</ul>
</li>
<li>branches：这段时间内发生分支预测的次数。现代的CPU都有分支预测方面的优化。</li>
<li>branches-misses：这段时间内分支预测失败的次数，这个值越小越好。</li>
</ol>
<h4 id="详细模式"><a href="#详细模式" class="headerlink" title="详细模式"></a>详细模式</h4><p>可以使用 -d 选项输出更详细的信息，带 <code>-d</code> 选项的输出会包含用于一级数据缓存事件和最后一级缓存(LLC)事件的额外计数器。<code>-dd,-ddd</code>可输出更加详细的信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$ perf <span class="built_in">stat</span> -d gzip file1</div><div class="line"></div><div class="line"> Performance counter stats <span class="keyword">for</span> <span class="string">'gzip file1'</span>:</div><div class="line"></div><div class="line">       1610.719530 task-clock                <span class="comment">#    0.998 CPUs utilized          </span></div><div class="line">                20 context-switches          <span class="comment">#    0.012 K/sec                  </span></div><div class="line">                 0 CPU-migrations            <span class="comment">#    0.000 K/sec                  </span></div><div class="line">               258 page-faults               <span class="comment">#    0.160 K/sec                  </span></div><div class="line">     5,491,605,997 cycles                    <span class="comment">#    3.409 GHz                     [40.18%]</span></div><div class="line">     1,654,551,151 stalled-cycles-frontend   <span class="comment">#   30.13% frontend cycles idle    [40.80%]</span></div><div class="line">     1,025,280,350 stalled-cycles-backend    <span class="comment">#   18.67% backend  cycles idle    [40.34%]</span></div><div class="line">     8,644,643,951 instructions              <span class="comment">#    1.57  insns per cycle        </span></div><div class="line">                                             <span class="comment">#    0.19  stalled cycles per insn [50.89%]</span></div><div class="line">     1,492,911,665 branches                  <span class="comment">#  926.860 M/sec                   [50.69%]</span></div><div class="line">        53,471,580 branch-misses             <span class="comment">#    3.58% of all branches         [51.21%]</span></div><div class="line">     1,938,889,736 L1-dcache-loads           <span class="comment"># 1203.741 M/sec                   [49.68%]</span></div><div class="line">       154,380,395 L1-dcache-load-misses     <span class="comment">#    7.96% of all L1-dcache hits   [49.66%]</span></div><div class="line">                 0 LLC-loads                 <span class="comment">#    0.000 K/sec                   [39.27%]</span></div><div class="line">                 0 LLC-load-misses           <span class="comment">#    0.00% of all LL-cache hits    [39.61%]</span></div><div class="line"></div><div class="line">       1.614165346 seconds time elapsed</div></pre></td></tr></table></figure>
<h3 id="2-2-指定-Hardware-Events-计数器"><a href="#2-2-指定-Hardware-Events-计数器" class="headerlink" title="2.2 指定 Hardware Events 计数器"></a>2.2 指定 Hardware Events 计数器</h3><p>下面是对 Hardware Events 指定计数的示例。如果 -e 指定的硬件事件包含“ cycle ”和“ instructions ”计数器，那么 perf 的输出中将包含 IPC。硬件事件通常是特定于处理器模型的，许多可能无法从虚拟化环境中获得。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 指定硬件计数器</span></div><div class="line">$ perf <span class="built_in">stat</span> -e L1-dcache-loads,L1-dcache-load-misses,L1-dcache-stores gzip file1</div><div class="line"></div><div class="line"> Performance counter stats <span class="keyword">for</span> <span class="string">'gzip file1'</span>:</div><div class="line"></div><div class="line">     1,947,551,657 L1-dcache-loads</div><div class="line">                                            </div><div class="line">       153,829,652 L1-dcache-misses</div><div class="line">         <span class="comment">#    7.90% of all L1-dcache hits  </span></div><div class="line">     1,171,475,286 L1-dcache-stores</div><div class="line">                                           </div><div class="line"></div><div class="line">       1.538038091 seconds time elapsed</div><div class="line"></div><div class="line"><span class="comment"># 使用原始事件</span></div><div class="line">$ perf <span class="built_in">stat</span> -e cycles,instructions,r80a2,r2b1 gzip file1</div><div class="line"></div><div class="line"> Performance counter stats <span class="keyword">for</span> <span class="string">'gzip file1'</span>:</div><div class="line"></div><div class="line">     5,586,963,328 cycles                    <span class="comment">#    0.000 GHz                    </span></div><div class="line">     8,608,237,932 instructions              <span class="comment">#    1.54  insns per cycle        </span></div><div class="line">         9,448,159 raw 0x80a2                                                  </div><div class="line">    11,855,777,803 raw 0x2b1                                                   </div><div class="line"></div><div class="line">       1.588618969 seconds time elapsed</div><div class="line"></div><div class="line"><span class="comment"># PMCs: counting cycles and frontend stalls via raw specification:</span></div><div class="line">$ perf <span class="built_in">stat</span> -e cycles -e cpu/event=0x0e,<span class="built_in">umask</span>=0x01,inv,cmask=0x01/ -a sleep 5</div></pre></td></tr></table></figure>
<h3 id="2-3-通过静态探针统计系统调用"><a href="#2-3-通过静态探针统计系统调用" class="headerlink" title="2.3 通过静态探针统计系统调用"></a>2.3 通过静态探针统计系统调用</h3><p>通过 -e 指定 Kernel Tracepoint Events，perf stat 可以统计程序执行的系统调用:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># 统计系统调用统计系统调用并打印摘要(非零计数)</div><div class="line">$ perf stat -e &apos;syscalls:sys_enter_*&apos; gzip file1 2&gt;&amp;1 | awk &apos;$1 != 0&apos;</div><div class="line"></div><div class="line">Performance counter stats for &apos;gzip file1&apos;:</div><div class="line"></div><div class="line">                 1 syscalls:sys_enter_utimensat               </div><div class="line">                 1 syscalls:sys_enter_unlink                  </div><div class="line">                 5 syscalls:sys_enter_newfstat                </div><div class="line">             1,603 syscalls:sys_enter_read                    </div><div class="line">             3,201 syscalls:sys_enter_write</div></pre></td></tr></table></figure>
<p>使用系统调用跟踪程序<code>strace -c</code>可以看到类似的报告，但是它可能导致比perf高得多的开销，因为perf在内核中缓冲数据。strace的当前实现使用ptrace(2)附加到目标进程并在系统调用期间停止它，就像调试器一样。这是暴力的，并可能导致严重的开销。</p>
<p>perf trace 子命令提供与 strace 类似的功能，但开销要低得多。perf trace 还可以进行系统级的系统调用跟踪（即跟踪所有进程），而 strace 只能跟踪特定的进程。</p>
<h2 id="3-采样事件"><a href="#3-采样事件" class="headerlink" title="3. 采样事件"></a>3. 采样事件</h2><p>perf record 是perf 的第二种使用方式，采样事件，他包含如下几种模式:</p>
<ol>
<li>Timed Profiling，以固定间隔采样，使用 -F 选项</li>
<li>Event Profiling，基于事件采样(通常是硬件事件，软件事件较少)，使用 -e 指定采样事件</li>
<li>Static Kernel Tracing: 基于内核的静态探针，使用 -e 指定静态探针类型。</li>
</ol>
<p>perf-record用来启动一次跟踪:</p>
<ol>
<li>perf record在当前目录产生一个perf.data文件，用来记录过程数据</li>
<li>如果这个文件已经存在，旧的文件会被改名为perf.data.old</li>
<li>perf.data只包含原始数据，perf report 需要访问本地的符号表，pid和进程的对应关系等信息来生成报告。</li>
<li>所以perf.data不能直接拷贝，可以通过perf-archive命令把所有这些数据打包，然后复制</li>
</ol>
<h3 id="3-1-perf-record-report-命令"><a href="#3-1-perf-record-report-命令" class="headerlink" title="3.1 perf record/report 命令"></a>3.1 perf record/report 命令</h3><p><code>perf record</code></p>
<ul>
<li>命令格式:<ul>
<li><code>perf record [-e &lt;EVENT&gt; | --event=EVENT] [-a] &lt;command&gt;</code></li>
<li><code>perf record [-e &lt;EVENT&gt; | --event=EVENT] [-a] — &lt;command&gt; [&lt;options&gt;]</code></li>
</ul>
</li>
<li>参数:<ul>
<li><code>-p, --pid &lt;pid&gt;</code>: 指定跟踪固定的一组进程，即仅仅跟踪发生在特定pid的事件</li>
<li><code>-a, --all-cpus</code>: 跟踪整个系统的性能，常用选项</li>
<li><code>-c, --count &lt;n&gt;</code>: 累计多少个事件记录一次</li>
<li><code>-g</code>: 开启堆栈追踪，通常无需使用</li>
<li><code>-F</code>: 事件采样的频率, 单位HZ, 更高的频率会获得更细的统计，但会带来更多的开销</li>
<li><code>sleep</code>: 采样的时间</li>
</ul>
</li>
</ul>
<p>perf.data 文件可以用多种方法处理。perf report命令启动ncurses导航器来检查调用图。或者使用 –stdio 选项将调用图打印成树状，并标注百分比:</p>
<p><code>perf report [-i &lt;file&gt; | --input=file]</code></p>
<ul>
<li>使用: 显示的是一个菜单项，回车可以查看折叠的代码，esc 或者 q 可以退出返回上一级</li>
<li>参数:<ul>
<li><code>--pid=</code>: 指定 pid</li>
<li><code>--tid=</code>: 指定 tid</li>
<li><code>-S, --symbols</code>=: Only consider these symbols. </li>
<li><code>--stdio</code>: 在终端将调用图以树状图打印</li>
</ul>
</li>
</ul>
<h3 id="3-2-Timed-Profiling"><a href="#3-2-Timed-Profiling" class="headerlink" title="3.2 Timed Profiling"></a>3.2 Timed Profiling</h3><p>perf 可以基于对指令指针或堆栈跟踪的固定间隔采样(定时分析)来分析CPU使用情况。入下例所示以99赫兹(-F 99)，对整个系统(-a，对所有CPU)采样CPU堆栈，采样10秒，并记录堆栈(-g，调用图):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ perf record -F 99 -a -g -- sleep 30</div></pre></td></tr></table></figure>
<p>选择99赫兹而不是100赫兹，是为了避免偶然地与某些周期性活动同步采样，以免产生扭曲的结果。这也是粗糙的:你可能想要增加到更高的速率(例如，高达997赫兹)以获得更好的分辨率，请记住，更高的频率意味着更高的开销。</p>
<h3 id="3-3-Event-Profiling"><a href="#3-3-Event-Profiling" class="headerlink" title="3.3 Event Profiling"></a>3.3 Event Profiling</h3><p>除了按时间间隔采样外，由CPU硬件计数器触发的采样是CPU分析的另一种形式。某些事件发生的频率非常高，在每次出现时都收集堆栈会导致过多的开销并降低系统速度并改变目标的性能特征。通常，只测量它们出现的一小部分，而不是全部，就足够了。这可以通过使用“-c” 指定触发事件收集的阈值来实现。“-c count”机制是由处理器实现的，它只在达到阈值时中断内核。</p>
<p>例如，下面的一行程序统计 1级数据缓存加载失败次数，每10000次失败收集一次堆栈跟踪:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 每 1000 次收集一次堆栈跟踪</span></div><div class="line">perf record -e L1-dcache-load-misses -c 10000 -ag -- sleep 5</div></pre></td></tr></table></figure>
<h3 id="3-4-Static-Kernel-Tracing"><a href="#3-4-Static-Kernel-Tracing" class="headerlink" title="3.4 Static Kernel Tracing"></a>3.4 Static Kernel Tracing</h3><p>通过内核静态探针，可以跟踪内核的系统调用。</p>
<h4 id="跟踪新进程的创建"><a href="#跟踪新进程的创建" class="headerlink" title="跟踪新进程的创建"></a>跟踪新进程的创建</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># perf record -e sched:sched_process_exec -a</span></div><div class="line">^C[ perf record: Woken up 1 <span class="built_in">times</span> to write data ]</div><div class="line">[ perf record: Captured and wrote 0.064 MB perf.data (~2788 samples) ]</div><div class="line"><span class="comment"># perf report -n --sort comm --stdio</span></div><div class="line">[...]</div><div class="line"><span class="comment"># Overhead       Samples  Command</span></div><div class="line"><span class="comment"># ........  ............  .......</span></div><div class="line"><span class="comment">#</span></div><div class="line">    11.11%             1    troff</div><div class="line">    11.11%             1      tbl</div><div class="line">    11.11%             1  preconv</div><div class="line">    11.11%             1    pager</div><div class="line">    11.11%             1    nroff</div><div class="line">    11.11%             1      man</div><div class="line">    11.11%             1   locale</div><div class="line">    11.11%             1   grotty</div><div class="line">    11.11%             1    groff</div></pre></td></tr></table></figure>
<h4 id="跟踪出站连接"><a href="#跟踪出站连接" class="headerlink" title="跟踪出站连接"></a>跟踪出站连接</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">$ perf record -e syscalls:sys_enter_connect -a</div><div class="line">^C[ perf record: Woken up 1 <span class="built_in">times</span> to write data ]</div><div class="line">[ perf record: Captured and wrote 0.057 MB perf.data (~2489 samples) ]</div><div class="line"><span class="comment"># perf report --stdio</span></div><div class="line"><span class="comment"># ========</span></div><div class="line"><span class="comment"># Samples: 21  of event 'syscalls:sys_enter_connect'</span></div><div class="line"><span class="comment"># Event count (approx.): 21</span></div><div class="line"><span class="comment">#</span></div><div class="line"> Overhead  Command       Shared Object                       Symbol</div><div class="line"> ........  .......  ..................  ...........................</div><div class="line"></div><div class="line">    52.38%     sshd  libc-2.15.so        [.] __GI___connect_internal</div><div class="line">    19.05%   groups  libc-2.15.so        [.] __GI___connect_internal</div><div class="line">     9.52%     sshd  libpthread-2.15.so  [.] __connect_internal     </div><div class="line">     9.52%     mesg  libc-2.15.so        [.] __GI___connect_internal</div><div class="line">     9.52%     bash  libc-2.15.so        [.] __GI___connect_internal</div></pre></td></tr></table></figure>
<p>记录connect()的堆栈跟踪可以解释为什么会出现这些出站连接:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ perf record -e syscalls:sys_enter_connect -ag</div><div class="line">^C[ perf record: Woken up 1 <span class="built_in">times</span> to write data ]</div><div class="line">[ perf record: Captured and wrote 0.057 MB perf.data (~2499 samples) ]</div><div class="line">$ perf report --stdio</div></pre></td></tr></table></figure>
<h4 id="跟踪套接字缓冲区消耗"><a href="#跟踪套接字缓冲区消耗" class="headerlink" title="跟踪套接字缓冲区消耗"></a>跟踪套接字缓冲区消耗</h4><p>跟踪套接字缓冲区的消耗和堆栈跟踪是识别导致套接字或网络I/O的原因的一种方法。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ perf record -e <span class="string">'skb:consume_skb'</span> -ag</div><div class="line">^C[ perf record: Woken up 1 <span class="built_in">times</span> to write data ]</div><div class="line">[ perf record: Captured and wrote 0.065 MB perf.data (~2851 samples) ]</div><div class="line">$ perf report</div></pre></td></tr></table></figure>
<h3 id="3-4-Static-User-Tracing"><a href="#3-4-Static-User-Tracing" class="headerlink" title="3.4 Static User Tracing"></a>3.4 Static User Tracing</h3><p>在4.x 的内核中，添加了用户态静态追踪机制。下面演示了Linux 4.10(附加了一个补丁集)，如何跟踪Node.js 的USDT探针:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># perf buildid-cache --add `which node`</span></div><div class="line"><span class="comment"># perf list | grep sdt_node</span></div><div class="line">  sdt_node:gc__done                                  [SDT event]</div><div class="line">  sdt_node:gc__start                                 [SDT event]</div><div class="line">  sdt_node:http__client__request                     [SDT event]</div><div class="line">  sdt_node:http__client__response                    [SDT event]</div><div class="line">  sdt_node:http__server__request                     [SDT event]</div><div class="line">  sdt_node:http__server__response                    [SDT event]</div><div class="line">  sdt_node:net__server__connection                   [SDT event]</div><div class="line">  sdt_node:net__stream__end                          [SDT event]</div><div class="line"><span class="comment"># perf record -e sdt_node:http__server__request -a</span></div><div class="line">^C[ perf record: Woken up 1 <span class="built_in">times</span> to write data ]</div><div class="line">[ perf record: Captured and wrote 0.446 MB perf.data (3 samples) ]</div><div class="line"><span class="comment"># perf script</span></div><div class="line">            node  7646 [002]   361.012364: sdt_node:http__server__request: (dc2e69)</div><div class="line">            node  7646 [002]   361.204718: sdt_node:http__server__request: (dc2e69)</div><div class="line">            node  7646 [002]   361.363043: sdt_node:http__server__request: (dc2e69)</div></pre></td></tr></table></figure></p>
<h3 id="3-5-Dynamic-Tracing"><a href="#3-5-Dynamic-Tracing" class="headerlink" title="3.5 Dynamic Tracing"></a>3.5 Dynamic Tracing</h3><p>使用动态追踪需要启用如下的内核参数:</p>
<ol>
<li>内核动态跟踪需要启用CONFIG_KPROBES=y和CONFIG_KPROBE_EVENTS=y</li>
<li>用户级动态跟踪需要启用 CONFIG_UPROBES=y和CONFIG_UPROBE_EVENTS=y</li>
<li>为避免内核栈指针优化，需要启用 CONFIG_FRAME_POINTER=y</li>
</ol>
<p>下面是几个在 Linux 使用 perf 进行动态追踪的示例</p>
<h4 id="检测内核tcp-sendmsg-函数"><a href="#检测内核tcp-sendmsg-函数" class="headerlink" title="检测内核tcp_sendmsg()函数"></a>检测内核tcp_sendmsg()函数</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 1. 添加动态探针</span></div><div class="line">$ perf probe --add tcp_sendmsg</div><div class="line">Failed to find path of kernel module.</div><div class="line">Added new event:</div><div class="line">  probe:tcp_sendmsg    (on tcp_sendmsg)</div><div class="line"></div><div class="line">You can now use it <span class="keyword">in</span> all perf tools, such as:</div><div class="line"></div><div class="line">	perf record -e probe:tcp_sendmsg -aR sleep 1</div><div class="line"></div><div class="line"><span class="comment"># 2. 使用动态探针</span></div><div class="line">$  perf record -e probe:tcp_sendmsg -a -g -- sleep 5</div><div class="line"></div><div class="line"><span class="comment"># 3. 输出追踪报告</span></div><div class="line">$ perf report --stdio</div><div class="line"></div><div class="line"><span class="comment"># 如果内核有debuginfo (CONFIG_DEBUG_INFO=y)，那么可以从函数中提取内核变量。</span></div><div class="line"><span class="comment"># 这是在Linux 3.13.1上检查size_t(整数)的一个简单示例。</span></div><div class="line"></div><div class="line"><span class="comment"># 5.列出tcp_sendmsg()可用的变量</span></div><div class="line">$  perf probe -V tcp_sendmsg</div><div class="line">Available variables at tcp_sendmsg</div><div class="line">        @&lt;tcp_sendmsg+0&gt;</div><div class="line">                size_t  size</div><div class="line">                struct kiocb*   iocb</div><div class="line">                struct msghdr*  msg</div><div class="line">                struct sock*    sk</div><div class="line"></div><div class="line"><span class="comment"># 6. 使用变量“size”为tcp_sendmsg()创建一个探针:</span></div><div class="line">$ perf probe --add <span class="string">'tcp_sendmsg size'</span></div><div class="line"></div><div class="line"><span class="comment"># 7. 跟踪此探针</span></div><div class="line">$ perf record -e probe:tcp_sendmsg -a</div><div class="line">$ perf script</div><div class="line"><span class="comment"># 内核:将显示 tcp_sendmsg()行号和本地变量值</span></div><div class="line"><span class="comment"># ========</span></div><div class="line"><span class="comment">#</span></div><div class="line">            sshd  1301 [001]   502.424719: probe:tcp_sendmsg: (ffffffff81505d80) size=b0</div><div class="line"></div><div class="line"><span class="comment"># 使用debuginfo, perf_events可以为内核函数中的行创建跟踪点。</span></div><div class="line"><span class="comment"># 必须安装 kernel-debuginfo 包，或者启用CONFIG_DEBUG_INFO=y</span></div><div class="line"><span class="comment"># 8. 列出tcp_sendmsg()可用的行探测:</span></div><div class="line">$ perf probe -L tcp_sendmsg</div><div class="line">&lt;tcp_sendmsg@/mnt/src/linux-3.14.5/net/ipv4/tcp.c:0&gt;</div><div class="line">      0  int tcp_sendmsg(struct kiocb *iocb, struct sock *sk, struct msghdr *msg,</div><div class="line">                        size_t size)</div><div class="line">      2  &#123;</div><div class="line">                struct iovec *iov;</div><div class="line">                struct tcp_sock *tp = tcp_sk(sk);</div><div class="line">                struct sk_buff *skb;</div><div class="line">      6         int iovlen, flags, err, copied = 0;</div><div class="line">      7         int mss_now = 0, size_goal, copied_syn = 0, offset = 0;</div><div class="line">                bool sg;</div><div class="line">                long timeo;</div><div class="line">[...]</div><div class="line"></div><div class="line"><span class="comment"># 9. 检查在第81行有哪些变量可用</span></div><div class="line">$ perf probe -V tcp_sendmsg:81</div><div class="line">Available variables at tcp_sendmsg:81</div><div class="line">        @&lt;tcp_sendmsg+537&gt;</div><div class="line">                bool    sg</div><div class="line">                int     copied</div><div class="line">                int     copied_syn</div><div class="line">                int     flags</div><div class="line">                int     mss_now</div><div class="line">                int     offset</div><div class="line">                int     size_goal</div><div class="line">                long int        timeo</div><div class="line">                size_t  seglen</div><div class="line">                struct iovec*   iov</div><div class="line">                struct sock*    sk</div><div class="line">                unsigned char*  from</div><div class="line"><span class="comment"># 10. 跟踪第81行，并使用循环中的seglen变量</span></div><div class="line">$ perf probe --add <span class="string">'tcp_sendmsg:81 seglen'</span></div><div class="line">$ perf record -e probe:tcp_sendmsg -a</div><div class="line">$ perf script</div><div class="line">            sshd  4652 [001] 2082360.931086: probe:tcp_sendmsg: (ffffffff81642ca9) seglen=0x80</div><div class="line">   app_plugin.pl  2400 [001] 2082360.970489: probe:tcp_sendmsg: (ffffffff81642ca9) seglen=0x20</div><div class="line">        postgres  2422 [000] 2082360.970703: probe:tcp_sendmsg: (ffffffff81642ca9) seglen=0x52</div><div class="line">[...]</div></pre></td></tr></table></figure>
<h4 id="跟踪-malloc-函数调用"><a href="#跟踪-malloc-函数调用" class="headerlink" title="跟踪 malloc 函数调用"></a>跟踪 malloc 函数调用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 1. 添加 malloc 探针</span></div><div class="line">$ perf probe -x /lib64/libc-2.17.so <span class="string">'--add=malloc'</span></div><div class="line">$ perf record -e probe_libc:malloc -a</div><div class="line">$ perf report -n</div><div class="line"></div><div class="line"><span class="comment"># 2. 添加带 size 参数的 malloc 探针</span></div><div class="line"><span class="comment"># size 保存的寄存器信息，依赖于你的处理器架构</span></div><div class="line">$ perf probe -x /lib64/libc-2.17.so <span class="string">'--add=malloc size=%di'</span></div></pre></td></tr></table></figure>
<p>malloc()调用非常频繁，因此需要考虑跟踪这样的调用的开销。</p>
<h2 id="4-perf-eBPF"><a href="#4-perf-eBPF" class="headerlink" title="4. perf eBPF"></a>4. perf eBPF</h2><h2 id="5-perf-特殊功能子命令"><a href="#5-perf-特殊功能子命令" class="headerlink" title="5. perf 特殊功能子命令"></a>5. perf 特殊功能子命令</h2><p>说完了 perf 的三种基础使用方式，我们来看perf 提供特殊功能的子命令。</p>
<h3 id="5-1-perf-trace"><a href="#5-1-perf-trace" class="headerlink" title="5.1 perf trace"></a>5.1 perf trace</h3><p>perf trace 类似于 strace 用于跟踪进程的系统调用，前面我们也提到了，相对于 strace 使用的 ptrace 机制来说，perf trace 基于内核事件，比进程跟踪的性能好很多。perf trace 还可以进行系统级的系统调用跟踪（即跟踪所有进程），而 strace 只能跟踪特定的进程。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Usage: perf trace [&lt;options&gt;] [&lt;<span class="built_in">command</span>&gt;]</div><div class="line">    or: perf trace [&lt;options&gt;] -- &lt;<span class="built_in">command</span>&gt; [&lt;options&gt;]</div><div class="line">    or: perf trace record [&lt;options&gt;] [&lt;<span class="built_in">command</span>&gt;]</div><div class="line">    or: perf trace record [&lt;options&gt;] -- &lt;<span class="built_in">command</span>&gt; [&lt;options&gt;]</div><div class="line"></div><div class="line">    -a, --all-cpus        system-wide collection from all CPUs</div><div class="line">    -C, --cpu &lt;cpu&gt;       list of cpus to monitor</div><div class="line">    -D, --delay &lt;n&gt;       ms to <span class="built_in">wait</span> before starting measurement after program start</div><div class="line">    -e, --event &lt;event&gt;   event/syscall selector. use <span class="string">'perf list'</span> to list available events</div><div class="line">    -f, --force           don<span class="string">'t complain, do it</span></div><div class="line"><span class="string">    -F, --pf &lt;all|maj|min&gt;</span></div><div class="line"><span class="string">                          Trace pagefaults</span></div><div class="line"><span class="string">    -G, --cgroup &lt;name&gt;   monitor event in cgroup name only</span></div><div class="line"><span class="string">    -i, --input &lt;file&gt;    Analyze events in file</span></div><div class="line"><span class="string">    -m, --mmap-pages &lt;pages&gt;</span></div><div class="line"><span class="string">                          number of mmap data pages</span></div><div class="line"><span class="string">    -o, --output &lt;file&gt;   output file name</span></div><div class="line"><span class="string">    -p, --pid &lt;pid&gt;       trace events on existing process id</span></div><div class="line"><span class="string">    --sched           show blocking scheduler events</span></div><div class="line"><span class="string">    --syscalls        Trace syscalls</span></div></pre></td></tr></table></figure>
<p>下面是 perf trace 的使用示例:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ perf trace --syscalls ls</div></pre></td></tr></table></figure></p>
<h3 id="5-1-perf-top"><a href="#5-1-perf-top" class="headerlink" title="5.1 perf top"></a>5.1 perf top</h3><p><code>perf top [-e &lt;EVENT&gt; | --event=EVENT] [&lt;options&gt;]</code></p>
<ul>
<li>作用: 可以动态收集和更新统计列表</li>
<li>options:<ul>
<li>-e:<ul>
<li>指定跟踪的事件，包括 perf list提供的所有事件以及 tracepoint</li>
<li>可以多次使用，也可以一次指定多个事件，事件使用逗号分隔</li>
<li>对于厂家为上传的事件可以直接是用编号，eg: <code>-e r0013</code> </li>
<li>事件可以指定后缀，用于限定跟踪范围</li>
</ul>
</li>
<li>-s:<ul>
<li>指定按什么参数来进行分类 </li>
<li>默认会按函数进行分类，按照 pid 分类需要指定 -s pid</li>
<li>-s也可以指定多个域（用逗号隔开）</li>
<li>可选值包括:<ul>
<li>pid, comm, dso, symbol, parent, srcline, weight, </li>
<li>local_weight, abort, in_tx, transaction, overhead, sample, period</li>
</ul>
</li>
</ul>
</li>
<li>-a：显示在所有CPU上的性能统计信息</li>
<li>-p：指定进程PID</li>
<li>-t：指定线程TID</li>
<li>-K：隐藏内核统计信息</li>
<li>-U：隐藏用户空间的统计信息</li>
<li>-S, –symbols: Only consider these symbols</li>
<li>-g, –call-graph: 得到函数的调用关系图<ul>
<li>格式: <code>&lt;print_type,threshold[,print_limit],order,sort_key[,branch],value&gt;</code></li>
<li>print_type:<ul>
<li>flat: single column, linear exposure of call chains.</li>
<li>graph: use a graph tree, displaying absolute overhead rates. (default)</li>
<li>fractal: like graph, but displays relative rates. Each branch of the tree is considered as a new profiled object.</li>
<li>folded: call chains are displayed in a line, separated by semicolons</li>
<li>none: disable call chain display.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 1. -e 指定多个事件</span></div><div class="line">&gt; sudo perf top -e branch-misses,cycles</div><div class="line"></div><div class="line"><span class="comment"># 2. 指定后缀，只跟踪用户态发生的分支预测失败</span></div><div class="line">&gt; sudo perf top -e branch-misses:u,cycles</div><div class="line">&gt; sudo perf top -e <span class="string">'&#123;branch-misses,cycles&#125;:u'</span></div><div class="line"></div><div class="line"><span class="comment"># 3. 指定分类</span></div><div class="line">&gt; sudo perf top -e <span class="string">'cycle'</span> -s comm,pid,dso</div></pre></td></tr></table></figure>
<h3 id="5-2-perf-sched"><a href="#5-2-perf-sched" class="headerlink" title="5.2 perf sched"></a>5.2 perf sched</h3><p>perf sched子命令提供了许多用于分析内核CPU调度器行为的工具。您可以使用它来识别和量化调度器延迟的问题。</p>
<p>这个命令的开销很大。如果开销是一个问题，可以使用<a href="http://www.brendangregg.com/ebpf.html#bcc" target="_blank" rel="external">eBPF/bcc工具</a>。其中runqlat和runqlen，只记录内核内的调度器事件摘要，进一步减少开销。perf sched转储所有事件的一个优点是不局限于摘要，对于分析问题而言可以获取更全面的信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># perf sched -h</span></div><div class="line"></div><div class="line"> Usage: perf <span class="built_in">sched</span> [] &#123;record|latency|map|replay|script|timehist&#125;</div><div class="line"></div><div class="line">    -D, --dump-raw-trace  dump raw trace <span class="keyword">in</span> ASCII</div><div class="line">    -f, --force           don<span class="string">'t complain, do it</span></div><div class="line"><span class="string">    -i, --input     input file name</span></div><div class="line"><span class="string">    -v, --verbose         be more verbose (show symbol address, etc)</span></div></pre></td></tr></table></figure>
<p>perf sched 有<code>{record|latency|map|replay|script|timehist}</code>使用模式，我们来一一介绍。</p>
<h4 id="perf-sched-record"><a href="#perf-sched-record" class="headerlink" title="perf sched record"></a>perf sched record</h4><h4 id="perf-sched-latency"><a href="#perf-sched-latency" class="headerlink" title="perf sched latency"></a>perf sched latency</h4><p>perf sched latency  将按任务统计调度程序延迟，包括平均延迟和最大延迟:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># perf sched latency</span></div><div class="line"></div><div class="line"> -----------------------------------------------------------------------------------------------------------------</div><div class="line">  Task                  |   Runtime ms  | Switches | Average delay ms | Maximum delay ms | Maximum delay at       |</div><div class="line"> -----------------------------------------------------------------------------------------------------------------</div><div class="line">  cat:(6)               |     12.002 ms |        6 | avg:   17.541 ms | max:   29.702 ms | max at: 991962.948070 s</div><div class="line">  ar:17043              |      3.191 ms |        1 | avg:   13.638 ms | max:   13.638 ms | max at: 991963.048070 s</div><div class="line">  rm:(10)               |     20.955 ms |       10 | avg:   11.212 ms | max:   19.598 ms | max at: 991963.404069 s</div></pre></td></tr></table></figure>
<h4 id="perf-sched-map"><a href="#perf-sched-map" class="headerlink" title="perf sched map"></a>perf sched map</h4><p>perf sched map 显示所有CPU和上下文切换事件，其中的列表示每个CPU正在做什么以及何时做。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># perf sched map</span></div><div class="line">                      *A0           991962.879971 secs A0 =&gt; perf:16999</div><div class="line">                       A0     *B0   991962.880070 secs B0 =&gt; cc1:16863</div><div class="line">          *C0          A0      B0   991962.880070 secs C0 =&gt; :17023:17023</div><div class="line">  *D0      C0          A0      B0   991962.880078 secs D0 =&gt; ksoftirqd/0:6</div><div class="line">   D0      C0 *E0      A0      B0   991962.880081 secs E0 =&gt; ksoftirqd/3:28</div><div class="line">   D0      C0 *F0      A0      B0   991962.880093 secs F0 =&gt; :17022:17022</div></pre></td></tr></table></figure>
<h4 id="perf-sched-replay"><a href="#perf-sched-replay" class="headerlink" title="perf sched replay"></a>perf sched replay</h4><h4 id="perf-sched-script"><a href="#perf-sched-script" class="headerlink" title="perf sched script"></a>perf sched script</h4><h4 id="perf-sched-timehist"><a href="#perf-sched-timehist" class="headerlink" title="perf sched timehist"></a>perf sched timehist</h4><h3 id="5-3-perf-mem"><a href="#5-3-perf-mem" class="headerlink" title="5.3 perf mem"></a>5.3 perf mem</h3><h2 id="6-perf-data-处理"><a href="#6-perf-data-处理" class="headerlink" title="6. perf.data 处理"></a>6. perf.data 处理</h2><h3 id="6-1-perf-diff"><a href="#6-1-perf-diff" class="headerlink" title="6.1 perf diff"></a>6.1 perf diff</h3><p><code>perf diff [baseline file] [data file1] [[data file2] ... ]</code></p>
<ul>
<li>作用: 比较两次运行的区别</li>
<li>场景: 可以用不同参数运行程序，看看两次运行的差别</li>
</ul>
<h3 id="6-2-perf-script"><a href="#6-2-perf-script" class="headerlink" title="6.2 perf script"></a>6.2 perf script</h3><p><code>perf script [&lt;options&gt;]</code></p>
<ul>
<li>作用: 对 perf.data 数据做格式转换</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 1. 导出原始分析数据</span></div><div class="line">&gt; perf record</div><div class="line">&gt; perf script <span class="comment"># 导出 perf record 中记录的原始数据</span></div><div class="line">&gt; perf script | ./stackcollapse-perf.pl | ./flamegraph.pl &gt; perf-kernel.svg</div><div class="line"></div><div class="line"><span class="comment"># List all perf.data events, with customized fields (&lt; Linux 4.1):</span></div><div class="line">perf script -f time,event,trace</div><div class="line"></div><div class="line"><span class="comment"># List all perf.data events, with customized fields (&gt;= Linux 4.1):</span></div><div class="line">perf script -F time,event,trace</div><div class="line"></div><div class="line"><span class="comment"># List all perf.data events, with my recommended fields (needs record -a; newer kernels):</span></div><div class="line">perf script --header -F comm,pid,tid,cpu,time,event,ip,sym,dso </div><div class="line"></div><div class="line"><span class="comment"># List all perf.data events, with my recommended fields (needs record -a; older kernels):</span></div><div class="line">perf script -f comm,pid,tid,cpu,time,event,ip,sym,dso</div><div class="line"></div><div class="line"><span class="comment"># Dump raw contents from perf.data as hex (for debugging):</span></div><div class="line">perf script -D</div></pre></td></tr></table></figure>
<h2 id="7-perf-数据可视化"><a href="#7-perf-数据可视化" class="headerlink" title="7. perf 数据可视化"></a>7. perf 数据可视化</h2><h3 id="7-1-perf-chart"><a href="#7-1-perf-chart" class="headerlink" title="7.1 perf chart"></a>7.1 perf chart</h3><p>perf timechart输出的是进程运行过程中系统调度的情况，无法对程序的具体代码段进行性能分析，但可以看出总结运行情况：running，idle，I/O等，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">perf timechart record ./a.out     <span class="comment"># 记录数据</span></div><div class="line">perf timechart                    <span class="comment"># 生成 output.svg</span></div></pre></td></tr></table></figure>
<h3 id="7-2-火焰图"><a href="#7-2-火焰图" class="headerlink" title="7.2 火焰图"></a>7.2 火焰图</h3><p>Brendangregg写了两款对perf采样结果进行可视化分析的开源工具：</p>
<ol>
<li>FlameGraphs即所谓的火焰图，能清晰的展示程序各个函数的性能消耗</li>
<li>HeatMap可以从采样数据中的延迟数据来进行消耗展示</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 生成火焰图</span></div><div class="line">git <span class="built_in">clone</span> https://github.com/brendangregg/FlameGraph  <span class="comment"># or download it from github</span></div><div class="line"><span class="built_in">cd</span> FlameGraph</div><div class="line">perf record -F 99 -ag -- sleep 60</div><div class="line">perf script | ./stackcollapse-perf.pl &gt; out.perf-folded</div><div class="line">cat out.perf-folded | ./flamegraph.pl &gt; perf-kernel.svg</div></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://www.brendangregg.com/perf.html" target="_blank" rel="external">brendangregg-perf</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/22194920" target="_blank" rel="external">在Linux下做性能分析3：perf</a></li>
</ul>

        </div>
        <!--  -->
        <footer class="article-footer">
            



    <a data-url="http://yoursite.com/2020/01/05/linux_perf/06_perf_use/" data-id="ckxy3rqgw006x8ku9iq2r9hup" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>



                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google-plus" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-google-plus"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2020/01/06/linux_perf/07.dtrace/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            2.5 Dtrace
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2020/01/04/linux_perf/04_perf/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">2.2 perf 的原理</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/10/17/assembley/link/link_01/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/操作系统/">操作系统</a></p>
                            <p class="item-title"><a href="/2021/10/17/assembley/link/link_01/" class="title">1. 《程序员的自我修养》读书笔记</a></p>
                            <p class="item-date"><time datetime="2021-10-16T16:00:00.000Z" itemprop="datePublished">2021-10-17</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/11/assembley/x86/x86_11/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/task.png)" alt="11. 任务和特权级保护" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/11/assembley/x86/x86_11/" class="title">11. 任务和特权级保护</a></p>
                            <p class="item-date"><time datetime="2021-07-10T16:00:00.000Z" itemprop="datePublished">2021-07-11</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/10/assembley/x86/x86_10/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/memory_asign.png)" alt="10. 程序的动态加载和执行" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/10/assembley/x86/x86_10/" class="title">10. 程序的动态加载和执行</a></p>
                            <p class="item-date"><time datetime="2021-07-09T16:00:00.000Z" itemprop="datePublished">2021-07-10</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/09/assembley/x86/x86_09/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/seg_check.png)" alt="9. 存储器的保护" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/09/assembley/x86/x86_09/" class="title">9. 存储器的保护</a></p>
                            <p class="item-date"><time datetime="2021-07-08T16:00:00.000Z" itemprop="datePublished">2021-07-09</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/08/assembley/x86/x86_08/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/gdt.png)" alt="8. 进入保护模式" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/08/assembley/x86/x86_08/" class="title">8. 进入保护模式</a></p>
                            <p class="item-date"><time datetime="2021-07-07T16:00:00.000Z" itemprop="datePublished">2021-07-08</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">61</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式/">分布式</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储/">存储</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/">操作系统</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">198</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">25</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">32</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">31</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">21</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">26</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">48</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">31</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">29</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">4</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Brendan-Gregg/">Brendan Gregg</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/">ES6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML-CSS/">HTML&CSS</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8S/">K8S</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/">Kafka</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux性能调优/">Linux性能调优</a><span class="tag-list-count">49</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL实战45讲/">MySQL实战45讲</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openstack/">Openstack</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/">React</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/">Vue</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go并发编程/">go并发编程</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go标准库及第三方库/">go标准库及第三方库</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go语言入门/">go语言入门</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wrapt/">wrapt</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/x86-汇编/">x86 汇编</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/入门指南/">入门指南</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/好玩的数据结构与算法/">好玩的数据结构与算法</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据密集型应用/">数据密集型应用</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构与算法/">数据结构与算法</a><span class="tag-list-count">39</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/极客时间/">极客时间</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/程序员的自我修养/">程序员的自我修养</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马哥-Linux/">马哥 Linux</a><span class="tag-list-count">135</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马哥-MySQL-运维/">马哥 MySQL 运维</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高性能的MySQL/">高性能的MySQL</a><span class="tag-list-count">5</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/Brendan-Gregg/" style="font-size: 10px;">Brendan Gregg</a> <a href="/tags/ES6/" style="font-size: 15.63px;">ES6</a> <a href="/tags/HTML-CSS/" style="font-size: 12.5px;">HTML&CSS</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/K8S/" style="font-size: 10px;">K8S</a> <a href="/tags/Kafka/" style="font-size: 16.25px;">Kafka</a> <a href="/tags/Linux性能调优/" style="font-size: 19.38px;">Linux性能调优</a> <a href="/tags/MySQL实战45讲/" style="font-size: 18.13px;">MySQL实战45讲</a> <a href="/tags/Openstack/" style="font-size: 13.75px;">Openstack</a> <a href="/tags/React/" style="font-size: 15.63px;">React</a> <a href="/tags/Vue/" style="font-size: 15.63px;">Vue</a> <a href="/tags/go并发编程/" style="font-size: 17.5px;">go并发编程</a> <a href="/tags/go标准库及第三方库/" style="font-size: 10.63px;">go标准库及第三方库</a> <a href="/tags/go语言入门/" style="font-size: 14.38px;">go语言入门</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/python/" style="font-size: 11.25px;">python</a> <a href="/tags/wrapt/" style="font-size: 16.88px;">wrapt</a> <a href="/tags/x86-汇编/" style="font-size: 14.38px;">x86 汇编</a> <a href="/tags/入门指南/" style="font-size: 16.25px;">入门指南</a> <a href="/tags/好玩的数据结构与算法/" style="font-size: 11.88px;">好玩的数据结构与算法</a> <a href="/tags/数据密集型应用/" style="font-size: 15.63px;">数据密集型应用</a> <a href="/tags/数据结构与算法/" style="font-size: 18.75px;">数据结构与算法</a> <a href="/tags/极客时间/" style="font-size: 18.13px;">极客时间</a> <a href="/tags/程序员的自我修养/" style="font-size: 10px;">程序员的自我修养</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a> <a href="/tags/马哥-Linux/" style="font-size: 20px;">马哥 Linux</a> <a href="/tags/马哥-MySQL-运维/" style="font-size: 13.13px;">马哥 MySQL 运维</a> <a href="/tags/高性能的MySQL/" style="font-size: 11.88px;">高性能的MySQL</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">讨论区</h3>
        <div class="widget">
            <h4> 联系我 <h4>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2022 宋涛</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'http://yoursite.com/2020/01/05/linux_perf/06_perf_use/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
