<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    

    
    <title>43 临时表 | 宋涛的博客</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="mysql运维" />
    
    <meta name="description" content="什么时候会使用临时表">
<meta name="keywords" content="mysql运维">
<meta property="og:type" content="article">
<meta property="og:title" content="43 临时表">
<meta property="og:url" content="http://yoursite.com/2020/03/30/mysql/MySQL实战45讲/43_临时表/index.html">
<meta property="og:site_name" content="宋涛的博客">
<meta property="og:description" content="什么时候会使用临时表">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/mysql/MySQL45讲/temporary_table_feature.png">
<meta property="og:updated_time" content="2020-03-30T07:25:56.980Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="43 临时表">
<meta name="twitter:description" content="什么时候会使用临时表">
<meta name="twitter:image" content="http://yoursite.com/images/mysql/MySQL45讲/temporary_table_feature.png">
    

    
        <link rel="alternate" href="/" title="宋涛的博客" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/3.3.1/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    


</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">漫步在大陆上的海龟</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Go/">Go</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Python/">Python</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/存储/">存储</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/运维/">运维</a></li></ul>
                                    
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/存储/">存储</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-mysql/MySQL实战45讲/43_临时表" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        43 临时表
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2020/03/30/mysql/MySQL实战45讲/43_临时表/" class="article-date">
            <time datetime="2020-03-29T16:00:00.000Z" itemprop="datePublished">2020-03-30</time>
        </a>
    </div>

		

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/mysql运维/">mysql运维</a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p>什么时候会使用临时表<br><a id="more"></a></p>
<h2 id="1-临时表"><a href="#1-临时表" class="headerlink" title="1. 临时表"></a>1. 临时表</h2><h3 id="1-1-临时表跟内存表"><a href="#1-1-临时表跟内存表" class="headerlink" title="1.1 临时表跟内存表"></a>1.1 临时表跟内存表</h3><ol>
<li>内存表，指的是使用 Memory 引擎的表，建表语法是 <code>create table … engine=memory</code>。这种表的数据都保存在内存里，系统重启的时候会被清空，但是表结构还在。除了这两个特性看上去比较“奇怪”外，从其他的特征上看，它就是一个正常的表。</li>
<li>而临时表，可以使用各种引擎类型 。如果是使用 InnoDB 引擎或者 MyISAM 引擎的临时表，写数据的时候是写到磁盘上的。当然，临时表也可以使用 Memory 引擎</li>
</ol>
<h3 id="1-2-临时表的特征"><a href="#1-2-临时表的特征" class="headerlink" title="1.2 临时表的特征"></a>1.2 临时表的特征</h3><p><img src="/images/mysql/MySQL45讲/temporary_table_feature.png" alt="temporary_table_feature"></p>
<p>从行面可以看到，临时表在使用上有以下几个特点：</p>
<ol>
<li>一个临时表只能被创建它的 session 访问，对其他线程不可见所以，图中 session A 创建的临时表 t，对于 session B 就是不可见的。</li>
<li>临时表可以与普通表同名。</li>
<li>session A 内有同名的临时表和普通表的时候，show create 语句，以及增删改查语句访问的是临时表。</li>
<li>show tables 命令不显示临时表。</li>
<li>由于临时表只能被创建它的 session 访问，所以在这个 session 结束的时候，会自动删除临时表。</li>
<li>不同 session 的临时表是可以重名的，如果有多个 session 同时执行 join 优化，不需要担心表名重复导致建表失败的问题。</li>
<li>不需要担心数据删除问题。如</li>
</ol>
<h3 id="1-3-临时表的应用场景"><a href="#1-3-临时表的应用场景" class="headerlink" title="1.3 临时表的应用场景"></a>1.3 临时表的应用场景</h3><p>由于不用担心线程之间的重名冲突，临时表经常会被用在复杂查询的优化过程中。其中，分库分表系统的跨库查询就是一个典型的使用场景。</p>
<p>一般分库分表的场景，就是要把一个逻辑上的大表分散到不同的数据库实例上。分区 key 的选择是以“减少跨库和跨表查询”为依据的。</p>
<p>但是如果查询条件里面没有用到分区字段，那么该如何实现查询呢，有以下两种思路:</p>
<ol>
<li>第一种思路是，在 proxy 层的进程代码中实现:<ul>
<li>优势是处理速度快，拿到分库的数据以后，直接在内存中参与计算</li>
<li>需要的开发工作量比较大，特别是是对于 group by，join 的操作</li>
<li>对 proxy 端的压力比较大，尤其是很容易出现内存不够用和 CPU 瓶颈的问题</li>
</ul>
</li>
<li>把各个分库拿到的数据，汇总到一个 MySQL 实例的一个表中，然后在这个汇总实例上做逻辑操作。</li>
</ol>
<p>我们看下面这个示例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ht 是一个大的分库分表，分区 key 是 f</span></div><div class="line">select v from ht <span class="built_in">where</span> k &gt;= M order by t_modified desc <span class="built_in">limit</span> 100;</div><div class="line"></div><div class="line"><span class="comment"># 思路二: 使用临时表实现的分库查询，汇总到汇总库</span></div><div class="line"><span class="comment"># 每个分库的查询</span></div><div class="line">select v,k,t_modified from ht_x <span class="built_in">where</span> k &gt;= M order by t_modified desc <span class="built_in">limit</span> 100;</div><div class="line"></div><div class="line"><span class="comment"># 汇总库的查询</span></div><div class="line">select v from temp_ht order by t_modified desc <span class="built_in">limit</span> 100;</div></pre></td></tr></table></figure>
<p>按照第二种思路，我们可以这样执行查询:</p>
<ol>
<li>在汇总库上创建一个临时表 temp_ht，表里包含三个字段 v、k、t_modified；</li>
<li>在各个分库上执行 <code>select v,k,t_modified from ht_x where k &gt;= M order by t_modified desc limit 100;</code></li>
<li>把分库执行的结果插入到 temp_ht 表中；</li>
<li>执行<code>select v from temp_ht order by t_modified desc limit 100;</code></li>
</ol>
<p><img src="/images/mysql/MySQL45讲/temporary_table_sort.jpg" alt="temporary_table_sort"></p>
<p>我们往往会发现每个分库的计算量都不饱和，所以会直接把临时表 temp_ht 放到 32 个分库中的某一个上。</p>
<h3 id="1-4-为什么临时表可以重命名"><a href="#1-4-为什么临时表可以重命名" class="headerlink" title="1.4 为什么临时表可以重命名"></a>1.4 为什么临时表可以重命名</h3><p>不同线程可以创建同名的临时表，这是怎么做到的呢？我们来看看MySQL是如何保存临时表的表结构与数据的</p>
<p>执行 <code>create temporary table temp_t(id int primary key)engine=innodb;</code></p>
<ol>
<li>临时表的 frm 文件放在临时文件目录下，文件名的后缀是.frm，前缀是<code>#sql{进程 id}_{线程 id}_ 序列号</code>。可以使用 <code>select @@tmpdir</code> 命令，来显示实例的临时文件目录。</li>
<li>关于表中数据的存放方式，在不同的 MySQL 版本中有着不同的处理方式：<ul>
<li>在 5.6 以及之前的版本里，MySQL 会在临时文件目录下创建一个相同前缀、以.ibd 为后缀的文件，用来存放数据文件；</li>
<li>从 5.7 版本开始，MySQL 引入了一个临时文件表空间，专门用来存放临时文件的数据。因此，我们就不需要再创建 ibd 文件了。</li>
</ul>
</li>
</ol>
<p>MySQL 维护数据表，除了物理上要有文件外，内存里面也有一套机制区别不同的表，每个表都对应一个 table_def_key。</p>
<ol>
<li>个普通表的 table_def_key 的值是由“库名 + 表名”得到的</li>
<li>而对于临时表，table_def_key 在“库名 + 表名”基础上，又加入了“server_id+thread_id”。</li>
</ol>
<p>在实现上，每个线程都维护了自己的临时表链表。这样每次 session 内操作表的时候，先遍历链表，检查是否有这个名字的临时表，如果有就优先操作临时表，如果没有再操作普通表；在 session 结束的时候，对链表里的每个临时表，执行 “DROP TEMPORARY TABLE + 表名”操作。binlog 中也记录了 DROP TEMPORARY TABLE 这条命令。</p>
<h4 id="临时表的-rename-操作"><a href="#临时表的-rename-操作" class="headerlink" title="临时表的 rename 操作"></a>临时表的 rename 操作</h4><p>执行 rename table 语句的时候，要求按照“库名 / 表名.frm”的规则去磁盘找文件，但是临时表在磁盘上的 frm 文件是放在 tmpdir 目录下的，并且文件名的规则是“#sql{进程 id}<em>{线程 id}</em> 序列号.frm”，因此会报“找不到文件名”的错误。</p>
<h3 id="1-5-临时表与主从复制"><a href="#1-5-临时表与主从复制" class="headerlink" title="1.5 临时表与主从复制"></a>1.5 临时表与主从复制</h3><p>临时表只在线程内自己可以访问，为什么需要写到 binlog 里面？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">create table t_normal(id int primary key, c int)engine=innodb;/*Q1*/</div><div class="line">create temporary table temp_t like t_normal;/*Q2*/</div><div class="line">insert into temp_t values(1,1);/*Q3*/</div><div class="line">insert into t_normal select * from temp_t;/*Q4*/</div></pre></td></tr></table></figure>
<p>如果关于临时表的操作都不记录，备库在执行到 insert into t_normal 的时候，就会报错“表 temp_t 不存在”。</p>
<p>如果当前的 binlog_format=row，那么跟临时表有关的语句，就不会记录到 binlog 里。也就是说，只在 binlog_format=statment/mixed 的时候，binlog 中才会记录临时表的操作。这种情况下，创建临时表的语句会传到备库执行，因此备库的同步线程就会创建这个临时表。主库在线程退出的时候，会自动删除临时表，但是备库同步线程是持续在运行的。所以，这时候我们就需要在主库上再写一个 DROP TEMPORARY TABLE 传给备库执行。</p>
<p>在 binlog_format=’row’的时候，临时表的操作不记录到 binlog 中，也省去了不少麻烦，这也可以成为你选择 binlog_format 时的一个考虑因素。</p>
<h4 id="MySQL-为什么会重写-drop-table-命令"><a href="#MySQL-为什么会重写-drop-table-命令" class="headerlink" title="MySQL 为什么会重写 drop table 命令"></a>MySQL 为什么会重写 drop table 命令</h4><p>MySQL 在记录 binlog 的时候，不论是 create table 还是 alter table 语句，都是原样记录，甚至于连空格都不变。但是如果执行 drop table t_normal，系统记录 binlog 就会写成：<br><code>DROP TABLE t_normal /* generated by server */</code></p>
<p>drop table 命令是可以一次删除多个表的。比如，在上面的例子中，设置 binlog_format=row，如果主库上执行 “drop table t_normal, temp_t”这个命令，那么 binlog 中就只能记录：<code>DROP TABLE t_normal /* generated by server */</code></p>
<p>因为备库上并没有表 temp_t，将这个命令重写后再传到备库执行，才不会导致备库同步线程停止。所以，drop table 命令记录 binlog 的时候，就必须对语句做改写。<code>/* generated by server */</code>说明了这是一个被服务端改写过的命令。</p>
<h4 id="从服务如何保证临时表不冲突"><a href="#从服务如何保证临时表不冲突" class="headerlink" title="从服务如何保证临时表不冲突"></a>从服务如何保证临时表不冲突</h4><p>MySQL 在记录 binlog 的时候，会把主库执行这个语句的线程 id 写到 binlog 中。这样，在备库的应用线程就能够知道执行每个语句的主库线程 id，并利用这个线程 id 来构造临时表的 table_def_key：</p>
<ol>
<li>session A 的临时表 t1，在备库的 table_def_key 就是：<code>库名 +t1+“M 的 serverid”+“session A 的 thread_id”</code>;</li>
<li>session B 的临时表 t1，在备库的 table_def_key 就是 ：<code>库名 +t1+“M 的 serverid”+“session B 的 thread_id”</code></li>
</ol>
<h2 id="2-内存临时表"><a href="#2-内存临时表" class="headerlink" title="2.内存临时表"></a>2.内存临时表</h2><p>MySQL 什么时候会使用内部临时表？</p>
<ol>
<li>如果语句执行过程可以一边读数据，一边直接得到结果，是不需要额外内存的，否则就需要额外的内存，来保存中间结果；</li>
<li>join_buffer 是无序数组，sort_buffer 是有序数组，临时表是二维表结构；</li>
<li>如果执行逻辑需要用到二维表特性，就会优先考虑使用临时表。比如我们的例子中，union 需要用到唯一索引约束， group by 还需要用到另外一个字段来存累积计数。</li>
</ol>
<h3 id="2-1-union"><a href="#2-1-union" class="headerlink" title="2.1 union"></a>2.1 union</h3><p> union，它的语义是，取这两个子查询结果的并集。并集的意思就是这两个集合加起来，重复的行只保留一行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(select 1000 as f) union (select id from t1 order by id desc <span class="built_in">limit</span> 2);</div></pre></td></tr></table></figure>
<p>上面这个 union 语句的执行过程是这样的:</p>
<ol>
<li>创建一个内存临时表，这个临时表只有一个整型字段 f，并且 f 是主键字段。</li>
<li>执行第一个子查询，得到 1000 这个值，并存入临时表中。</li>
<li>执行第二个子查询：<ul>
<li>拿到第一行 id=1000，试图插入临时表中。但由于 1000 这个值已经存在于临时表了，违反了唯一性约束，所以插入失败，然后继续执行；</li>
<li>取到第二行 id=999，插入临时表成功。</li>
</ul>
</li>
<li>从临时表中按行取出数据，返回结果，并删除临时表，结果中包含两行数据分别是 1000 和 999</li>
</ol>
<p>这里的内存临时表起到了暂存数据的作用，而且计算过程还用上了临时表主键 id 的唯一性约束，实现了 union 的语义。如果把上面这个语句中的 union 改成 union all 的话，就没有了“去重”的语义。这样执行的时候，就依次执行子查询，得到的结果直接作为结果集的一部分，发给客户端。因此也就不需要临时表了。</p>
<h3 id="2-2-group-by"><a href="#2-2-group-by" class="headerlink" title="2.2 group by"></a>2.2 group by</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 会对返回结果排序</span></div><div class="line">select id%10 as m, count(*) as c from t1 group by m;</div><div class="line"></div><div class="line"><span class="comment"># order by null 结果集不排序</span></div><div class="line">select id%10 as m, count(*) as c from t1 group by m order by null;</div></pre></td></tr></table></figure>
<p>它的 explain 结果如下：</p>
<p><img src="/images/mysql/MySQL45讲/group_explain.jpg" alt="group_explain"></p>
<p>Extra 字段：</p>
<ol>
<li>Using index，表示这个语句使用了覆盖索引，选择了索引 a，不需要回表；</li>
<li>Using temporary，表示使用了临时表；</li>
<li>Using filesort，表示需要排序。</li>
</ol>
<p>个语句的执行流程是这样的：</p>
<ol>
<li>创建内存临时表，表里有两个字段 m 和 c，主键是 m；</li>
<li>扫描表 t1 的索引 a，依次取出叶子节点上的 id 值，计算 id%10 的结果，记为 x；<ul>
<li>如果临时表中没有主键为 x 的行，就插入一个记录 (x,1);</li>
<li>如果表中有主键为 x 的行，就将 x 这一行的 c 值加 1；</li>
</ul>
</li>
<li>遍历完成后，再根据字段 m 做排序，得到结果集返回给客户端。</li>
</ol>
<h4 id="临时表大小"><a href="#临时表大小" class="headerlink" title="临时表大小"></a>临时表大小</h4><p>参数 <code>tmp_table_size</code> 用于控制内存临时表大小的，默认是 16M。如果执行过程中会发现内存临时表大小到达了上限，这时候就会把内存临时表转成磁盘临时表，磁盘临时表默认使用的引擎是 InnoDB。 </p>
<h2 id="3-group-by-优化"><a href="#3-group-by-优化" class="headerlink" title="3. group by 优化"></a>3. group by 优化</h2><h3 id="3-1-索引优化"><a href="#3-1-索引优化" class="headerlink" title="3.1 索引优化"></a>3.1 索引优化</h3><p>可以看到，不论是使用内存临时表还是磁盘临时表，group by 逻辑都需要构造一个带唯一索引的表，执行代价很高。</p>
<p>group by 的语义逻辑，是统计不同的值出现的个数。那么，如果扫描过程中可以保证出现的数据是有序的就无须临时表了。在 MySQL 5.7 版本支持了 generated column 机制，用来实现列数据的关联更新。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">alter table t1 add column z int generated always as(id % 100), add index(z);</div></pre></td></tr></table></figure>
<h3 id="3-2-直接排序"><a href="#3-2-直接排序" class="headerlink" title="3.2 直接排序"></a>3.2 直接排序</h3><p>碰上不适合创建索引的场景,如果我们明明知道，一个 group by 语句中需要放到临时表上的数据量特别大，却还是要按照“先放到内存临时表，插入一部分数据后，发现内存临时表不够用了再转成磁盘临时表”，看上去就有点儿傻。</p>
<p>在 group by 语句中加入 SQL_BIG_RESULT 这个提示（hint），就可以告诉优化器：这个语句涉及的数据量很大，请直接用磁盘临时表。</p>
<p>MySQL 的优化器一看，磁盘临时表是 B+ 树存储，存储效率不如数组来得高。所以，既然你告诉我数据量很大，那从磁盘空间考虑，还是直接用数组来存吧。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select SQL_BIG_RESULT id%100 as m, count(*) as c from t1 group by m;</div></pre></td></tr></table></figure>
<p>执行流程就是这样的：</p>
<ol>
<li>初始化 sort_buffer，确定放入一个整型字段，记为 m；</li>
<li>扫描表 t1 的索引 a，依次取出里面的 id 值, 将 id%100 的值存入 sort_buffer 中；</li>
<li>扫描完成后，对 sort_buffer 的字段 m 做排序（如果 sort_buffer 内存不够用，就会利用磁盘临时文件辅助排序）；</li>
<li>排序完成后，就得到了一个有序数组</li>
<li>据有序数组，得到数组里面的不同值，以及每个值的出现次数。</li>
</ol>
<h3 id="3-3-group-by-使用技巧"><a href="#3-3-group-by-使用技巧" class="headerlink" title="3.3 group by 使用技巧"></a>3.3 group by 使用技巧</h3><p>group by 的几种实现算法，从中可以总结一些使用的指导原则：</p>
<ol>
<li>如果对 group by 语句的结果没有排序要求，要在语句后面加 order by null；</li>
<li>尽量让 group by 过程用上表的索引，确认方法是 explain 结果里没有 Using temporary 和 Using filesort；</li>
<li>如果 group by 需要统计的数据量不大，尽量只使用内存临时表；也可以通过适当调大 tmp_table_size 参数，来避免用到磁盘临时表；</li>
<li>如果数据量实在太大，使用 SQL_BIG_RESULT 这个提示，来告诉优化器直接使用排序算法得到 group by 的结果</li>
</ol>
<h3 id="3-4-distinct-和-group-by-的性能"><a href="#3-4-distinct-和-group-by-的性能" class="headerlink" title="3.4 distinct 和 group by 的性能"></a>3.4 distinct 和 group by 的性能</h3><p>如果只需要去重，不需要执行聚合函数，distinct 和 group by 哪种效率高一些呢？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">select a from t group by a order by null;</div><div class="line">select distinct a from t;</div></pre></td></tr></table></figure>
<p>不需要执行聚合函数时，distinct 和 group by 这两条语句的语义和执行流程是相同的，因此执行性能也相同。执行流程是下面这样的。</p>
<ol>
<li>创建一个临时表，临时表有一个字段 a，并且在这个字段 a 上创建一个唯一索引；</li>
<li>遍历表 t，依次取数据插入临时表中：<ul>
<li>如果发现唯一键冲突，就跳过；</li>
<li>否则插入成功；</li>
</ul>
</li>
<li>遍历完成后，将临时表作为结果集返回给客户端。</li>
</ol>

        </div>
        <footer class="article-footer">
            



    <a data-url="http://yoursite.com/2020/03/30/mysql/MySQL实战45讲/43_临时表/" data-id="ckal5ebf500nf5su9a80bz3ru" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>



                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google-plus" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-google-plus"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2020/03/31/mysql/MySQL实战45讲/44_Memory存储引擎/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            44 MYSQL Memory 存储引擎
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2020/03/29/mysql/MySQL实战45讲/42_join/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">42 join</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/04/04/mysql/MySQL实战45讲/61_分区表/" class="thumbnail">
    
    
        <span style="background-image:url(/images/mysql/MySQL45讲/split_innodb.jpg)" alt="61 MYSQL 分区表" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/存储/">存储</a></p>
                            <p class="item-title"><a href="/2020/04/04/mysql/MySQL实战45讲/61_分区表/" class="title">61 MYSQL 分区表</a></p>
                            <p class="item-date"><time datetime="2020-04-03T16:00:00.000Z" itemprop="datePublished">2020-04-04</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/04/03/mysql/MySQL实战45讲/52_连接管理/" class="thumbnail">
    
    
        <span style="background-image:url(/images/mysql/MySQL45讲/kill_failure.png)" alt="52 MySQL 连接管理" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/存储/">存储</a></p>
                            <p class="item-title"><a href="/2020/04/03/mysql/MySQL实战45讲/52_连接管理/" class="title">52 MySQL 连接管理</a></p>
                            <p class="item-date"><time datetime="2020-04-02T16:00:00.000Z" itemprop="datePublished">2020-04-03</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/04/02/mysql/MySQL实战45讲/51_grant_privileges/" class="thumbnail">
    
    
        <span style="background-image:url(/images/mysql/MySQL45讲/grant_connect.png)" alt="51 MYSQL flush privileges" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/存储/">存储</a></p>
                            <p class="item-title"><a href="/2020/04/02/mysql/MySQL实战45讲/51_grant_privileges/" class="title">51 MYSQL flush privileges</a></p>
                            <p class="item-date"><time datetime="2020-04-01T16:00:00.000Z" itemprop="datePublished">2020-04-02</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/04/01/mysql/MySQL实战45讲/45_自增主键/" class="thumbnail">
    
    
        <span style="background-image:url(/images/mysql/MySQL45讲/auto_error.jpg)" alt="45 MYSQL 自增主键" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/存储/">存储</a></p>
                            <p class="item-title"><a href="/2020/04/01/mysql/MySQL实战45讲/45_自增主键/" class="title">45 MYSQL 自增主键</a></p>
                            <p class="item-date"><time datetime="2020-03-31T16:00:00.000Z" itemprop="datePublished">2020-04-01</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/03/31/mysql/MySQL实战45讲/44_Memory存储引擎/" class="thumbnail">
    
    
        <span style="background-image:url(/images/mysql/MySQL45讲/innodb_data.jpg)" alt="44 MYSQL Memory 存储引擎" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/存储/">存储</a></p>
                            <p class="item-title"><a href="/2020/03/31/mysql/MySQL实战45讲/44_Memory存储引擎/" class="title">44 MYSQL Memory 存储引擎</a></p>
                            <p class="item-date"><time datetime="2020-03-30T16:00:00.000Z" itemprop="datePublished">2020-03-31</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">56</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储/">存储</a><span class="category-list-count">46</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">141</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">33</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">27</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">48</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">25</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">29</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">27</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">4</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/DNS/">DNS</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8S/">K8S</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LAMP/">LAMP</a><span class="tag-list-count">22</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux基础/">Linux基础</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux开机启动/">Linux开机启动</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux进阶/">Linux进阶</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go语言入门/">go语言入门</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql运维/">mysql运维</a><span class="tag-list-count">37</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell脚本/">shell脚本</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/supervisor/">supervisor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tornado/">tornado</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unittest/">unittest</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wrapt/">wrapt</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/函数装饰器/">函数装饰器</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/单元测试/">单元测试</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据密集型应用/">数据密集型应用</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构与算法/">数据结构与算法</a><span class="tag-list-count">39</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文件共享服务/">文件共享服务</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文本处理/">文本处理</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/磁盘与文件系统/">磁盘与文件系统</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/缓存系统/">缓存系统</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/自动化运维/">自动化运维</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/负载均衡/">负载均衡</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/部署工具/">部署工具</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/防火墙/">防火墙</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高可用/">高可用</a><span class="tag-list-count">3</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/DNS/" style="font-size: 12px;">DNS</a> <a href="/tags/K8S/" style="font-size: 10px;">K8S</a> <a href="/tags/LAMP/" style="font-size: 18px;">LAMP</a> <a href="/tags/Linux基础/" style="font-size: 18.67px;">Linux基础</a> <a href="/tags/Linux开机启动/" style="font-size: 15.33px;">Linux开机启动</a> <a href="/tags/Linux进阶/" style="font-size: 14px;">Linux进阶</a> <a href="/tags/go语言入门/" style="font-size: 15.33px;">go语言入门</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/mysql/" style="font-size: 12.67px;">mysql</a> <a href="/tags/mysql运维/" style="font-size: 19.33px;">mysql运维</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/shell脚本/" style="font-size: 14.67px;">shell脚本</a> <a href="/tags/supervisor/" style="font-size: 10px;">supervisor</a> <a href="/tags/tornado/" style="font-size: 10px;">tornado</a> <a href="/tags/unittest/" style="font-size: 10px;">unittest</a> <a href="/tags/wrapt/" style="font-size: 17.33px;">wrapt</a> <a href="/tags/函数装饰器/" style="font-size: 17.33px;">函数装饰器</a> <a href="/tags/单元测试/" style="font-size: 10px;">单元测试</a> <a href="/tags/数据密集型应用/" style="font-size: 12px;">数据密集型应用</a> <a href="/tags/数据结构与算法/" style="font-size: 20px;">数据结构与算法</a> <a href="/tags/文件共享服务/" style="font-size: 10px;">文件共享服务</a> <a href="/tags/文本处理/" style="font-size: 13.33px;">文本处理</a> <a href="/tags/磁盘与文件系统/" style="font-size: 12.67px;">磁盘与文件系统</a> <a href="/tags/缓存系统/" style="font-size: 13.33px;">缓存系统</a> <a href="/tags/自动化运维/" style="font-size: 16px;">自动化运维</a> <a href="/tags/负载均衡/" style="font-size: 16.67px;">负载均衡</a> <a href="/tags/部署工具/" style="font-size: 10.67px;">部署工具</a> <a href="/tags/防火墙/" style="font-size: 14px;">防火墙</a> <a href="/tags/高可用/" style="font-size: 11.33px;">高可用</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">讨论区</h3>
        <div class="widget">
            <h4> 联系我 <h4>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2020 宋涛</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'http://yoursite.com/2020/03/30/mysql/MySQL实战45讲/43_临时表/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
