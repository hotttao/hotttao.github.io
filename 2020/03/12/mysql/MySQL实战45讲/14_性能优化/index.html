<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    

    
    <title>12 MySQL 问题追踪与性能优化 | 宋涛的博客</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="极客时间,MySQL实战45讲" />
    
    <meta name="description" content="MySQL 中怎么做问题追踪与性能优化">
<meta name="keywords" content="极客时间,MySQL实战45讲">
<meta property="og:type" content="article">
<meta property="og:title" content="12 MySQL 问题追踪与性能优化">
<meta property="og:url" content="http://yoursite.com/2020/03/12/mysql/MySQL实战45讲/14_性能优化/index.html">
<meta property="og:site_name" content="宋涛的博客">
<meta property="og:description" content="MySQL 中怎么做问题追踪与性能优化">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/mysql/MySQL45讲/show_processlist.png">
<meta property="og:updated_time" content="2020-06-26T06:20:02.231Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="12 MySQL 问题追踪与性能优化">
<meta name="twitter:description" content="MySQL 中怎么做问题追踪与性能优化">
<meta name="twitter:image" content="http://yoursite.com/images/mysql/MySQL45讲/show_processlist.png">
    

    
        <link rel="alternate" href="/" title="宋涛的博客" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/3.3.1/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    


</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">漫步在大陆上的海龟</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Go/">Go</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Python/">Python</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/分布式/">分布式</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/存储/">存储</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/运维/">运维</a></li></ul>
                                    
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/存储/">存储</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-mysql/MySQL实战45讲/14_性能优化" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        12 MySQL 问题追踪与性能优化
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2020/03/12/mysql/MySQL实战45讲/14_性能优化/" class="article-date">
            <time datetime="2020-03-11T16:00:00.000Z" itemprop="datePublished">2020-03-12</time>
        </a>
    </div>

		

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/MySQL实战45讲/">MySQL实战45讲<span class="tag-count">29</span></a>, <a class="tag-link" href="/tags/极客时间/">极客时间<span class="tag-count">29</span></a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p>MySQL 中怎么做问题追踪与性能优化</p>
<a id="more"></a>
<h2 id="1-问题排查的工具"><a href="#1-问题排查的工具" class="headerlink" title="1. 问题排查的工具"></a>1. 问题排查的工具</h2><p>mysql 中有以下几种问题排查的工具:</p>
<ol>
<li><code>show processlist</code></li>
<li><code>show engine innodb status</code></li>
<li><code>information_schema.innodb_trx</code></li>
<li><code>show engine innodb status</code></li>
<li><code>optimizer_trace</code></li>
<li>慢查询日志</li>
<li><code>performance_schema 和 sys 系统库</code></li>
</ol>
<h3 id="1-1-试验环境"><a href="#1-1-试验环境" class="headerlink" title="1.1 试验环境"></a>1.1 试验环境</h3><p>接下来我们以下面的实现环境看看，如何使用这些工具排查 MySQL 的性能问题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">mysql&gt; CREATE TABLE `t` (</div><div class="line">  `id` int(11) NOT NULL,</div><div class="line">  `c` int(11) DEFAULT NULL,</div><div class="line">  PRIMARY KEY (`id`)</div><div class="line">) ENGINE=InnoDB;</div><div class="line"></div><div class="line">delimiter ;;</div><div class="line">create procedure idata()</div><div class="line">begin</div><div class="line">  <span class="built_in">declare</span> i int;</div><div class="line">  <span class="built_in">set</span> i=1;</div><div class="line">  <span class="keyword">while</span>(i&lt;=100000) <span class="keyword">do</span></div><div class="line">    insert into t values(i,i);</div><div class="line">    <span class="built_in">set</span> i=i+1;</div><div class="line">  end <span class="keyword">while</span>;</div><div class="line">end;;</div><div class="line">delimiter ;</div><div class="line"></div><div class="line">call idata();</div></pre></td></tr></table></figure>
<h3 id="1-2-Mariadb-的差异"><a href="#1-2-Mariadb-的差异" class="headerlink" title="1.2 Mariadb 的差异"></a>1.2 Mariadb 的差异</h3><p>Mariadb 没有 sys schema 库，mysql sys schema 部分功能通过 information_schema 和 插件提供。下面是二者之间的简单对比:</p>
<table>
<thead>
<tr>
<th style="text-align:left">功能</th>
<th style="text-align:left">MySQL</th>
<th style="text-align:left">Mariadb</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">查看MDL锁</td>
<td style="text-align:left">sys.schema_table_lock_waits</td>
<td style="text-align:left">INSTALL SONAME ‘metadata_lock_info’<br>information_schema.metadata_lock_info</td>
</tr>
<tr>
<td style="text-align:left">查看Innodb行锁</td>
<td style="text-align:left">sys.innodb_lock_waits</td>
<td style="text-align:left">information_schema.innodb_lock_waits<br>INNODB_LOCKS<br>INNODB_TRX</td>
</tr>
<tr>
<td style="text-align:left">会话状态</td>
<td style="text-align:left">performance_schema.session_status</td>
<td style="text-align:left">information_schema.session_status</td>
</tr>
</tbody>
</table>
<h2 id="2-锁等待排查"><a href="#2-锁等待排查" class="headerlink" title="2. 锁等待排查"></a>2. 锁等待排查</h2><p>在表 t 执行 SQL 语句 <code>select * from t where id=1;</code> 如果查询长时间不返回，一般这种情况，大概率是表 t 被锁住了。接下来分析原因的时候，一般都是首先执行一下 show processlist 命令，看看当前语句处于什么状态。然后我们再针对每种状态，去分析它们产生的原因、如何复现，以及如何处理。</p>
<p>出现锁等待有以下几种情况:</p>
<ol>
<li>Waiting for table metadata lock，即 等待 MDL 锁</li>
<li>Waiting for table flush</li>
<li>Innodb 行锁</li>
</ol>
<h3 id="2-1-等待-MDL-锁"><a href="#2-1-等待-MDL-锁" class="headerlink" title="2.1 等待 MDL 锁"></a>2.1 等待 MDL 锁</h3><p>第一种情况如下图所示，查询正在等待 MDL 锁。</p>
<p><img src="/images/mysql/MySQL45讲/show_processlist.png" alt="show_processlist"></p>
<p>这类问题的处理方式，就是找到谁持有 MDL 写锁，然后把它 kill 掉。但是，由于在 show processlist 的结果里面，持有 MDL 写锁线程的 Command 列可能是“Sleep”，导致查找起来很不方便。</p>
<p>通过查询 sys.schema_table_lock_waits 这张表，我们就可以直接找出造成阻塞的 process id，把这个连接用 kill 命令断开即可。</p>
<p><img src="/images/mysql/MySQL45讲/schema_table_lock_waits.png" alt="schema_table_lock_waits"></p>
<p>不过启用 performance_schema 和 sys(mariadb 中为 information_schema) 系统库需要 MySQL 在启动时设置 <code>performance_schema=on</code>，相比于设置为 off 会有 10% 左右的性能损失。</p>
<h4 id="mariadb"><a href="#mariadb" class="headerlink" title="mariadb"></a>mariadb</h4><p>mariadb 没有 sys.schema_table_lock_waits 可以通过 METADATA_LOCK_INFO plugin 来查看MDL 锁的相关信息。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 1. 启用 METADATA_LOCK_INFO plugin</span></div><div class="line"><span class="comment"># 临时</span></div><div class="line">INSTALL SONAME <span class="string">'metadata_lock_info'</span>;</div><div class="line"></div><div class="line"><span class="comment"># 永久</span></div><div class="line">[mariadb]</div><div class="line">...</div><div class="line">plugin_load_add = metadata_lock_info</div><div class="line"></div><div class="line"><span class="comment"># 2. 查看MDL锁</span></div><div class="line">MariaDB [performance_schema]&gt; SELECT * FROM information_schema.metadata_lock_info;</div><div class="line">+-----------+--------------------------+---------------+----------------------+--------------+------------+</div><div class="line">| THREAD_ID | LOCK_MODE                | LOCK_DURATION | LOCK_TYPE            | TABLE_SCHEMA | TABLE_NAME |</div><div class="line">+-----------+--------------------------+---------------+----------------------+--------------+------------+</div><div class="line">|        11 | MDL_BACKUP_DDL           | NULL          | Backup lock          |              |            |</div><div class="line">|        11 | MDL_SHARED_NO_READ_WRITE | NULL          | Table metadata lock  | tsong        | words      |</div><div class="line">|        11 | MDL_INTENTION_EXCLUSIVE  | NULL          | Schema metadata lock | tsong        |            |</div><div class="line">+-----------+--------------------------+---------------+----------------------+--------------+------------+</div><div class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</div><div class="line"></div><div class="line"><span class="comment"># 直接查看被锁住的线程</span></div><div class="line">MariaDB [performance_schema]&gt; SELECT</div><div class="line">    -&gt; CONCAT(<span class="string">'Thread '</span>,P.ID,<span class="string">' executing "'</span>,P.INFO,<span class="string">'" IS LOCKED BY Thread '</span>,</div><div class="line">    -&gt; M.THREAD_ID) WhoLocksWho</div><div class="line">    -&gt; FROM INFORMATION_SCHEMA.PROCESSLIST P,</div><div class="line">    -&gt; INFORMATION_SCHEMA.METADATA_LOCK_INFO M</div><div class="line">    -&gt; WHERE LOCATE(lcase(LOCK_TYPE), lcase(STATE))&gt;0;</div><div class="line">+----------------------------------------------------------------------------------------+</div><div class="line">| WhoLocksWho                                                                            |</div><div class="line">+----------------------------------------------------------------------------------------+</div><div class="line">| Thread 10 executing <span class="string">"select * from words where id=1 for update"</span> IS LOCKED BY Thread 11 |</div><div class="line">+----------------------------------------------------------------------------------------+</div><div class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.002 sec)</div><div class="line"></div><div class="line"><span class="comment"># kill 占用锁的线程</span></div><div class="line">MariaDB [performance_schema]&gt; <span class="built_in">kill</span> 11</div></pre></td></tr></table></figure></p>
<h3 id="2-2-等-flush"><a href="#2-2-等-flush" class="headerlink" title="2.2 等 flush"></a>2.2 等 flush</h3><p>第二种情况如下图所示，查询在等 flush</p>
<p><img src="/images/mysql/MySQL45讲/wait_flush.png" alt="wait_flush"></p>
<p>flush tables 有两种用法:</p>
<ul>
<li>flush tables t with read lock: 只关闭表 t</li>
<li>flush tables with read lock: 关闭 MySQL 里所有打开的表。</li>
<li>正常这两个语句执行起来都很快，除非它们也被别的线程堵住了</li>
</ul>
<p>出现上面 Waiting for table flush 状态情况是：有一个 flush tables 命令被别的语句堵住了，然后它又堵住了我们的 select 语句。</p>
<h3 id="2-3-innodb-行锁"><a href="#2-3-innodb-行锁" class="headerlink" title="2.3 innodb 行锁"></a>2.3 innodb 行锁</h3><p>第三种情况，等待Innodb 行锁的情况如下:</p>
<p><img src="/images/mysql/MySQL45讲/line_lock.png" alt="line_lock"></p>
<p>state 为 statistics 的线程被阻塞。这个问题并不难分析，但问题是怎么查出是谁占着这个写锁。如果你用的是 MySQL 5.7 版本，可以通过 sys.innodb_lock_waits 表查到。</p>
<p><img src="/images/mysql/MySQL45讲/innodb_lock_waits.png" alt="innodb_lock_waits"></p>
<p>可以看到，4 号线程是造成堵塞的罪魁祸首。而干掉这个罪魁祸首的方式，就是 KILL QUERY 4 或 KILL 4。</p>
<ul>
<li>不过，这里不应该显示“KILL QUERY 4”。这个命令表示停止 4 号线程当前正在执行的语句，而这个方法其实是没有用的。因为占有行锁的是 update 语句，这个语句已经是之前执行完成了的，现在执行 KILL QUERY，无法让这个事务去掉 id=1 上的行锁。</li>
<li>实际上，KILL 4 才有效，也就是说直接断开这个连接。这里隐含的一个逻辑就是，连接被断开的时候，会自动回滚这个连接里面正在执行的线程，也就释放了 id=1 上的行锁。</li>
</ul>
<h4 id="mariadb-1"><a href="#mariadb-1" class="headerlink" title="mariadb"></a>mariadb</h4><p>mariadb innodb_lock_waits 表位于 information_schema 中。可以使用下面的方法查看等待 Innodb 行锁的线程。 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 1. 查看事务持有的锁</span></div><div class="line">MariaDB [information_schema]&gt; SELECT l.*, t.*</div><div class="line">    FROM information_schema.INNODB_LOCKS l</div><div class="line">    JOIN information_schema.INNODB_TRX t</div><div class="line">        ON l.lock_trx_id = t.trx_id</div><div class="line">    WHERE trx_state = <span class="string">'LOCK WAIT'</span> \G</div><div class="line"></div><div class="line"><span class="comment"># 2. 查看行锁等待，</span></div><div class="line">MariaDB [information_schema]&gt;  SELECT requesting_trx_id     AS run_trx_id, </div><div class="line">       r.trx_mysql_thread_id AS run_pid, </div><div class="line">       blocking_trx_id, </div><div class="line">       z.trx_mysql_thread_id AS blocking_pid </div><div class="line">FROM   innodb_lock_waits AS l </div><div class="line">       JOIN innodb_trx AS r </div><div class="line">         ON l.requesting_trx_id = r.trx_id </div><div class="line">       JOIN innodb_trx AS z </div><div class="line">         ON l.blocking_trx_id = z.trx_id;</div><div class="line"></div><div class="line">+-----------------+---------+-----------------+--------------+</div><div class="line">| run_trx_id      | run_pid | blocking_trx_id | blocking_pid |</div><div class="line">+-----------------+---------+-----------------+--------------+</div><div class="line">| 422151806689784 |      13 | 21240           |           10 |</div><div class="line">+-----------------+---------+-----------------+--------------+</div><div class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</div></pre></td></tr></table></figure>
<h3 id="2-4-死锁查看"><a href="#2-4-死锁查看" class="headerlink" title="2.4 死锁查看"></a>2.4 死锁查看</h3><p>出现死锁后，执行 show engine innodb status，有一节 LATESTDETECTED DEADLOCK，就是记录的最后一次死锁信息。</p>
<p>并发执行下面两个语句，产生的死锁信息如下图所示:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">select id from t <span class="built_in">where</span> c <span class="keyword">in</span>(5,20,10) lock <span class="keyword">in</span> share mode;</div><div class="line">select id from t <span class="built_in">where</span> c <span class="keyword">in</span>(5,20,10) order by c desc <span class="keyword">for</span> update;</div></pre></td></tr></table></figure></p>
<p><img src="/images/mysql/MySQL45讲/innodb_status.png" alt="innodb_status"></p>
<ol>
<li>这个结果分成三部分：<ul>
<li>(1) TRANSACTION，是第一个事务的信息；</li>
<li>(2) TRANSACTION，是第二个事务的信息；</li>
<li>WE ROLL BACK TRANSACTION (1)，是最终的处理结果，表示回滚了第一个事务。</li>
</ul>
</li>
<li>第一个事务的信息中：<ul>
<li>WAITING FOR THIS LOCK TO BE GRANTED，表示的是这个事务在等待的锁信息；</li>
<li>index c of table <code>test</code>.<code>t</code>，说明在等的是表 t 的索引 c 上面的锁；</li>
<li>lock mode S waiting 表示这个语句要自己加一个读锁，当前的状态是等待中；</li>
<li>Record lock 说明这是一个记录锁；</li>
<li>n_fields 2 表示这个记录是两列，也就是字段 c 和主键字段 id；</li>
<li>0: len 4; hex 0000000a; asc ;; 是第一个字段，也就是 c。值是十六进制 a，也就是 10；</li>
<li>1: len 4; hex 0000000a; asc ;; 是第二个字段，也就是主键 id，值也是 10；</li>
<li>这两行里面的 asc 表示的是，接下来要打印出值里面的“可打印字符”，但 10 不是可打印字符，因此就显示空格。</li>
<li>第一个事务信息就只显示出了等锁的状态，在等待 (c=10,id=10) 这一行的锁。当然你是知道的，既然出现死锁了，就表示这个事务也占有别的锁，但是没有显示出来。别着急，我们从第二个事务的信息中推导出来。</li>
</ul>
</li>
<li><p>第二个事务显示的信息要多一些：</p>
<ul>
<li>“ HOLDS THE LOCK(S)”用来显示这个事务持有哪些锁；</li>
<li>index c of table <code>test</code>.<code>t</code> 表示锁是在表 t 的索引 c 上；</li>
<li>hex 0000000a 和 hex 00000014 表示这个事务持有 c=10 和 c=20 这两个记录锁；</li>
<li>WAITING FOR THIS LOCK TO BE GRANTED，表示在等 (c=5,id=5) 这个记录锁。</li>
</ul>
</li>
<li><p>说明:</p>
<ul>
<li>lock_mode X/S waiting表示next-key lock；</li>
<li>lock_mode X/S locks rec but not gap是只有行锁；</li>
<li>locks gap before rec，就是只有间隙锁；</li>
</ul>
</li>
</ol>
<p>从上面这些信息中，我们就知道：</p>
<ul>
<li>“lock in share mode”的这条语句，持有 c=5 的记录锁，在等 c=10 的锁；</li>
<li>“for update”这个语句，持有 c=20 和 c=10 的记录锁，在等 c=5 的记录锁。</li>
</ul>
<p>因此导致了死锁。这里，我们可以得到两个结论：</p>
<ul>
<li>由于锁是一个个加的，要避免死锁，对同一组资源，要按照尽量相同的顺序访问；</li>
<li>在发生死锁的时刻，for update 这条语句占有的资源更多，回滚成本更大，所以 InnoDB 选择了回滚成本更小的 lock in share mode 语句，来回滚。</li>
</ul>
<h2 id="2-SQL执行追踪"><a href="#2-SQL执行追踪" class="headerlink" title="2. SQL执行追踪"></a>2. SQL执行追踪</h2><p>可以用下面介绍的方法，来确定一个排序语句是否使用了临时文件，以及使用的排序算法。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">/* 打开optimizer_trace，只对本线程有效 */</div><div class="line">SET optimizer_trace=<span class="string">'enabled=on'</span>; </div><div class="line"></div><div class="line">/* @a保存Innodb_rows_read的初始值 */</div><div class="line">select VARIABLE_VALUE into @a from  performance_schema.session_status <span class="built_in">where</span> variable_name = <span class="string">'Innodb_rows_read'</span>;</div><div class="line"></div><div class="line">/* mariadb */</div><div class="line">select VARIABLE_VALUE into @a from  information_schema.session_status <span class="built_in">where</span> variable_name = <span class="string">'Innodb_rows_read'</span>;</div><div class="line"></div><div class="line">/* 执行语句 */</div><div class="line">select city, name,age from t <span class="built_in">where</span> city=<span class="string">'杭州'</span> order by name <span class="built_in">limit</span> 1000; </div><div class="line"></div><div class="line">/* 查看 OPTIMIZER_TRACE 输出 */</div><div class="line">SELECT * FROM `information_schema`.`OPTIMIZER_TRACE`\G</div><div class="line"></div><div class="line">/* @b保存Innodb_rows_read的当前值 */</div><div class="line">select VARIABLE_VALUE into @b from performance_schema.session_status <span class="built_in">where</span> variable_name = <span class="string">'Innodb_rows_read'</span>;</div><div class="line"></div><div class="line">/* 计算Innodb_rows_read差值 */</div><div class="line">select @b-@a;</div></pre></td></tr></table></figure>
<h2 id="3-性能优化"><a href="#3-性能优化" class="headerlink" title="3. 性能优化"></a>3. 性能优化</h2><p>说完了 MySQL 一些常见的问题追踪，接下来，我们来看看一些在业务高峰期拿来”应急”的解决方案，并着重说一说它们可能存在的风险，内容包括:</p>
<ol>
<li>短连接风暴</li>
<li>慢查询性能问题</li>
<li>QPS 突增问题</li>
</ol>
<h2 id="4-短连接风暴"><a href="#4-短连接风暴" class="headerlink" title="4. 短连接风暴"></a>4. 短连接风暴</h2><p>正常的短连接模式就是连接到数据库后，执行很少的 SQL 语句就断开，下次需要的时候再重连。如果使用的是短连接，在业务高峰期的时候，就可能出现连接数突然暴涨的情况。</p>
<p>前面我们说过，MySQL 建立连接的过程，成本是很高的。除了正常的网络连接三次握手外，还需要做登录权限判断和获得这个连接的数据读写权限。在数据库压力比较小的时候，这些额外的成本并不明显。但是，短连接模型存在一个风险，就是一旦数据库处理得慢一些，连接数就会暴涨。</p>
<p>max_connections 参数，用来控制一个 MySQL 实例同时存在的连接数的上限，超过这个值，系统就会拒绝接下来的连接请求，并报错提示“Too many connections”。在机器负载比较高的时候，处理现有请求的时间变长，每个连接保持的时间也更长。这时，再有新建连接的话，就可能会超过 max_connections 的限制。对于被拒绝连接的请求来说，从业务角度看就是数据库不可用。</p>
<p>显然我们不能直接增大 max_connections 的值，让更多的连接都可以进来。因为更多的连接会进一步增大系统负载。，大量的资源耗费在权限验证等逻辑上，结果可能是适得其反，已经连接的线程拿不到 CPU 资源去执行业务的 SQL 请求。</p>
<p>这里还有两种方法，但要注意，这些方法都是有损的:</p>
<ol>
<li>第一种方法：先处理掉那些占着连接但是不工作的线程。</li>
<li>减少连接过程的消耗</li>
</ol>
<h3 id="4-1-先处理掉那些占着连接但是不工作的线程"><a href="#4-1-先处理掉那些占着连接但是不工作的线程" class="headerlink" title="4.1 先处理掉那些占着连接但是不工作的线程"></a>4.1 先处理掉那些占着连接但是不工作的线程</h3><p>对于那些不需要保持的连接，我们可以通过 kill connection 主动踢掉。这个行为跟事先设置 wait_timeout 的效果是一样的。设置 wait_timeout 参数表示的是，一个线程空闲 wait_timeout 这么多秒之后，就会被 MySQL 直接断开连接。</p>
<p>但是需要注意，在 show processlist 的结果里，踢掉显示为 sleep 的线程，可能是有损的。我们来看下面这个例子。</p>
<p><img src="/images/mysql/MySQL45讲/show_processlist_sleep.png" alt="show_processlist_sleep"></p>
<p>session A,B 在show processlist 中都是 Sleep，但按照优先级来说，应该优先断开像 session B 这样的事务外空闲的连接。但是，怎么判断哪些是事务外空闲的呢？可以通过 information_schema 库的 innodb_trx 表。因此，如果是连接数过多，你可以优先断开事务外空闲太久的连接；如果这样还不够，再考虑断开事务内空闲太久的连接。</p>
<p>从服务端断开连接使用的是 kill connection + id 的命令， 一个客户端处于 sleep 状态时，它的连接被服务端主动断开后，这个客户端并不会马上知道。直到客户端在发起下一个请求的时候，才会收到这样的报错“ERROR 2013 (HY000): Lost connection to MySQL server during query”。</p>
<p>从数据库端主动断开连接可能是有损的，尤其是有的应用端收到这个错误后，不重新连接，而是直接用这个已经不能用的句柄重试查询。这会导致从应用端看上去，“MySQL 一直没恢复”。</p>
<h3 id="4-2-减少连接过程的消耗"><a href="#4-2-减少连接过程的消耗" class="headerlink" title="4.2 减少连接过程的消耗"></a>4.2 减少连接过程的消耗</h3><p>有的业务代码会在短时间内先大量申请数据库连接做备用，如果现在数据库确认是被连接行为打挂了，那么一种可能的做法，是让数据库跳过权限验证阶段。但是风险极高，非常不建议。</p>
<p>跳过权限验证的方法是：重启数据库，并使用–skip-grant-tables 参数启动。在 MySQL 8.0 版本里，如果你启用–skip-grant-tables 参数，MySQL 会默认把 –skip-networking 参数打开，表示这时候数据库只能被本地的客户端连接。</p>
<h2 id="5-慢查询性能问题"><a href="#5-慢查询性能问题" class="headerlink" title="5. 慢查询性能问题"></a>5. 慢查询性能问题</h2><p>在 MySQL 中，会引发性能问题的慢查询，大体有以下三种可能：</p>
<ol>
<li>索引没有设计好；</li>
<li>SQL 语句没写好；</li>
<li>MySQL 选错了索引。</li>
</ol>
<h3 id="5-1-索引没设计好"><a href="#5-1-索引没设计好" class="headerlink" title="5.1 索引没设计好"></a>5.1 索引没设计好</h3><p>这种场景一般就是通过紧急创建索引来解决。MySQL 5.6 版本以后，创建索引都支持 Online DDL 了，对于那种高峰期数据库已经被这个语句打挂了的情况，最高效的做法就是直接执行 alter table 语句。</p>
<p>比较理想的是能够在备库先执行。假设你现在的服务是一主一备，主库 A、备库 B，这个方案的大致流程是这样的：</p>
<ol>
<li>在备库 B 上执行 set sql_log_bin=off，也就是不写 binlog，然后执行 alter table 语句加上索引；</li>
<li>执行主备切换；</li>
<li>这时候主库是 B，备库是 A。在 A 上执行 set sql_log_bin=off，然后执行 alter table 语句加上索引。</li>
</ol>
<p>这是一个“古老”的 DDL 方案。平时在做变更的时候，你应该考虑类似 gh-ost 这样的方案，更加稳妥。但是在需要紧急处理时，上面这个方案的效率是最高的。</p>
<h3 id="5-2-语句没写好"><a href="#5-2-语句没写好" class="headerlink" title="5.2 语句没写好"></a>5.2 语句没写好</h3><p>我们可以通过改写 SQL 语句来处理。MySQL 5.7 提供了 query_rewrite 功能，可以把输入的一种语句改写成另外一种模式。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql&gt; insert into query_rewrite.rewrite_rules(pattern, replacement, pattern_database) values (<span class="string">"select * from t where id + 1 = ?"</span>, <span class="string">"select * from t where id = ? - 1"</span>, <span class="string">"db1"</span>);</div><div class="line"></div><div class="line">call query_rewrite.flush_rewrite_rules();</div></pre></td></tr></table></figure>
<p>call query_rewrite.flush_rewrite_rules() 这个存储过程，是让插入的新规则生效。</p>
<h3 id="5-3-选错了索引"><a href="#5-3-选错了索引" class="headerlink" title="5.3 选错了索引"></a>5.3 选错了索引</h3><p>应急方案就是给这个语句加上 force index。同样地，使用查询重写功能，给原来的语句加上 force index，也可以解决这个问题。</p>
<h3 id="5-4-问题总结"><a href="#5-4-问题总结" class="headerlink" title="5.4 问题总结"></a>5.4 问题总结</h3><p>慢查询导致性能问题的三种可能情况，实际上出现最多的是前两种，即：索引没设计好和语句没写好。而这两种情况，恰恰是完全可以避免的。比如，通过下面这个过程，我们就可以预先发现问题。</p>
<ol>
<li>上线前，在测试环境，把慢查询日志（slow log）打开，并且把 long_query_time 设置成 0，确保每个语句都会被记录入慢查询日志；</li>
<li>在测试表里插入模拟线上的数据，做一遍回归测试；</li>
<li>观察慢查询日志里每类语句的输出，特别留意 Rows_examined 字段是否与预期一致。</li>
</ol>
<p>如果新增的 SQL 语句不多，手动跑一下就可以。而如果是新项目的话，或者是修改了原有项目的 表结构设计，全量回归测试都是必要的。这时候，你需要工具帮你检查所有的 SQL 语句的返回结果。比如，你可以使用开源工具 <a href="https://www.percona.com/doc/percona-toolkit/3.0/pt-query-digest.html" target="_blank" rel="external">pt-query-digest</a>。</p>
<h2 id="6-QPS-突增问题"><a href="#6-QPS-突增问题" class="headerlink" title="6. QPS 突增问题"></a>6. QPS 突增问题</h2><p>有时候由于业务突然出现高峰，或者应用程序 bug，导致某个语句的 QPS 突然暴涨，也可能导致 MySQL 压力过大，影响服务。如果是bug 引起的，最理想的情况是让业务把这个功能下掉，服务自然就会恢复。</p>
<p>而下掉一个功能，如果从数据库端处理的话，对应于不同的背景，有不同的方法可用。我这里再和你展开说明一下:</p>
<ol>
<li>一种是由全新业务的 bug 导致的。假设你的 DB 运维是比较规范的，也就是说白名单是一个个加的。这种情况下，如果你能够确定业务方会下掉这个功能，只是时间上没那么快，那么就可以从数据库端直接把白名单去掉。</li>
<li>如果这个新功能使用的是单独的数据库用户，可以用管理员账号把这个用户删掉，然后断开现有连接。这样，这个新功能的连接不成功，由它引发的 QPS 就会变成 0。</li>
<li>如果这个新增的功能跟主体功能是部署在一起的，那么我们只能通过处理语句来限制。这时，我们可以使用上面提到的查询重写功能，把压力最大的 SQL 语句直接重写成”select 1”返回。</li>
</ol>
<p>当然，这个操作的风险很高，需要你特别细致。它可能存在两个副作用：</p>
<ol>
<li>如果别的功能里面也用到了这个 SQL 语句模板，会有误伤；</li>
<li>很多业务并不是靠这一个语句就能完成逻辑的，所以如果单独把这一个语句以 select 1 的结果返回的话，可能会导致后面的业务逻辑一起失败。</li>
</ol>
<p>所以，方案 3 是用于止血的，跟前面提到的去掉权限验证一样，应该是你所有选项里优先级最低的一个方案。</p>
<p>同时你会发现，其实方案 1 和 2 都要依赖于规范的运维体系：虚拟化、白名单机制、业务账号分离。由此可见，更多的准备，往往意味着更稳定的系统。</p>
<p>在实际开发中，我们也要尽量避免一些低效的方法，比如避免大量地使用短连接。同时，如果你做业务开发的话，要知道，连接异常断开是常有的事，你的代码里要有正确地重连并重试的机制。</p>

        </div>
        <!--  -->
        <footer class="article-footer">
            



    <a data-url="http://yoursite.com/2020/03/12/mysql/MySQL实战45讲/14_性能优化/" data-id="ckbvtx2ug00na28u9xp5sb3pf" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>



                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google-plus" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-google-plus"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2020/03/13/mysql/MySQL实战45讲/15_优化器/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            13 MYSQL 索引选择
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2020/03/11/mysql/MySQL实战45讲/13_SQL错误用法/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">11 SQL 一些常见的错误用法</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/06/18/brendangregg/02_perf_example/" class="thumbnail">
    
    
        <span style="background-image:url(/images/linux_pf/perf_tracepoints_1700.png)" alt="2. perf Examples" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/运维/">运维</a></p>
                            <p class="item-title"><a href="/2020/06/18/brendangregg/02_perf_example/" class="title">2. perf Examples</a></p>
                            <p class="item-date"><time datetime="2020-06-17T16:00:00.000Z" itemprop="datePublished">2020-06-18</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/03/29/mysql/MySQL实战45讲/61_分区表/" class="thumbnail">
    
    
        <span style="background-image:url(/images/mysql/MySQL45讲/split_innodb.jpg)" alt="29 MYSQL 分区表" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/存储/">存储</a></p>
                            <p class="item-title"><a href="/2020/03/29/mysql/MySQL实战45讲/61_分区表/" class="title">29 MYSQL 分区表</a></p>
                            <p class="item-date"><time datetime="2020-03-28T16:00:00.000Z" itemprop="datePublished">2020-03-29</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/03/28/mysql/MySQL实战45讲/52_连接管理/" class="thumbnail">
    
    
        <span style="background-image:url(/images/mysql/MySQL45讲/kill_failure.png)" alt="28 MySQL 连接管理" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/存储/">存储</a></p>
                            <p class="item-title"><a href="/2020/03/28/mysql/MySQL实战45讲/52_连接管理/" class="title">28 MySQL 连接管理</a></p>
                            <p class="item-date"><time datetime="2020-03-27T16:00:00.000Z" itemprop="datePublished">2020-03-28</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/03/27/mysql/MySQL实战45讲/51_grant_privileges/" class="thumbnail">
    
    
        <span style="background-image:url(/images/mysql/MySQL45讲/grant_connect.png)" alt="27 MYSQL flush privileges" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/存储/">存储</a></p>
                            <p class="item-title"><a href="/2020/03/27/mysql/MySQL实战45讲/51_grant_privileges/" class="title">27 MYSQL flush privileges</a></p>
                            <p class="item-date"><time datetime="2020-03-26T16:00:00.000Z" itemprop="datePublished">2020-03-27</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/03/26/mysql/MySQL实战45讲/45_自增主键/" class="thumbnail">
    
    
        <span style="background-image:url(/images/mysql/MySQL45讲/auto_error.jpg)" alt="26 MYSQL 自增主键" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/存储/">存储</a></p>
                            <p class="item-title"><a href="/2020/03/26/mysql/MySQL实战45讲/45_自增主键/" class="title">26 MYSQL 自增主键</a></p>
                            <p class="item-date"><time datetime="2020-03-25T16:00:00.000Z" itemprop="datePublished">2020-03-26</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">56</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式/">分布式</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储/">存储</a><span class="category-list-count">43</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">188</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">32</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">31</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">26</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">48</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">31</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">29</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">4</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Brendan-Gregg/">Brendan Gregg</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8S/">K8S</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux性能调优/">Linux性能调优</a><span class="tag-list-count">49</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL实战45讲/">MySQL实战45讲</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go语言入门/">go语言入门</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wrapt/">wrapt</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/入门指南/">入门指南</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据密集型应用/">数据密集型应用</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构与算法/">数据结构与算法</a><span class="tag-list-count">39</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/极客时间/">极客时间</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马哥-Linux/">马哥 Linux</a><span class="tag-list-count">135</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马哥-MySQL-运维/">马哥 MySQL 运维</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高性能的MySQL/">高性能的MySQL</a><span class="tag-list-count">5</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/Brendan-Gregg/" style="font-size: 10px;">Brendan Gregg</a> <a href="/tags/K8S/" style="font-size: 10px;">K8S</a> <a href="/tags/Linux性能调优/" style="font-size: 19.09px;">Linux性能调优</a> <a href="/tags/MySQL实战45讲/" style="font-size: 17.27px;">MySQL实战45讲</a> <a href="/tags/go语言入门/" style="font-size: 15.45px;">go语言入门</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/python/" style="font-size: 11.82px;">python</a> <a href="/tags/wrapt/" style="font-size: 16.36px;">wrapt</a> <a href="/tags/入门指南/" style="font-size: 10.91px;">入门指南</a> <a href="/tags/数据密集型应用/" style="font-size: 12.73px;">数据密集型应用</a> <a href="/tags/数据结构与算法/" style="font-size: 18.18px;">数据结构与算法</a> <a href="/tags/极客时间/" style="font-size: 17.27px;">极客时间</a> <a href="/tags/马哥-Linux/" style="font-size: 20px;">马哥 Linux</a> <a href="/tags/马哥-MySQL-运维/" style="font-size: 14.55px;">马哥 MySQL 运维</a> <a href="/tags/高性能的MySQL/" style="font-size: 13.64px;">高性能的MySQL</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">讨论区</h3>
        <div class="widget">
            <h4> 联系我 <h4>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2020 宋涛</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'http://yoursite.com/2020/03/12/mysql/MySQL实战45讲/14_性能优化/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
