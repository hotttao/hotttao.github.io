<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    

    
    <title>5. redis 拓展篇 | 宋涛的博客</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="Kafka" />
    
    <meta name="description" content="Redis 拓展应用">
<meta name="keywords" content="Kafka">
<meta property="og:type" content="article">
<meta property="og:title" content="5. redis 拓展篇">
<meta property="og:url" content="http://yoursite.com/2020/05/05/redis/05_拓展篇/index.html">
<meta property="og:site_name" content="宋涛的博客">
<meta property="og:description" content="Redis 拓展应用">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/redis/redis_stream.png">
<meta property="og:updated_time" content="2021-03-20T02:55:49.671Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="5. redis 拓展篇">
<meta name="twitter:description" content="Redis 拓展应用">
<meta name="twitter:image" content="http://yoursite.com/images/redis/redis_stream.png">
    

    
        <link rel="alternate" href="/" title="宋涛的博客" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/3.3.1/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    


</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">漫步在大陆上的海龟</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Go/">Go</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Python/">Python</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/分布式/">分布式</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/前端/">前端</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/存储/">存储</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/操作系统/">操作系统</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/运维/">运维</a></li></ul>
                                    
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/存储/">存储</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-redis/05_拓展篇" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        5. redis 拓展篇
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2020/05/05/redis/05_拓展篇/" class="article-date">
            <time datetime="2020-05-04T16:00:00.000Z" itemprop="datePublished">2020-05-05</time>
        </a>
    </div>

		

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Kafka/">Kafka<span class="tag-count">15</span></a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p>Redis 拓展应用</p>
<a id="more"></a>
<h2 id="1-拓展篇概述"><a href="#1-拓展篇概述" class="headerlink" title="1. 拓展篇概述"></a>1. 拓展篇概述</h2><p>拓展篇我们将介绍基于 Redis 的扩展应用</p>
<ul>
<li>Stream 消息流</li>
<li>Info 指令，Redis 的监测</li>
<li>分布式锁的实现</li>
<li>Redis 的惰性删除</li>
<li>Redis 的加密</li>
</ul>
<h2 id="2-消息队列"><a href="#2-消息队列" class="headerlink" title="2. 消息队列"></a>2. 消息队列</h2><p>通过 List 实现的消息队列支持只有一组消费着，没有 ack 保证，不支持多播，消息无法持久化。为了解决这些问题，Redis 陆续引入了不同的消息队列实现。本节我们就来介绍 Redis 中队列实现的多种方式，包括:</p>
<ol>
<li>list 实现的消息队列</li>
<li>zset 实现的延时队列</li>
<li>pubsub 发布订阅</li>
<li>Stream</li>
</ol>
<h3 id="2-1-Redis-List-消息队列"><a href="#2-1-Redis-List-消息队列" class="headerlink" title="2.1 Redis List 消息队列"></a>2.1 Redis List 消息队列</h3><p>最简单的消息队列，通过 list 和 list 操作指令(rpush，lpush，rpop，lpop) 实现。rpop，lpop 在 list 为空时会造成忙等待。Redis 提供了对应的阻塞读版本: blpop，brpop，这两个指令在list 为空时就会阻塞等待。这就是所谓的长轮询优化。</p>
<p>需要注意的是被 block 住的空闲连接可能会被服务器端断开，因此使用 brpop，blpop 时需要捕获连接异常并重试。</p>
<h3 id="2-2-延时队列"><a href="#2-2-延时队列" class="headerlink" title="2.2 延时队列"></a>2.2 延时队列</h3><p>延时队列需要记录消息的到期处理时间，以便及时对消息进行处理。可以通过 zset 来实现延时队列，将消息序列化成一个字符串作为 zset 的 value，到期处理时间作为 score。然后用多个线程轮询 zset 获取到期的任务进行处理。因为使用了多线程，此时需要考虑并发争抢，确保任务不会被多次执行。下面是实现的一个 demon</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">def loop():</div><div class="line">    <span class="keyword">while</span> 1:</div><div class="line">        values = redis.zrangebyscore(<span class="string">"delay-queue"</span>, 0, time.time(), start=0, num=1)</div><div class="line">        <span class="keyword">if</span> not values:</div><div class="line">            time.sleep(1)</div><div class="line">            <span class="built_in">continue</span></div><div class="line">        value = values[0]</div><div class="line">        success = redis.zrem(<span class="string">"delay-queue"</span>, value)</div><div class="line">        <span class="keyword">if</span> success:</div><div class="line">            msg = json.load(value)</div><div class="line">            handle_msg(msg)</div></pre></td></tr></table></figure>
<p>这个示例通过判断 zrem 有没有成功删除消息的方式来判断是否成功抢占任务，来避免多次执行一个任务。那些没有抢到的进程都白取了一次任务，可以考虑使用 lua 脚本来优化这个逻辑，将zrangebyscore 和 zrem 放到服务器端进行原子化操作，这样多个进程抢占任务就不会出现浪费了。</p>
<h3 id="2-2-pubsub-发布-订阅"><a href="#2-2-pubsub-发布-订阅" class="headerlink" title="2.2 pubsub(发布/订阅)"></a>2.2 pubsub(发布/订阅)</h3><p>list 实现的消息队列只支持一组消费者，不支持消息的多播(扇出)。Redis 使用了一个单独的模块来支持多个消费者组，叫做 PubSub。下面是 PubSub 使用的 Python 代码示例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 发布</span></div><div class="line">client = redis.StrictRedis()</div><div class="line">client.publish(<span class="string">"code"</span>, <span class="string">"python"</span>)</div><div class="line"></div><div class="line"><span class="comment"># 订阅-非阻塞</span></div><div class="line">client = redis.StrictRedis()</div><div class="line">p = client.pubsub()</div><div class="line">p.subscribe(<span class="string">"code"</span>)</div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">    msg = p.get_message() <span class="comment"># 非阻塞的</span></div><div class="line"></div><div class="line"><span class="comment"># 订阅-阻塞</span></div><div class="line">client = redis.StrictRedis()</div><div class="line">p = client.pubsub()</div><div class="line">p.subscribe(<span class="string">"code"</span>)</div><div class="line"><span class="keyword">for</span> msg <span class="keyword">in</span> p.listen():  <span class="comment"># 阻塞监听</span></div><div class="line">    print(msg)</div></pre></td></tr></table></figure>
<p>Redis 支持对主题名称使用模糊匹配来订阅多个主题。如果生产者新增了同模式的主题，消费者可以立即收到消息，无须额外的订阅指令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt; psubscribe code*</div></pre></td></tr></table></figure>
<h4 id="pubsub-的缺点"><a href="#pubsub-的缺点" class="headerlink" title="pubsub 的缺点"></a>pubsub 的缺点</h4><p>pubsub 的消息是不会持久化的:</p>
<ol>
<li>如果消息没有对应的消费者，那么消息会被直接丢弃</li>
<li>如果有多个消费者，其中一个消费者中间迭机掉线，等到它从新上线之间的所有消息，对于这个消费者就彻底丢失了</li>
</ol>
<p>所以 Redis 的 pubsub 没有太多合适的适用场景。</p>
<h2 id="2-3-Stream"><a href="#2-3-Stream" class="headerlink" title="2.3 Stream"></a>2.3 Stream</h2><h4 id="Stream-结构"><a href="#Stream-结构" class="headerlink" title="Stream 结构"></a>Stream 结构</h4><p>Stream支持多播的可持久化消息队列。其结构如下图所示:</p>
<p><img src="/images/redis/redis_stream.png" alt="Stream数据结构"></p>
<p>Stream:</p>
<ol>
<li>是一个消息链表，具有唯一的名称(Redis key)，消息是持久化的</li>
<li>每个消息都有唯一的ID</li>
<li>每个 Stream 支持多个消费组</li>
</ol>
<p>消费组:</p>
<ol>
<li>每个消费组会有一个游标 last_delivered_id 表示当前已经消费到哪条消息</li>
<li>每个消费组都有一个 Stream 内唯一名称</li>
<li>通过 xgroup create 创建消费者组，需要指定从哪个消息ID开始消费，这个ID用来初始化 last_delivered_id</li>
<li>同一个消费组支持多个消费者</li>
</ol>
<p>消费者:</p>
<ol>
<li>消费者之间属于竞争关系</li>
<li>每个消费者在组内唯一</li>
<li>消费者内部会有一个状态变量 pending_ids，记录了被客户端读取，但还没有 ack 的消息。</li>
<li>pending_ids 用来确保客户端至少消费了一次消息</li>
<li>pending_id是变量被Redis 称为 PEL</li>
</ol>
<h4 id="Stream-操作"><a href="#Stream-操作" class="headerlink" title="Stream 操作"></a>Stream 操作</h4><p>消息的增删改查指令如下:</p>
<ol>
<li>xadd: 向Stream 追加消息，提供了一个定长参数 maxlen，超过长度的老消息会被彻底删除</li>
<li>xdel: 标记删除</li>
<li>xrange: 按范围获取消息，自动过滤已经删除的消息</li>
<li>xlen: 获取Stream 消息的长度</li>
<li>del: 删除整个 Stream 消息列表中是所有消息</li>
<li>xinfo: 获取 stream 信息</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># * 表示自动生成消息ID</span></div><div class="line">&gt; xadd codehole maxlen 3 * name xiaoshuo</div></pre></td></tr></table></figure>
<p>消费组指令:</p>
<ol>
<li>xgroup read: 创建消费组</li>
<li>xreadgroup: <ul>
<li>消费者组的组内消费</li>
<li>组内消费的消息ID 一般设置为 0-0，表示读取所有 PEL 消息以及自 last_delivered_id 之后的新消息</li>
</ul>
</li>
<li>xack: <ul>
<li>确认消息</li>
<li>Stream 在每个消费者结构中保存了正在处理中的消息ID列表 PEL，如果消费者收到消息，处理完成但是没有回复 ack，PEL就会不断增大，从而占用越来越多的内存，因此消息必须 ack</li>
</ul>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt;  xgroup create codehole cg1 0-0 <span class="comment"># 0-0 用于初始化 last_delivered_id</span></div><div class="line">&gt; xreadgroup GROUP cg2 c1 count 1 stream codehole 0-0 <span class="comment"># 0-0 组内消费的起始 ID</span></div><div class="line">&gt; xack codehole cg1 ID1 ID2</div></pre></td></tr></table></figure>
<h4 id="独立消费者"><a href="#独立消费者" class="headerlink" title="独立消费者"></a>独立消费者</h4><p>使用 xread 可以定义独立消费者，在没有消费组的情况下直接读取Stream 中的消息。独立消费者将Stream 当做消息队列 list 来使用，设置可以在没有消息时阻塞等待。</p>
<p>客户端使用 xread 顺序消费是一定要保存 xread 返回的消息ID，下次调用时需要将此 ID 当做 xread 参数传入以便继续消费后面的消息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 从头部读取消息</span></div><div class="line">&gt; xread count 1 stream code 0-0 </div><div class="line"><span class="comment"># 从尾部读取消息，只接受新消息</span></div><div class="line">&gt; xread count 1 stream code $</div><div class="line"><span class="comment"># 阻塞读取</span></div><div class="line">&gt; xread block 0 count 1 stream code $</div></pre></td></tr></table></figure>
<h4 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h4><p>Redis 不支持消息分区，只能在客户端通过生产和消费多个 Stream 来手动分区。</p>
<p>Kafka 支持 Partition，与 Redis 类似，Kafka 也是通过客户端的 hash 算法来将不同的消息塞入到不同的分区。这个实现方式与 Redis 的生产消费多个 Stream 是类似的。但是显然 kafka 的机制更加完善，因为分区不仅仅是消息的分区分配问题，分区通常都会有多个副本，这就涉及到 leader 副本的选举等一系列问题。</p>
<h2 id="2-Info-指令"><a href="#2-Info-指令" class="headerlink" title="2. Info 指令"></a>2. Info 指令</h2><p>在诊断 Redis 性能问题之前，需要了解 Redis 的运行状态，通过强大的 info 指令，可以查看 Redis 内部一系列的运行参数。info 的输出分为 9 大块:</p>
<ol>
<li>Server: 服务器运行的环境参数</li>
<li>Clients: 客户端相关信息</li>
<li>Memory: 服务器运行内存统计数据</li>
<li>Persistence: 持久化信息</li>
<li>Stats: 通用统计数据</li>
<li>Replication: 主从复制相关信息</li>
<li>CPU: CPU 使用情况</li>
<li>Cluster: 集群信息</li>
<li>KeySpace: 键值对统计数量信息</li>
</ol>
<p>info 可一次获取所有信息，也可分块获取。</p>
<h2 id="3-分布式锁"><a href="#3-分布式锁" class="headerlink" title="3. 分布式锁"></a>3. 分布式锁</h2><h3 id="3-1-Redis-分布式锁的实现"><a href="#3-1-Redis-分布式锁的实现" class="headerlink" title="3.1 Redis 分布式锁的实现"></a>3.1 Redis 分布式锁的实现</h3><p>用 redis 实现的分布式锁有如下几个要点:</p>
<ol>
<li>本质上就是在 redis 占一个”坑”，一般使用 setnx(set if not exists)，抢占成功即加锁成功，用完了在调用 del 指令删除键即释放锁</li>
<li>为了避免因<strong>del 删除指令</strong>未被执行而导致的死锁，需要给锁加一个过期时间</li>
<li>由于 setnx + expire 也不是原子的，因此加锁需要 set 指令的扩展  </li>
<li>如果加锁和释放锁之间的逻辑执行太长，以至于超过锁的超时限制，就很好有可能出现并发问题，因此 Redis 分布式锁不适合较长时间的任务</li>
<li>通过占位实现锁，可能会被未占用锁的进程误删除，稍微安全的做法是，将 set 指令的 value 设置为一个随机数，相当于版本号，释放锁时先验证，然后再删除 key。但是匹配 value 和 删除 key 不是一个原子操作，这里就需要 Lua 脚本处理了，因为 Lua 脚本可以保证连续多个指令的原子性执行(我觉得这里不能说是原子执行，只能说严格串行执行)</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 1. 可能死锁</span></div><div class="line">&gt; setnx lock:codehole <span class="literal">true</span></div><div class="line">&gt; del lock:codehole</div><div class="line"></div><div class="line"><span class="comment"># 2. 异常完全有可能在 setnx 和 expire 之间发生 </span></div><div class="line">&gt; setnx lock:codehole <span class="literal">true</span></div><div class="line">&gt; expire lock:codehole 5</div><div class="line">&gt; del lock:codehole</div><div class="line"></div><div class="line"><span class="comment"># 3. 正确的实现，创建和设置超时是一个原子操作</span></div><div class="line">&gt; <span class="built_in">set</span> lock:codehole <span class="literal">true</span> ex 5 nx</div><div class="line">&gt; del lock:codehole</div></pre></td></tr></table></figure>
<p>Redis 分布式锁如果要支持可重入，需要对客户端的 set 方法进行包装，使用线程的 Threadlocal 变量存储当前持有锁的计数。是否需要可重入依赖于业务逻辑，这里不再详述。</p>
<h4 id="锁冲突的处理"><a href="#锁冲突的处理" class="headerlink" title="锁冲突的处理"></a>锁冲突的处理</h4><p>客户端加锁失败，一般有以下 3 中策略来处理:</p>
<ol>
<li>直接抛出异常: 比较适合客户端直接发送的请求</li>
<li>sleep: 阻塞并重试</li>
<li>延时队列: 将当前冲突的请求放到消息队列中，稍后在重试，比较适合异步消息处理。</li>
</ol>
<h3 id="3-2-Redis-中的乐观锁"><a href="#3-2-Redis-中的乐观锁" class="headerlink" title="3.2 Redis 中的乐观锁"></a>3.2 Redis 中的乐观锁</h3><p>分布式锁是一种悲观锁， Redis 通过另一种机制 watch 提供了乐观锁，使用方式如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; watch books</div><div class="line">&gt; multi</div><div class="line">&gt; incr books</div><div class="line">&gt; <span class="built_in">exec</span></div></pre></td></tr></table></figure>
<ol>
<li>watch 会在事务开始之前监测一个或多个关键变量</li>
<li>事务执行时，即开始顺序执行事务队列中的命令时，Redis 会先检查关键变量自 watch 以来是否被修改，包括当前事务所在的客户端</li>
<li>如果关键变量被修改，exec 指令返回 NULL，表示事务执行失败</li>
<li>否则执行事务</li>
</ol>
<p>注意 watch 之后即便是当前事务所在的客户端对关键变量进行修改(指在 watch 和 multi 之间对关键变量的修改)，事务也会报错，同时Redis 禁止在 multi 和 exec 之间执行 watch 指令。</p>
<h3 id="3-3-分布式锁"><a href="#3-3-分布式锁" class="headerlink" title="3.3 分布式锁"></a>3.3 分布式锁</h3><p>在集群环境下，主从切换可能会导致锁信息的丢失从而出现问题。为了解决这个问题，Redis 使用了 Redlock 算法。</p>
<p>为了使用 Redlock，需要提供多个 Redis 实例，这些实例之间相互独立，没有主从关系。加锁时客户端向过半节点发送set(key, value, nx=True, err=XXX)，只要过半节点 set 成功，加锁成功。释放锁是向所有节点发送 del 指令，不过Redlock 还需要考虑出错重试，时钟漂移等很多细节问题。</p>
<h2 id="4-惰性删除"><a href="#4-惰性删除" class="headerlink" title="4. 惰性删除"></a>4. 惰性删除</h2><h2 id="5-Redis-加密"><a href="#5-Redis-加密" class="headerlink" title="5. Redis 加密"></a>5. Redis 加密</h2><p>Redis 中的安全措施</p>
<h3 id="5-1-指令安全"><a href="#5-1-指令安全" class="headerlink" title="5.1 指令安全"></a>5.1 指令安全</h3><p>Redis 在配置文件中 rename-command 指令，用于将某些危险的指令修改成特别的名称，比如在配置文件的 security 块增加:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">rename-command keys abckeysabc</div><div class="line">rename-command flushall <span class="string">""</span> <span class="comment"># 禁用指令</span></div></pre></td></tr></table></figure>
<h3 id="5-2-端口安全"><a href="#5-2-端口安全" class="headerlink" title="5.2 端口安全"></a>5.2 端口安全</h3><h3 id="5-3-增加密码访问限制"><a href="#5-3-增加密码访问限制" class="headerlink" title="5.3 增加密码访问限制"></a>5.3 增加密码访问限制</h3><h3 id="5-4-Lua-脚本安全"><a href="#5-4-Lua-脚本安全" class="headerlink" title="5.4 Lua 脚本安全"></a>5.4 Lua 脚本安全</h3><p>必须禁止Lua脚本由用户输入(UGC)生成</p>
<h3 id="5-5-使用-spiped-SSL-代理"><a href="#5-5-使用-spiped-SSL-代理" class="headerlink" title="5.5 使用 spiped SSL 代理"></a>5.5 使用 spiped SSL 代理</h3><p>Redis 不支持 SSL 连接，可以用 SSL 代理，官方推荐 spiped。</p>

        </div>
        <!--  -->
        <footer class="article-footer">
            



    <a data-url="http://yoursite.com/2020/05/05/redis/05_拓展篇/" data-id="ckxy3rqk500b68ku9brmjku5k" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>



                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google-plus" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-google-plus"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2020/05/06/redis/06_源码篇/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            6. redis 拓展篇
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2020/05/04/redis/04.集群篇/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">4. redis 集群篇</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/10/17/assembley/link/link_01/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/操作系统/">操作系统</a></p>
                            <p class="item-title"><a href="/2021/10/17/assembley/link/link_01/" class="title">1. 《程序员的自我修养》读书笔记</a></p>
                            <p class="item-date"><time datetime="2021-10-16T16:00:00.000Z" itemprop="datePublished">2021-10-17</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/11/assembley/x86/x86_11/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/task.png)" alt="11. 任务和特权级保护" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/11/assembley/x86/x86_11/" class="title">11. 任务和特权级保护</a></p>
                            <p class="item-date"><time datetime="2021-07-10T16:00:00.000Z" itemprop="datePublished">2021-07-11</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/10/assembley/x86/x86_10/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/memory_asign.png)" alt="10. 程序的动态加载和执行" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/10/assembley/x86/x86_10/" class="title">10. 程序的动态加载和执行</a></p>
                            <p class="item-date"><time datetime="2021-07-09T16:00:00.000Z" itemprop="datePublished">2021-07-10</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/09/assembley/x86/x86_09/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/seg_check.png)" alt="9. 存储器的保护" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/09/assembley/x86/x86_09/" class="title">9. 存储器的保护</a></p>
                            <p class="item-date"><time datetime="2021-07-08T16:00:00.000Z" itemprop="datePublished">2021-07-09</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/08/assembley/x86/x86_08/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/gdt.png)" alt="8. 进入保护模式" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/08/assembley/x86/x86_08/" class="title">8. 进入保护模式</a></p>
                            <p class="item-date"><time datetime="2021-07-07T16:00:00.000Z" itemprop="datePublished">2021-07-08</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">61</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式/">分布式</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储/">存储</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/">操作系统</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">198</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">25</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">32</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">31</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">21</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">26</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">48</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">31</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">29</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">4</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Brendan-Gregg/">Brendan Gregg</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/">ES6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML-CSS/">HTML&CSS</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8S/">K8S</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/">Kafka</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux性能调优/">Linux性能调优</a><span class="tag-list-count">49</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL实战45讲/">MySQL实战45讲</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openstack/">Openstack</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/">React</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/">Vue</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go并发编程/">go并发编程</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go标准库及第三方库/">go标准库及第三方库</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go语言入门/">go语言入门</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wrapt/">wrapt</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/x86-汇编/">x86 汇编</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/入门指南/">入门指南</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/好玩的数据结构与算法/">好玩的数据结构与算法</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据密集型应用/">数据密集型应用</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构与算法/">数据结构与算法</a><span class="tag-list-count">39</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/极客时间/">极客时间</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/程序员的自我修养/">程序员的自我修养</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马哥-Linux/">马哥 Linux</a><span class="tag-list-count">135</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马哥-MySQL-运维/">马哥 MySQL 运维</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高性能的MySQL/">高性能的MySQL</a><span class="tag-list-count">5</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/Brendan-Gregg/" style="font-size: 10px;">Brendan Gregg</a> <a href="/tags/ES6/" style="font-size: 15.63px;">ES6</a> <a href="/tags/HTML-CSS/" style="font-size: 12.5px;">HTML&CSS</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/K8S/" style="font-size: 10px;">K8S</a> <a href="/tags/Kafka/" style="font-size: 16.25px;">Kafka</a> <a href="/tags/Linux性能调优/" style="font-size: 19.38px;">Linux性能调优</a> <a href="/tags/MySQL实战45讲/" style="font-size: 18.13px;">MySQL实战45讲</a> <a href="/tags/Openstack/" style="font-size: 13.75px;">Openstack</a> <a href="/tags/React/" style="font-size: 15.63px;">React</a> <a href="/tags/Vue/" style="font-size: 15.63px;">Vue</a> <a href="/tags/go并发编程/" style="font-size: 17.5px;">go并发编程</a> <a href="/tags/go标准库及第三方库/" style="font-size: 10.63px;">go标准库及第三方库</a> <a href="/tags/go语言入门/" style="font-size: 14.38px;">go语言入门</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/python/" style="font-size: 11.25px;">python</a> <a href="/tags/wrapt/" style="font-size: 16.88px;">wrapt</a> <a href="/tags/x86-汇编/" style="font-size: 14.38px;">x86 汇编</a> <a href="/tags/入门指南/" style="font-size: 16.25px;">入门指南</a> <a href="/tags/好玩的数据结构与算法/" style="font-size: 11.88px;">好玩的数据结构与算法</a> <a href="/tags/数据密集型应用/" style="font-size: 15.63px;">数据密集型应用</a> <a href="/tags/数据结构与算法/" style="font-size: 18.75px;">数据结构与算法</a> <a href="/tags/极客时间/" style="font-size: 18.13px;">极客时间</a> <a href="/tags/程序员的自我修养/" style="font-size: 10px;">程序员的自我修养</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a> <a href="/tags/马哥-Linux/" style="font-size: 20px;">马哥 Linux</a> <a href="/tags/马哥-MySQL-运维/" style="font-size: 13.13px;">马哥 MySQL 运维</a> <a href="/tags/高性能的MySQL/" style="font-size: 11.88px;">高性能的MySQL</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">讨论区</h3>
        <div class="widget">
            <h4> 联系我 <h4>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2022 宋涛</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'http://yoursite.com/2020/05/05/redis/05_拓展篇/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
