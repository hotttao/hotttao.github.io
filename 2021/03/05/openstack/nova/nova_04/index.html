<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    

    
    <title>4. API 接口服务(一)Web 框架 | 宋涛的博客</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="Openstack" />
    
    <meta name="description" content="搞 Openstack 开发的大多数应该都或多或少都熟悉 Python 的 Web 开发。我准备花三节来讲讲 Nova 里面 API 接口服务，分别是:  Nova API 服务的 Web 框架 Nova API 服务的路由管理 Nova 的 API 服务的并发管理 Nova 里的一个请求的处理流程  今天我们就先来讲讲 Nova 里的 Web 框架。">
<meta name="keywords" content="Openstack">
<meta property="og:type" content="article">
<meta property="og:title" content="4. API 接口服务(一)Web 框架">
<meta property="og:url" content="http://yoursite.com/2021/03/05/openstack/nova/nova_04/index.html">
<meta property="og:site_name" content="宋涛的博客">
<meta property="og:description" content="搞 Openstack 开发的大多数应该都或多或少都熟悉 Python 的 Web 开发。我准备花三节来讲讲 Nova 里面 API 接口服务，分别是:  Nova API 服务的 Web 框架 Nova API 服务的路由管理 Nova 的 API 服务的并发管理 Nova 里的一个请求的处理流程  今天我们就先来讲讲 Nova 里的 Web 框架。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/openstack/wsgi.png">
<meta property="og:updated_time" content="2021-06-14T01:31:50.589Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="4. API 接口服务(一)Web 框架">
<meta name="twitter:description" content="搞 Openstack 开发的大多数应该都或多或少都熟悉 Python 的 Web 开发。我准备花三节来讲讲 Nova 里面 API 接口服务，分别是:  Nova API 服务的 Web 框架 Nova API 服务的路由管理 Nova 的 API 服务的并发管理 Nova 里的一个请求的处理流程  今天我们就先来讲讲 Nova 里的 Web 框架。">
<meta name="twitter:image" content="http://yoursite.com/images/openstack/wsgi.png">
    

    
        <link rel="alternate" href="/" title="宋涛的博客" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/3.3.1/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    


</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">漫步在大陆上的海龟</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Go/">Go</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Python/">Python</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/分布式/">分布式</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/前端/">前端</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/存储/">存储</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/操作系统/">操作系统</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/运维/">运维</a></li></ul>
                                    
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/运维/">运维</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-openstack/nova/nova_04" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        4. API 接口服务(一)Web 框架
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2021/03/05/openstack/nova/nova_04/" class="article-date">
            <time datetime="2021-03-04T16:00:00.000Z" itemprop="datePublished">2021-03-05</time>
        </a>
    </div>

		

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Openstack/">Openstack<span class="tag-count">10</span></a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p>搞 Openstack 开发的大多数应该都或多或少都熟悉 Python 的 Web 开发。我准备花三节来讲讲 Nova 里面 API 接口服务，分别是:</p>
<ol>
<li>Nova API 服务的 Web 框架</li>
<li>Nova API 服务的路由管理</li>
<li>Nova 的 API 服务的并发管理</li>
<li>Nova 里的一个请求的处理流程</li>
</ol>
<p>今天我们就先来讲讲 Nova 里的 Web 框架。<br><a id="more"></a></p>
<h2 id="1-WSGI"><a href="#1-WSGI" class="headerlink" title="1. WSGI"></a>1. WSGI</h2><p>熟悉 Web 开发的同学，应该都知道后端 Web 应用分成两个部分:</p>
<ol>
<li>Web 服务器: Nginx 和 Apache，负责 HTTP 协议的解析</li>
<li>Web 开发框架: 以 Python 为例就是 flask、Django，提供动态的网页内容</li>
</ol>
<p>Web 服务如何把解析的 HTTP 请求数据给 Web 框架，以及如何从 Web 框架接受响应内容呢？这就是 WSGI 协议规范所约定的事情。Web服务器网关接口（Python Web Server Gateway Interface，缩写为WSGI）是为Python语言定义的Web服务器和Web应用程序或框架之间的一种简单而通用的接口。</p>
<h3 id="1-1-WSGI-接口"><a href="#1-1-WSGI-接口" class="headerlink" title="1.1. WSGI 接口"></a>1.1. WSGI 接口</h3><p>WSGI 约定的是一个如下的接口:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, environ: dict, start_response: t.Callable)</span> -&gt; t.Any:</span></div><div class="line">        <span class="keyword">return</span> body</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_response</span><span class="params">(status: str, headers: List[Tuple[str, str]], exc_info: Optional[_OptExcInfo])</span> :</span> </div><div class="line">    <span class="keyword">pass</span></div></pre></td></tr></table></figure>
<p>Web 框架是一个可调用对象，其接受两个参数:</p>
<ol>
<li>environ: 字典对象，包含了 http 请求被解析后的所有数据</li>
<li>start_response: 也是一个可调用对象，用于为 http 响应添加状态码和请求头信息</li>
</ol>
<p>Web 框架被调用后，返回值作为 body，连同 start_response 写入的响应状态码和响应头信息返回给 Web 服务器用作 HTTP 请求的响应。</p>
<p>Flask 和 Openstack 里面的 Web 服务本质上都是类似的:</p>
<ol>
<li>Web 服务需要能同时处理多个不同的请求，因此需要解决并发和路由问题</li>
<li>除了基本功能，一个完整的 web 服务还要解决权限控制、流控等管理需求，基本上所有的 Web 都采用了面向切面的编程思想，提供了某种机制，以中间件的方式提供这些功能</li>
</ol>
<p>所有这些 Web 框架中都有如下类似的概念:</p>
<ol>
<li>Application/App: 一个 Web 应用</li>
<li>Router: 路由 </li>
<li>Request/Responce: 请求和响应对象</li>
<li>Resource/Controller: 请求处理函数</li>
<li>Middleware: 中间件</li>
<li>Service: 服务端的并发管理</li>
</ol>
<p>这些概念将是我们接下来阅读源码的切入点。</p>
<h3 id="1-2-Nova-API-中的抽象"><a href="#1-2-Nova-API-中的抽象" class="headerlink" title="1.2 Nova API 中的抽象"></a>1.2 Nova API 中的抽象</h3><p>在 Nova 中上面所说对象的抽象都定义在 <code>nova.api.wsgi</code> 中(如下图4.1 和 图4.2 所示)</p>
<p><img src="/images/openstack/wsgi.png" alt="4.1 Nova API 中的抽象"></p>
<p><img src="/images/openstack/wsgi_detail.png" alt="4.2 Nova API 中的抽象接口"></p>
<p>其中:</p>
<ol>
<li>Request: 请求对象，Nova API 的 Request 依赖 webob 第三方库，这个库也是我们接下来要了解的重点内容。因为 Request 不影响我们对整体框架的理解，我们在后面的请求处理再来详细讲解</li>
<li>Loader: Application 加载器，这个类跟与我们接下来要介绍的 paste.deploy 有关，它定义了如何加载我们的 Application 对象</li>
</ol>
<p>其他几个核心对象的定义如下:</p>
<h4 id="Application"><a href="#Application" class="headerlink" title="Application"></a>Application</h4><p>Application 代表一个 Web 应用，其核心是定义 WSGI 接口的抽象方法 <code>__call__(self, environ, start_response):</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""Base WSGI application wrapper. Subclasses need to implement __call__."""</span></div><div class="line"></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">factory</span><span class="params">(cls, global_config, **local_config)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line"><span class="string">        paste.deploy 约定调用的方法，用来实例化一个 Application 对象</span></div><div class="line"><span class="string">        """</span></div><div class="line">        <span class="keyword">return</span> cls(**local_config)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, environ, start_response)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line"><span class="string">        WSGI 的接口实现</span></div><div class="line"><span class="string">        """</span></div><div class="line">        <span class="keyword">raise</span> NotImplementedError(_(<span class="string">'You must implement __call__'</span>))</div></pre></td></tr></table></figure>
<h4 id="Middleware"><a href="#Middleware" class="headerlink" title="Middleware"></a>Middleware</h4><p>Middleware 中间件，它利用了 Python 中类似装饰器的编程技巧，Middleware 会接收一个 Application<br>对象，并实现 Application 接口，这样就可以在 Application 处理的前后添加额外的功能。详见下面的代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Middleware</span><span class="params">(Application)</span>:</span></div><div class="line"></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">factory</span><span class="params">(cls, global_config, **local_config)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line"><span class="string">        paste.deploy 约定调用的方法，用来实例化一个 Middleware 对象</span></div><div class="line"><span class="string">        """</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_factory</span><span class="params">(app)</span>:</span></div><div class="line">            <span class="keyword">return</span> cls(app, **local_config)</div><div class="line">        <span class="keyword">return</span> _factory</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, application)</span>:</span></div><div class="line">        <span class="comment"># 接收一个 Application 对象</span></div><div class="line">        self.application = application</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, req)</span>:</span></div><div class="line">        <span class="string">"""Called on each request.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        If this returns None, the next application down the stack will be</span></div><div class="line"><span class="string">        executed. If it returns a response then that response will be returned</span></div><div class="line"><span class="string">        and execution will stop here.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        """</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, response)</span>:</span></div><div class="line">        <span class="string">"""Do whatever you'd like to the response."""</span></div><div class="line">        <span class="keyword">return</span> response</div><div class="line"></div><div class="line"><span class="meta">    @webob.dec.wsgify(RequestClass=Request)</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, req)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line"><span class="string">        实现了 WSGI 接口，目的是在调用 self.application 处理请求的前后，调用</span></div><div class="line"><span class="string">        自定义的 self.process_request 和 self.process_response 方法。</span></div><div class="line"><span class="string">        """</span></div><div class="line">        response = self.process_request(req) </div><div class="line">        <span class="keyword">if</span> response:</div><div class="line">            <span class="keyword">return</span> response</div><div class="line">        <span class="comment"># 调用被包装的 application 对象</span></div><div class="line">        response = req.get_response(self.application)</div><div class="line">        <span class="keyword">return</span> self.process_response(response)</div></pre></td></tr></table></figure>
<h4 id="Router"><a href="#Router" class="headerlink" title="Router"></a>Router</h4><p>Router 路由对象，用于路由的管理，借助于 <code>@webob.dec.wsgify</code> 装饰器，Router 也实现了 WSGI 接口，从某种意义上来说 Routes 更像一个直接可用的 Application 对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, mapper)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line"><span class="string">        路由管理器，nova 中的路由管理使用到了第三方库 routers，这是我们接下来学习的一个重点</span></div><div class="line"><span class="string">        """</span></div><div class="line">        self.map = mapper</div><div class="line">        self._router = routes.middleware.RoutesMiddleware(self._dispatch,</div><div class="line">                                                          self.map)</div><div class="line"></div><div class="line"><span class="meta">    @webob.dec.wsgify(RequestClass=Request)</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, req)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line"><span class="string">        @webob.dec.wsgify 再次使得 Router 实现了 WSGI 接口，</span></div><div class="line"><span class="string">        Router 的实例更像是一个完整的 Application</span></div><div class="line"><span class="string">        """</span></div><div class="line">        <span class="keyword">return</span> self._router</div><div class="line"></div><div class="line"><span class="meta">    @staticmethod</span></div><div class="line"><span class="meta">    @webob.dec.wsgify(RequestClass=Request)</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_dispatch</span><span class="params">(req)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line"><span class="string">        路由匹配的核心处理函数，这里返回的 app 就是我们前面调到的 Resource/Controller 对象</span></div><div class="line"><span class="string">        """</span></div><div class="line">        match = req.environ[<span class="string">'wsgiorg.routing_args'</span>][<span class="number">1</span>]</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> match:</div><div class="line">            <span class="keyword">return</span> webob.exc.HTTPNotFound()</div><div class="line">        app = match[<span class="string">'controller'</span>]</div><div class="line">        <span class="keyword">return</span> app</div></pre></td></tr></table></figure>
<p>Application/Middlewar/Router 源码我都添加了注释，这里面有两个值的注意的点:</p>
<ol>
<li>Application/Middlewar 都定义了一个 factory 类方法用于实例化，这是它们与 paste.deploy 的约定，paste.deploy 下一节我们就会介绍</li>
<li>webob.dec.wsgify(RequestClass=Request) 装饰器，它对 WSGI 接口做了转化，它是我们理解 Nova API 的关键点</li>
</ol>
<h3 id="1-3-webob-dec-wsgify"><a href="#1-3-webob-dec-wsgify" class="headerlink" title="1.3 webob.dec.wsgify"></a>1.3 webob.dec.wsgify</h3><p>webob.dec.wsgify 的源码如下(注: wsgify 有很多方法，装饰器功能是我们关注的重点):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">wsgify</span><span class="params">(object)</span>:</span></div><div class="line">    RequestClass = Request</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func=None, RequestClass=None,</span></span></div><div class="line"><span class="function"><span class="params">                 args=<span class="params">()</span>, kwargs=None, middleware_wraps=None)</span>:</span></div><div class="line">        self.func = func</div><div class="line">        <span class="keyword">if</span> (RequestClass <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span></div><div class="line">            <span class="keyword">and</span> RequestClass <span class="keyword">is</span> <span class="keyword">not</span> self.RequestClass):</div><div class="line">            self.RequestClass = RequestClass</div><div class="line">        self.args = tuple(args)</div><div class="line">        <span class="keyword">if</span> kwargs <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            kwargs = &#123;&#125;</div><div class="line">        self.kwargs = kwargs</div><div class="line">        self.middleware_wraps = middleware_wraps</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_prepare_args</span><span class="params">(self, args, kwargs)</span>:</span></div><div class="line">        args = args <span class="keyword">or</span> self.args</div><div class="line">        kwargs = kwargs <span class="keyword">or</span> self.kwargs</div><div class="line">        <span class="keyword">if</span> self.middleware_wraps:</div><div class="line">            args = (self.middleware_wraps,) + args</div><div class="line">        <span class="keyword">return</span> args, kwargs</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clone</span><span class="params">(self, func=None, **kw)</span>:</span></div><div class="line">        <span class="string">"""Creates a copy/clone of this object, but with some</span></div><div class="line"><span class="string">        parameters rebound</span></div><div class="line"><span class="string">        """</span></div><div class="line">        kwargs = &#123;&#125;</div><div class="line">        <span class="keyword">if</span> func <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            kwargs[<span class="string">'func'</span>] = func</div><div class="line">        <span class="keyword">if</span> self.RequestClass <span class="keyword">is</span> <span class="keyword">not</span> self.__class__.RequestClass:</div><div class="line">            kwargs[<span class="string">'RequestClass'</span>] = self.RequestClass</div><div class="line">        <span class="keyword">if</span> self.args:</div><div class="line">            kwargs[<span class="string">'args'</span>] = self.args</div><div class="line">        <span class="keyword">if</span> self.kwargs:</div><div class="line">            kwargs[<span class="string">'kwargs'</span>] = self.kwargs</div><div class="line">        kwargs.update(kw)</div><div class="line">        <span class="keyword">return</span> self.__class__(**kwargs)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call_func</span><span class="params">(self, req, *args, **kwargs)</span>:</span></div><div class="line">        <span class="string">"""Call the wrapped function; override this in a subclass to</span></div><div class="line"><span class="string">        change how the function is called."""</span></div><div class="line">        <span class="keyword">return</span> self.func(req, *args, **kwargs)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, req, *args, **kw)</span>:</span></div><div class="line">        <span class="string">"""Call this as a WSGI application or with a request"""</span></div><div class="line">        func = self.func</div><div class="line">        <span class="keyword">if</span> func <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">if</span> args <span class="keyword">or</span> kw:</div><div class="line">                <span class="keyword">raise</span> TypeError(</div><div class="line">                    <span class="string">"Unbound %s can only be called with the function it "</span></div><div class="line">                    <span class="string">"will wrap"</span> % self.__class__.__name__)</div><div class="line">            <span class="comment"># 1. 实现了一个带参数的装饰器</span></div><div class="line">            func = req</div><div class="line">            <span class="keyword">return</span> self.clone(func)</div><div class="line">        <span class="keyword">if</span> isinstance(req, dict):</div><div class="line">            <span class="comment"># 2. WSGI 接口的参数检查</span></div><div class="line">            <span class="comment"># 这里的 req 对应的即使 WSGI 接口中的 environ 参数</span></div><div class="line">            <span class="keyword">if</span> len(args) != <span class="number">1</span> <span class="keyword">or</span> kw:</div><div class="line">                <span class="comment"># args 里面保存的就是 WSGI 接口的另一个 start_response 参数</span></div><div class="line">                <span class="keyword">raise</span> TypeError(</div><div class="line">                    <span class="string">"Calling %r as a WSGI app with the wrong signature"</span> %</div><div class="line">                    self.func)</div><div class="line">            environ = req</div><div class="line">            start_response = args[<span class="number">0</span>]</div><div class="line"></div><div class="line">            <span class="comment"># 3. 请求对象初始化</span></div><div class="line">            req = self.RequestClass(environ)</div><div class="line">            req.response = req.ResponseClass()</div><div class="line">            </div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                <span class="comment"># 3. 调用被包装函数</span></div><div class="line">                args, kw = self._prepare_args(<span class="keyword">None</span>, <span class="keyword">None</span>)</div><div class="line">                <span class="comment"># resp 是被包装函数返回的结果，根据结果有不同的处理</span></div><div class="line">                resp = self.call_func(req, *args, **kw)</div><div class="line">            <span class="keyword">except</span> HTTPException <span class="keyword">as</span> exc:</div><div class="line">                resp = exc</div><div class="line">            <span class="keyword">if</span> resp <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">                <span class="comment">## <span class="doctag">FIXME:</span> I'm not sure what this should be?</span></div><div class="line">                resp = req.response</div><div class="line">            <span class="keyword">if</span> isinstance(resp, text_type):</div><div class="line">                resp = bytes_(resp, req.charset)</div><div class="line">            <span class="keyword">if</span> isinstance(resp, bytes):</div><div class="line">                body = resp</div><div class="line">                resp = req.response</div><div class="line">                resp.write(body)</div><div class="line">            <span class="comment"># 被包装函数返回了一个新的 Response</span></div><div class="line">            <span class="keyword">if</span> resp <span class="keyword">is</span> <span class="keyword">not</span> req.response:</div><div class="line">                resp = req.response.merge_cookies(resp)</div><div class="line">            <span class="comment"># 4. 所有情况都经过统一处理成 resp 对象，resp 也是实现 WSGI 接口的对象</span></div><div class="line">            <span class="comment"># resp 可以是请求处理的终点，直接向 http 服务器返回响应</span></div><div class="line">            <span class="comment"># 也可以是一个新的 Application 执行新的请求处理逻辑，这就是上面 Middleware 返回 self.router 的逻辑</span></div><div class="line">            <span class="keyword">return</span> resp(environ, start_response)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="comment"># 如果不是 WSGi 的调用，直接调用被装饰函数</span></div><div class="line">            args, kw = self._prepare_args(args, kw)</div><div class="line">            <span class="keyword">return</span> self.call_func(req, *args, **kw)</div></pre></td></tr></table></figure>
<p>webob.dec.wsgify 的实现中掺杂着前面所说的 Request/Response 逻辑，如果你现在就想知道的更细可以先自己追追源码。这里面更重要的是最后 <code>resp(environ, start_response)</code> 的调用逻辑，假如我有三个 Application 对象的实例，它们 WSGI 接口都是通过 webob.dec.wsgify 装饰所实现，并且具有这样的包装关系: <code>app1(app2(app3))</code>，它们就会形成这样的一个调用链: <code>app1.__call__ -&gt; app2.__call__ -&gt; app3.__call__</code>。这就是中间件、路由、Application 对象之间的结合逻辑。</p>
<h2 id="2-paste-deploy"><a href="#2-paste-deploy" class="headerlink" title="2. paste.deploy"></a>2. paste.deploy</h2><p>paste.deploy 用来配置和管理 WSGI 应用，对应到源码就是用来定义如何实例化 Application 对象。Nova 正是使用这个库来对 API 服务进行配置和管理，结合 setuptools 和  paste.deploy 我们就可以找到 Nova API 服务的真正入口，因此我们有必要先对它有一定了解。</p>
<h3 id="2-1-paste-deploy-配置文件"><a href="#2-1-paste-deploy-配置文件" class="headerlink" title="2.1 paste.deploy 配置文件"></a>2.1 paste.deploy 配置文件</h3><p>paste.deploy 的配置文件是形如下面的一个 ini 风格配置文件。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure>
<p>待补充…..</p>
<p>所以像这样使用 paste.deploy 我们就可以得到一个带有中间件功能的 Application 实例。相信到这大家也就明白了中间件跟 Application 之间的关系。</p>
<h3 id="2-2-加载-Application-的-Loader-类"><a href="#2-2-加载-Application-的-Loader-类" class="headerlink" title="2.2 加载 Application 的 Loader 类"></a>2.2 加载 Application 的 Loader 类</h3><p>Nova 为 paste.deploy 解析加载 Application 提供了一个加载器类 Loader，位于 <code>nova.api.wsgi</code>，其源码如下。其核心就是通过 oslo.config 提供的配置文件以及变量查找机制，找到 paste.deploy 配置文件的位置，然后通过传入的 name 查找到对应的 Application 执行初始化并返回。oslo.config 的作用不了解的同学，可以查看前面的章节。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Loader</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""Used to load WSGI applications from paste configurations."""</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, config_path=None)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line"><span class="string">        搜索 paste.deploy 配置文件的位置，加载 Application 对象</span></div><div class="line"><span class="string">        """</span></div><div class="line">        self.config_path = <span class="keyword">None</span></div><div class="line"></div><div class="line">        config_path = config_path <span class="keyword">or</span> CONF.wsgi.api_paste_config</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.isabs(config_path):</div><div class="line">            self.config_path = CONF.find_file(config_path)</div><div class="line">        <span class="keyword">elif</span> os.path.exists(config_path):</div><div class="line">            self.config_path = config_path</div><div class="line"></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.config_path:</div><div class="line">            <span class="keyword">raise</span> exception.ConfigNotFound(path=config_path)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load_app</span><span class="params">(self, name)</span>:</span></div><div class="line">        <span class="string">"""Return the paste URLMap wrapped WSGI application.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        :param name: Name of the application to load.</span></div><div class="line"><span class="string">        :returns: Paste URLMap object wrapping the requested application.</span></div><div class="line"><span class="string">        :raises: `nova.exception.PasteAppNotFound`</span></div><div class="line"><span class="string">        """</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            LOG.debug(<span class="string">"Loading app %(name)s from %(path)s"</span>,</div><div class="line">                      &#123;<span class="string">'name'</span>: name, <span class="string">'path'</span>: self.config_path&#125;)</div><div class="line">            <span class="keyword">return</span> deploy.loadapp(<span class="string">"config:%s"</span> % self.config_path, name=name)</div><div class="line">        <span class="keyword">except</span> LookupError:</div><div class="line">            LOG.exception(<span class="string">"Couldn't lookup app: %s"</span>, name)</div><div class="line">            <span class="keyword">raise</span> exception.PasteAppNotFound(name=name, path=self.config_path)</div></pre></td></tr></table></figure>
<p>CONF.wsgi.api_paste_config 默认值为 api-paste.ini，对应的配置文件预定义在 nova/etc 目录下，nova 包被安装时会默认拷贝到 etc/nova/api-paste.ini，这个目录默认就在 oslo.conf 的搜索条件内。</p>
<h3 id="2-3-Nova-API-服务加载的示例"><a href="#2-3-Nova-API-服务加载的示例" class="headerlink" title="2.3 Nova API 服务加载的示例"></a>2.3 Nova API 服务加载的示例</h3><p>想必到这，你再去看 api-paste.ini 配置文件，自然就能看懂 Nova 都创建了哪些 API 服务，以及他们初始化的位置，我们就以其中的 osapi_compute api 服务为例，看看他是如何进行路由管理的。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="section">[composite:osapi_compute]</span></div><div class="line"><span class="attr">use</span> = call:nova.api.openstack.urlmap:urlmap_factory</div><div class="line">/: oscomputeversions</div><div class="line">/v2: oscomputeversion_legacy_v2</div><div class="line">/v2.1: oscomputeversion_v2</div><div class="line"><span class="comment"># v21 is an exactly feature match for v2, except it has more stringent</span></div><div class="line"><span class="comment"># input validation on the wsgi surface (prevents fuzzing early on the</span></div><div class="line"><span class="comment"># API). It also provides new features via API microversions which are</span></div><div class="line"><span class="comment"># opt into for clients. Unaware clients will receive the same frozen</span></div><div class="line"><span class="comment"># v2 API feature set, but with some relaxed validation</span></div><div class="line">/v2/+: openstack_compute_api_v21_legacy_v2_compatible</div><div class="line">/v2.1/+: openstack_compute_api_v21</div><div class="line"></div><div class="line"><span class="section">[composite:openstack_compute_api_v21]</span></div><div class="line"><span class="attr">use</span> = call:nova.api.auth:pipeline_factory_v21</div><div class="line"><span class="attr">keystone</span> = cors http_proxy_to_wsgi compute_req_id faultwrap request_log sizelimit osprofiler authtoken keystonecontext osapi_compute_app_v21</div><div class="line"><span class="comment"># DEPRECATED: The [api]auth_strategy conf option is deprecated and will be</span></div><div class="line"><span class="comment"># removed in a subsequent release, whereupon this pipeline will be unreachable.</span></div><div class="line"><span class="attr">noauth2</span> = cors http_proxy_to_wsgi compute_req_id faultwrap request_log sizelimit osprofiler noauth2 osapi_compute_app_v21</div><div class="line"></div><div class="line"><span class="section">[app:osapi_compute_app_v21]</span></div><div class="line">paste.app_factory = nova.api.openstack.compute:APIRouterV21.factory</div></pre></td></tr></table></figure>
<p>osapi_compute_app_v21 对应的 Application 的初始化在 <code>nova.api.openstack.compute:APIRouterV21.factory</code>，下面是其核心源码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_create_controller</span><span class="params">(main_controller, action_controller_list)</span>:</span></div><div class="line">    <span class="string">"""This is a helper method to create controller with a</span></div><div class="line"><span class="string">    list of action controller.</span></div><div class="line"><span class="string">    """</span></div><div class="line"></div><div class="line">    controller = wsgi.Resource(main_controller())</div><div class="line">    <span class="keyword">for</span> ctl <span class="keyword">in</span> action_controller_list:</div><div class="line">        controller.register_actions(ctl())</div><div class="line">    <span class="keyword">return</span> controller</div><div class="line"></div><div class="line">flavor_controller = functools.partial(_create_controller,</div><div class="line">    flavors.FlavorsController,</div><div class="line">    [</div><div class="line">        flavor_manage.FlavorManageController,</div><div class="line">        flavor_access.FlavorActionController</div><div class="line">    ]</div><div class="line">)</div><div class="line"></div><div class="line">ROUTE_LIST = (</div><div class="line">    <span class="comment"># <span class="doctag">NOTE:</span> This is a redirection from '' to '/'. The request to the '/v2.1'</span></div><div class="line">    <span class="comment"># or '/2.0' without the ending '/' will get a response with status code</span></div><div class="line">    <span class="comment"># '302' returned.</span></div><div class="line">    (<span class="string">''</span>, <span class="string">'/'</span>),</div><div class="line">    (<span class="string">'/'</span>, &#123;</div><div class="line">        <span class="string">'GET'</span>: [version_controller, <span class="string">'show'</span>]</div><div class="line">    &#125;),</div><div class="line">    (<span class="string">'/flavors'</span>, &#123;</div><div class="line">        <span class="string">'GET'</span>: [flavor_controller, <span class="string">'index'</span>],</div><div class="line">        <span class="string">'POST'</span>: [flavor_controller, <span class="string">'create'</span>]</div><div class="line">    &#125;),</div><div class="line">    (<span class="string">'/flavors/detail'</span>, &#123;</div><div class="line">        <span class="string">'GET'</span>: [flavor_controller, <span class="string">'detail'</span>]</div><div class="line">    &#125;),</div><div class="line">    (<span class="string">'/flavors/&#123;id&#125;'</span>, &#123;</div><div class="line">        <span class="string">'GET'</span>: [flavor_controller, <span class="string">'show'</span>],</div><div class="line">        <span class="string">'PUT'</span>: [flavor_controller, <span class="string">'update'</span>],</div><div class="line">        <span class="string">'DELETE'</span>: [flavor_controller, <span class="string">'delete'</span>]</div><div class="line">    &#125;),</div><div class="line">    (<span class="string">'/flavors/&#123;id&#125;/action'</span>, &#123;</div><div class="line">        <span class="string">'POST'</span>: [flavor_controller, <span class="string">'action'</span>]</div><div class="line">    &#125;),</div><div class="line">)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIRouterV21</span><span class="params">(base_wsgi.Router)</span>:</span></div><div class="line">    <span class="string">"""Routes requests on the OpenStack API to the appropriate controller</span></div><div class="line"><span class="string">    and method. The URL mapping based on the plain list `ROUTE_LIST` is built</span></div><div class="line"><span class="string">    at here.</span></div><div class="line"><span class="string">    """</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, custom_routes=None)</span>:</span></div><div class="line">        <span class="string">""":param custom_routes: the additional routes can be added by this</span></div><div class="line"><span class="string">               parameter. This parameter is used to test on some fake routes</span></div><div class="line"><span class="string">               primarily.</span></div><div class="line"><span class="string">        """</span></div><div class="line">        super(APIRouterV21, self).__init__(nova.api.openstack.ProjectMapper())</div><div class="line"></div><div class="line">        <span class="keyword">if</span> custom_routes <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            custom_routes = tuple()</div><div class="line"></div><div class="line">        <span class="keyword">for</span> path, methods <span class="keyword">in</span> ROUTE_LIST + custom_routes:</div><div class="line">            <span class="comment"># NOTE(alex_xu): The variable 'methods' is a dict in normal, since</span></div><div class="line">            <span class="comment"># the dict includes all the methods supported in the path. But</span></div><div class="line">            <span class="comment"># if the variable 'method' is a string, it means a redirection.</span></div><div class="line">            <span class="comment"># For example, the request to the '' will be redirect to the '/' in</span></div><div class="line">            <span class="comment"># the Nova API. To indicate that, using the target path instead of</span></div><div class="line">            <span class="comment"># a dict. The route entry just writes as "('', '/)".</span></div><div class="line">            <span class="keyword">if</span> isinstance(methods, str):</div><div class="line">                self.map.redirect(path, methods)</div><div class="line">                <span class="keyword">continue</span></div><div class="line"></div><div class="line">            <span class="keyword">for</span> method, controller_info <span class="keyword">in</span> methods.items():</div><div class="line">                <span class="comment"># TODO(alex_xu): In the end, I want to create single controller</span></div><div class="line">                <span class="comment"># instance instead of create controller instance for each</span></div><div class="line">                <span class="comment"># route.</span></div><div class="line">                controller = controller_info[<span class="number">0</span>]()</div><div class="line">                action = controller_info[<span class="number">1</span>]</div><div class="line">                self.map.create_route(path, method, controller, action)</div><div class="line"></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">factory</span><span class="params">(cls, global_config, **local_config)</span>:</span></div><div class="line">        <span class="string">"""Simple paste factory, :class:`nova.wsgi.Router` doesn't have one."""</span></div><div class="line">        <span class="keyword">return</span> cls()</div></pre></td></tr></table></figure>
<p>其中:</p>
<ol>
<li>nova.api.openstack.wsgi.Resource + 各种 Controller 就是我们的请求处理函数</li>
<li>APIRouterV21: 就是我们新定义的路由管理对象，它继承自 <code>nova.api.wsgi.Router</code>，继承关系如图 4.3 所示</li>
</ol>
<p><img src="/images/openstack/routes.png" alt="4.3 路由的继承关系"></p>
<p>APIRouterV21 只是定义了url 与请求处理函数之间的路由关系，因此要想搞明白路由管理，我们还是要回到 nova.api.wsgi.Router 上。</p>
<p>写到这内容已经很多了，API 服务的路由管理，我们放到下一节继续介绍。</p>

        </div>
        <!--  -->
        <footer class="article-footer">
            



    <a data-url="http://yoursite.com/2021/03/05/openstack/nova/nova_04/" data-id="ckvgqi8u500wlh0u9fhqzaqrp" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>



                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google-plus" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-google-plus"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2021/03/07/openstack/nova/nova_06/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            6. API 接口服务(三)并发管理
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2021/03/05/openstack/nova/nova_05/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">5. API 接口服务(二)路由管理</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/10/17/assembley/link/link_01/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/操作系统/">操作系统</a></p>
                            <p class="item-title"><a href="/2021/10/17/assembley/link/link_01/" class="title">1. 《程序员的自我修养》读书笔记</a></p>
                            <p class="item-date"><time datetime="2021-10-16T16:00:00.000Z" itemprop="datePublished">2021-10-17</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/05/assembley/x86/x86_05/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/memery_stack.png)" alt="5. x86 实模式(一)" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/05/assembley/x86/x86_05/" class="title">5. x86 实模式(一)</a></p>
                            <p class="item-date"><time datetime="2021-07-04T16:00:00.000Z" itemprop="datePublished">2021-07-05</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/04/assembley/x86/x86_04/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/video.png)" alt="4. x86 实模式(一)" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/04/assembley/x86/x86_04/" class="title">4. x86 实模式(一)</a></p>
                            <p class="item-date"><time datetime="2021-07-03T16:00:00.000Z" itemprop="datePublished">2021-07-04</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/03/assembley/x86/x86_03/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/cpu_structure.png)" alt="3. x86 汇编环境准备" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/03/assembley/x86/x86_03/" class="title">3. x86 汇编环境准备</a></p>
                            <p class="item-date"><time datetime="2021-07-02T16:00:00.000Z" itemprop="datePublished">2021-07-03</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/02/assembley/x86/x86_02/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/cpu_ram_rom.jpg)" alt="2. 硬件系统的结构" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/02/assembley/x86/x86_02/" class="title">2. 硬件系统的结构</a></p>
                            <p class="item-date"><time datetime="2021-07-01T16:00:00.000Z" itemprop="datePublished">2021-07-02</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">61</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式/">分布式</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储/">存储</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/">操作系统</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">198</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">25</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">32</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">31</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">21</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">26</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">48</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">31</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">29</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">4</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Brendan-Gregg/">Brendan Gregg</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/">ES6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML-CSS/">HTML&CSS</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8S/">K8S</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/">Kafka</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux性能调优/">Linux性能调优</a><span class="tag-list-count">49</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL实战45讲/">MySQL实战45讲</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openstack/">Openstack</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/">React</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/">Vue</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go并发编程/">go并发编程</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go标准库及第三方库/">go标准库及第三方库</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go语言入门/">go语言入门</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wrapt/">wrapt</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/x86-汇编/">x86 汇编</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/入门指南/">入门指南</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/好玩的数据结构与算法/">好玩的数据结构与算法</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据密集型应用/">数据密集型应用</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构与算法/">数据结构与算法</a><span class="tag-list-count">39</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/极客时间/">极客时间</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/程序员的自我修养/">程序员的自我修养</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马哥-Linux/">马哥 Linux</a><span class="tag-list-count">135</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马哥-MySQL-运维/">马哥 MySQL 运维</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高性能的MySQL/">高性能的MySQL</a><span class="tag-list-count">5</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/Brendan-Gregg/" style="font-size: 10px;">Brendan Gregg</a> <a href="/tags/ES6/" style="font-size: 15.63px;">ES6</a> <a href="/tags/HTML-CSS/" style="font-size: 12.5px;">HTML&CSS</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/K8S/" style="font-size: 10px;">K8S</a> <a href="/tags/Kafka/" style="font-size: 16.25px;">Kafka</a> <a href="/tags/Linux性能调优/" style="font-size: 19.38px;">Linux性能调优</a> <a href="/tags/MySQL实战45讲/" style="font-size: 18.13px;">MySQL实战45讲</a> <a href="/tags/Openstack/" style="font-size: 13.75px;">Openstack</a> <a href="/tags/React/" style="font-size: 15.63px;">React</a> <a href="/tags/Vue/" style="font-size: 15.63px;">Vue</a> <a href="/tags/go并发编程/" style="font-size: 17.5px;">go并发编程</a> <a href="/tags/go标准库及第三方库/" style="font-size: 10.63px;">go标准库及第三方库</a> <a href="/tags/go语言入门/" style="font-size: 14.38px;">go语言入门</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/python/" style="font-size: 11.25px;">python</a> <a href="/tags/wrapt/" style="font-size: 16.88px;">wrapt</a> <a href="/tags/x86-汇编/" style="font-size: 11.88px;">x86 汇编</a> <a href="/tags/入门指南/" style="font-size: 16.25px;">入门指南</a> <a href="/tags/好玩的数据结构与算法/" style="font-size: 11.88px;">好玩的数据结构与算法</a> <a href="/tags/数据密集型应用/" style="font-size: 15.63px;">数据密集型应用</a> <a href="/tags/数据结构与算法/" style="font-size: 18.75px;">数据结构与算法</a> <a href="/tags/极客时间/" style="font-size: 18.13px;">极客时间</a> <a href="/tags/程序员的自我修养/" style="font-size: 10px;">程序员的自我修养</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a> <a href="/tags/马哥-Linux/" style="font-size: 20px;">马哥 Linux</a> <a href="/tags/马哥-MySQL-运维/" style="font-size: 13.13px;">马哥 MySQL 运维</a> <a href="/tags/高性能的MySQL/" style="font-size: 11.88px;">高性能的MySQL</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">讨论区</h3>
        <div class="widget">
            <h4> 联系我 <h4>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2021 宋涛</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'http://yoursite.com/2021/03/05/openstack/nova/nova_04/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
