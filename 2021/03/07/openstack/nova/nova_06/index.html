<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    

    
    <title>6. API 接口服务(三)并发管理 | 宋涛的博客</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="Openstack" />
    
    <meta name="description" content="今天我们来介绍 Nova API 服务的第三篇内容: API 服务的并发管理。">
<meta name="keywords" content="Openstack">
<meta property="og:type" content="article">
<meta property="og:title" content="6. API 接口服务(三)并发管理">
<meta property="og:url" content="http://yoursite.com/2021/03/07/openstack/nova/nova_06/index.html">
<meta property="og:site_name" content="宋涛的博客">
<meta property="og:description" content="今天我们来介绍 Nova API 服务的第三篇内容: API 服务的并发管理。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/openstack/api_service.png">
<meta property="og:updated_time" content="2021-06-14T09:13:11.841Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="6. API 接口服务(三)并发管理">
<meta name="twitter:description" content="今天我们来介绍 Nova API 服务的第三篇内容: API 服务的并发管理。">
<meta name="twitter:image" content="http://yoursite.com/images/openstack/api_service.png">
    

    
        <link rel="alternate" href="/" title="宋涛的博客" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/3.3.1/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    


</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">漫步在大陆上的海龟</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Go/">Go</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Python/">Python</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/分布式/">分布式</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/前端/">前端</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/存储/">存储</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/操作系统/">操作系统</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/运维/">运维</a></li></ul>
                                    
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/运维/">运维</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-openstack/nova/nova_06" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        6. API 接口服务(三)并发管理
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2021/03/07/openstack/nova/nova_06/" class="article-date">
            <time datetime="2021-03-06T16:00:00.000Z" itemprop="datePublished">2021-03-07</time>
        </a>
    </div>

		

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Openstack/">Openstack<span class="tag-count">10</span></a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p>今天我们来介绍 Nova API 服务的第三篇内容: API 服务的并发管理。</p>
<a id="more"></a>
<h2 id="1-Nova-API-服务启动"><a href="#1-Nova-API-服务启动" class="headerlink" title="1. Nova API 服务启动"></a>1. Nova API 服务启动</h2><p>从前面介绍的 Python 包管理工具 setuptools，我们知道 nova 所有的服务入口都定义在 nova/setup.cfg 的 console 配置段中:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">console_scripts =</div><div class="line">    nova-api = nova.cmd.api:main</div><div class="line">    nova-api-metadata = nova.cmd.api_metadata:main</div><div class="line">    nova-api-os-compute = nova.cmd.api_os_compute:main</div><div class="line">    nova-compute = nova.cmd.compute:main</div><div class="line">    nova-conductor = nova.cmd.conductor:main</div><div class="line">    nova-manage = nova.cmd.manage:main</div><div class="line">    nova-novncproxy = nova.cmd.novncproxy:main</div><div class="line">    nova-policy = nova.cmd.policy:main</div><div class="line">    nova-rootwrap = oslo_rootwrap.cmd:main</div><div class="line">    nova-rootwrap-daemon = oslo_rootwrap.cmd:daemon</div><div class="line">    nova-scheduler = nova.cmd.scheduler:main</div><div class="line">    nova-serialproxy = nova.cmd.serialproxy:main</div><div class="line">    nova-spicehtml5proxy = nova.cmd.spicehtml5proxy:main</div><div class="line">    nova-status = nova.cmd.status:main</div><div class="line">wsgi_scripts =</div><div class="line">    nova-api-wsgi = nova.api.openstack.compute.wsgi:init_application</div><div class="line">    nova-metadata-wsgi = nova.api.metadata.wsgi:init_application</div></pre></td></tr></table></figure>
<p>其中 <code>nova-api = nova.cmd.api:main</code> 定义的就是 Nova API 服务的入口，源码如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># nova.cmd.api.py</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line"><span class="keyword">from</span> oslo_log <span class="keyword">import</span> log <span class="keyword">as</span> logging</div><div class="line"><span class="keyword">from</span> oslo_reports <span class="keyword">import</span> guru_meditation_report <span class="keyword">as</span> gmr</div><div class="line"><span class="keyword">from</span> oslo_reports <span class="keyword">import</span> opts <span class="keyword">as</span> gmr_opts</div><div class="line"></div><div class="line"><span class="keyword">import</span> nova.conf</div><div class="line"><span class="keyword">from</span> nova.conf <span class="keyword">import</span> remote_debug</div><div class="line"><span class="keyword">from</span> nova <span class="keyword">import</span> config</div><div class="line"><span class="keyword">from</span> nova <span class="keyword">import</span> exception</div><div class="line"><span class="keyword">from</span> nova <span class="keyword">import</span> objects</div><div class="line"><span class="keyword">from</span> nova <span class="keyword">import</span> service</div><div class="line"><span class="keyword">from</span> nova <span class="keyword">import</span> version</div><div class="line"></div><div class="line">CONF = nova.conf.CONF</div><div class="line">remote_debug.register_cli_opts(CONF)     <span class="comment"># 注册服务配置选项</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    config.parse_args(sys.argv)          <span class="comment"># 解析配置文件和命令行参数</span></div><div class="line">    logging.setup(CONF, <span class="string">"nova"</span>)          <span class="comment"># 日志配置</span></div><div class="line">    objects.register_all()               <span class="comment"># 数据库操作对象初始化</span></div><div class="line">    gmr_opts.set_defaults(CONF)          </div><div class="line">    <span class="keyword">if</span> <span class="string">'osapi_compute'</span> <span class="keyword">in</span> CONF.enabled_apis:  <span class="comment"># 服务兼容处理，后面会单独介绍</span></div><div class="line">        <span class="comment"># NOTE(mriedem): This is needed for caching the nova-compute service</span></div><div class="line">        <span class="comment"># version.</span></div><div class="line">        objects.Service.enable_min_version_cache()</div><div class="line">    log = logging.getLogger(__name__)</div><div class="line"></div><div class="line">    gmr.TextGuruMeditation.setup_autorun(version, conf=CONF)</div><div class="line"></div><div class="line">    launcher = service.process_launcher() <span class="comment"># 重点1：API 服务的并发管理</span></div><div class="line">    started = <span class="number">0</span>                       </div><div class="line">    <span class="keyword">for</span> api <span class="keyword">in</span> CONF.enabled_apis:                    </div><div class="line">        should_use_ssl = api <span class="keyword">in</span> CONF.enabled_ssl_apis </div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            server = service.WSGIService(api, use_ssl=should_use_ssl) <span class="comment"># 重点2: Web API 初始化</span></div><div class="line">            launcher.launch_service(server, workers=server.workers <span class="keyword">or</span> <span class="number">1</span>) <span class="comment"># Web 服务启动</span></div><div class="line">            started += <span class="number">1</span></div><div class="line">        <span class="keyword">except</span> exception.PasteAppNotFound <span class="keyword">as</span> ex:</div><div class="line">            log.warning(<span class="string">"%s. ``enabled_apis`` includes bad values. "</span></div><div class="line">                        <span class="string">"Fix to remove this warning."</span>, ex)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> started == <span class="number">0</span>:</div><div class="line">        log.error(<span class="string">'No APIs were started. '</span></div><div class="line">                  <span class="string">'Check the enabled_apis config option.'</span>)</div><div class="line">        sys.exit(<span class="number">1</span>)</div><div class="line"></div><div class="line">    launcher.wait()                                                  <span class="comment"># 服务一致运行直至退出</span></div></pre></td></tr></table></figure>
<p>启动脚本中有两个核心对象:</p>
<ol>
<li>service.process_launcher(): 返回一个 Lancher 对象，用于对服务进行并发管理</li>
<li>nova.service.WSGIService: 包装了一个完整的 Web API 服务，定义了 Web 服务如何启动和停止</li>
</ol>
<p>Lancher 与 WSGIService 的关系可以理解为，Lancher 可以将 WSGIService 中的操作并行化。这两个对象就是我们接下来要讲的并发服务管理的核心。我们先来看看这两个类的继承层次。</p>
<h3 id="1-2-WSGIService-的-UML-类图"><a href="#1-2-WSGIService-的-UML-类图" class="headerlink" title="1.2 WSGIService 的 UML 类图"></a>1.2 WSGIService 的 UML 类图</h3><p>WSGIService 位于 nova.api.service 模块，下面是其 UML 类图。</p>
<p><img src="/images/openstack/api_service.png" alt="6.1 service 的继承关系"></p>
<p>其中:</p>
<ol>
<li>oslo_service.service.ServiceBase 定义了服务的接口</li>
<li>oslo_service.service.Service 是 ServiceBase 的基本实现，里面包含了一个 eventlet 的协程池</li>
<li>nova.service.Service 是 rpc 服务的实现</li>
<li>nova.service.WSGIService 是 web api 服务的实现</li>
</ol>
<h3 id="1-3-Lancher-的-UML-类图"><a href="#1-3-Lancher-的-UML-类图" class="headerlink" title="1.3 Lancher 的 UML 类图"></a>1.3 Lancher 的 UML 类图</h3><p>nova.service.process_launcher 的源码如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> oslo_service <span class="keyword">import</span> service</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_launcher</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> service.ProcessLauncher(CONF, restart_method=<span class="string">'mutate'</span>)</div></pre></td></tr></table></figure>
<p>显然我们要看的是 oslo_service.service.ProcessLauncher 的继承层次。</p>
<p><img src="/images/openstack/api_lancher.png" alt="6.2 Lancher 的继承关系"></p>
<p>乍一看 oslo_service.service 的源码，有很多类，而且貌似没有深关联。让我们细看下去，oslo_service.service 中有一个 lancher 函数，源码如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">launch</span><span class="params">(conf, service, workers=<span class="number">1</span>, restart_method=<span class="string">'reload'</span>)</span>:</span></div><div class="line">    <span class="string">"""使用给定的进程数启动一个服务.</span></div><div class="line"><span class="string">    """</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> workers <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> <span class="keyword">not</span> isinstance(workers, int):</div><div class="line">        <span class="keyword">raise</span> TypeError(_(<span class="string">"Type of workers should be int!"</span>))</div><div class="line"></div><div class="line">    <span class="keyword">if</span> workers <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> workers &lt;= <span class="number">0</span>:</div><div class="line">        <span class="keyword">raise</span> ValueError(_(<span class="string">"Number of workers should be positive!"</span>))</div><div class="line"></div><div class="line">    <span class="keyword">if</span> workers <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> workers == <span class="number">1</span>:</div><div class="line">        launcher = ServiceLauncher(conf, restart_method=restart_method)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        launcher = ProcessLauncher(conf, restart_method=restart_method)</div><div class="line">    launcher.launch_service(service, workers=workers)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> launcher</div></pre></td></tr></table></figure>
<p>可以看到:</p>
<ol>
<li>ServiceLauncher 和 ProcessLauncher 是平级的</li>
<li>ProcessLauncher 用于管理多进程服务</li>
<li>ServiceLauncher 用于管理单进程服务</li>
</ol>
<p>我们再来看 ServiceLauncher 和 ProcessLauncher 的初始化:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Launcher</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""Launch one or more services and wait for them to complete."""</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, conf, restart_method=<span class="string">'reload'</span>)</span>:</span></div><div class="line">        <span class="string">"""Initialize the service launcher.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        :param restart_method: If 'reload', calls reload_config_files on</span></div><div class="line"><span class="string">            SIGHUP. If 'mutate', calls mutate_config_files on SIGHUP. Other</span></div><div class="line"><span class="string">            values produce a ValueError.</span></div><div class="line"><span class="string">        :returns: None</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        """</span></div><div class="line">        self.conf = conf</div><div class="line">        conf.register_opts(_options.service_opts)</div><div class="line">        self.services = Services(restart_method=restart_method)</div><div class="line">        self.backdoor_port = (</div><div class="line">            eventlet_backdoor.initialize_if_enabled(self.conf))</div><div class="line">        self.restart_method = restart_method</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">launch_service</span><span class="params">(self, service, workers=<span class="number">1</span>)</span>:</span></div><div class="line">        <span class="string">"""Load and start the given service.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        :param service: The service you would like to start, must be an</span></div><div class="line"><span class="string">                        instance of :class:`oslo_service.service.ServiceBase`</span></div><div class="line"><span class="string">        :param workers: This param makes this method compatible with</span></div><div class="line"><span class="string">                        ProcessLauncher.launch_service. It must be None, 1 or</span></div><div class="line"><span class="string">                        omitted.</span></div><div class="line"><span class="string">        :returns: None</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        """</span></div><div class="line">        <span class="keyword">if</span> workers <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> workers != <span class="number">1</span>:</div><div class="line">            <span class="keyword">raise</span> ValueError(_(<span class="string">"Launcher asked to start multiple workers"</span>))</div><div class="line">        _check_service_base(service)</div><div class="line">        service.backdoor_port = self.backdoor_port</div><div class="line">        self.services.add(service)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceLauncher</span><span class="params">(Launcher)</span>:</span></div><div class="line">    <span class="string">"""Runs one or more service in a parent process."""</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, conf, restart_method=<span class="string">'reload'</span>)</span>:</span></div><div class="line">        <span class="string">"""Constructor.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        :param conf: an instance of ConfigOpts</span></div><div class="line"><span class="string">        :param restart_method: passed to super</span></div><div class="line"><span class="string">        """</span></div><div class="line">        super(ServiceLauncher, self).__init__(</div><div class="line">            conf, restart_method=restart_method)</div><div class="line">        self.signal_handler = SignalHandler()</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProcessLauncher</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""Launch a service with a given number of workers."""</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, conf, wait_interval=<span class="number">0.01</span>, restart_method=<span class="string">'reload'</span>)</span>:</span></div><div class="line">        <span class="string">"""Constructor.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        :param conf: an instance of ConfigOpts</span></div><div class="line"><span class="string">        :param wait_interval: The interval to sleep for between checks</span></div><div class="line"><span class="string">                              of child process exit.</span></div><div class="line"><span class="string">        :param restart_method: If 'reload', calls reload_config_files on</span></div><div class="line"><span class="string">            SIGHUP. If 'mutate', calls mutate_config_files on SIGHUP. Other</span></div><div class="line"><span class="string">            values produce a ValueError.</span></div><div class="line"><span class="string">        """</span></div><div class="line">        self.conf = conf</div><div class="line">        conf.register_opts(_options.service_opts)</div><div class="line">        self.children = &#123;&#125;</div><div class="line">        self.sigcaught = <span class="keyword">None</span></div><div class="line">        self.running = <span class="keyword">True</span></div><div class="line">        self.wait_interval = wait_interval</div><div class="line">        self.launcher = <span class="keyword">None</span></div><div class="line">        rfd, self.writepipe = os.pipe()</div><div class="line">        self.readpipe = eventlet.greenio.GreenPipe(rfd, <span class="string">'r'</span>)</div><div class="line">        self.signal_handler = SignalHandler()</div><div class="line">        self.handle_signal()</div><div class="line">        self.restart_method = restart_method</div><div class="line">        <span class="keyword">if</span> restart_method <span class="keyword">not</span> <span class="keyword">in</span> _LAUNCHER_RESTART_METHODS:</div><div class="line">            <span class="keyword">raise</span> ValueError(_(<span class="string">"Invalid restart_method: %s"</span>) % restart_method)</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">launch_service</span><span class="params">(self, service, workers=<span class="number">1</span>)</span>:</span></div><div class="line">        <span class="string">"""Launch a service with a given number of workers.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">       :param service: a service to launch, must be an instance of</span></div><div class="line"><span class="string">              :class:`oslo_service.service.ServiceBase`</span></div><div class="line"><span class="string">       :param workers: a number of processes in which a service</span></div><div class="line"><span class="string">              will be running</span></div><div class="line"><span class="string">        """</span></div><div class="line">        _check_service_base(service)</div><div class="line">        wrap = ServiceWrapper(service, workers)</div><div class="line"></div><div class="line">        <span class="comment"># Hide existing objects from the garbage collector, so that most</span></div><div class="line">        <span class="comment"># existing pages will remain in shared memory rather than being</span></div><div class="line">        <span class="comment"># duplicated between subprocesses in the GC mark-and-sweep. (Requires</span></div><div class="line">        <span class="comment"># Python 3.7 or later.)</span></div><div class="line">        <span class="keyword">if</span> hasattr(gc, <span class="string">'freeze'</span>):</div><div class="line">            gc.freeze()</div><div class="line"></div><div class="line">        LOG.info(<span class="string">'Starting %d workers'</span>, wrap.workers)</div><div class="line">        <span class="keyword">while</span> self.running <span class="keyword">and</span> len(wrap.children) &lt; wrap.workers:</div><div class="line">            self._start_child(wrap)</div></pre></td></tr></table></figure>
<p>launch_service 用于向 Lancher 中添加一个应用实例(把继承自 ServiceBase 的类称为应用实例)。从上面的源码我们可以看到(其实还需要你大致看一下 它们的源码，看方法名即可):</p>
<ol>
<li>ServiceLauncher:<ul>
<li>其继承自 Launcher，Launcher 将服务的管理(启、停、重载)委托给了 Services</li>
<li>ServiceLauncher 本身添加了信号处理的代码逻辑</li>
</ul>
</li>
<li>ProcessLauncher <ul>
<li>实现的功能就是 ServiceLauncher + Launcher，只不过是多进程的实现</li>
<li>为了实现对应用实例的多进程管理，ProcessLauncher 使用了 ServiceWrapper 对应用实例做了一层包装，便于管理为应用实例启动的多个进程。</li>
<li>对于应用实例的每个子进程，ProcessLauncher 内部则依旧使用的 Launcher 来对其管理</li>
</ul>
</li>
</ol>
<p>至此我们就搞清楚了，oslo_service.service 中这些对象的关系。下面我们来看看具体的源码，我们从 WSGIService 开始。</p>
<h2 id="2-WSGIService"><a href="#2-WSGIService" class="headerlink" title="2. WSGIService"></a>2. WSGIService</h2><p>WSGIService 继承自 oslo_service.service.Service，下面是它们的源码。这里有一个注意的点是虽然这里有继承关系，但是  WSGIService 并没有调用父类的 <code>__init__</code> 初始化方法，而且 WSGIService 覆盖了所有的其他方法，所以这里似乎继承自 ServiceBase 更加合适。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> oslo_service <span class="keyword">import</span> threadgroup</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Service</span><span class="params">(ServiceBase)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, threads=<span class="number">1000</span>)</span>:</span></div><div class="line">        <span class="comment"># 1. 启动了一个 greenthreads 协程池做并发管理</span></div><div class="line">        self.tg = threadgroup.ThreadGroup(threads)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reset</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Reset a service in case it received a SIGHUP."""</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Start a service."""</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stop</span><span class="params">(self, graceful=False)</span>:</span></div><div class="line">        <span class="string">"""Stop a service.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        :param graceful: indicates whether to wait for all threads to finish</span></div><div class="line"><span class="string">               or terminate them instantly</span></div><div class="line"><span class="string">        """</span></div><div class="line">        self.tg.stop(graceful)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Wait for a service to shut down."""</span></div><div class="line">        self.tg.wait()</div><div class="line"></div><div class="line"><span class="keyword">from</span> nova <span class="keyword">import</span> wsgi</div><div class="line"></div><div class="line"></div><div class="line">SERVICE_MANAGERS = &#123;</div><div class="line">    <span class="string">'nova-compute'</span>: <span class="string">'nova.compute.manager.ComputeManager'</span>,</div><div class="line">    <span class="string">'nova-conductor'</span>: <span class="string">'nova.conductor.manager.ConductorManager'</span>,</div><div class="line">    <span class="string">'nova-scheduler'</span>: <span class="string">'nova.scheduler.manager.SchedulerManager'</span>,</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WSGIService</span><span class="params">(service.Service)</span>:</span></div><div class="line">    <span class="string">"""Provides ability to launch API from a 'paste' configuration."""</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, loader=None, use_ssl=False, max_url_len=None)</span>:</span></div><div class="line">        <span class="string">"""Initialize, but do not start the WSGI server.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        :param name: The name of the WSGI server given to the loader.</span></div><div class="line"><span class="string">        :param loader: Loads the WSGI application using the given name.</span></div><div class="line"><span class="string">        :returns: None</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        """</span></div><div class="line">        self.name = name <span class="comment"># 1. paste.deploy 配置文件中的 Application 名称</span></div><div class="line">        self.binary = <span class="string">'nova-%s'</span> % name <span class="comment"># 服务名称</span></div><div class="line"></div><div class="line">        LOG.warning(<span class="string">'Running %s using eventlet is deprecated. Deploy with '</span></div><div class="line">                    <span class="string">'a WSGI server such as uwsgi or mod_wsgi.'</span>, self.binary)</div><div class="line"></div><div class="line">        self.topic = <span class="keyword">None</span> </div><div class="line">        <span class="comment"># 与 nova api 的下游服务有关，api 服务内没有用</span></div><div class="line">        self.manager = self._get_manager() </div><div class="line">        self.loader = loader <span class="keyword">or</span> api_wsgi.Loader() <span class="comment"># 2. Application 的加载器类</span></div><div class="line">        self.app = self.loader.load_app(name)</div><div class="line">        <span class="comment"># inherit all compute_api worker counts from osapi_compute</span></div><div class="line">        <span class="keyword">if</span> name.startswith(<span class="string">'openstack_compute_api'</span>):</div><div class="line">            wname = <span class="string">'osapi_compute'</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            wname = name</div><div class="line">        <span class="comment"># 3. 获取 API 监听的地址、端口以及进程数</span></div><div class="line">        self.host = getattr(CONF, <span class="string">'%s_listen'</span> % name, <span class="string">"0.0.0.0"</span>)</div><div class="line">        <span class="comment"># 端口为 0 表示使用随机端口</span></div><div class="line">        self.port = getattr(CONF, <span class="string">'%s_listen_port'</span> % name, <span class="number">0</span>)</div><div class="line">        self.workers = (getattr(CONF, <span class="string">'%s_workers'</span> % wname, <span class="keyword">None</span>) <span class="keyword">or</span></div><div class="line">                        processutils.get_worker_count())</div><div class="line">        <span class="keyword">if</span> self.workers <span class="keyword">and</span> self.workers &lt; <span class="number">1</span>:</div><div class="line">            worker_name = <span class="string">'%s_workers'</span> % name</div><div class="line">            msg = (_(<span class="string">"%(worker_name)s value of %(workers)s is invalid, "</span></div><div class="line">                     <span class="string">"must be greater than 0"</span>) %</div><div class="line">                   &#123;<span class="string">'worker_name'</span>: worker_name,</div><div class="line">                    <span class="string">'workers'</span>: str(self.workers)&#125;)</div><div class="line">            <span class="keyword">raise</span> exception.InvalidInput(msg)</div><div class="line">        self.use_ssl = use_ssl</div><div class="line">        <span class="comment"># 4. nova.wsgi.Server 才是真正启动的 API Server</span></div><div class="line">        self.server = wsgi.Server(name,</div><div class="line">                                  self.app,</div><div class="line">                                  host=self.host,</div><div class="line">                                  port=self.port,</div><div class="line">                                  use_ssl=self.use_ssl,</div><div class="line">                                  max_url_len=max_url_len)</div><div class="line">        <span class="comment"># Pull back actual port used</span></div><div class="line">        self.port = self.server.port</div><div class="line">        self.backdoor_port = <span class="keyword">None</span></div><div class="line">        <span class="comment"># 5. 性能调试有关，后面我们详细再说</span></div><div class="line">        setup_profiler(name, self.host)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reset</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""服务重置，重置以下内容:</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        * server greenpool size to default</span></div><div class="line"><span class="string">        * service version cache</span></div><div class="line"><span class="string">        * cell cache holding database transaction context managers</span></div><div class="line"><span class="string">        存储数据库事务上下文管理器的单元缓存</span></div><div class="line"><span class="string">        """</span></div><div class="line">        self.server.reset()</div><div class="line">        service_obj.Service.clear_min_version_cache()</div><div class="line">        context.CELL_CACHE = &#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_manager</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line"><span class="string">        初始化与此服务相关的 Manager 对象，Manager 对象是真正的功能实现类</span></div><div class="line"><span class="string">        """</span></div><div class="line">        manager = SERVICE_MANAGERS.get(self.binary)</div><div class="line">        <span class="keyword">if</span> manager <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line">        manager_class = importutils.import_class(manager)</div><div class="line">        <span class="keyword">return</span> manager_class()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line"><span class="string">        服务启动，0 号端口对应为随机端口</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        </span></div><div class="line"><span class="string">        """</span></div><div class="line">        <span class="comment"># 清除保存数据库事务上下文管理器对象的单元格缓存。</span></div><div class="line">        <span class="comment"># 我们这样做是为了确保我们创建了新的内部oslo.db锁，以避免子进程在被分叉时收到一个已经被锁定的oslo.db锁的情况。</span></div><div class="line">        <span class="comment"># 当一个子进程继承了一个锁定的oslo.db锁时，通过事务上下文管理器访问数据库将永远无法获得锁，请求将会失败，并出现CellTimeout错误。</span></div><div class="line">        <span class="comment"># 更多信息请参见https://bugs.python.org/issue6721。</span></div><div class="line">        <span class="comment"># 在python 3.7中，oslo.db可以使用os.register_at_fork()方法重新初始化它的锁。</span></div><div class="line">        <span class="comment"># 在我们需要python 3.7作为最小版本之前，我们必须在oslo.db之外处理这种情况。</span></div><div class="line">        context.CELL_CACHE = &#123;&#125;</div><div class="line"></div><div class="line">        ctxt = context.get_admin_context()</div><div class="line">        <span class="comment"># 1. 将启动的服务更新到数据库中，便于其他服务发现启动的 API 服务</span></div><div class="line">        service_ref = objects.Service.get_by_host_and_binary(ctxt, self.host,</div><div class="line">                                                             self.binary)</div><div class="line">        <span class="keyword">if</span> service_ref:</div><div class="line">            _update_service_ref(service_ref)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                service_ref = _create_service_ref(self, ctxt)</div><div class="line">            <span class="keyword">except</span> (exception.ServiceTopicExists,</div><div class="line">                    exception.ServiceBinaryExists):</div><div class="line">                <span class="comment"># NOTE(danms): If we race to create a record wth a sibling,</span></div><div class="line">                <span class="comment"># don't fail here.</span></div><div class="line">                service_ref = objects.Service.get_by_host_and_binary(</div><div class="line">                    ctxt, self.host, self.binary)</div><div class="line"></div><div class="line">        <span class="keyword">if</span> self.manager:</div><div class="line">            self.manager.init_host()</div><div class="line">            self.manager.pre_start_hook()</div><div class="line">            <span class="keyword">if</span> self.backdoor_port <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">                self.manager.backdoor_port = self.backdoor_port</div><div class="line">        <span class="comment"># 2. 真正启动服务</span></div><div class="line">        self.server.start()</div><div class="line">        <span class="keyword">if</span> self.manager:</div><div class="line">            self.manager.post_start_hook()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stop</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Stop serving this API.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        :returns: None</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        """</span></div><div class="line">        self.server.stop()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Wait for the service to stop serving this API.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        :returns: None</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        """</span></div><div class="line">        self.server.wait()</div></pre></td></tr></table></figure>
<p>从源码可以看到 WSGIService 将 API 服务的管理委托了同样继承自 oslo.service.ServiceBase 的 nova.wsgi.Server。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os.path</div><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">import</span> ssl</div><div class="line"></div><div class="line"><span class="keyword">import</span> eventlet</div><div class="line"><span class="keyword">import</span> eventlet.wsgi</div><div class="line"><span class="keyword">import</span> greenlet</div><div class="line"><span class="keyword">from</span> oslo_log <span class="keyword">import</span> log <span class="keyword">as</span> logging</div><div class="line"><span class="keyword">from</span> oslo_service <span class="keyword">import</span> service</div><div class="line"><span class="keyword">from</span> oslo_utils <span class="keyword">import</span> excutils</div><div class="line"></div><div class="line"><span class="keyword">import</span> nova.conf</div><div class="line"><span class="keyword">from</span> nova <span class="keyword">import</span> exception</div><div class="line"><span class="keyword">from</span> nova.i18n <span class="keyword">import</span> _</div><div class="line"><span class="keyword">from</span> nova <span class="keyword">import</span> utils</div><div class="line"></div><div class="line">CONF = nova.conf.CONF</div><div class="line"></div><div class="line">LOG = logging.getLogger(__name__)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span><span class="params">(service.ServiceBase)</span>:</span></div><div class="line">    <span class="string">"""Server class to manage a WSGI server, serving a WSGI application."""</span></div><div class="line"></div><div class="line">    default_pool_size = CONF.wsgi.default_pool_size</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, app, host=<span class="string">'0.0.0.0'</span>, port=<span class="number">0</span>, pool_size=None,</span></span></div><div class="line"><span class="function"><span class="params">                       protocol=eventlet.wsgi.HttpProtocol, backlog=<span class="number">128</span>,</span></span></div><div class="line"><span class="function"><span class="params">                       use_ssl=False, max_url_len=None)</span>:</span></div><div class="line">        <span class="string">"""Initialize, but do not start, a WSGI server.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        :param name: Pretty name for logging.</span></div><div class="line"><span class="string">        :param app: The WSGI application to serve.</span></div><div class="line"><span class="string">        :param host: IP address to serve the application.</span></div><div class="line"><span class="string">        :param port: Port number to server the application.</span></div><div class="line"><span class="string">        :param pool_size: Maximum number of eventlets to spawn concurrently.</span></div><div class="line"><span class="string">        :param backlog: Maximum number of queued connections.</span></div><div class="line"><span class="string">        :param max_url_len: Maximum length of permitted URLs.</span></div><div class="line"><span class="string">        :returns: None</span></div><div class="line"><span class="string">        :raises: nova.exception.InvalidInput</span></div><div class="line"><span class="string">        """</span></div><div class="line">        <span class="comment"># Allow operators to customize http requests max header line size.</span></div><div class="line">        eventlet.wsgi.MAX_HEADER_LINE = CONF.wsgi.max_header_line</div><div class="line">        self.name = name</div><div class="line">        self.app = app</div><div class="line">        self._server = <span class="keyword">None</span></div><div class="line">        self._protocol = protocol</div><div class="line">        self.pool_size = pool_size <span class="keyword">or</span> self.default_pool_size</div><div class="line">        <span class="comment"># 1. </span></div><div class="line">        self._pool = eventlet.GreenPool(self.pool_size)</div><div class="line">        self._logger = logging.getLogger(<span class="string">"nova.%s.wsgi.server"</span> % self.name)</div><div class="line">        self._use_ssl = use_ssl</div><div class="line">        self._max_url_len = max_url_len</div><div class="line">        self.client_socket_timeout = CONF.wsgi.client_socket_timeout <span class="keyword">or</span> <span class="keyword">None</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> backlog &lt; <span class="number">1</span>:</div><div class="line">            <span class="keyword">raise</span> exception.InvalidInput(</div><div class="line">                    reason=_(<span class="string">'The backlog must be more than 0'</span>))</div><div class="line"></div><div class="line">        bind_addr = (host, port)</div><div class="line">        <span class="comment"># TODO(dims): eventlet's green dns/socket module does not actually</span></div><div class="line">        <span class="comment"># support IPv6 in getaddrinfo(). We need to get around this in the</span></div><div class="line">        <span class="comment"># future or monitor upstream for a fix</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            info = socket.getaddrinfo(bind_addr[<span class="number">0</span>],</div><div class="line">                                      bind_addr[<span class="number">1</span>],</div><div class="line">                                      socket.AF_UNSPEC,</div><div class="line">                                      socket.SOCK_STREAM)[<span class="number">0</span>]</div><div class="line">            family = info[<span class="number">0</span>]</div><div class="line">            bind_addr = info[<span class="number">-1</span>]</div><div class="line">        <span class="keyword">except</span> Exception:</div><div class="line">            family = socket.AF_INET</div><div class="line"></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            self._socket = eventlet.listen(bind_addr, family, backlog=backlog)</div><div class="line">        <span class="keyword">except</span> EnvironmentError:</div><div class="line">            LOG.error(<span class="string">"Could not bind to %(host)s:%(port)s"</span>,</div><div class="line">                      &#123;<span class="string">'host'</span>: host, <span class="string">'port'</span>: port&#125;)</div><div class="line">            <span class="keyword">raise</span></div><div class="line"></div><div class="line">        (self.host, self.port) = self._socket.getsockname()[<span class="number">0</span>:<span class="number">2</span>]</div><div class="line">        LOG.info(<span class="string">"%(name)s listening on %(host)s:%(port)s"</span>,</div><div class="line">                 &#123;<span class="string">'name'</span>: self.name, <span class="string">'host'</span>: self.host, <span class="string">'port'</span>: self.port&#125;)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Start serving a WSGI application.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        :returns: None</span></div><div class="line"><span class="string">        """</span></div><div class="line">        <span class="comment"># The server socket object will be closed after server exits,</span></div><div class="line">        <span class="comment"># but the underlying file descriptor will remain open, and will</span></div><div class="line">        <span class="comment"># give bad file descriptor error. So duplicating the socket object,</span></div><div class="line">        <span class="comment"># to keep file descriptor usable.</span></div><div class="line"></div><div class="line">        dup_socket = self._socket.dup()</div><div class="line">        dup_socket.setsockopt(socket.SOL_SOCKET,</div><div class="line">                              socket.SO_REUSEADDR, <span class="number">1</span>)</div><div class="line">        <span class="comment"># sockets can hang around forever without keepalive</span></div><div class="line">        dup_socket.setsockopt(socket.SOL_SOCKET,</div><div class="line">                              socket.SO_KEEPALIVE, <span class="number">1</span>)</div><div class="line"></div><div class="line">        <span class="comment"># This option isn't available in the OS X version of eventlet</span></div><div class="line">        <span class="keyword">if</span> hasattr(socket, <span class="string">'TCP_KEEPIDLE'</span>):</div><div class="line">            dup_socket.setsockopt(socket.IPPROTO_TCP,</div><div class="line">                                  socket.TCP_KEEPIDLE,</div><div class="line">                                  CONF.wsgi.tcp_keepidle)</div><div class="line"></div><div class="line">        <span class="keyword">if</span> self._use_ssl:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                ca_file = CONF.wsgi.ssl_ca_file</div><div class="line">                cert_file = CONF.wsgi.ssl_cert_file</div><div class="line">                key_file = CONF.wsgi.ssl_key_file</div><div class="line"></div><div class="line">                <span class="keyword">if</span> cert_file <span class="keyword">and</span> <span class="keyword">not</span> os.path.exists(cert_file):</div><div class="line">                    <span class="keyword">raise</span> RuntimeError(</div><div class="line">                          _(<span class="string">"Unable to find cert_file : %s"</span>) % cert_file)</div><div class="line"></div><div class="line">                <span class="keyword">if</span> ca_file <span class="keyword">and</span> <span class="keyword">not</span> os.path.exists(ca_file):</div><div class="line">                    <span class="keyword">raise</span> RuntimeError(</div><div class="line">                          _(<span class="string">"Unable to find ca_file : %s"</span>) % ca_file)</div><div class="line"></div><div class="line">                <span class="keyword">if</span> key_file <span class="keyword">and</span> <span class="keyword">not</span> os.path.exists(key_file):</div><div class="line">                    <span class="keyword">raise</span> RuntimeError(</div><div class="line">                          _(<span class="string">"Unable to find key_file : %s"</span>) % key_file)</div><div class="line"></div><div class="line">                <span class="keyword">if</span> self._use_ssl <span class="keyword">and</span> (<span class="keyword">not</span> cert_file <span class="keyword">or</span> <span class="keyword">not</span> key_file):</div><div class="line">                    <span class="keyword">raise</span> RuntimeError(</div><div class="line">                          _(<span class="string">"When running server in SSL mode, you must "</span></div><div class="line">                            <span class="string">"specify both a cert_file and key_file "</span></div><div class="line">                            <span class="string">"option value in your configuration file"</span>))</div><div class="line">                ssl_kwargs = &#123;</div><div class="line">                    <span class="string">'server_side'</span>: <span class="keyword">True</span>,</div><div class="line">                    <span class="string">'certfile'</span>: cert_file,</div><div class="line">                    <span class="string">'keyfile'</span>: key_file,</div><div class="line">                    <span class="string">'cert_reqs'</span>: ssl.CERT_NONE,</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> CONF.wsgi.ssl_ca_file:</div><div class="line">                    ssl_kwargs[<span class="string">'ca_certs'</span>] = ca_file</div><div class="line">                    ssl_kwargs[<span class="string">'cert_reqs'</span>] = ssl.CERT_REQUIRED</div><div class="line"></div><div class="line">                dup_socket = eventlet.wrap_ssl(dup_socket,</div><div class="line">                                               **ssl_kwargs)</div><div class="line">            <span class="keyword">except</span> Exception:</div><div class="line">                <span class="keyword">with</span> excutils.save_and_reraise_exception():</div><div class="line">                    LOG.error(</div><div class="line">                        <span class="string">"Failed to start %(name)s on %(host)s:%(port)s with "</span></div><div class="line">                        <span class="string">"SSL support"</span>,</div><div class="line">                        &#123;<span class="string">'name'</span>: self.name, <span class="string">'host'</span>: self.host,</div><div class="line">                         <span class="string">'port'</span>: self.port&#125;)</div><div class="line"></div><div class="line">        wsgi_kwargs = &#123;</div><div class="line">            <span class="string">'func'</span>: eventlet.wsgi.server,</div><div class="line">            <span class="string">'sock'</span>: dup_socket,</div><div class="line">            <span class="string">'site'</span>: self.app,</div><div class="line">            <span class="string">'protocol'</span>: self._protocol,</div><div class="line">            <span class="string">'custom_pool'</span>: self._pool,</div><div class="line">            <span class="string">'log'</span>: self._logger,</div><div class="line">            <span class="string">'log_format'</span>: CONF.wsgi.wsgi_log_format,</div><div class="line">            <span class="string">'debug'</span>: <span class="keyword">False</span>,</div><div class="line">            <span class="string">'keepalive'</span>: CONF.wsgi.keep_alive,</div><div class="line">            <span class="string">'socket_timeout'</span>: self.client_socket_timeout</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> self._max_url_len:</div><div class="line">            wsgi_kwargs[<span class="string">'url_length_limit'</span>] = self._max_url_len</div><div class="line"></div><div class="line">        self._server = utils.spawn(**wsgi_kwargs)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reset</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Reset server greenpool size to default.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        :returns: None</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        """</span></div><div class="line">        self._pool.resize(self.pool_size)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stop</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Stop this server.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        This is not a very nice action, as currently the method by which a</span></div><div class="line"><span class="string">        server is stopped is by killing its eventlet.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        :returns: None</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        """</span></div><div class="line">        LOG.info(<span class="string">"Stopping WSGI server."</span>)</div><div class="line"></div><div class="line">        <span class="keyword">if</span> self._server <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            <span class="comment"># Resize pool to stop new requests from being processed</span></div><div class="line">            self._pool.resize(<span class="number">0</span>)</div><div class="line">            self._server.kill()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Block, until the server has stopped.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        Waits on the server's eventlet to finish, then returns.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        :returns: None</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        """</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">if</span> self._server <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">                self._pool.waitall()</div><div class="line">                self._server.wait()</div><div class="line">        <span class="keyword">except</span> greenlet.GreenletExit:</div><div class="line">            LOG.info(<span class="string">"WSGI server has stopped."</span>)</div></pre></td></tr></table></figure>
<p>nova.wsgi.Server 核心是 socket 编程和 evenlet 提供的 web server(这个 web server 提供了类似 nginx web 服务器相同的功能)。这里面的代码依旧值的我们深究，限于篇幅，我们会在后面展开介绍 nova.wsgi.Server 中的内容。</p>
<p>到这里 Nova API 服务的并发管理我们就讲完了。</p>

        </div>
        <!--  -->
        <footer class="article-footer">
            



    <a data-url="http://yoursite.com/2021/03/07/openstack/nova/nova_06/" data-id="ckxy3rr3x00x68ku9k083pyva" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>



                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google-plus" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-google-plus"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2021/03/08/openstack/nova/nova_07/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            7. API 接口服务(四)
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2021/03/05/openstack/nova/nova_04/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">4. API 接口服务(一)Web 框架</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/10/17/assembley/link/link_01/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/操作系统/">操作系统</a></p>
                            <p class="item-title"><a href="/2021/10/17/assembley/link/link_01/" class="title">1. 《程序员的自我修养》读书笔记</a></p>
                            <p class="item-date"><time datetime="2021-10-16T16:00:00.000Z" itemprop="datePublished">2021-10-17</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/11/assembley/x86/x86_11/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/task.png)" alt="11. 任务和特权级保护" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/11/assembley/x86/x86_11/" class="title">11. 任务和特权级保护</a></p>
                            <p class="item-date"><time datetime="2021-07-10T16:00:00.000Z" itemprop="datePublished">2021-07-11</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/10/assembley/x86/x86_10/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/memory_asign.png)" alt="10. 程序的动态加载和执行" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/10/assembley/x86/x86_10/" class="title">10. 程序的动态加载和执行</a></p>
                            <p class="item-date"><time datetime="2021-07-09T16:00:00.000Z" itemprop="datePublished">2021-07-10</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/09/assembley/x86/x86_09/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/seg_check.png)" alt="9. 存储器的保护" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/09/assembley/x86/x86_09/" class="title">9. 存储器的保护</a></p>
                            <p class="item-date"><time datetime="2021-07-08T16:00:00.000Z" itemprop="datePublished">2021-07-09</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/08/assembley/x86/x86_08/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/gdt.png)" alt="8. 进入保护模式" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/08/assembley/x86/x86_08/" class="title">8. 进入保护模式</a></p>
                            <p class="item-date"><time datetime="2021-07-07T16:00:00.000Z" itemprop="datePublished">2021-07-08</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">61</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式/">分布式</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储/">存储</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/">操作系统</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">198</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">25</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">32</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">31</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">21</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">26</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">48</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">31</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">29</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">4</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Brendan-Gregg/">Brendan Gregg</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/">ES6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML-CSS/">HTML&CSS</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8S/">K8S</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/">Kafka</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux性能调优/">Linux性能调优</a><span class="tag-list-count">49</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL实战45讲/">MySQL实战45讲</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openstack/">Openstack</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/">React</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/">Vue</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go并发编程/">go并发编程</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go标准库及第三方库/">go标准库及第三方库</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go语言入门/">go语言入门</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wrapt/">wrapt</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/x86-汇编/">x86 汇编</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/入门指南/">入门指南</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/好玩的数据结构与算法/">好玩的数据结构与算法</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据密集型应用/">数据密集型应用</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构与算法/">数据结构与算法</a><span class="tag-list-count">39</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/极客时间/">极客时间</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/程序员的自我修养/">程序员的自我修养</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马哥-Linux/">马哥 Linux</a><span class="tag-list-count">135</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马哥-MySQL-运维/">马哥 MySQL 运维</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高性能的MySQL/">高性能的MySQL</a><span class="tag-list-count">5</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/Brendan-Gregg/" style="font-size: 10px;">Brendan Gregg</a> <a href="/tags/ES6/" style="font-size: 15.63px;">ES6</a> <a href="/tags/HTML-CSS/" style="font-size: 12.5px;">HTML&CSS</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/K8S/" style="font-size: 10px;">K8S</a> <a href="/tags/Kafka/" style="font-size: 16.25px;">Kafka</a> <a href="/tags/Linux性能调优/" style="font-size: 19.38px;">Linux性能调优</a> <a href="/tags/MySQL实战45讲/" style="font-size: 18.13px;">MySQL实战45讲</a> <a href="/tags/Openstack/" style="font-size: 13.75px;">Openstack</a> <a href="/tags/React/" style="font-size: 15.63px;">React</a> <a href="/tags/Vue/" style="font-size: 15.63px;">Vue</a> <a href="/tags/go并发编程/" style="font-size: 17.5px;">go并发编程</a> <a href="/tags/go标准库及第三方库/" style="font-size: 10.63px;">go标准库及第三方库</a> <a href="/tags/go语言入门/" style="font-size: 14.38px;">go语言入门</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/python/" style="font-size: 11.25px;">python</a> <a href="/tags/wrapt/" style="font-size: 16.88px;">wrapt</a> <a href="/tags/x86-汇编/" style="font-size: 14.38px;">x86 汇编</a> <a href="/tags/入门指南/" style="font-size: 16.25px;">入门指南</a> <a href="/tags/好玩的数据结构与算法/" style="font-size: 11.88px;">好玩的数据结构与算法</a> <a href="/tags/数据密集型应用/" style="font-size: 15.63px;">数据密集型应用</a> <a href="/tags/数据结构与算法/" style="font-size: 18.75px;">数据结构与算法</a> <a href="/tags/极客时间/" style="font-size: 18.13px;">极客时间</a> <a href="/tags/程序员的自我修养/" style="font-size: 10px;">程序员的自我修养</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a> <a href="/tags/马哥-Linux/" style="font-size: 20px;">马哥 Linux</a> <a href="/tags/马哥-MySQL-运维/" style="font-size: 13.13px;">马哥 MySQL 运维</a> <a href="/tags/高性能的MySQL/" style="font-size: 11.88px;">高性能的MySQL</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">讨论区</h3>
        <div class="widget">
            <h4> 联系我 <h4>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2022 宋涛</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'http://yoursite.com/2021/03/07/openstack/nova/nova_06/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
