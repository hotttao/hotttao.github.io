<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    

    
    <title>24.2 LVS 4层负载均衡原理 | 宋涛的博客</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="负载均衡" />
    
    <meta name="description" content="LVS 4层负载均衡原理">
<meta name="keywords" content="负载均衡">
<meta property="og:type" content="article">
<meta property="og:title" content="24.2 LVS 4层负载均衡原理">
<meta property="og:url" content="http://yoursite.com/2018/10/02/linux_mt/27-LVS4层负载均衡/LVS4层负载均衡原理/index.html">
<meta property="og:site_name" content="宋涛的博客">
<meta property="og:description" content="LVS 4层负载均衡原理">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/linux_mt/linux_slb.jpg">
<meta property="og:updated_time" content="2019-02-11T14:14:28.542Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="24.2 LVS 4层负载均衡原理">
<meta name="twitter:description" content="LVS 4层负载均衡原理">
<meta name="twitter:image" content="http://yoursite.com/images/linux_mt/linux_slb.jpg">
    

    
        <link rel="alternate" href="/" title="宋涛的博客" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/3.3.1/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    


</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">漫步在大陆上的海龟</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Go/">Go</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Python/">Python</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/运维/">运维</a></li></ul>
                                    
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/运维/">运维</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-linux_mt/27-LVS4层负载均衡/LVS4层负载均衡原理" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        24.2 LVS 4层负载均衡原理
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2018/10/02/linux_mt/27-LVS4层负载均衡/LVS4层负载均衡原理/" class="article-date">
            <time datetime="2018-10-01T16:00:00.000Z" itemprop="datePublished">2018-10-02</time>
        </a>
    </div>

		

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/负载均衡/">负载均衡</a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p>LVS 4层负载均衡原理</p>
<p><img src="/images/linux_mt/linux_slb.jpg" alt="linux-mt"><br><a id="more"></a></p>
<p>本节我们先来讲解 LVS 实现负载均衡的原理，内容包括:</p>
<ol>
<li>LVS nginx 工作层级</li>
<li>LVS 负载均衡原理</li>
<li>LVS 负载均衡的四种模型</li>
</ol>
<h2 id="1-LVS-nginx-工作层级"><a href="#1-LVS-nginx-工作层级" class="headerlink" title="1. LVS nginx 工作层级"></a>1. LVS nginx 工作层级</h2><p><img src="/images/linux_mt/tcp_ip_iso.jpg" alt="tcp_ip"></p>
<p>要想区分 lvs 与 nginx 实现负载均衡的区别，关键是要明白它们工作在TCP/IP 协议哪个层级。<a href="../12-计算机网络及Linux网络配置/计算机网络基础知识.md">12.1 计算机网络基础知识</a> 我们详细讲解过 TCP/IP 协议。计算机网络被分成两个层次，通信子网和资源子网，应用层是资源子网位于用户空间，下四层位于内核空间。应用层想进行网络通信，必需通过套接子接口向内核发起系统调用，而 Linux 上套接子的数量是有数量限制的。</p>
<h4 id="LVS"><a href="#LVS" class="headerlink" title="LVS"></a>LVS</h4><p>LVS 是四层的负载均衡器又称为四层路由器，四层交换机，位于内核空间，直接附加在 iptables netfilter 的 nat 表的 INPUT 链上。可直接根据请求报文的目标 IP 和 port 向后端服务器转发报文，无需创建套接字，因此没有套接字数量的限制。</p>
<p>LVS 通过修改请求报文的或IP地址或端口或 MAC 地址直接将报文转发至后端服务器，后端服务器看到的请求依然可能是用户的IP而与中间转发的主机无关。</p>
<h4 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h4><p>ngxin/haproxy 则工作在应用层，同时充当服务器端和客户端，作为服务器接收外部用户请求，再作为客户端向后端服务器发起请求，将用户请求转发给后端服务器。整个过程需要创建套接字以完成网络通信，所以存在套接字数量限制。</p>
<h4 id="应用对比"><a href="#应用对比" class="headerlink" title="应用对比"></a>应用对比</h4><p>相比于 nginx，LVS 在实际的生产环境中使用相对较少，原因有以下几点:</p>
<ol>
<li>大多数企业并没有达到使用 LVS 进行负载均衡的规模，通常情况下使用 nginx，haproxy 就可以很好的完整负载均衡任务</li>
<li>LVS 工作于内核，没有很好的用户端工具，也没有操作更高应用级别的能力，比如无法通过 cookie 进行转发，所以没有 nginx/haproxy 易用</li>
<li>当企业的并发请求超过套接子的限制时，更加倾向于通过硬件实现负载均衡。</li>
</ol>
<p>但是 LVS 仍然不失为高并发下负载均衡的有效解决方案，而且LVS 是我们理解其他负载均衡集群非常重要的组件，同时 LVS 也是面试重点，因此我们还是要学好 LVS。</p>
<p>实际工作环境中，如果并发请求达到了使用 LVS 的级别，通常采用二级调度的方式，第一级是 LVS，第二级是 nginx/haproxy.</p>
<h2 id="2-LVS-负载均衡原理"><a href="#2-LVS-负载均衡原理" class="headerlink" title="2. LVS 负载均衡原理"></a>2. LVS 负载均衡原理</h2><p><img src="/images/linux_mt/lvs_base.png" alt="iptables_frame"></p>
<p>如上图所示 LVS 由两个部分组成:</p>
<ul>
<li><code>ipvs</code>: 工作于内核空间中 netfilter INPUT 链上的钩子函数</li>
<li><code>ipvsadmin</code>: ipvs 的用户空间命令行工具，用于向 ipvs 添加集群服务和规则</li>
</ul>
<p>我们需要通过<code>ipvsadmin</code> 向 <code>ipvs</code> 添加监听的服务和对应的集群。当请求报文到来时:</p>
<ol>
<li>经过第一次路由决策，发往本机的报文会由 <code>PREROUTING</code> 到达 <code>INPUT</code></li>
<li>附加在 <code>INPUT</code> 的 ipvs 会根据 ipvs 上集群服务的IP，协议和端口来判断报文是否需要向后端的集群进行转发</li>
<li>如果是需要转发的报文，LVS 会根据配置的调度算法，选择集群中某一台主机，将请求报文直接送往 <code>POSTROUTING</code>链转，转发至该服务器</li>
<li>LVS 有 4 种工作类型，不同类型下，LVS 会相应的修改请求报文的 ip，端口或 mac 地址，以将报文转发至目标服务器</li>
</ol>
<p>因此对于 LVS 而言，报文的在内核的流经顺序为 <code>PREROUTING --&gt; INPUT --&gt; POSTROUTING</code></p>
<h2 id="3-LVS-术语及架构"><a href="#3-LVS-术语及架构" class="headerlink" title="3. LVS 术语及架构"></a>3. LVS 术语及架构</h2><h3 id="3-1-LVS-组成"><a href="#3-1-LVS-组成" class="headerlink" title="3.1 LVS 组成"></a>3.1 LVS 组成</h3><p>LVS(Linux Virtual Server) 由 VS, RS 两个部分组成</p>
<ol>
<li><code>VS</code>：Virtual Server, 负载均衡的调度器，又称为 Director, Dispatcher, Balancer</li>
<li><code>rs</code>：Real Server, 真正提供服务的集群服务器，又称为 upstream server, backend server</li>
</ol>
<h3 id="3-2-LVS的类型-架构"><a href="#3-2-LVS的类型-架构" class="headerlink" title="3.2 LVS的类型(架构)"></a>3.2 LVS的类型(架构)</h3><p>LVS 有四种不同的类型，这四中类型的工作流程实现就是我们接下来讲解的重点:</p>
<ol>
<li><code>lvs-nat</code>: Network Address Translation，多目标IP的DNAT，通过修改请求报文的目标IP完整转发</li>
<li><code>lvs-dr</code>: Direct Routing，直接路由，通过重新封装新的MAC地址完成转发</li>
<li><code>lvs-tun</code>:IP Tunneling，在原请求IP报文之外新加一个IP首部</li>
<li><code>lvs-fullnat</code>:修改请求报文的源和目标IP，非标准实现</li>
</ol>
<h2 id="3-3-LVS-NAT-MASQUERADE"><a href="#3-3-LVS-NAT-MASQUERADE" class="headerlink" title="3.3 LVS-NAT(MASQUERADE)"></a>3.3 LVS-NAT(MASQUERADE)</h2><p><img src="/images/linux_mt/lvs_nat.jpg" alt="web_fram"></p>
<p>附注: IP 命名:</p>
<ul>
<li><code>VIP</code>：Virtual IP</li>
<li><code>DIP</code>: Director IP</li>
<li><code>RIP</code>: Real Server IP</li>
<li><code>CIP</code>：Client IP</li>
</ul>
<p><code>LVS-NAT</code> 就是一个多用途的 DNAT(iptables) 通过修改请求报文的目标IP地址(端口)至挑选出的某RS IP 地址实现转发。相比与 DNAT 只能将报文转发至固定主机，LVS-NAT 可以根据调度算法选择转发的后端主机。LVS-NAT 具有如下一些特征:</p>
<ol>
<li>RS(RIP),DIP应该使用私有地址；RS的网关必须指向DIP；</li>
<li>请求和响应都要经过Director；高负载场景中，Director易成为性能瓶颈；</li>
<li>支持端口映射；</li>
<li>vs必须是Linux系统，rs可以是任意系统；</li>
<li>RS 的 RIP 和 Director 的 DIP 必须在同一 IP 网络</li>
</ol>
<h3 id="3-4-LVS-DR-GATEWAY"><a href="#3-4-LVS-DR-GATEWAY" class="headerlink" title="3.4 LVS-DR(GATEWAY)"></a>3.4 LVS-DR(GATEWAY)</h3><p><img src="/images/linux_mt/lvs_dr.jpg" alt="web_fram"></p>
<p>LVS-DR 通过修改请求报文的目标 MAC 地址进行转发。如上图所示，报文经过了如下的转发过程:</p>
<ol>
<li>VS 接收到来自用户的请求报文</li>
<li>VS 通过调度算法选择一个 RS，通过修改请求报文的目标 MAC 地址为该 VS 的 mac 地址直接向其转发请求报文。因为 VS 必需要能获取 RS 的 MAC 地址，所以 RS 与 VS 必需位于同一物理网络中</li>
<li>RS 接收到响应报文后无需经过 VS 直接向客户端进行响应。因为客户端请求的目标地址是 VIP，所以 RS 进行响应的源地址必需是 VIP，否则客户端不会接收响应。</li>
</ol>
<p>那我们如何确保 RS 响应的源地址是 VIP 呢？</p>
<ol>
<li>首先我们需要在所有的 RS 的网卡上添加 VIP 的 IP 地址</li>
<li>因为 VS 和 RS 都绑定了 VIP ，我们需要保证前端路由将目标地址为VIP的报文统统发往 VS，而不能发往 RS</li>
<li>Linux 上响应报文的源IP，是由其发出的第一块网卡上的IP 地址决定，因此我们必需设置 RS 的路由条目，让所有的响应报文从 VIP 所在的网卡发出。</li>
</ol>
<p>那我们如何保证前端路由将目标地址为VIP的报文统统发往 VS，而不能是 RS 呢？有三种方法:</p>
<ol>
<li>在前端路由器上静态绑定 VS VIP 地址所在网卡的 MAC 地址；问题是未必有路由操作权限，且无法为 VS 实现高可用，因为 VS 发生故障转移时，VS 所在的服务器就会发生变化，VIP 所在的网卡也就发生了变化。</li>
<li>使用 aprtables 在 RS 上拒绝对 VIP 的 arp 响应和通告，aprtables 类似防火墙的工作于物理层，可通过 MAC 过滤，使用复杂不便于配置</li>
<li><strong>修改RS上内核参数，将RS上的VIP配置在lo接口的别名上，并限制lo接口的 arp 通告和响应，这样就能阻断 RS 对 VIP 地址的解析请求，这是最佳的解决方案。</strong></li>
</ol>
<p>因此 VIP 必需配置的 lo 接口的别名上，同时必需设置路由，强制让响应报文先经过 lo 接口，再通过内核的转发功能从网卡发出。</p>
<p>LVS-DR 具有如下特征:</p>
<ol>
<li>RS可以使用私有地址；但也可以使用公网地址，此时可通过互联网通过RIP对其直接访问；</li>
<li>RS跟Directory必须在同一物理网络中，以便能基于物理地址做转发；</li>
<li>请求报文经由Director，但响应报文必须不能经过Director；</li>
<li>不支持端口映射；</li>
<li>RS可以是大多数常见的OS；</li>
<li>RS的网关绝不允许指向DIP；</li>
</ol>
<h3 id="3-5-LVS-TUN-IPIP"><a href="#3-5-LVS-TUN-IPIP" class="headerlink" title="3.5 LVS-TUN(IPIP)"></a>3.5 LVS-TUN(IPIP)</h3><p>LVS-NAT 需要 RS 的网关必需指向 DIP，因此 RS 和 VS 必需位于同一网段中，LVS-DR VS 需要能获取到 RS 的 MAC 地址，因此 VS 和 RS 必需位于同一物理网段中；通常的传输介质，比如双绞线最大的传输距离也就只有 100 米，所以 VS 和 RS 必需位于同一机房内，所以如果各 RS 不再同一位置，比如为了灾备在不同地方分别放置了集群服务器，这两种模式就无法使用。</p>
<p>LVS-TUN 类似 LVS-DR 不过其能跨越地理位置的限制。 LVS-TUN 不修改请求报文的 ip 首部，而是通过在原有的 ip 首部之外，在封装一个 ip 首部。真个请求响应过程如下图所示。</p>
<p><img src="/images/linux_mt/lvs_tun.jpg" alt="web_fram"></p>
<p>与 LVS-DR 相同的是每个 RS 都必须配置 VIP，并将 VIP 所在网卡作为响应报文的出口以确保响应报文的源IP 为 VIP。但是 RS 无需限制 ARP 的通告和响应，因为此时 VS 与 RS 不再同一网络中。RS 上配置的 VIP 不会影响请求报文到达 VS，因为 VIP 不可能位于 RS 的网段中，因此 RS 中 VIP 是不可达网络，不能接收到发送到 VIP 的请求。</p>
<p>因为额外添加一层 IP 首部，因此 RS 必需要支持隧道协议，否则无法解析转发的报文。同时额外增加的 IP 首部会增加报文大小，如果刚好使得报文从小于 MTU 变成大于 MTU，则会发生报文拆分降低传输速度，因此 VS 上最好能针对这种情况自动拆分报文。</p>
<p>LVS-TUN 具有如下特性:</p>
<ul>
<li>RIP、VIP、DIP全部是公网地址；</li>
<li>RS的网关不会也不可能指向DIP；</li>
<li>请求报文经由Director，但响应报文必须不能经过Director；</li>
<li>不支持端口映射；</li>
<li>RS的OS必须支持隧道功能；</li>
</ul>
<h3 id="3-6-LVS-FULLNAT"><a href="#3-6-LVS-FULLNAT" class="headerlink" title="3.6 LVS-FULLNAT"></a>3.6 LVS-FULLNAT</h3><p>LVS-TUN 虽然能跨越地理位置的限制，但是配置起来不便，很少使用。为了满足跨越机房的需求，LVS 有第四种非标准实现 LVS-FULLNAT。LVS-FULLNAT 未收录进内核，要使用需要自己编译内核才能使用。</p>
<p>LVS-NAT 只修改了请求报文的目标地址，因此 RS 进行响应时，为了让目标地址为 CIP 经过 VS，必需将 RS 的网关设置为 RS。LVS-FULLNAT 会同时修改请求报文的目标地址和源地址进行转发，</p>
<p><img src="/images/linux_mt/lvs_fullnat.png" alt="web_fram"></p>
<p>这样 RS 的响应报文的目标地址为 DIP 而不是 CIP，报文经过路由一定到达 VS，因此 就可以跨越同一网络的限制。</p>
<p>LVS-FULLNAT具有如下特性:</p>
<ul>
<li>VIP 是公网地址，RIP 和 DIP 是私网地址，二者无须在同一网络中</li>
<li>RS 接收到的请求报文的源地址为 DIP，因此要响应给 DIP</li>
<li>请求报文和响应报文都必须经由 Director</li>
<li>支持端口映射</li>
<li>RS 可以使用任意 OS</li>
</ul>
<h3 id="3-7-总结"><a href="#3-7-总结" class="headerlink" title="3.7 总结"></a>3.7 总结</h3><ul>
<li><code>lvs-nat</code>, <code>lvs-fullnat</code>：请求和响应报文都经由Director<ul>
<li><code>lvs-nat</code>：RIP的网关要指向DIP；</li>
<li><code>lvs-fullnat</code>：RIP和DIP未必在同一IP网络，但要能通信；</li>
</ul>
</li>
<li><code>lvs-dr</code>, <code>lvs-tun</code>：请求报文要经由Director，但响应报文由RS直接发往Client<ul>
<li><code>lvs-dr</code>：通过封装新的MAC首部实现，通过MAC网络转发</li>
<li><code>lvs-tun</code>：通过在原IP报文之外封装新的IP首部实现转发，支持远距离通信</li>
</ul>
</li>
</ul>
<h2 id="4-arp-内核控制参数"><a href="#4-arp-内核控制参数" class="headerlink" title="4. arp 内核控制参数"></a>4. arp 内核控制参数</h2><p>LVS-DR 模型中，我们说到可以通过内核参数来控制 arp 的通告和响应，arp_ignore, apr_announce 就是控制参数。每个网卡都有对应 arp_ignore, apr_announce 控制参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ ls  /proc/sys/net/ipv4/conf</div><div class="line">all  default  lo  virbr0  virbr0-nic  wlp1s0</div><div class="line"># all 表示所有网卡</div><div class="line"></div><div class="line">$ ll /proc/sys/net/ipv4/conf/lo/|grep arp</div><div class="line">-rw-r--r--. 1 root root 0 9月   7 09:51 arp_accept</div><div class="line">-rw-r--r--. 1 root root 0 9月   7 09:51 arp_announce</div><div class="line">-rw-r--r--. 1 root root 0 9月   7 09:51 arp_filter</div><div class="line">-rw-r--r--. 1 root root 0 9月   7 09:51 arp_ignore</div><div class="line">-rw-r--r--. 1 root root 0 9月   7 09:51 arp_notify</div><div class="line">-rw-r--r--. 1 root root 0 9月   7 09:51 proxy_arp</div><div class="line">-rw-r--r--. 1 root root 0 9月   7 09:51 proxy_arp_pvlan</div></pre></td></tr></table></figure>
<h2 id="4-1-arp-ignore"><a href="#4-1-arp-ignore" class="headerlink" title="4.1 arp_ignore"></a>4.1 arp_ignore</h2><p><code>arp_ignore</code></p>
<ul>
<li>作用: 控制系统在收到外部的arp请求时，是否要返回arp响应</li>
<li>取值: 主要有0，1，2，3~8较少用到<ul>
<li><code>0</code>: 响应任意网卡上接收到的对本机IP地址的arp请求（包括环回网卡上的地址），而不管该目的IP是否在接收网卡上。</li>
<li><code>1</code>: 只响应目的IP地址为接收网卡上的本地地址的arp请求</li>
<li><code>2</code>: 只响应目的IP地址为接收网卡上的本地地址的arp请求，并且arp请求的源IP必须和接收网卡同网段。</li>
<li><code>3</code>: 如果ARP请求数据包所请求的IP地址对应的本地地址其作用域（scope）为主机（host），则不回应ARP响应数据包，如果作用域为全局（global）或链路（link），则回应ARP响应数据包</li>
<li><code>4~7</code>: 保留未使用</li>
<li><code>8</code>: 不回应所有的arp请求</li>
</ul>
</li>
</ul>
<h3 id="图示"><a href="#图示" class="headerlink" title="图示"></a>图示</h3><p><img src="/images/linux_mt/arp_ignore_0.png" alt="web_fram"></p>
<p>arp_ignore=1,当 arp 从 eth1 请求 lo 接口上的 IP 地址的 MAC 地址允许响应。</p>
<p><img src="/images/linux_mt/arp_ignore_1.png" alt="web_fram"></p>
<p><code>arp_ignore=1</code>,当 arp 从 eth1 请求 lo 接口上的 IP 地址的 MAC 地址不允许响应。</p>
<h2 id="4-2-arp-announce"><a href="#4-2-arp-announce" class="headerlink" title="4.2 arp_announce"></a>4.2 arp_announce</h2><p><code>arp_announce</code></p>
<ul>
<li>作用: 控制系统在对外发送arp请求时，如何选择arp请求数据包的源IP地址</li>
<li>取值:<ul>
<li><code>0</code>：允许使用任意网卡上的IP地址作为arp请求的源IP，通常就是使用数据包a的源IP。</li>
<li><code>1</code>：尽量避免使用不属于该发送网卡子网的本地地址作为发送arp请求的源IP地址。</li>
<li><code>2</code>：忽略IP数据包的源IP地址，选择该发送网卡上最合适的本地地址作为arp请求的源IP地址。</li>
</ul>
</li>
</ul>
<h3 id="图示-1"><a href="#图示-1" class="headerlink" title="图示"></a>图示</h3><p><img src="/images/linux_mt/arp_announce_0.png" alt="web_fram"></p>
<p><code>arp_announce=0</code> 时 数据包的源 IP 为 lo 接口的IP 地址，其从 eth2发出时，arp 请求的源地址仍然为 lo 接口的 IP。</p>
<p><img src="/images/linux_mt/arp_announce_1.png" alt="web_fram"></p>
<p><code>arp_announce=1</code> 时 数据包的源 IP 为 lo 接口的IP 地址，其从 eth2发出时，arp 请求的源地址重新选择为 eth1 的IP 地址。</p>
<h2 id="4-3-修改-arp-参数"><a href="#4-3-修改-arp-参数" class="headerlink" title="4.3 修改 arp 参数"></a>4.3 修改 arp 参数</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span>  1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</div><div class="line"><span class="built_in">echo</span>  1 &gt; /proc/sys/net/ipv4/conf/eth1/arp_ignore</div><div class="line"><span class="built_in">echo</span>  2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</div><div class="line"><span class="built_in">echo</span>  2 &gt; /proc/sys/net/ipv4/conf/eth1/arp_announce</div></pre></td></tr></table></figure>

        </div>
        <footer class="article-footer">
            



    <a data-url="http://yoursite.com/2018/10/02/linux_mt/27-LVS4层负载均衡/LVS4层负载均衡原理/" data-id="cjs7cmj2u00gzt3hgpxa1uq99" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>



                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google-plus" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-google-plus"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2018/10/03/linux_mt/27-LVS4层负载均衡/调度算法和ipvsadmin使用/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            24.3 LVS 调度算法和 ipvsadmin
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2018/10/01/linux_mt/27-LVS4层负载均衡/架构拓展及集群介绍/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">24.1 架构拓展及集群介绍</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2019/01/08/go/go_grammar/go_8/" class="thumbnail">
    
    
        <span style="background-image:url(/images/go/grammar/go_func.jpg)" alt="8 go 的委托模式" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2019/01/08/go/go_grammar/go_8/" class="title">8 go 的委托模式</a></p>
                            <p class="item-date"><time datetime="2019-01-07T16:00:00.000Z" itemprop="datePublished">2019-01-08</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2019/01/07/go/go_grammar/go_7/" class="thumbnail">
    
    
        <span style="background-image:url(/images/go/grammar/go_func.jpg)" alt="7 go 接口" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2019/01/07/go/go_grammar/go_7/" class="title">7 go 接口</a></p>
                            <p class="item-date"><time datetime="2019-01-06T16:00:00.000Z" itemprop="datePublished">2019-01-07</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2019/01/06/go/go_grammar/go_6/" class="thumbnail">
    
    
        <span style="background-image:url(/images/go/grammar/go_func.jpg)" alt="6 go 方法" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2019/01/06/go/go_grammar/go_6/" class="title">6 go 方法</a></p>
                            <p class="item-date"><time datetime="2019-01-05T16:00:00.000Z" itemprop="datePublished">2019-01-06</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2019/01/05/go/go_grammar/go_5/" class="thumbnail">
    
    
        <span style="background-image:url(/images/go/grammar/go_func.jpg)" alt="5 go 函数" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2019/01/05/go/go_grammar/go_5/" class="title">5 go 函数</a></p>
                            <p class="item-date"><time datetime="2019-01-04T16:00:00.000Z" itemprop="datePublished">2019-01-05</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2019/01/04/go/go_grammar/go_4/" class="thumbnail">
    
    
        <span style="background-image:url(/images/go/grammar/go_type.jpg)" alt="4 go 复合数据类型" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2019/01/04/go/go_grammar/go_4/" class="title">4 go 复合数据类型</a></p>
                            <p class="item-date"><time datetime="2019-01-03T16:00:00.000Z" itemprop="datePublished">2019-01-04</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">56</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">140</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">27</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">49</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">25</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">27</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">29</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">27</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">3</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/DNS/">DNS</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8S/">K8S</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LAMP/">LAMP</a><span class="tag-list-count">22</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux基础/">Linux基础</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux开机启动/">Linux开机启动</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux进阶/">Linux进阶</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go语言入门/">go语言入门</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell脚本/">shell脚本</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/supervisor/">supervisor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tornado/">tornado</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unittest/">unittest</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wrapt/">wrapt</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/函数装饰器/">函数装饰器</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/单元测试/">单元测试</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构与算法/">数据结构与算法</a><span class="tag-list-count">39</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文件共享服务/">文件共享服务</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文本处理/">文本处理</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/磁盘与文件系统/">磁盘与文件系统</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/缓存系统/">缓存系统</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/自动化运维/">自动化运维</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/负载均衡/">负载均衡</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/部署工具/">部署工具</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/防火墙/">防火墙</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高可用/">高可用</a><span class="tag-list-count">3</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/DNS/" style="font-size: 12px;">DNS</a> <a href="/tags/K8S/" style="font-size: 10px;">K8S</a> <a href="/tags/LAMP/" style="font-size: 18.67px;">LAMP</a> <a href="/tags/Linux基础/" style="font-size: 19.33px;">Linux基础</a> <a href="/tags/Linux开机启动/" style="font-size: 16px;">Linux开机启动</a> <a href="/tags/Linux进阶/" style="font-size: 14px;">Linux进阶</a> <a href="/tags/go语言入门/" style="font-size: 14.67px;">go语言入门</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/shell脚本/" style="font-size: 15.33px;">shell脚本</a> <a href="/tags/supervisor/" style="font-size: 10px;">supervisor</a> <a href="/tags/tornado/" style="font-size: 10px;">tornado</a> <a href="/tags/unittest/" style="font-size: 10px;">unittest</a> <a href="/tags/wrapt/" style="font-size: 18px;">wrapt</a> <a href="/tags/函数装饰器/" style="font-size: 18px;">函数装饰器</a> <a href="/tags/单元测试/" style="font-size: 10px;">单元测试</a> <a href="/tags/数据结构与算法/" style="font-size: 20px;">数据结构与算法</a> <a href="/tags/文件共享服务/" style="font-size: 10px;">文件共享服务</a> <a href="/tags/文本处理/" style="font-size: 13.33px;">文本处理</a> <a href="/tags/磁盘与文件系统/" style="font-size: 12.67px;">磁盘与文件系统</a> <a href="/tags/缓存系统/" style="font-size: 13.33px;">缓存系统</a> <a href="/tags/自动化运维/" style="font-size: 16.67px;">自动化运维</a> <a href="/tags/负载均衡/" style="font-size: 17.33px;">负载均衡</a> <a href="/tags/部署工具/" style="font-size: 10.67px;">部署工具</a> <a href="/tags/防火墙/" style="font-size: 14px;">防火墙</a> <a href="/tags/高可用/" style="font-size: 11.33px;">高可用</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">讨论区</h3>
        <div class="widget">
            <h4> 联系我 <h4>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2019 宋涛</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'http://yoursite.com/2018/10/02/linux_mt/27-LVS4层负载均衡/LVS4层负载均衡原理/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
