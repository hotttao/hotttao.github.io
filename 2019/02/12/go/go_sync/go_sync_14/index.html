<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    

    
    <title>14 Channel 应用 | 宋涛的博客</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="go并发编程" />
    
    <meta name="description" content="应用">
<meta name="keywords" content="go并发编程">
<meta property="og:type" content="article">
<meta property="og:title" content="14 Channel 应用">
<meta property="og:url" content="http://yoursite.com/2019/02/12/go/go_sync/go_sync_14/index.html">
<meta property="og:site_name" content="宋涛的博客">
<meta property="og:description" content="应用">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-12-16T13:20:25.613Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="14 Channel 应用">
<meta name="twitter:description" content="应用">
    

    
        <link rel="alternate" href="/" title="宋涛的博客" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/3.3.1/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    


</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">漫步在大陆上的海龟</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Go/">Go</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Python/">Python</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/分布式/">分布式</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/前端/">前端</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/存储/">存储</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/运维/">运维</a></li></ul>
                                    
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/Go/">Go</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-go/go_sync/go_sync_14" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        14 Channel 应用
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2019/02/12/go/go_sync/go_sync_14/" class="article-date">
            <time datetime="2019-02-11T16:00:00.000Z" itemprop="datePublished">2019-02-12</time>
        </a>
    </div>

		

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/go并发编程/">go并发编程<span class="tag-count">21</span></a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p>应用<br><a id="more"></a></p>
<h2 id="1-使用反射操作-Channel"><a href="#1-使用反射操作-Channel" class="headerlink" title="1. 使用反射操作 Channel"></a>1. 使用反射操作 Channel</h2><p>在学习如何使用 Channel 之前，我们来看看如何通过反射的方式执行 select 语句，这在处理很多的 case clause，尤其是不定长的 case clause 的时候，非常有用。</p>
<p>为了便于操作 Select，reflect 提供了如下几个函数:</p>
<ol>
<li><code>func Select(cases []SelectCase) (chosen int, recv Value, recvOK bool)</code>:<ul>
<li>参数: SelectCase 表示 Select 语句的一个分支</li>
<li>返回值:<ul>
<li>chosen:  select 是伪随机的，它在执行的 case 中随机选择一个 case，并把选择的这个 case 的索引（chosen）返回</li>
<li>recv: 如果 select 选中的 recv case，recvValue 表示接收的元素</li>
<li>recvOK: 表示是否有 case 成功被选择，false 表示没有可用的 case 返回</li>
</ul>
</li>
</ul>
</li>
<li><code>SelectCase</code>: struct 表示一个 select case 分支</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> (</div><div class="line">    SelectSend    <span class="comment">// case Chan &lt;- Send</span></div><div class="line">    SelectRecv    <span class="comment">// case &lt;-Chan:</span></div><div class="line">    SelectDefault <span class="comment">// default</span></div><div class="line">)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">type</span> SelectCase <span class="keyword">struct</span> &#123;</div><div class="line">    Dir  SelectDir <span class="comment">// case的方向</span></div><div class="line">    Chan Value     <span class="comment">// 使用的通道（收/发）</span></div><div class="line">    Send Value     <span class="comment">// 用于发送的值</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> SelectDir <span class="keyword">int</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Select</span><span class="params">(cases []SelectCase)</span> <span class="params">(chosen <span class="keyword">int</span>, recv Value, recvOK <span class="keyword">bool</span>)</span></span></div></pre></td></tr></table></figure>
<p>下面是动态创建 Select 的一个示例:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> ch1 = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</div><div class="line">    <span class="keyword">var</span> ch2 = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</div><div class="line"></div><div class="line">    <span class="comment">// 创建SelectCase</span></div><div class="line">    <span class="keyword">var</span> cases = createCases(ch1, ch2)</div><div class="line"></div><div class="line">    <span class="comment">// 执行10次select</span></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</div><div class="line">        chosen, recv, ok := reflect.Select(cases)</div><div class="line">        <span class="keyword">if</span> recv.IsValid() &#123; <span class="comment">// recv case</span></div><div class="line">            fmt.Println(<span class="string">"recv:"</span>, cases[chosen].Dir, recv, ok)</div><div class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// send case</span></div><div class="line">            fmt.Println(<span class="string">"send:"</span>, cases[chosen].Dir, ok)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">createCases</span><span class="params">(chs ...<span class="keyword">chan</span> <span class="keyword">int</span>)</span> []<span class="title">reflect</span>.<span class="title">SelectCase</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> cases []reflect.SelectCase</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// 创建recv case</span></div><div class="line">    <span class="keyword">for</span> _, ch := <span class="keyword">range</span> chs &#123;</div><div class="line">        cases = <span class="built_in">append</span>(cases, reflect.SelectCase&#123;</div><div class="line">            Dir:  reflect.SelectRecv,</div><div class="line">            Chan: reflect.ValueOf(ch),</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 创建send case</span></div><div class="line">    <span class="keyword">for</span> i, ch := <span class="keyword">range</span> chs &#123;</div><div class="line">        v := reflect.ValueOf(i)</div><div class="line">        cases = <span class="built_in">append</span>(cases, reflect.SelectCase&#123;</div><div class="line">            Dir:  reflect.SelectSend,</div><div class="line">            Chan: reflect.ValueOf(ch),</div><div class="line">            Send: v,</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> cases</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上一节我们说了 Channel 的五种使用场景:</p>
<ol>
<li>数据交流：当作并发的 buffer 或者 queue，解决生产者 - 消费者问题。多个 goroutine 可以并发当作生产者（Producer）和消费者（Consumer）</li>
<li>数据传递：一个 goroutine 将数据交给另一个 goroutine，相当于把数据的拥有权 (引用) 托付出去。</li>
<li>信号通知：一个 goroutine 可以将信号 (closing、closed、data ready 等) 传递给另一个或者另一组 goroutine</li>
<li>任务编排：可以让一组 goroutine 按照一定的顺序并发或者串行的执行，这就是编排的功能</li>
<li>锁：利用 Channel 也可以实现互斥锁的机制</li>
</ol>
<p>接下来我们一一举例说明。</p>
<h2 id="2-消息交流"><a href="#2-消息交流" class="headerlink" title="2.消息交流"></a>2.消息交流</h2><p>从 chan 的内部实现看，它是以一个循环队列的方式存放数据，所以，它有时候也会被当成线程安全的队列和 buffer 使用。我们来看几个例子。</p>
<h3 id="2-1-worker-池"><a href="#2-1-worker-池" class="headerlink" title="2.1 worker 池"></a>2.1 worker 池</h3><p>Marcio Castilho 在 <a href="http://marcio.io/2015/07/handling-1-million-requests-per-minute-with-golang/" target="_blank" rel="external">使用 Go 每分钟处理百万请求</a>  这篇文章中，就介绍了他们应对大并发请求的设计。他们将用户的请求放在一个 chan Job 中，这个 chan Job 就相当于一个待处理任务队列。除此之外，还有一个 chan chan Job 队列，用来存放可以处理任务的 worker 的缓存队列。下面核心代码实现:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1. 定义Worker 池和消息队列的长度</span></div><div class="line"><span class="keyword">var</span> (</div><div class="line">	MaxWorker = os.Getenv(<span class="string">"MAX_WORKERS"</span>)</div><div class="line">	MaxQueue  = os.Getenv(<span class="string">"MAX_QUEUE"</span>)</div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// 2. 定义任务队列 </span></div><div class="line"><span class="keyword">type</span> Job <span class="keyword">struct</span> &#123;</div><div class="line">	Payload Payload</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> JobQueue <span class="keyword">chan</span> Job</div><div class="line"></div><div class="line"><span class="comment">// 3. 定义 Worker</span></div><div class="line"><span class="keyword">type</span> Worker <span class="keyword">struct</span> &#123;</div><div class="line">	WorkerPool  <span class="keyword">chan</span> <span class="keyword">chan</span> Job </div><div class="line">	JobChannel  <span class="keyword">chan</span> Job  <span class="comment">// 接收任务</span></div><div class="line">	quit    	<span class="keyword">chan</span> <span class="keyword">bool</span> <span class="comment">// Worker 退出</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewWorker</span><span class="params">(workerPool <span class="keyword">chan</span> <span class="keyword">chan</span> Job)</span> <span class="title">Worker</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> Worker&#123;</div><div class="line">		WorkerPool: workerPool,</div><div class="line">		JobChannel: <span class="built_in">make</span>(<span class="keyword">chan</span> Job),</div><div class="line">		quit:       <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 3.1 启动任务</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w Worker)</span> <span class="title">Start</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">for</span> &#123;</div><div class="line">			<span class="comment">// 重要: register the current worker into the worker queue.</span></div><div class="line">			w.WorkerPool &lt;- w.JobChannel</div><div class="line"></div><div class="line">			<span class="keyword">select</span> &#123;</div><div class="line">			<span class="keyword">case</span> job := &lt;-w.JobChannel:</div><div class="line">				<span class="comment">// we have received a work request.</span></div><div class="line">				<span class="keyword">if</span> err := job.Payload.UploadToS3(); err != <span class="literal">nil</span> &#123;</div><div class="line">					log.Errorf(<span class="string">"Error uploading to S3: %s"</span>, err.Error())</div><div class="line">				&#125;</div><div class="line"></div><div class="line">			<span class="keyword">case</span> &lt;-w.quit:</div><div class="line">				<span class="comment">// we have received a signal to stop</span></div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 3.2 停止任务</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w Worker)</span> <span class="title">Stop</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		w.quit &lt;- <span class="literal">true</span></div><div class="line">	&#125;()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 4. 创建 Worker Pool</span></div><div class="line"><span class="keyword">type</span> Dispatcher <span class="keyword">struct</span> &#123;</div><div class="line">	WorkerPool <span class="keyword">chan</span> <span class="keyword">chan</span> Job</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDispatcher</span><span class="params">(maxWorkers <span class="keyword">int</span>)</span> *<span class="title">Dispatcher</span></span> &#123;</div><div class="line">	pool := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">chan</span> Job, maxWorkers)</div><div class="line">	<span class="keyword">return</span> &amp;Dispatcher&#123;WorkerPool: pool&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dispatcher)</span> <span class="title">Run</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// starting n number of workers</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; d.maxWorkers; i++ &#123;</div><div class="line">		worker := NewWorker(d.pool)</div><div class="line">		worker.Start()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">go</span> d.dispatch()</div><div class="line">&#125;</div><div class="line"><span class="comment">// 4.1 将任务从 JobQueue 放入到 Woker Pool 中某一个 Workder 的 JobChannel 中，来调用 Worker</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dispatcher)</span> <span class="title">dispatch</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="keyword">select</span> &#123;</div><div class="line">		<span class="keyword">case</span> job := &lt;-JobQueue:</div><div class="line">			<span class="comment">// a job request has been received</span></div><div class="line">			<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(job Job)</span></span> &#123;</div><div class="line">				<span class="comment">// try to obtain a worker job channel that is available.</span></div><div class="line">				<span class="comment">// this will block until a worker is idle</span></div><div class="line">				jobChannel := &lt;-d.WorkerPool</div><div class="line"></div><div class="line">				<span class="comment">// dispatch the job to the worker job channel</span></div><div class="line">				jobChannel &lt;- job</div><div class="line">			&#125;(job)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 5. 使用 Worker Pool</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">payloadHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> _, payload := <span class="keyword">range</span> content.Payloads &#123;</div><div class="line"></div><div class="line">        <span class="comment">// let's create a job with the payload</span></div><div class="line">        work := Job&#123;Payload: payload&#125;</div><div class="line"></div><div class="line">        <span class="comment">// Push the work onto the queue.</span></div><div class="line">        JobQueue &lt;- work</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-数据传递"><a href="#3-数据传递" class="headerlink" title="3. 数据传递"></a>3. 数据传递</h2><p>下面是一个数据传递(任务编排)的例子，让四个 goroutine 顺序打印 1,2,3,4</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">type</span> Token <span class="keyword">struct</span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">newWorker</span><span class="params">(id <span class="keyword">int</span>, ch <span class="keyword">chan</span> Token, nextCh <span class="keyword">chan</span> Token)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        token := &lt;-ch         <span class="comment">// 取得令牌</span></div><div class="line">        fmt.Println((id + <span class="number">1</span>)) <span class="comment">// id从1开始</span></div><div class="line">        time.Sleep(time.Second)</div><div class="line">        nextCh &lt;- token</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    chs := []<span class="keyword">chan</span> Token&#123;<span class="built_in">make</span>(<span class="keyword">chan</span> Token), <span class="built_in">make</span>(<span class="keyword">chan</span> Token), <span class="built_in">make</span>(<span class="keyword">chan</span> Token), <span class="built_in">make</span>(<span class="keyword">chan</span> Token)&#125;</div><div class="line"></div><div class="line">    <span class="comment">// 创建4个worker</span></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">4</span>; i++ &#123;</div><div class="line">        <span class="keyword">go</span> newWorker(i, chs[i], chs[(i+<span class="number">1</span>)%<span class="number">4</span>])</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//首先把令牌交给第一个worker</span></div><div class="line">    chs[<span class="number">0</span>] &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</div><div class="line">  </div><div class="line">    <span class="keyword">select</span> &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这类场景有一个特点，就是当前持有数据的 goroutine 都有一个信箱，信箱使用 chan 实现，goroutine 只需要关注自己的信箱中的数据，处理完毕后，就把结果发送到下一家的信箱中。</p>
<h2 id="4-信号通知"><a href="#4-信号通知" class="headerlink" title="4. 信号通知"></a>4. 信号通知</h2><p>chan 类型有这样一个特点：chan 如果为空，那么，receiver 接收数据的时候就会阻塞等待，直到 chan 被关闭或者有新的数据到来。利用这个机制，我们可以实现 wait/notify 的设计模式。</p>
<p>除了正常的业务处理时的 wait/notify，我们经常碰到的一个场景，就是程序关闭的时候，我们需要在退出之前做一些清理（doCleanup 方法）的动作。这个时候，我们经常要使用 chan。</p>
<p>比如，使用 chan 实现程序的 graceful shutdown，在退出之前执行一些连接关闭、文件 close、缓存落盘等一些动作。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">      ...... <span class="comment">// 执行业务处理</span></div><div class="line">    &#125;()</div><div class="line"></div><div class="line">  <span class="comment">// 处理CTRL+C等中断信号</span></div><div class="line">  termChan := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal)</div><div class="line">  signal.Notify(termChan, syscall.SIGINT, syscall.SIGTERM)</div><div class="line">  &lt;-termChan </div><div class="line"></div><div class="line">  <span class="comment">// 执行退出之前的清理动作</span></div><div class="line">    doCleanup()</div><div class="line">  </div><div class="line">  fmt.Println(<span class="string">"优雅退出"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有时候，doCleanup 可能是一个很耗时的操作，我们需要设置一个最长的等待时间。只要超过了这个时间，程序就不再等待，可以直接退出。所以，退出的时候分为两个阶段：</p>
<ol>
<li>closing，代表程序退出，但是清理工作还没做；</li>
<li>closed，代表清理工作已经做完。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> closing = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</div><div class="line">    <span class="keyword">var</span> closed = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</div><div class="line"></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="comment">// 模拟业务处理</span></div><div class="line">        <span class="keyword">for</span> &#123;</div><div class="line">            <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> &lt;-closing:</div><div class="line">                <span class="keyword">return</span></div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="comment">// ....... 业务计算</span></div><div class="line">                time.Sleep(<span class="number">100</span> * time.Millisecond)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    <span class="comment">// 处理CTRL+C等中断信号</span></div><div class="line">    termChan := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal)</div><div class="line">    signal.Notify(termChan, syscall.SIGINT, syscall.SIGTERM)</div><div class="line">    &lt;-termChan</div><div class="line"></div><div class="line">    <span class="built_in">close</span>(closing)</div><div class="line">    <span class="comment">// 执行退出之前的清理动作</span></div><div class="line">    <span class="keyword">go</span> doCleanup(closed)</div><div class="line"></div><div class="line">    <span class="keyword">select</span> &#123;</div><div class="line">    <span class="keyword">case</span> &lt;-closed:</div><div class="line">    <span class="keyword">case</span> &lt;-time.After(time.Second):</div><div class="line">        fmt.Println(<span class="string">"清理超时，不等了"</span>)</div><div class="line">    &#125;</div><div class="line">    fmt.Println(<span class="string">"优雅退出"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doCleanup</span><span class="params">(closed <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</div><div class="line">    time.Sleep((time.Minute))</div><div class="line">    <span class="built_in">close</span>(closed)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="5-锁"><a href="#5-锁" class="headerlink" title="5. 锁"></a>5. 锁</h2><p>使用 chan 也可以实现互斥锁。在 chan 的内部实现中，就有一把互斥锁保护着它的所有字段。从外在表现上，chan 的发送和接收之间也存在着 happens-before 的关系，保证元素放进去之后，receiver 才能读取到。</p>
<p>要想使用 chan 实现互斥锁，至少有两种方式。一种方式是先初始化一个 capacity 等于 1 的 Channel，然后再放入一个元素。这个元素就代表锁，谁取得了这个元素，就相当于获取了这把锁。另一种方式是，先初始化一个 capacity 等于 1 的 Channel，它的“空槽”代表锁，谁能成功地把元素发送到这个 Channel，谁就获取了这把锁。</p>
<p>我们以第一种为例实现一个锁:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// 使用chan实现互斥锁</span></div><div class="line"><span class="keyword">type</span> Mutex <span class="keyword">struct</span> &#123;</div><div class="line">    ch <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 使用锁需要初始化</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMutex</span><span class="params">()</span> *<span class="title">Mutex</span></span> &#123;</div><div class="line">    mu := &amp;Mutex&#123;<span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">1</span>)&#125;</div><div class="line">    mu.ch &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</div><div class="line">    <span class="keyword">return</span> mu</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 请求锁，直到获取到</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Lock</span><span class="params">()</span></span> &#123;</div><div class="line">    &lt;-m.ch</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 解锁</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Unlock</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">select</span> &#123;</div><div class="line">    <span class="keyword">case</span> m.ch &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;:</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">        <span class="built_in">panic</span>(<span class="string">"unlock of unlocked mutex"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 尝试获取锁</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">TryLock</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</div><div class="line">    <span class="keyword">select</span> &#123;</div><div class="line">    <span class="keyword">case</span> &lt;-m.ch:</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">    <span class="keyword">default</span>:</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 加入一个超时的设置</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">LockTimeout</span><span class="params">(timeout time.Duration)</span> <span class="title">bool</span></span> &#123;</div><div class="line">    timer := time.NewTimer(timeout)</div><div class="line">    <span class="keyword">select</span> &#123;</div><div class="line">    <span class="keyword">case</span> &lt;-m.ch:</div><div class="line">        timer.Stop()</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">    <span class="keyword">case</span> &lt;-timer.C:</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 锁是否已被持有</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">IsLocked</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(m.ch) == <span class="number">0</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    m := NewMutex()</div><div class="line">    ok := m.TryLock()</div><div class="line">    fmt.Printf(<span class="string">"locked v %v\n"</span>, ok)</div><div class="line">    ok = m.TryLock()</div><div class="line">    fmt.Printf(<span class="string">"locked %v\n"</span>, ok)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="6-任务编排"><a href="#6-任务编排" class="headerlink" title="6. 任务编排"></a>6. 任务编排</h2><p>消息交流的场景是一个特殊的任务编排的场景：</p>
<ol>
<li>前面我们介绍的顺序答应1,2,3,4 s 也被称为流水线模式</li>
<li>WaitGroup 可以实现等待模式，Channel 也可以实现这种等待模式</li>
</ol>
<p>任务编排既指安排 goroutine 按照指定的顺序执行，也指多个 chan 按照指定的方式组合处理的方式。我们通过编排数据在 channel 之间的流转，就可以控制 goroutine 的执行。接下来我们着重介绍 channel 编排的五种典型模式L</p>
<ol>
<li>Or-Done</li>
<li>扇入</li>
<li>扇出</li>
<li>Stream</li>
<li>map-reduce</li>
</ol>
<h3 id="6-1-Or-Done-模式"><a href="#6-1-Or-Done-模式" class="headerlink" title="6.1 Or-Done 模式"></a>6.1 Or-Done 模式</h3><p>Or-Done 模式是信号通知模式中更宽泛的一种模式。我们会使用“信号通知”实现某个任务执行完成后的通知机制，在实现时:</p>
<ol>
<li>我们为这个任务定义一个类型为 chan struct{}类型的 done 变量</li>
<li>等任务结束后，我们就可以 close 这个变量，然后，其它 receiver 就会收到这个通知。</li>
</ol>
<p>这是有一个任务的情况，如果有多个任务，只要有任意一个任务执行完，我们就想获得这个信号，这就是 Or-Done 模式。比如发送同一个请求到多个微服务节点，只要任意一个微服务返回结果就算成功。下面是Or-Done 的一个实现:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">or</span><span class="params">(channels ...&lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span> &lt;-<span class="title">chan</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">    <span class="comment">// 特殊情况，只有零个或者1个chan</span></div><div class="line">    <span class="keyword">switch</span> <span class="built_in">len</span>(channels) &#123;</div><div class="line">    <span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">    <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">        <span class="keyword">return</span> channels[<span class="number">0</span>]</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    orDone := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">defer</span> <span class="built_in">close</span>(orDone)</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> <span class="built_in">len</span>(channels) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">// 2个也是一种特殊情况</span></div><div class="line">            <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> &lt;-channels[<span class="number">0</span>]:</div><div class="line">            <span class="keyword">case</span> &lt;-channels[<span class="number">1</span>]:</div><div class="line">            &#125;</div><div class="line">        <span class="keyword">default</span>: <span class="comment">//超过两个，二分法递归处理</span></div><div class="line">            m := <span class="built_in">len</span>(channels) / <span class="number">2</span></div><div class="line">            <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> &lt;-or(channels[:m]...):</div><div class="line">            <span class="keyword">case</span> &lt;-or(channels[m:]...):</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    <span class="keyword">return</span> orDone</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的实现使用了一个巧妙的方式，当 chan 的数量大于 2 时，使用递归的方式等待信号。在 chan 数量比较多的情况下，递归并不是一个很好的解决方式，根据这一讲最开始介绍的反射的方法，我们也可以实现 Or-Done 模式：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">or</span><span class="params">(channels ...&lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span> &lt;-<span class="title">chan</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">    <span class="comment">//特殊情况，只有0个或者1个</span></div><div class="line">    <span class="keyword">switch</span> <span class="built_in">len</span>(channels) &#123;</div><div class="line">    <span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">    <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">        <span class="keyword">return</span> channels[<span class="number">0</span>]</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    orDone := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">defer</span> <span class="built_in">close</span>(orDone)</div><div class="line">        <span class="comment">// 利用反射构建SelectCase</span></div><div class="line">        <span class="keyword">var</span> cases []reflect.SelectCase</div><div class="line">        <span class="keyword">for</span> _, c := <span class="keyword">range</span> channels &#123;</div><div class="line">            cases = <span class="built_in">append</span>(cases, reflect.SelectCase&#123;</div><div class="line">                Dir:  reflect.SelectRecv,</div><div class="line">                Chan: reflect.ValueOf(c),</div><div class="line">            &#125;)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 随机选择一个可用的case</span></div><div class="line">        reflect.Select(cases)</div><div class="line">    &#125;()</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">return</span> orDone</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="6-2-扇入"><a href="#6-2-扇入" class="headerlink" title="6.2 扇入"></a>6.2 扇入</h3><p>Channel 扇入模式来说，是指有多个源 Channel 输入、一个目的 Channel 输出的情况。每个源 Channel 的元素都会发送给目标 Channel，相当于目标 Channel 的 receiver 只需要监听目标 Channel，就可以接收所有发送给源 Channel 的数据。</p>
<p>扇入模式也可以使用反射、递归，或者是用最笨的每个 goroutine 处理一个 Channel 的方式来实现。</p>
<h4 id="反射实现"><a href="#反射实现" class="headerlink" title="反射实现"></a>反射实现</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">fanInReflect</span><span class="params">(chans ...&lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span> &lt;-<span class="title">chan</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">    out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">defer</span> <span class="built_in">close</span>(out)</div><div class="line">        <span class="comment">// 构造SelectCase slice</span></div><div class="line">        <span class="keyword">var</span> cases []reflect.SelectCase</div><div class="line">        <span class="keyword">for</span> _, c := <span class="keyword">range</span> chans &#123;</div><div class="line">            cases = <span class="built_in">append</span>(cases, reflect.SelectCase&#123;</div><div class="line">                Dir:  reflect.SelectRecv,</div><div class="line">                Chan: reflect.ValueOf(c),</div><div class="line">            &#125;)</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// 循环，从cases中选择一个可用的</span></div><div class="line">        <span class="keyword">for</span> <span class="built_in">len</span>(cases) &gt; <span class="number">0</span> &#123;</div><div class="line">            i, v, ok := reflect.Select(cases)</div><div class="line">            <span class="keyword">if</span> !ok &#123; <span class="comment">// 此channel已经close</span></div><div class="line">                cases = <span class="built_in">append</span>(cases[:i], cases[i+<span class="number">1</span>:]...)</div><div class="line">                <span class="keyword">continue</span></div><div class="line">            &#125;</div><div class="line">            out &lt;- v.Interface()</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> out</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="递归实现"><a href="#递归实现" class="headerlink" title="递归实现"></a>递归实现</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">fanInRec</span><span class="params">(chans ...&lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span> &lt;-<span class="title">chan</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">    <span class="keyword">switch</span> <span class="built_in">len</span>(chans) &#123;</div><div class="line">    <span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">        c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</div><div class="line">        <span class="built_in">close</span>(c)</div><div class="line">        <span class="keyword">return</span> c</div><div class="line">    <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">        <span class="keyword">return</span> chans[<span class="number">0</span>]</div><div class="line">    <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">        <span class="keyword">return</span> mergeTwo(chans[<span class="number">0</span>], chans[<span class="number">1</span>])</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">        m := <span class="built_in">len</span>(chans) / <span class="number">2</span></div><div class="line">        <span class="keyword">return</span> mergeTwo(</div><div class="line">            fanInRec(chans[:m]...),</div><div class="line">            fanInRec(chans[m:]...))</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">mergeTwo</span><span class="params">(a, b &lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span> &lt;-<span class="title">chan</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">defer</span> <span class="built_in">close</span>(c)</div><div class="line">        <span class="keyword">for</span> a != <span class="literal">nil</span> || b != <span class="literal">nil</span> &#123; <span class="comment">//只要还有可读的chan</span></div><div class="line">            <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> v, ok := &lt;-a:</div><div class="line">                <span class="keyword">if</span> !ok &#123; <span class="comment">// a 已关闭，设置为nil</span></div><div class="line">                    a = <span class="literal">nil</span></div><div class="line">                    <span class="keyword">continue</span></div><div class="line">                &#125;</div><div class="line">                c &lt;- v</div><div class="line">            <span class="keyword">case</span> v, ok := &lt;-b:</div><div class="line">                <span class="keyword">if</span> !ok &#123; <span class="comment">// b 已关闭，设置为nil</span></div><div class="line">                    b = <span class="literal">nil</span></div><div class="line">                    <span class="keyword">continue</span></div><div class="line">                &#125;</div><div class="line">                c &lt;- v</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> c</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="6-3-扇出"><a href="#6-3-扇出" class="headerlink" title="6.3 扇出"></a>6.3 扇出</h3><p>扇出模式只有一个输入源 Channel，有多个目标 Channel，经常用在设计模式中的观察者模式中，将一个一个对象的状态变化通知到多个观察者中。扇入模式也可以使用反射、递归，或者是用最笨的每个 goroutine 处理一个 Channel 的方式来实现。</p>
<h4 id="反射实现-1"><a href="#反射实现-1" class="headerlink" title="反射实现"></a>反射实现</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">fanOut</span><span class="params">(ch &lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, out []<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, async <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">//退出时关闭所有的输出chan</span></div><div class="line">            <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(out); i++ &#123;</div><div class="line">                <span class="built_in">close</span>(out[i])</div><div class="line">            &#125;</div><div class="line">        &#125;()</div><div class="line"></div><div class="line">        <span class="keyword">for</span> v := <span class="keyword">range</span> ch &#123; <span class="comment">// 从输入chan中读取数据</span></div><div class="line">            v := v</div><div class="line">            <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(out); i++ &#123;</div><div class="line">                i := i</div><div class="line">                <span class="keyword">if</span> async &#123; <span class="comment">//异步</span></div><div class="line">                    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">                        out[i] &lt;- v <span class="comment">// 放入到输出chan中,异步方式</span></div><div class="line">                    &#125;()</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    out[i] &lt;- v <span class="comment">// 放入到输出chan中，同步方式</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="递归实现-1"><a href="#递归实现-1" class="headerlink" title="递归实现"></a>递归实现</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="string">``</span><span class="string">`</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">### 6.4 Stream</span></div><div class="line"><span class="string">把 Channel 当作流式管道使用，提供跳过几个元素，或者是只取其中的几个元素等方法。在下面的实现中，我们首先创建流，然后为流定义以下方法:</span></div><div class="line"><span class="string">1. takeN：只取流中的前 n 个数据；</span></div><div class="line"><span class="string">2. takeFn：筛选流中的数据，只保留满足条件的数据；</span></div><div class="line"><span class="string">3. takeWhile：只取前面满足条件的数据，一旦不满足条件，就不再取；</span></div><div class="line"><span class="string">4. skipN：跳过流中前几个数据；</span></div><div class="line"><span class="string">5. skipFn：跳过满足条件的数据；</span></div><div class="line"><span class="string">6. skipWhile：跳过前面满足条件的数据，一旦不满足条件，当前这个元素和以后的元素都会输出给 Channel 的 receiver。</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">这些方法的实现很类似，我们以 takeN 为例。</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">#### 创建流</span></div><div class="line"><span class="string">`</span><span class="string">``</span><span class="keyword">go</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">asStream</span><span class="params">(done &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, values ...<span class="keyword">interface</span>&#123;&#125;)</span> &lt;-<span class="title">chan</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">    s := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;) <span class="comment">//创建一个unbuffered的channel</span></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">// 启动一个goroutine，往s中塞数据</span></div><div class="line">        <span class="keyword">defer</span> <span class="built_in">close</span>(s) <span class="comment">// 退出时关闭chan</span></div><div class="line">        <span class="keyword">for</span> _, v := <span class="keyword">range</span> values &#123; <span class="comment">// 遍历数组</span></div><div class="line">            <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> &lt;-done:</div><div class="line">                <span class="keyword">return</span></div><div class="line">            <span class="keyword">case</span> s &lt;- v: <span class="comment">// 将数组元素塞入到chan中</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> s</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="流上的方法"><a href="#流上的方法" class="headerlink" title="流上的方法"></a>流上的方法</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">takeN</span><span class="params">(done &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, valueStream &lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, num <span class="keyword">int</span>)</span> &lt;-<span class="title">chan</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">    takeStream := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;) <span class="comment">// 创建输出流</span></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">defer</span> <span class="built_in">close</span>(takeStream)</div><div class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; num; i++ &#123; <span class="comment">// 只读取前num个元素</span></div><div class="line">            <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> &lt;-done:</div><div class="line">                <span class="keyword">return</span></div><div class="line">            <span class="keyword">case</span> takeStream &lt;- &lt;-valueStream: <span class="comment">//从输入流中读取元素</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> takeStream</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="6-5-map-reduce"><a href="#6-5-map-reduce" class="headerlink" title="6.5 map-reduce"></a>6.5 map-reduce</h3><p>这里我们要讲的是单机单进程的 map-reduce 方法。map-reduce 分为两个步骤，第一步是映射（map），处理队列中的数据，第二步是规约（reduce），把列表中的每一个元素按照一定的处理方式处理成结果，放入到结果队列中。</p>
<h4 id="map"><a href="#map" class="headerlink" title="map"></a>map</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapChan</span><span class="params">(in &lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, fn <span class="keyword">func</span>(<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">interface</span></span>&#123;&#125;) &lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125; &#123;</div><div class="line">    out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;) <span class="comment">//创建一个输出chan</span></div><div class="line">    <span class="keyword">if</span> in == <span class="literal">nil</span> &#123; <span class="comment">// 异常检查</span></div><div class="line">        <span class="built_in">close</span>(out)</div><div class="line">        <span class="keyword">return</span> out</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">// 启动一个goroutine,实现map的主要逻辑</span></div><div class="line">        <span class="keyword">defer</span> <span class="built_in">close</span>(out)</div><div class="line">        <span class="keyword">for</span> v := <span class="keyword">range</span> in &#123; <span class="comment">// 从输入chan读取数据，执行业务操作，也就是map操作</span></div><div class="line">            out &lt;- fn(v)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    <span class="keyword">return</span> out</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">reduce</span><span class="params">(in &lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, fn <span class="keyword">func</span>(r, v <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">interface</span></span>&#123;&#125;) <span class="keyword">interface</span>&#123;&#125; &#123;</div><div class="line">    <span class="keyword">if</span> in == <span class="literal">nil</span> &#123; <span class="comment">// 异常检查</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    out := &lt;-in <span class="comment">// 先读取第一个元素</span></div><div class="line">    <span class="keyword">for</span> v := <span class="keyword">range</span> in &#123; <span class="comment">// 实现reduce的主要逻辑</span></div><div class="line">        out = fn(out, v)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> out</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// 生成一个数据流</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">asStream</span><span class="params">(done &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> &lt;-<span class="title">chan</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">    s := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</div><div class="line">    values := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">defer</span> <span class="built_in">close</span>(s)</div><div class="line">        <span class="keyword">for</span> _, v := <span class="keyword">range</span> values &#123; <span class="comment">// 从数组生成</span></div><div class="line">            <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> &lt;-done:</div><div class="line">                <span class="keyword">return</span></div><div class="line">            <span class="keyword">case</span> s &lt;- v:</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> s</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    in := asStream(<span class="literal">nil</span>)</div><div class="line"></div><div class="line">    <span class="comment">// map操作: 乘以10</span></div><div class="line">    mapFn := <span class="function"><span class="keyword">func</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">        <span class="keyword">return</span> v.(<span class="keyword">int</span>) * <span class="number">10</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// reduce操作: 对map的结果进行累加</span></div><div class="line">    reduceFn := <span class="function"><span class="keyword">func</span><span class="params">(r, v <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">        <span class="keyword">return</span> r.(<span class="keyword">int</span>) + v.(<span class="keyword">int</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    sum := reduce(mapChan(in, mapFn), reduceFn) <span class="comment">//返回累加结果</span></div><div class="line">    fmt.Println(sum)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
        </div>
        <!--  -->
        <footer class="article-footer">
            



    <a data-url="http://yoursite.com/2019/02/12/go/go_sync/go_sync_14/" data-id="ckmiod8lz00ev4su9swzpjnpd" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>



                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google-plus" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-google-plus"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2019/02/12/go/go_sync/go_sync_13/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            13 Channel
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2019/02/11/go/go_sync/go_sync_11/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">11 Context</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/01/01/go/go_design/go_design_1/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/01/01/go/go_design/go_design_1/" class="title">1 Go 设计模式</a></p>
                            <p class="item-date"><time datetime="2020-12-31T16:00:00.000Z" itemprop="datePublished">2021-01-01</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/12/01/go/go_module/go_module_1/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2020/12/01/go/go_module/go_module_1/" class="title">1 go 标准库和第三方库入门</a></p>
                            <p class="item-date"><time datetime="2020-11-30T16:00:00.000Z" itemprop="datePublished">2020-12-01</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/12/01/go/go_module/go_module_2/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2020/12/01/go/go_module/go_module_2/" class="title">2 文件 IO 和字符操作</a></p>
                            <p class="item-date"><time datetime="2020-11-30T16:00:00.000Z" itemprop="datePublished">2020-12-01</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/11/15/web/react/react_15/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/前端/">前端</a></p>
                            <p class="item-title"><a href="/2020/11/15/web/react/react_15/" class="title">15 react 项目实战</a></p>
                            <p class="item-date"><time datetime="2020-11-14T16:00:00.000Z" itemprop="datePublished">2020-11-15</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/11/14/web/react/react_14/" class="thumbnail">
    
    
        <span style="background-image:url(/images/JavaScript/dva_flow.png)" alt="14 Dva" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/前端/">前端</a></p>
                            <p class="item-title"><a href="/2020/11/14/web/react/react_14/" class="title">14 Dva</a></p>
                            <p class="item-date"><time datetime="2020-11-13T16:00:00.000Z" itemprop="datePublished">2020-11-14</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">35</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">61</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式/">分布式</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储/">存储</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">188</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">25</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">32</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">31</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">21</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">26</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">48</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">31</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">29</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">4</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Brendan-Gregg/">Brendan Gregg</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/">ES6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML-CSS/">HTML&CSS</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8S/">K8S</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/">Kafka</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux性能调优/">Linux性能调优</a><span class="tag-list-count">49</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL实战45讲/">MySQL实战45讲</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/">React</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/">Vue</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go并发编程/">go并发编程</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go标准库及第三方库/">go标准库及第三方库</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go语言入门/">go语言入门</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wrapt/">wrapt</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/入门指南/">入门指南</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/好玩的数据结构与算法/">好玩的数据结构与算法</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据密集型应用/">数据密集型应用</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构与算法/">数据结构与算法</a><span class="tag-list-count">39</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/极客时间/">极客时间</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马哥-Linux/">马哥 Linux</a><span class="tag-list-count">135</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马哥-MySQL-运维/">马哥 MySQL 运维</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高性能的MySQL/">高性能的MySQL</a><span class="tag-list-count">5</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/Brendan-Gregg/" style="font-size: 10px;">Brendan Gregg</a> <a href="/tags/ES6/" style="font-size: 15.33px;">ES6</a> <a href="/tags/HTML-CSS/" style="font-size: 12.67px;">HTML&CSS</a> <a href="/tags/JavaScript/" style="font-size: 14.67px;">JavaScript</a> <a href="/tags/K8S/" style="font-size: 10px;">K8S</a> <a href="/tags/Kafka/" style="font-size: 16px;">Kafka</a> <a href="/tags/Linux性能调优/" style="font-size: 19.33px;">Linux性能调优</a> <a href="/tags/MySQL实战45讲/" style="font-size: 18px;">MySQL实战45讲</a> <a href="/tags/React/" style="font-size: 15.33px;">React</a> <a href="/tags/Vue/" style="font-size: 15.33px;">Vue</a> <a href="/tags/go并发编程/" style="font-size: 17.33px;">go并发编程</a> <a href="/tags/go标准库及第三方库/" style="font-size: 10.67px;">go标准库及第三方库</a> <a href="/tags/go语言入门/" style="font-size: 14px;">go语言入门</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/python/" style="font-size: 11.33px;">python</a> <a href="/tags/wrapt/" style="font-size: 16.67px;">wrapt</a> <a href="/tags/入门指南/" style="font-size: 14px;">入门指南</a> <a href="/tags/好玩的数据结构与算法/" style="font-size: 12px;">好玩的数据结构与算法</a> <a href="/tags/数据密集型应用/" style="font-size: 15.33px;">数据密集型应用</a> <a href="/tags/数据结构与算法/" style="font-size: 18.67px;">数据结构与算法</a> <a href="/tags/极客时间/" style="font-size: 18px;">极客时间</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a> <a href="/tags/马哥-Linux/" style="font-size: 20px;">马哥 Linux</a> <a href="/tags/马哥-MySQL-运维/" style="font-size: 13.33px;">马哥 MySQL 运维</a> <a href="/tags/高性能的MySQL/" style="font-size: 12px;">高性能的MySQL</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">讨论区</h3>
        <div class="widget">
            <h4> 联系我 <h4>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2021 宋涛</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'http://yoursite.com/2019/02/12/go/go_sync/go_sync_14/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
