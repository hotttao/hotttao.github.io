<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    

    
    <title>10 Pool | 宋涛的博客</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="go并发编程" />
    
    <meta name="description" content="Pool">
<meta name="keywords" content="go并发编程">
<meta property="og:type" content="article">
<meta property="og:title" content="10 Pool">
<meta property="og:url" content="http://yoursite.com/2019/02/10/go/go_sync/go_sync_10/index.html">
<meta property="og:site_name" content="宋涛的博客">
<meta property="og:description" content="Pool">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/go/sync/Pool.jpg">
<meta property="og:updated_time" content="2020-12-11T12:21:45.519Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="10 Pool">
<meta name="twitter:description" content="Pool">
<meta name="twitter:image" content="http://yoursite.com/images/go/sync/Pool.jpg">
    

    
        <link rel="alternate" href="/" title="宋涛的博客" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/3.3.1/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    


</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">漫步在大陆上的海龟</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Go/">Go</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Python/">Python</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/分布式/">分布式</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/前端/">前端</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/存储/">存储</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/运维/">运维</a></li></ul>
                                    
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/Go/">Go</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-go/go_sync/go_sync_10" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        10 Pool
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2019/02/10/go/go_sync/go_sync_10/" class="article-date">
            <time datetime="2019-02-09T16:00:00.000Z" itemprop="datePublished">2019-02-10</time>
        </a>
    </div>

		

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/go并发编程/">go并发编程<span class="tag-count">21</span></a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p>Pool<br><a id="more"></a></p>
<h2 id="1-Pool-概述"><a href="#1-Pool-概述" class="headerlink" title="1. Pool 概述"></a>1. Pool 概述</h2><p>Go 是一个自动垃圾回收的编程语言，采用<a href="https://blog.golang.org/ismmkeynote" target="_blank" rel="external">三色并发标记算法</a>标记对象并回收。但是，如果你想使用 Go 开发一个高性能的应用程序的话，就必须考虑垃圾回收给性能带来的影响。对象池化， 可以有效地减少新对象的创建次数，是性能优化的重要方式。</p>
<p>Go 标准库中提供了一个通用的 Pool 数据结构，也就是 sync.Pool，我们使用它可以创建池化的对象。sync.Pool 有一个缺陷，就是它池化的对象可能会被垃圾回收掉，这对于数据库长连接等场景是不合适的。因此接下来我们将介绍:</p>
<ol>
<li>sync.Pool 的使用、实现和采坑点</li>
<li>其他 Pool 包括 TCP 连接池、数据库连接池</li>
<li>Worker Pool: goroutine pool，使用有限的 goroutine 资源去处理大量的业务数据</li>
</ol>
<p>如果你发现程序中有一种 GC 耗时特别高，有大量的相同类型的临时对象，不断地被创建销毁，这时，你就可以考虑看看，是不是可以通过池化的手段重用这些对象。</p>
<h3 id="1-1-sync-Pool-使用"><a href="#1-1-sync-Pool-使用" class="headerlink" title="1.1 sync.Pool 使用"></a>1.1 sync.Pool 使用</h3><p>sync.Pool 用来保存一组可独立访问的<strong>临时</strong>对象，临时两个字表明”它池化的对象会在未来的某个时候被毫无预兆地移除掉”。如果没有别的对象引用这个被移除的对象的话，这个被移除的对象就会被垃圾回收掉。</p>
<p>sync.Pool 有两个知识点需要记住:</p>
<ol>
<li>sync.Pool 本身就是线程安全的，多个 goroutine 可以并发地调用它的方法存取对象；</li>
<li>sync.Pool 使用之后不可再复制使用</li>
</ol>
<p>sync.Pool 只提供了三个对外方法:</p>
<ol>
<li>New 字段: <ul>
<li>类型为<code>func() interface{}</code></li>
<li>当 Get 方法从池中获取元素，没有更多空闲元素可返回时，就会调用 New 方法来创建新的元素。</li>
<li>如果你没有设置 New 字段，没有更多的空闲元素可返回时，Get 方法将返回 nil，表明当前没有可用的元素</li>
<li>New 是可变的字段，这意味着可以在程序运行的时候改变创建元素的方法，但是没必要这么做</li>
</ul>
</li>
<li>Get 方法:<ul>
<li>调用这个方法，就会从 Pool取走一个元素(从 Pool 中移除)，并返回给调用者</li>
<li>除了正常实例化的元素，Get 方法的返回值还可能会是一个 nil（Pool.New 字段没有设置，又没有空闲元素可以返回），使用时需要判断</li>
</ul>
</li>
<li>Put 方法:<ul>
<li>用于将一个元素返还给 Pool，Pool 会把这个元素保存到池中，并且可以复用</li>
<li>如果 Put 一个 nil 值，Pool 就会忽略这个值</li>
</ul>
</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Pool <span class="keyword">struct</span> &#123;</div><div class="line">	noCopy noCopy</div><div class="line"></div><div class="line">	local     unsafe.Pointer <span class="comment">// local fixed-size per-P pool, actual type is [P]poolLocal</span></div><div class="line">	localSize <span class="keyword">uintptr</span>        <span class="comment">// size of the local array</span></div><div class="line"></div><div class="line">	victim     unsafe.Pointer <span class="comment">// local from previous cycle</span></div><div class="line">	victimSize <span class="keyword">uintptr</span>        <span class="comment">// size of victims array</span></div><div class="line"></div><div class="line">	<span class="comment">// New optionally specifies a function to generate</span></div><div class="line">	<span class="comment">// a value when Get would otherwise return nil.</span></div><div class="line">	<span class="comment">// It may not be changed concurrently with calls to Get.</span></div><div class="line">	New <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Put</span><span class="params">(x <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Get</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;&#125;</div></pre></td></tr></table></figure>
<p>下面是 sync.Pool 实现的 buffer 池(缓冲池)。注意下面这段代码是有问题的，你一定不要将这段代码应用到实际的产品中，它可能会有内存泄漏的问题。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> bytes</div><div class="line"></div><div class="line"><span class="keyword">var</span> buffers = sync.Pool&#123;</div><div class="line">	New: <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">		<span class="keyword">return</span> <span class="built_in">new</span>(bytes.Buffer)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetBuffer</span><span class="params">()</span> *<span class="title">bytes</span>.<span class="title">Buffer</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> buffers.Get().(*bytes.Buffer)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">PutBuffer</span><span class="params">(* bytes.Buffer)</span></span>&#123;</div><div class="line">	buf.Reset()</div><div class="line">	buffer.Put(buf)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-Pool-实现"><a href="#2-Pool-实现" class="headerlink" title="2. Pool 实现"></a>2. Pool 实现</h2><p>Go 1.13 之前的 sync.Pool 的实现有 2 大问题：</p>
<ol>
<li>每次 GC 都会回收创建的对象: 如果缓存元素数量太多，就会导致 STW 耗时变长；缓存元素都被回收后，会导致 Get 命中率下降，Get 方法不得不新创建很多对象。</li>
<li>底层实现使用了 Mutex，对这个锁并发请求竞争激烈的时候，会导致性能的下降</li>
</ol>
<p>在 Go 1.13 中，sync.Pool 做了大量的优化。优化的方式就是避免使用锁，同时将加锁的 queue 改成 lock-free 的 queue 的实现，给即将移除的元素再多一次“复活”的机会。sync.Pool 的数据结构如下图所示：</p>
<p><img src="/images/go/sync/Pool.jpg" alt="Pool"></p>
<p>Pool 实现中:</p>
<ol>
<li>每次垃圾回收的时候，Pool 会把 victim 中的对象移除，然后把 local 的数据给 victim</li>
<li>victim 就像一个垃圾分拣站，里面的东西可能会被当做垃圾丢弃了，但是里面有用的东西也可能被捡回来重新使用</li>
<li>victim 中的元素如果被 Get 取走，他就会被重用；没有被 Get 取走，那么就会被移除掉，因为没有别人引用它的话，就会被垃圾回收掉</li>
</ol>
<h3 id="2-1-Pool-的垃圾回收"><a href="#2-1-Pool-的垃圾回收" class="headerlink" title="2.1 Pool 的垃圾回收"></a>2.1 Pool 的垃圾回收</h3><p>下面的代码是垃圾回收时 sync.Pool 的处理逻辑：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">poolCleanup</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// 丢弃当前victim, STW所以不用加锁</span></div><div class="line">    <span class="keyword">for</span> _, p := <span class="keyword">range</span> oldPools &#123;</div><div class="line">        p.victim = <span class="literal">nil</span></div><div class="line">        p.victimSize = <span class="number">0</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 将local复制给victim, 并将原local置为nil</span></div><div class="line">    <span class="keyword">for</span> _, p := <span class="keyword">range</span> allPools &#123;</div><div class="line">        p.victim = p.local</div><div class="line">        p.victimSize = p.localSize</div><div class="line">        p.local = <span class="literal">nil</span></div><div class="line">        p.localSize = <span class="number">0</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    oldPools, allPools = allPools, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-2-local"><a href="#2-2-local" class="headerlink" title="2.2 local"></a>2.2 local</h3><p>local 字段包含一个 poolLocalInternal 字段，并提供 CPU 缓存对齐，从而避免 false sharing。而 poolLocalInternal 也包含两个字段：private 和 shared。</p>
<ol>
<li>private，代表一个缓存的元素，而且只能由相应的一个 P 存取。因为一个 P 同时只能执行一个 goroutine，所以不会有并发的问题。</li>
<li>shared，可以由任意的 P 访问，但是只有本地的 P 才能 pushHead/popHead，其它 P 可以 popTail，相当于只有一个本地的 P 作为生产者（Producer），多个 P 作为消费者（Consumer），它是使用一个 local-free 的 queue 列表实现的。</li>
</ol>
<h3 id="2-3-Get-方法"><a href="#2-3-Get-方法" class="headerlink" title="2.3 Get 方法"></a>2.3 Get 方法</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Get</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">    <span class="comment">// 把当前goroutine固定在当前的P上</span></div><div class="line">    l, pid := p.pin()</div><div class="line">    x := l.private <span class="comment">// 1. 优先从local的private字段取，快速</span></div><div class="line">    l.private = <span class="literal">nil</span></div><div class="line">    <span class="keyword">if</span> x == <span class="literal">nil</span> &#123;</div><div class="line">        <span class="comment">// 2. 从当前的local.shared弹出一个，注意是从head读取并移除</span></div><div class="line">        x, _ = l.shared.popHead()</div><div class="line">        <span class="keyword">if</span> x == <span class="literal">nil</span> &#123; <span class="comment">// 3. 如果没有，则去偷一个</span></div><div class="line">            x = p.getSlow(pid) </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    runtime_procUnpin()</div><div class="line">    <span class="comment">// 如果没有获取到，尝试使用New函数生成一个新的</span></div><div class="line">    <span class="keyword">if</span> x == <span class="literal">nil</span> &amp;&amp; p.New != <span class="literal">nil</span> &#123;</div><div class="line">        x = p.New()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> x</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的重点是 getSlow 方法，它首先要遍历所有的 local，尝试从它们的 shared 弹出一个元素。如果还没找到一个，那么，就开始对 victim 下手了。在 vintim 中查询可用元素的逻辑还是一样的，先从对应的 victim 的 private 查找，如果查不到，就再从其它 victim 的 shared 中查找。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">getSlow</span><span class="params">(pid <span class="keyword">int</span>)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line"></div><div class="line">    size := atomic.LoadUintptr(&amp;p.localSize)</div><div class="line">    locals := p.local                       </div><div class="line">    <span class="comment">// 从其它proc中尝试偷取一个元素</span></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="keyword">int</span>(size); i++ &#123;</div><div class="line">        l := indexLocal(locals, (pid+i+<span class="number">1</span>)%<span class="keyword">int</span>(size))</div><div class="line">        <span class="keyword">if</span> x, _ := l.shared.popTail(); x != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">return</span> x</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 如果其它proc也没有可用元素，那么尝试从vintim中获取</span></div><div class="line">    size = atomic.LoadUintptr(&amp;p.victimSize)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">uintptr</span>(pid) &gt;= size &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">    &#125;</div><div class="line">    locals = p.victim</div><div class="line">    l := indexLocal(locals, pid)</div><div class="line">    <span class="keyword">if</span> x := l.private; x != <span class="literal">nil</span> &#123; <span class="comment">// 同样的逻辑，先从vintim中的local private获取</span></div><div class="line">        l.private = <span class="literal">nil</span></div><div class="line">        <span class="keyword">return</span> x</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="keyword">int</span>(size); i++ &#123; <span class="comment">// 从vintim其它proc尝试偷取</span></div><div class="line">        l := indexLocal(locals, (pid+i)%<span class="keyword">int</span>(size))</div><div class="line">        <span class="keyword">if</span> x, _ := l.shared.popTail(); x != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">return</span> x</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 如果victim中都没有，则把这个victim标记为空，以后的查找可以快速跳过了</span></div><div class="line">    atomic.StoreUintptr(&amp;p.victimSize, <span class="number">0</span>)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里没列出 pin 代码的实现，你只需要知道，pin 方法会将此 goroutine 固定在当前的 P 上，避免查找元素期间被其它的 P 执行。固定的好处就是查找元素期间直接得到跟这个 P 相关的 local。有一点需要注意的是，pin 方法在执行的时候，如果跟这个 P 相关的 local 还没有创建，或者运行时 P 的数量被修改了的话，就会新创建 local。</p>
<h3 id="2-4-Put-方法"><a href="#2-4-Put-方法" class="headerlink" title="2.4 Put 方法"></a>2.4 Put 方法</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Put</span><span class="params">(x <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> x == <span class="literal">nil</span> &#123; <span class="comment">// nil值直接丢弃</span></div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    l, _ := p.pin()</div><div class="line">    <span class="keyword">if</span> l.private == <span class="literal">nil</span> &#123; <span class="comment">// 如果本地private没有值，直接设置这个值即可</span></div><div class="line">        l.private = x</div><div class="line">        x = <span class="literal">nil</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> x != <span class="literal">nil</span> &#123; <span class="comment">// 否则加入到本地队列中</span></div><div class="line">        l.shared.pushHead(x)</div><div class="line">    &#125;</div><div class="line">    runtime_procUnpin()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Put 的逻辑相对简单，优先设置本地 private，如果 private 字段已经有值了，那么就把此元素 push 到本地队列中。</p>
<h2 id="3-Pool-采坑点"><a href="#3-Pool-采坑点" class="headerlink" title="3. Pool 采坑点"></a>3. Pool 采坑点</h2><p>使用 Once 有两个常见错误:分别是内存泄漏和内存浪费。</p>
<h4 id="3-1-内存泄漏"><a href="#3-1-内存泄漏" class="headerlink" title="3.1 内存泄漏"></a>3.1 内存泄漏</h4><p>文章开始，我们用 sync.Pool 实现了一个 buffer pool，这个实现可能存在内存泄漏。取出来的 bytes.Buffer 在使用的时候，我们可以往这个元素中增加大量的 byte 数据，这会导致底层的 byte slice 的容量可能会变得很大。这个时候，即使 Reset 再放回到池子中，这些 byte slice 的容量不会改变，所占的空间依然很大。而且，因为 Pool 回收的机制，这些大的 Buffer 可能不被回收(被重复使用，但只使用了很小一部分)，而是会一直占用很大的空间，这属于内存泄漏的问题。</p>
<p>在使用 sync.Pool 回收 buffer 的时候，一定要检查回收的对象的大小。如果 buffer 太大，就不要回收了，否则就太浪费了。</p>
<h3 id="3-2-内存浪费"><a href="#3-2-内存浪费" class="headerlink" title="3.2 内存浪费"></a>3.2 内存浪费</h3><p>除了内存泄漏以外，还有一种浪费的情况，就是池子中的 buffer 都比较大，但在实际使用的时候，很多时候只需要一个小的 buffer，这也是一种浪费现象。</p>
<p>要做到物尽其用，尽可能不浪费的话，我们可以将 buffer 池分成几层，比如分成 512byte，1k，2k，4k 的多层 buffer 池。获取 buffer 时根据需要，到所需大小的池子中获取 buffer 即可。在标准库 net/http/server.go中的代码中，就提供了 2K 和 4K 两个 writer 的池子。</p>
<p>YouTube 开源的知名项目 vitess 中提供了<a href="https://github.com/vitessio/vitess/blob/master/go/bucketpool/bucketpool.go" target="_blank" rel="external">bucketpool</a>的实现，它提供了更加通用的多层 buffer 池。你在使用的时候，只需要指定池子的最大和最小尺寸，vitess 就会自动计算出合适的池子数。而且，当你调用 Get 方法的时候，只需要传入你要获取的 buffer 的大小，就可以了。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Pool</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(minSize, maxSize <span class="keyword">int</span>)</span> *<span class="title">Pool</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(p *Pool)</span> <span class="title">Get</span><span class="params">(size <span class="keyword">int</span>)</span> *[]<span class="title">bytes</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(p *Pool)</span> <span class="title">Put</span><span class="params">(b *[]bytes)</span></span></div></pre></td></tr></table></figure>
<h2 id="4-buffer-的其他第三方库"><a href="#4-buffer-的其他第三方库" class="headerlink" title="4. buffer 的其他第三方库"></a>4. buffer 的其他第三方库</h2><p>除了这种分层的为了节省空间的 buffer 设计外，还有其它的一些第三方的库也会提供 buffer 池的功能:</p>
<ol>
<li><a href="https://github.com/oxtoacart/bpool" target="_blank" rel="external">bytebufferpool</a><ul>
<li>基本功能和 sync.Pool 相同，它的底层也是使用 sync.Pool 实现的</li>
<li>包括会检测最大的 buffer，超过最大尺寸的 buffer，就会被丢弃</li>
<li>提供了校准（calibrate，用来动态调整创建元素的权重）的机制，可以“智能”地调整 Pool 的 defaultSize 和 maxSize</li>
<li>一般来说，我们使用 buffer size 的场景比较固定，所用 buffer 的大小会集中在某个范围里。有了校准的特性，bytebufferpool 就能够偏重于创建这个范围大小的 buffer，从而节省空间。</li>
</ul>
</li>
<li><a href="https://github.com/valyala/bytebufferpool" target="_blank" rel="external">oxtoacart/bpool</a> 提供了以下几种类型的 buffer:<ul>
<li>bpool.BufferPool： <ul>
<li>提供一个固定元素数量的 buffer 池，元素类型是 bytes.Buffer</li>
<li>如果超过这个数量，Put 的时候就丢弃</li>
<li>如果池中的元素都被取光了，会新建一个返回</li>
<li>Put 回去的时候，不会检测 buffer 的大小</li>
</ul>
</li>
<li>bpool.BytesPool：<ul>
<li>提供一个固定元素数量的 byte slice 池，元素类型是 byte slice</li>
<li>Put 回去的时候不检测 slice 的大小</li>
</ul>
</li>
<li>bpool.SizedBufferPool： <ul>
<li>提供一个固定元素数量的 buffer 池</li>
<li>如果超过这个数量，Put 的时候就丢弃</li>
<li>如果池中的元素都被取光了，会新建一个返回</li>
<li>Put 回去的时候，会检测 buffer 的大小，超过指定的大小的话，就会创建一个新的满足条件的 buffer 放回去</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>bpool 最大的特色就是能够保持池子中元素的数量，一旦 Put 的数量多于它的阈值，就会自动丢弃，而 sync.Pool 是一个没有限制的池子，只要 Put 就会收进去。bpool 是基于 Channel 实现的，不像 sync.Pool 为了提高性能而做了很多优化，所以，在性能上比不过 sync.Pool。</p>
<h2 id="5-连接池"><a href="#5-连接池" class="headerlink" title="5. 连接池"></a>5. 连接池</h2><p>Pool 的另一个很常用的一个场景就是保持 TCP 的连接。我们很少会使用 sync.Pool 去池化连接对象，原因就在于，sync.Pool 会无通知地在某个时候就把连接移除垃圾回收掉了，而我们的场景是需要长久保持这个连接，所以，我们一般会使用其它方法来池化连接，包括:</p>
<ol>
<li>标准库中的 http client 池</li>
<li>TCP 连接池</li>
<li>数据库连接池</li>
<li>Memcached Client 连接池</li>
<li>Worker Pool</li>
</ol>
<h3 id="5-1-标准库中的-http-client-池"><a href="#5-1-标准库中的-http-client-池" class="headerlink" title="5.1 标准库中的 http client 池"></a>5.1 标准库中的 http client 池</h3><p>标准库的 http.Client 是一个 http client 的库，可以用它来访问 web 服务器。http.Client 实现连接池的代码是在 Transport 类型中，它使用 idleConn 保存持久化的可重用的长连接：</p>
<p><img src="/images/go/sync/http_client.png" alt="http.Client"></p>
<h3 id="5-2-TCP-连接池"><a href="#5-2-TCP-连接池" class="headerlink" title="5.2 TCP 连接池"></a>5.2 TCP 连接池</h3><p>最常用的一个 TCP 连接池是 fatih 开发的<a href="https://github.com/fatih/pool" target="_blank" rel="external">fatih/pool</a>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// 工厂模式，提供创建连接的工厂方法</span></div><div class="line">factory    := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(net.Conn, error)</span></span> &#123; <span class="keyword">return</span> net.Dial(<span class="string">"tcp"</span>, <span class="string">"127.0.0.1:4000"</span>) &#125;</div><div class="line"></div><div class="line"><span class="comment">// 创建一个tcp池，提供初始容量和最大容量以及工厂方法</span></div><div class="line">p, err := pool.NewChannelPool(<span class="number">5</span>, <span class="number">30</span>, factory)</div><div class="line"></div><div class="line"><span class="comment">// 获取一个连接</span></div><div class="line">conn, err := p.Get()</div><div class="line"></div><div class="line"><span class="comment">// Close并不会真正关闭这个连接，而是把它放回池子，所以你不必显式地Put这个对象到池子中</span></div><div class="line">conn.Close()</div><div class="line"></div><div class="line"><span class="comment">// 通过调用MarkUnusable, Close的时候就会真正关闭底层的tcp的连接了</span></div><div class="line"><span class="keyword">if</span> pc, ok := conn.(*pool.PoolConn); ok &#123;</div><div class="line">  pc.MarkUnusable()</div><div class="line">  pc.Close()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 关闭池子就会关闭=池子中的所有的tcp连接</span></div><div class="line">p.Close()</div><div class="line"></div><div class="line"><span class="comment">// 当前池子中的连接的数量</span></div><div class="line">current := p.Len()</div></pre></td></tr></table></figure>
<p>虽说是 TCP，但是它管理的是更通用的 net.Conn，不局限于 TCP 连接。它通过把 net.Conn 包装成 PoolConn，实现了拦截 net.Conn 的 Close 方法，避免了真正地关闭底层连接，而是把这个连接放回到池中。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  <span class="keyword">type</span> PoolConn <span class="keyword">struct</span> &#123;</div><div class="line">  net.Conn</div><div class="line">  mu       sync.RWMutex</div><div class="line">  c        *channelPool</div><div class="line">  unusable <span class="keyword">bool</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">  <span class="comment">//拦截Close</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *PoolConn)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">  p.mu.RLock()</div><div class="line">  <span class="keyword">defer</span> p.mu.RUnlock()</div><div class="line"></div><div class="line">  <span class="keyword">if</span> p.unusable &#123;</div><div class="line">    <span class="keyword">if</span> p.Conn != <span class="literal">nil</span> &#123;</div><div class="line">      <span class="keyword">return</span> p.Conn.Close()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> p.c.put(p.Conn)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>它的 Pool 是通过 Channel 实现的，空闲的连接放入到 Channel 中，这也是 Channel 的一个应用场景：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">type</span> channelPool <span class="keyword">struct</span> &#123;</div><div class="line">    <span class="comment">// 存储连接池的channel</span></div><div class="line">    mu    sync.RWMutex</div><div class="line">    conns <span class="keyword">chan</span> net.Conn</div><div class="line">  </div><div class="line"></div><div class="line">    <span class="comment">// net.Conn 的产生器</span></div><div class="line">    factory Factory</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h3 id="5-3-数据库连接池"><a href="#5-3-数据库连接池" class="headerlink" title="5.3 数据库连接池"></a>5.3 数据库连接池</h3><p>标准库 sql.DB 还提供了一个通用的数据库的连接池，通过 MaxOpenConns 和 MaxIdleConns 控制最大的连接数和最大的 idle 的连接数。默认的 MaxIdleConns 是 2，这个数对于数据库相关的应用来说太小了，我们一般都会调整它。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> DB</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">Open</span><span class="params">(driverName, dataSourceName <span class="keyword">string</span>)</span> <span class="params">(*DB, error)</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="title">OpenDB</span><span class="params">(c driver.Connector)</span> *<span class="title">DB</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">Begin</span><span class="params">()</span> <span class="params">(*Tx, error)</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">BeginTx</span><span class="params">(ctx context.Context, opts *TxOptions)</span> <span class="params">(*Tx, error)</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">Conn</span><span class="params">(ctx context.Context)</span> <span class="params">(*Conn, error)</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">Driver</span><span class="params">()</span> <span class="title">driver</span>.<span class="title">Driver</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">Exec</span><span class="params">(query <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(Result, error)</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">ExecContext</span><span class="params">(ctx context.Context, query <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(Result, error)</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">Ping</span><span class="params">()</span> <span class="title">error</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">PingContext</span><span class="params">(ctx context.Context)</span> <span class="title">error</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">Prepare</span><span class="params">(query <span class="keyword">string</span>)</span> <span class="params">(*Stmt, error)</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">PrepareContext</span><span class="params">(ctx context.Context, query <span class="keyword">string</span>)</span> <span class="params">(*Stmt, error)</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">Query</span><span class="params">(query <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(*Rows, error)</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">QueryContext</span><span class="params">(ctx context.Context, query <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(*Rows, error)</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">QueryRow</span><span class="params">(query <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">Row</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">QueryRowContext</span><span class="params">(ctx context.Context, query <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">Row</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">SetConnMaxIdleTime</span><span class="params">(d time.Duration)</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">SetConnMaxLifetime</span><span class="params">(d time.Duration)</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">SetMaxIdleConns</span><span class="params">(n <span class="keyword">int</span>)</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">SetMaxOpenConns</span><span class="params">(n <span class="keyword">int</span>)</span></span></div><div class="line"><span class="function">    <span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">Stats</span><span class="params">()</span> <span class="title">DBStats</span></span></div></pre></td></tr></table></figure>
<p>DB 的 <a href="https://github.com/golang/go/blob/4fc3896e7933e31822caa50e024d4e139befc75f/src/database/sql/sql.go#L1196" target="_blank" rel="external">freeConn</a> 保存了 idle 的连接，这样，当我们获取数据库连接的时候，它就会优先尝试从 freeConn 获取已有的连接（conn）。</p>
<p><img src="/images/go/sync/sql_db.png" alt="sql.DB"></p>
<h3 id="5-4-Memcached-Client-连接池"><a href="#5-4-Memcached-Client-连接池" class="headerlink" title="5.4 Memcached Client 连接池"></a>5.4 Memcached Client 连接池</h3><p>Brad Fitzpatrick 是知名缓存库 Memcached 的原作者，<a href="https://github.com/bradfitz/gomemcache" target="_blank" rel="external">gomemcache</a>是他使用 Go 开发的 Memchaced 的客户端，其中也用了连接池。</p>
<p>gomemcache Client 有一个 freeconn 的字段，用来保存空闲的连接。当一个请求使用完之后，它会调用 putFreeConn 放回到池子中，请求的时候，调用 getFreeConn 优先查询 freeConn 中是否有可用的连接。它采用 Mutex+Slice 实现 Pool：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"> <span class="comment">// 放回一个待重用的连接</span></div><div class="line"> <span class="function"><span class="keyword">func</span> <span class="params">(c *Client)</span> <span class="title">putFreeConn</span><span class="params">(addr net.Addr, cn *conn)</span></span> &#123;</div><div class="line">  c.lk.Lock()</div><div class="line">  <span class="keyword">defer</span> c.lk.Unlock()</div><div class="line">  <span class="keyword">if</span> c.freeconn == <span class="literal">nil</span> &#123; <span class="comment">// 如果对象为空，创建一个map对象</span></div><div class="line">    c.freeconn = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]*conn)</div><div class="line">  &#125;</div><div class="line">  freelist := c.freeconn[addr.String()] <span class="comment">//得到此地址的连接列表</span></div><div class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(freelist) &gt;= c.maxIdleConns() &#123;<span class="comment">//如果连接已满,关闭，不再放入</span></div><div class="line">    cn.nc.Close()</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line">  c.freeconn[addr.String()] = <span class="built_in">append</span>(freelist, cn) <span class="comment">// 加入到空闲列表中</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 得到一个空闲连接</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Client)</span> <span class="title">getFreeConn</span><span class="params">(addr net.Addr)</span> <span class="params">(cn *conn, ok <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">  c.lk.Lock()</div><div class="line">  <span class="keyword">defer</span> c.lk.Unlock()</div><div class="line">  <span class="keyword">if</span> c.freeconn == <span class="literal">nil</span> &#123; </div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></div><div class="line">  &#125;</div><div class="line">  freelist, ok := c.freeconn[addr.String()]</div><div class="line">  <span class="keyword">if</span> !ok || <span class="built_in">len</span>(freelist) == <span class="number">0</span> &#123; <span class="comment">// 没有此地址的空闲列表，或者列表为空</span></div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></div><div class="line">  &#125;</div><div class="line">  cn = freelist[<span class="built_in">len</span>(freelist)<span class="number">-1</span>] <span class="comment">// 取出尾部的空闲连接</span></div><div class="line">  c.freeconn[addr.String()] = freelist[:<span class="built_in">len</span>(freelist)<span class="number">-1</span>]</div><div class="line">  <span class="keyword">return</span> cn, <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="5-4-Worker-Pool"><a href="#5-4-Worker-Pool" class="headerlink" title="5.4 Worker Pool"></a>5.4 Worker Pool</h3><p>goroutine 是一个很轻量级的“纤程”，一个 goroutine 初始的栈大小是 2048 个字节，并且在需要的时候可以扩展到 1GB(<a href="https://github.com/golang/go/blob/f296b7a6f045325a230f77e9bda1470b1270f817/src/runtime/proc.go#L120" target="_blank" rel="external">不同架构的配置</a>)。</p>
<p>所以，大量的 goroutine 还是很耗资源的。同时，大量的 goroutine 对于调度和垃圾回收的耗时还是会有影响的，因此，goroutine 并不是越多越好。特别是在网络请求处理中，我们需要一个 Worker pool，即 goroutine 的池。由这一组 Worker 去处理连接，比如 <a href="https://github.com/valyala/fasthttp/blob/9f11af296864153ee45341d3f2fe0f5178fd6210/workerpool.go#L16" target="_blank" rel="external">fasthttp</a> 中的Worker Pool。</p>
<p>大部分的 Worker Pool 都是通过 Channel 来缓存任务的，因为 Channel 能够比较方便地实现并发的保护，有的是多个 Worker 共享同一个任务 Channel，有些是每个 Worker 都有一个独立的 Channel。</p>
<p>下面三款比较常用的 Worker Pool 库:</p>
<ol>
<li><a href="https://godoc.org/github.com/gammazero/workerpool" target="_blank" rel="external">gammazero/workerpool</a>：gammazero/workerpool 可以无限制地提交任务，提供了更便利的 Submit 和 SubmitWait 方法提交任务，还可以提供当前的 worker 数和任务数以及关闭 Pool 的功能。</li>
<li><a href="https://godoc.org/github.com/ivpusic/grpool" target="_blank" rel="external">ivpusic/grpool</a>：grpool 创建 Pool 的时候需要提供 Worker 的数量和等待执行的任务的最大数量，任务的提交是直接往 Channel 放入任务。</li>
<li><a href="https://godoc.org/github.com/dpaks/goworkers" target="_blank" rel="external">dpaks/goworkers</a>：dpaks/goworkers 提供了更便利的 Submi 方法提交任务以及 Worker 数、任务数等查询方法、关闭 Pool 的方法。它的任务的执行结果需要在 ResultChan 和 ErrChan 中去获取，没有提供阻塞的方法，但是它可以在初始化的时候设置 Worker 的数量和任务数。</li>
</ol>
<p>类似的 Worker Pool 的实现非常多，比如还有<a href="https://github.com/panjf2000/ants" target="_blank" rel="external">panjf2000/ants</a>、<a href="https://github.com/Jeffail/tunny" target="_blank" rel="external">Jeffail/tunny</a> 、<a href="https://github.com/benmanns/goworker" target="_blank" rel="external">benmanns/goworker</a>、<a href="https://github.com/go-playground/pool" target="_blank" rel="external">go-playground/pool</a>、<a href="https://github.com/Sherifabdlnaby/gpool" target="_blank" rel="external">Sherifabdlnaby/gpool</a>等第三方库。<a href="https://github.com/alitto/pond" target="_blank" rel="external">pond</a>也是一个非常不错的 Worker Pool，关注度目前不是很高，但是功能非常齐全。</p>

        </div>
        <!--  -->
        <footer class="article-footer">
            



    <a data-url="http://yoursite.com/2019/02/10/go/go_sync/go_sync_10/" data-id="ckminog8900dsmcu9nu6dv11u" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>



                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google-plus" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-google-plus"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2019/02/11/go/go_sync/go_sync_11/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            11 Context
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2019/02/09/go/go_sync/go_sync_9/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">9 线程安全的 map</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/03/21/redis/12_redis原理总结/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2021/03/21/redis/12_redis原理总结/" class="title"></a></p>
                            <p class="item-date"><time datetime="2021-03-21T04:20:55.555Z" itemprop="datePublished">2021-03-21</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/01/09/web/html_css/test/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2021/01/09/web/html_css/test/" class="title"></a></p>
                            <p class="item-date"><time datetime="2021-01-09T14:22:23.753Z" itemprop="datePublished">2021-01-09</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/01/01/go/go_design/go_design_1/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/01/01/go/go_design/go_design_1/" class="title">1 Go 设计模式</a></p>
                            <p class="item-date"><time datetime="2020-12-31T16:00:00.000Z" itemprop="datePublished">2021-01-01</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/12/01/go/go_module/go_module_1/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2020/12/01/go/go_module/go_module_1/" class="title">1 go 标准库和第三方库入门</a></p>
                            <p class="item-date"><time datetime="2020-11-30T16:00:00.000Z" itemprop="datePublished">2020-12-01</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/12/01/go/go_module/go_module_2/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2020/12/01/go/go_module/go_module_2/" class="title">2 文件 IO 和字符操作</a></p>
                            <p class="item-date"><time datetime="2020-11-30T16:00:00.000Z" itemprop="datePublished">2020-12-01</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">35</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">56</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式/">分布式</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储/">存储</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">188</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">25</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">32</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">31</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">21</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">26</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">48</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">31</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">29</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">4</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Brendan-Gregg/">Brendan Gregg</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/">ES6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML-CSS/">HTML&CSS</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript-入门/">JavaScript 入门</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8S/">K8S</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/">Kafka</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux性能调优/">Linux性能调优</a><span class="tag-list-count">49</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL实战45讲/">MySQL实战45讲</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/">React</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/">Vue</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go并发编程/">go并发编程</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go标准库及第三方库/">go标准库及第三方库</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go语言入门/">go语言入门</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wrapt/">wrapt</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/入门指南/">入门指南</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据密集型应用/">数据密集型应用</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构与算法/">数据结构与算法</a><span class="tag-list-count">39</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/极客时间/">极客时间</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马哥-Linux/">马哥 Linux</a><span class="tag-list-count">135</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马哥-MySQL-运维/">马哥 MySQL 运维</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高性能的MySQL/">高性能的MySQL</a><span class="tag-list-count">5</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/Brendan-Gregg/" style="font-size: 10px;">Brendan Gregg</a> <a href="/tags/ES6/" style="font-size: 15px;">ES6</a> <a href="/tags/HTML-CSS/" style="font-size: 12.86px;">HTML&CSS</a> <a href="/tags/JavaScript/" style="font-size: 14.29px;">JavaScript</a> <a href="/tags/JavaScript-入门/" style="font-size: 10px;">JavaScript 入门</a> <a href="/tags/K8S/" style="font-size: 10px;">K8S</a> <a href="/tags/Kafka/" style="font-size: 15.71px;">Kafka</a> <a href="/tags/Linux性能调优/" style="font-size: 19.29px;">Linux性能调优</a> <a href="/tags/MySQL实战45讲/" style="font-size: 17.86px;">MySQL实战45讲</a> <a href="/tags/React/" style="font-size: 15px;">React</a> <a href="/tags/Vue/" style="font-size: 15px;">Vue</a> <a href="/tags/go并发编程/" style="font-size: 17.14px;">go并发编程</a> <a href="/tags/go标准库及第三方库/" style="font-size: 10.71px;">go标准库及第三方库</a> <a href="/tags/go语言入门/" style="font-size: 14.29px;">go语言入门</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/python/" style="font-size: 11.43px;">python</a> <a href="/tags/wrapt/" style="font-size: 16.43px;">wrapt</a> <a href="/tags/入门指南/" style="font-size: 14.29px;">入门指南</a> <a href="/tags/数据密集型应用/" style="font-size: 15px;">数据密集型应用</a> <a href="/tags/数据结构与算法/" style="font-size: 18.57px;">数据结构与算法</a> <a href="/tags/极客时间/" style="font-size: 17.86px;">极客时间</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a> <a href="/tags/马哥-Linux/" style="font-size: 20px;">马哥 Linux</a> <a href="/tags/马哥-MySQL-运维/" style="font-size: 13.57px;">马哥 MySQL 运维</a> <a href="/tags/高性能的MySQL/" style="font-size: 12.14px;">高性能的MySQL</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">讨论区</h3>
        <div class="widget">
            <h4> 联系我 <h4>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2021 宋涛</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'http://yoursite.com/2019/02/10/go/go_sync/go_sync_10/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
