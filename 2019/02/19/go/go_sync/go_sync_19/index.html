<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    

    
    <title>19 分组操作 | 宋涛的博客</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="go并发编程" />
    
    <meta name="description" content="分组操作">
<meta name="keywords" content="go并发编程">
<meta property="og:type" content="article">
<meta property="og:title" content="19 分组操作">
<meta property="og:url" content="http://yoursite.com/2019/02/19/go/go_sync/go_sync_19/index.html">
<meta property="og:site_name" content="宋涛的博客">
<meta property="og:description" content="分组操作">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/go/sync/bilibili_errgroup.png">
<meta property="og:updated_time" content="2021-01-02T01:41:25.504Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="19 分组操作">
<meta name="twitter:description" content="分组操作">
<meta name="twitter:image" content="http://yoursite.com/images/go/sync/bilibili_errgroup.png">
    

    
        <link rel="alternate" href="/" title="宋涛的博客" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/3.3.1/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    


</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">漫步在大陆上的海龟</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Go/">Go</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Python/">Python</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/分布式/">分布式</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/前端/">前端</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/存储/">存储</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/运维/">运维</a></li></ul>
                                    
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/Go/">Go</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-go/go_sync/go_sync_19" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        19 分组操作
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2019/02/19/go/go_sync/go_sync_19/" class="article-date">
            <time datetime="2019-02-18T16:00:00.000Z" itemprop="datePublished">2019-02-19</time>
        </a>
    </div>

		

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/go并发编程/">go并发编程<span class="tag-count">21</span></a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p>分组操作<br><a id="more"></a></p>
<h2 id="1-分组操作概述"><a href="#1-分组操作概述" class="headerlink" title="1. 分组操作概述"></a>1. 分组操作概述</h2><p>共享资源保护、任务编排和消息传递是 Go 并发编程中常见的场景，而分组执行一批相同的或类似的任务则是任务编排中一类情形，本节我们来介绍一下分组编排的一些常见场景和并发原语，包括:</p>
<ol>
<li>ErrGroup</li>
<li>gollback</li>
<li>Hunch</li>
<li>schedgroup</li>
</ol>
<h2 id="2-ErrGroup"><a href="#2-ErrGroup" class="headerlink" title="2. ErrGroup"></a>2. ErrGroup</h2><p><a href="https://github.com/golang/sync/tree/master/errgroup" target="_blank" rel="external">ErrGroup</a>:</p>
<ul>
<li>包位置: <code>golang.org/x/sync/errgroup</code></li>
<li>适用场景: 将一个通用的父任务拆成几个小任务并发执行的场景</li>
<li>底层实现: 基于 WaitGroup</li>
<li>提供功能:<ul>
<li>和 Context 集成</li>
<li>error 向上传播，可以把子任务的错误传递给 Wait 的调用者</li>
</ul>
</li>
</ul>
<h3 id="2-1-基本用法"><a href="#2-1-基本用法" class="headerlink" title="2.1 基本用法"></a>2.1 基本用法</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> errgroup</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"context"</span></div><div class="line">	<span class="string">"sync"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// A Group is a collection of goroutines working on subtasks that are part of</span></div><div class="line"><span class="comment">// the same overall task.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// A zero Group is valid and does not cancel on error.</span></div><div class="line"><span class="keyword">type</span> Group <span class="keyword">struct</span> &#123;</div><div class="line">	cancel <span class="function"><span class="keyword">func</span><span class="params">()</span></span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function">	<span class="title">wg</span> <span class="title">sync</span>.<span class="title">WaitGroup</span></span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function">	<span class="title">errOnce</span> <span class="title">sync</span>.<span class="title">Once</span></span></div><div class="line"><span class="function">	<span class="title">err</span>     <span class="title">error</span></span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function">// <span class="title">WithContext</span> <span class="title">returns</span> <span class="title">a</span> <span class="title">new</span> <span class="title">Group</span> <span class="title">and</span> <span class="title">an</span> <span class="title">associated</span> <span class="title">Context</span> <span class="title">derived</span> <span class="title">from</span> <span class="title">ctx</span>.</span></div><div class="line"><span class="function">//</span></div><div class="line"><span class="function">// <span class="title">The</span> <span class="title">derived</span> <span class="title">Context</span> <span class="title">is</span> <span class="title">canceled</span> <span class="title">the</span> <span class="title">first</span> <span class="title">time</span> <span class="title">a</span> <span class="title">function</span> <span class="title">passed</span> <span class="title">to</span> <span class="title">Go</span></span></div><div class="line"><span class="function">// <span class="title">returns</span> <span class="title">a</span> <span class="title">non</span>-<span class="title">nil</span> <span class="title">error</span> <span class="title">or</span> <span class="title">the</span> <span class="title">first</span> <span class="title">time</span> <span class="title">Wait</span> <span class="title">returns</span>, <span class="title">whichever</span> <span class="title">occurs</span></span></div><div class="line"><span class="function">// <span class="title">first</span>.</span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">WithContext</span><span class="params">(ctx context.Context)</span> <span class="params">(*Group, context.Context)</span></span> &#123;</div><div class="line">	ctx, cancel := context.WithCancel(ctx)</div><div class="line">	<span class="keyword">return</span> &amp;Group&#123;cancel: cancel&#125;, ctx</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Wait blocks until all function calls from the Go method have returned, then</span></div><div class="line"><span class="comment">// returns the first non-nil error (if any) from them.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *Group)</span> <span class="title">Wait</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	g.wg.Wait()</div><div class="line">	<span class="keyword">if</span> g.cancel != <span class="literal">nil</span> &#123;</div><div class="line">		g.cancel()</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> g.err</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Go calls the given function in a new goroutine.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// The first call to return a non-nil error cancels the group; its error will be</span></div><div class="line"><span class="comment">// returned by Wait.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *Group)</span> <span class="title">Go</span><span class="params">(f <span class="keyword">func</span>()</span> <span class="title">error</span>)</span> &#123;</div><div class="line">	g.wg.Add(<span class="number">1</span>)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">defer</span> g.wg.Done()</div><div class="line"></div><div class="line">		<span class="keyword">if</span> err := f(); err != <span class="literal">nil</span> &#123;</div><div class="line">			g.errOnce.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">				g.err = err</div><div class="line">				<span class="keyword">if</span> g.cancel != <span class="literal">nil</span> &#123;</div><div class="line">					g.cancel()</div><div class="line">				&#125;</div><div class="line">			&#125;)</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ErrGroup 有三个方法分别是 WithContext、Go 和 Wait。</p>
<p>WithContext:</p>
<ul>
<li>作用: 创建一个 Group 对象</li>
<li>签名: <code>func WithContext(ctx context.Context) (*Group, context.Context)</code></li>
<li>返回: Group 实例和使用 context.WithCancel(ctx) 生成的新 Context，一旦有一个子任务返回错误，或者 Wait 调用返回，新的 Context 就会被 cancel</li>
<li>注意:<ul>
<li>Group 的零值也是合法的，只不过，你就没有一个可以监控是否 cancel 的 Context 了</li>
<li>如果传递给 WithContext 的 ctx 参数，是一个可以 cancel 的 Context 的话，那么，它被 cancel 的时候，并不会终止正在执行的子任务</li>
</ul>
</li>
</ul>
<p>Go 方法:</p>
<ul>
<li>作用: 执行子任务</li>
<li>签名: <code>func (g *Group) Go(f func() error)</code></li>
<li>执行: 子任务函数 f 是类型为 func() error 的函数，如果任务执行成功，就返回 nil，否则就返回 error，并且会 cancel 那个新的 Context</li>
<li>注意: <ul>
<li>可能有多个子任务执行失败返回 error，Wait 方法只会返回第一个错误，所以，如果想返回所有的错误，需要特别的处理</li>
<li>处理方式是使用全局的 result slice 保存子任务的执行结果</li>
</ul>
</li>
</ul>
<p>Wait:</p>
<ul>
<li>作用: 所有的子任务都完成后，它才会返回，否则只会阻塞等待</li>
<li>签名: <code>func (g *Group) Wait() error</code></li>
<li>返回: 如果有多个子任务返回错误，它只会返回第一个出现的错误，如果所有的子任务都执行成功，就返回 nil</li>
</ul>
<h3 id="2-2-使用示例"><a href="#2-2-使用示例" class="headerlink" title="2.2 使用示例"></a>2.2 使用示例</h3><p>使用 20 goroutine 计算传入目录下所有文件的 md5 值:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure>
<h3 id="2-3-bilibili-ErrGroup-扩展"><a href="#2-3-bilibili-ErrGroup-扩展" class="headerlink" title="2.3 bilibili ErrGroup 扩展"></a>2.3 bilibili ErrGroup 扩展</h3><p>如果我们无限制地直接调用 ErrGroup 的 Go 方法，就可能会创建出非常多的 goroutine，太多的 goroutine 会带来调度和 GC 的压力，就像<a href="https://github.com/golang/go/issues/34457" target="_blank" rel="external">go#34457</a>指出的那样，当前 Go 运行时创建的 g 对象只会增长和重用，不会回收，所以在高并发的情况下，也要尽可能减少 goroutine 的使用。</p>
<p>常用的一个手段就是使用 worker pool(goroutine pool)，或者是类似<a href="https://github.com/containerd/stargz-snapshotter/pull/157" target="_blank" rel="external">containerd/stargz-snapshotter</a>的方案，使用前面我们讲的信号量，信号量的资源的数量就是可以并行的 goroutine 的数量。</p>
<p>bilibili 实现了一个扩展的 ErrGroup <a href="https://godoc.org/github.com/bilibili/kratos/pkg/sync/errgroup" target="_blank" rel="external">bilibili/errgroup</a>，可以使用一个固定数量的 goroutine 处理子任务。如果不设置 goroutine 的数量，那么每个子任务都会比较“放肆地”创建一个 goroutine 并发执行。</p>
<p>除了可以控制并发 goroutine 的数量，它还提供了 2 个功能：</p>
<ol>
<li>cancel，失败的子任务可以 cancel 所有正在执行任务；</li>
<li>recover，而且会把 panic 的堆栈信息放到 error 中，避免子任务 panic 导致的程序崩溃。</li>
</ol>
<p>是，有一点不太好的地方就是，一旦你设置了并发数，超过并发数的子任务需要等到调用者调用 Wait 之后才会执行，而不是只要 goroutine 空闲下来，就去执行。如果不注意这一点的话，可能会出现子任务不能及时处理的情况，这是这个库可以优化的一点。</p>
<p>另外，这个库其实是有一个并发问题的。在高并发的情况下，如果任务数大于设定的 goroutine 的数量，并且这些任务被集中加入到 Group 中，这个库的处理方式是把子任务加入到一个数组中，但是，这个数组不是线程安全的，有并发问题，问题就在于，下面图片中的标记为 96 行的那一行，这一行对 slice 的 append 操作不是线程安全的：</p>
<p><img src="/images/go/sync/bilibili_errgroup.png" alt="bilibili_errgroup"></p>
<p>我们可以写一个简单的测试程序，运行这个程序的话，你就会发现死锁问题</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"context"</span></div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"sync/atomic"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line"></div><div class="line">    <span class="string">"github.com/bilibili/kratos/pkg/sync/errgroup"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> g errgroup.Group</div><div class="line">    g.GOMAXPROCS(<span class="number">1</span>) <span class="comment">// 只使用一个goroutine处理子任务</span></div><div class="line"></div><div class="line">    <span class="keyword">var</span> count <span class="keyword">int64</span></div><div class="line">    g.Go(<span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span> <span class="title">error</span></span> &#123;</div><div class="line">        time.Sleep(time.Second) <span class="comment">//睡眠5秒，把这个goroutine占住</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">    &#125;)</div><div class="line"></div><div class="line">    total := <span class="number">10000</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; total; i++ &#123; <span class="comment">// 并发一万个goroutine执行子任务，理论上这些子任务都会加入到Group的待处理列表中</span></div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            g.Go(<span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span> <span class="title">error</span></span> &#123;</div><div class="line">                atomic.AddInt64(&amp;count, <span class="number">1</span>)</div><div class="line">                <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">            &#125;)</div><div class="line">        &#125;()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 等待所有的子任务完成。理论上10001个子任务都会被完成</span></div><div class="line">    <span class="keyword">if</span> err := g.Wait(); err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="built_in">panic</span>(err)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    got := atomic.LoadInt64(&amp;count)</div><div class="line">    <span class="keyword">if</span> got != <span class="keyword">int64</span>(total) &#123;</div><div class="line">        <span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"expect %d but got %d"</span>, total, got))</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-4-neilotoole-errgroup-扩展"><a href="#2-4-neilotoole-errgroup-扩展" class="headerlink" title="2.4 neilotoole/errgroup 扩展"></a>2.4 neilotoole/errgroup 扩展</h3><p><a href="https://github.com/neilotoole/errgroup" target="_blank" rel="external">neilotoole/errgroup</a> 是今年年中新出现的一个 ErrGroup 扩展库，它可以直接替换官方的 ErrGroup，方法都一样，原有功能也一样，只不过增加了可以控制并发 goroutine 的功能。它的方法集如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Group</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">WithContext</span><span class="params">(ctx context.Context)</span> <span class="params">(*Group, context.Context)</span></span></div><div class="line"><span class="function">  <span class="title">func</span> <span class="title">WithContextN</span><span class="params">(ctx context.Context, numG, qSize <span class="keyword">int</span>)</span> <span class="params">(*Group, context.Context)</span></span></div><div class="line"><span class="function">  <span class="title">func</span> <span class="params">(g *Group)</span> <span class="title">Go</span><span class="params">(f <span class="keyword">func</span>()</span> <span class="title">error</span>)</span></div><div class="line"><span class="function">  <span class="title">func</span> <span class="params">(g *Group)</span> <span class="title">Wait</span><span class="params">()</span> <span class="title">error</span></span></div></pre></td></tr></table></figure>
<p>新增加的方法 WithContextN，可以设置并发的 goroutine 数，以及等待处理的子任务队列的大小。当队列满的时候，如果调用 Go 方法，就会被阻塞，直到子任务可以放入到队列中才返回。如果你传给这两个参数的值不是正整数，它就会使用 runtime.NumCPU 代替你传入的参数。</p>
<h3 id="2-5-facebookgo-errgroup"><a href="#2-5-facebookgo-errgroup" class="headerlink" title="2.5 facebookgo/errgroup"></a>2.5 facebookgo/errgroup</h3><p><a href="https://github.com/facebookarchive/errgroup" target="_blank" rel="external">facebookgo/errgroup</a> Facebook 提供的这个 ErrGroup，其实并不是对 Go 扩展库 ErrGroup 的扩展，而是对标准库 WaitGroup 的扩展。</p>
<p>标准库的 WaitGroup 只提供了 Add、Done、Wait 方法，而且 Wait 方法也没有返回子 goroutine 的 error。而 Facebook 提供的 ErrGroup 提供的 Wait 方法可以返回 error，而且可以包含多个 error。子任务在调用 Done 之前，可以把自己的 error 信息设置给 ErrGroup。接着，Wait 在返回的时候，就会把这些 error 信息返回给调用者。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Group</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="params">(g *Group)</span> <span class="title">Add</span><span class="params">(delta <span class="keyword">int</span>)</span></span></div><div class="line"><span class="function">  <span class="title">func</span> <span class="params">(g *Group)</span> <span class="title">Done</span><span class="params">()</span></span></div><div class="line"><span class="function">  <span class="title">func</span> <span class="params">(g *Group)</span> <span class="title">Error</span><span class="params">(e error)</span> // 设置 <span class="title">error</span> 给 <span class="title">ErrorGroup</span>，<span class="title">Wait</span> 返回时会返回这些 <span class="title">error</span></span></div><div class="line"><span class="function">  <span class="title">func</span> <span class="params">(g *Group)</span> <span class="title">Wait</span><span class="params">()</span> <span class="title">error</span></span></div></pre></td></tr></table></figure>
<h2 id="3-其他分组执行的并发原语"><a href="#3-其他分组执行的并发原语" class="headerlink" title="3. 其他分组执行的并发原语"></a>3. 其他分组执行的并发原语</h2><p>下面这些并发原语都是控制一组子 goroutine 执行的面向特定场景的并发原语，当你遇见这些特定场景时，就可以参考这些库。</p>
<h3 id="3-1-go-pkgz-syncs"><a href="#3-1-go-pkgz-syncs" class="headerlink" title="3.1 go-pkgz/syncs"></a>3.1 go-pkgz/syncs</h3><p><a href="https://github.com/go-pkgz/syncs" target="_blank" rel="external">go-pkgz/syncs</a> 提供了两个 Group 并发原语，分别是 SizedGroup 和 ErrSizedGroup:</p>
<h4 id="SizedGroup"><a href="#SizedGroup" class="headerlink" title="SizedGroup"></a>SizedGroup</h4><p>SizedGroup 内部是使用信号量和 WaitGroup 实现的，它通过信号量控制并发的 goroutine 数量，或者是不控制 goroutine 数量，只控制子任务并发执行时候的数量（通过）。</p>
<p>默认情况下，SizedGroup 控制的是子任务的并发数量，而不是 goroutine 的数量。在这种方式下，每次调用 Go 方法都不会被阻塞，而是新建一个 goroutine 去执行。如果想控制 goroutine 的数量，你可以使用 syncs.Preemptive 设置这个并发原语的可选项。如果设置了这个可选项，但在调用 Go 方法的时候没有可用的 goroutine，那么调用者就会等待，直到有 goroutine 可以处理这个子任务才返回，这个控制在内部是使用信号量实现的。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"context"</span></div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"sync/atomic"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line"></div><div class="line">    <span class="string">"github.com/go-pkgz/syncs"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// 设置goroutine数是10</span></div><div class="line">    swg := syncs.NewSizedGroup(<span class="number">10</span>)</div><div class="line">    <span class="comment">// swg := syncs.NewSizedGroup(10, syncs.Preemptive)</span></div><div class="line">    <span class="keyword">var</span> c <span class="keyword">uint32</span></div><div class="line"></div><div class="line">    <span class="comment">// 执行1000个子任务，只会有10个goroutine去执行</span></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</div><div class="line">        swg.Go(<span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span></span> &#123;</div><div class="line">            time.Sleep(<span class="number">5</span> * time.Millisecond)</div><div class="line">            atomic.AddUint32(&amp;c, <span class="number">1</span>)</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 等待任务完成</span></div><div class="line">    swg.Wait()</div><div class="line">    <span class="comment">// 输出结果</span></div><div class="line">    fmt.Println(c)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ErrSizedGroup"><a href="#ErrSizedGroup" class="headerlink" title="ErrSizedGroup"></a>ErrSizedGroup</h4><p>ErrSizedGroup 为 SizedGroup 提供了 error 处理的功能，它的功能和 Go 官方扩展库的功能一样，就是等待子任务完成并返回第一个出现的 error。不过，它还提供了额外的功能</p>
<ol>
<li>可以控制并发的 goroutine 数量，这和 SizedGroup 的功能一样</li>
<li>如果设置了 termOnError，子任务出现第一个错误的时候会 cancel Context，而且后续的 Go 调用会直接返回，Wait 调用者会得到这个错误，这相当于是遇到错误快速返回。如果没有设置 termOnError，Wait 会返回所有的子任务的错误</li>
</ol>
<p>不过，ErrSizedGroup 和 SizedGroup 设计得不太一致的地方是，SizedGroup 可以把 Context 传递给子任务，这样可以通过 cancel 让子任务中断执行，但是 ErrSizedGroup 却没有实现</p>
<h3 id="3-2-gollback"><a href="#3-2-gollback" class="headerlink" title="3.2 gollback"></a>3.2 gollback</h3><p><a href="https://github.com/vardius/gollback" target="_blank" rel="external">gollback</a>也是用来处理一组子任务的执行的，不过它解决了 ErrGroup 收集子任务返回结果的痛点。它的方法会把结果和 error 信息都返回。</p>
<p>gollback 提供了如下三个方法: All, Race, Retry</p>
<h4 id="All"><a href="#All" class="headerlink" title="All"></a>All</h4><p>All:</p>
<ul>
<li>签名: <code>func All(ctx context.Context, fns ...AsyncFunc) ([]interface{}, []error)</code></li>
<li>执行: 它会等待所有的异步函数（AsyncFunc）都执行完才返回，而且返回结果的顺序和传入的函数的顺序保持一致。</li>
<li>返回: 第一个返回参数是子任务的执行结果，第二个参数是子任务执行时的错误信息</li>
<li>异步函数: <ul>
<li><code>type AsyncFunc func(ctx context.Context) (interface{}, error)</code></li>
<li>ctx 会被传递给子任务。如果你 cancel 这个 ctx，可以取消子任务</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">  <span class="string">"context"</span></div><div class="line">  <span class="string">"errors"</span></div><div class="line">  <span class="string">"fmt"</span></div><div class="line">  <span class="string">"github.com/vardius/gollback"</span></div><div class="line">  <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">  rs, errs := gollback.All( <span class="comment">// 调用All方法</span></div><div class="line">    context.Background(),</div><div class="line">    <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123; </div><div class="line">      time.Sleep(<span class="number">3</span> * time.Second)</div><div class="line">      <span class="keyword">return</span> <span class="number">1</span>, <span class="literal">nil</span> <span class="comment">// 第一个任务没有错误，返回1</span></div><div class="line">    &#125;,</div><div class="line">    <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</div><div class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"failed"</span>) <span class="comment">// 第二个任务返回一个错误</span></div><div class="line">    &#125;,</div><div class="line">    <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</div><div class="line">      <span class="keyword">return</span> <span class="number">3</span>, <span class="literal">nil</span> <span class="comment">// 第三个任务没有错误，返回3</span></div><div class="line">    &#125;,</div><div class="line">  )</div><div class="line"></div><div class="line">  fmt.Println(rs) <span class="comment">// 输出子任务的结果</span></div><div class="line">  fmt.Println(errs) <span class="comment">// 输出子任务的错误信息</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Race"><a href="#Race" class="headerlink" title="Race"></a>Race</h4><p>Race:</p>
<ul>
<li>签名: <code>func Race(ctx context.Context, fns ...AsyncFunc) (interface{}, error)</code></li>
<li>返回: 跟 All 方法类似，只不过，在使用 Race 方法的时候，只要一个异步函数执行没有错误，就立马返回，而不会返回所有的子任务信息。如果所有的子任务都没有成功，就会返回最后一个 error 信息</li>
<li>注意: 如果有一个正常的子任务的结果返回，Race 会把传入到其它子任务的 Context cancel 掉，这样子任务就可以中断自己的执行</li>
</ul>
<h4 id="Retry"><a href="#Retry" class="headerlink" title="Retry"></a>Retry</h4><p>Retry:</p>
<ul>
<li>签名: <code>func Retry(ctx context.Context, retires int, fn AsyncFunc) (interface{}, error)</code></li>
<li>作用: Retry 不是执行一组子任务，而是执行一个子任务</li>
<li>返回:<ul>
<li>如果子任务执行失败，它会尝试一定的次数，</li>
<li>如果一直不成功 ，就会返回失败错误  </li>
<li>如果执行成功，它会立即返回</li>
<li>如果 retires 等于 0，它会永远尝试，直到成功</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">  <span class="string">"context"</span></div><div class="line">  <span class="string">"errors"</span></div><div class="line">  <span class="string">"fmt"</span></div><div class="line">  <span class="string">"github.com/vardius/gollback"</span></div><div class="line">  <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">  ctx, cancel := context.WithTimeout(context.Background(), <span class="number">5</span>*time.Second)</div><div class="line">  <span class="keyword">defer</span> cancel()</div><div class="line"></div><div class="line">  <span class="comment">// 尝试5次，或者超时返回</span></div><div class="line">  res, err := gollback.Retry(ctx, <span class="number">5</span>, <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"failed"</span>)</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  fmt.Println(res) <span class="comment">// 输出结果</span></div><div class="line">  fmt.Println(err) <span class="comment">// 输出错误信息</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-3-Hunch"><a href="#3-3-Hunch" class="headerlink" title="3.3 Hunch"></a>3.3 Hunch</h3><p><a href="https://github.com/AaronJan/Hunch" target="_blank" rel="external">Hunch</a> 提供的功能和 gollback 类似，不过它提供的方法更多包括:</p>
<ol>
<li>All</li>
<li>Take</li>
<li>Last</li>
<li>Retry</li>
<li>Waterfall</li>
</ol>
<p>它定义了执行子任务的函数，这和 gollback 的 AyncFunc 是一样的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Executable <span class="function"><span class="keyword">func</span><span class="params">(context.Context)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span></div></pre></td></tr></table></figure>
<h4 id="All-1"><a href="#All-1" class="headerlink" title="All"></a>All</h4><p>All:</p>
<ul>
<li>签名: <code>func All(parentCtx context.Context, execs ...Executable) ([]interface{}, error)</code></li>
<li>作用: 传入一组可执行的函数（子任务），返回子任务的执行结果</li>
<li>区别: 和 gollback 的 All 方法不一样的是，一旦一个子任务出现错误，它就会返回错误信息，执行结果（第一个返回参数）为 nil。</li>
</ul>
<h4 id="Take"><a href="#Take" class="headerlink" title="Take"></a>Take</h4><p>Take:</p>
<ul>
<li>签名: <code>func Take(parentCtx context.Context, num int, execs ...Executable) ([]interface{}, error)</code></li>
<li>作用: <ul>
<li>可以指定 num 参数，只要有 num 个子任务正常执行完没有错误，这个方法就会返回这几个子任务的结果</li>
<li>一旦一个子任务出现错误，它就会返回错误信息，执行结果（第一个返回参数）为 nil。</li>
</ul>
</li>
</ul>
<h4 id="Last"><a href="#Last" class="headerlink" title="Last"></a>Last</h4><p>Last:</p>
<ul>
<li>签名: <code>func Last(parentCtx context.Context, num int, execs ...Executable) ([]interface{}, error)</code></li>
<li>作用: <ul>
<li>只返回最后 num 个正常执行的、没有错误的子任务的结果</li>
<li>一旦一个子任务出现错误，它就会返回错误信息，执行结果（第一个返回参数）为 nil</li>
</ul>
</li>
</ul>
<h4 id="Retry-1"><a href="#Retry-1" class="headerlink" title="Retry"></a>Retry</h4><p>Retry:</p>
<ul>
<li>签名: <code>func Retry(parentCtx context.Context, retries int, fn Executable) (interface{}, error)</code></li>
<li>作用: <ul>
<li>它的功能和 gollback 的 Retry 方法的功能一样，如果子任务执行出错，就会不断尝试，直到成功或者是达到重试上限。</li>
<li>如果达到重试上限，就会返回错误</li>
<li>如果 retries 等于 0，它会不断尝试</li>
</ul>
</li>
</ul>
<h4 id="Waterfall"><a href="#Waterfall" class="headerlink" title="Waterfall"></a>Waterfall</h4><p>Waterfall:</p>
<ul>
<li>签名: <code>func Waterfall(parentCtx context.Context, execs ...ExecutableInSequence) (interface{}, error)</code></li>
<li>作用: <ul>
<li>它其实是一个 pipeline 的处理方式，所有的子任务都是串行执行的，</li>
<li>前一个子任务的执行结果会被当作参数传给下一个子任务，直到所有的任务都完成，返回最后的执行结果</li>
<li>一旦一个子任务出现错误，它就会返回错误信息，执行结果（第一个返回参数）为 nil</li>
</ul>
</li>
</ul>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>gollback 和 Hunch 是属于同一类的并发原语，对一组子任务的执行结果，可以选择一个结果或者多个结果</p>
<h3 id="3-4-schedgroup"><a href="#3-4-schedgroup" class="headerlink" title="3.4 schedgroup"></a>3.4 schedgroup</h3><p><a href="https://github.com/mdlayher/schedgroup" target="_blank" rel="external">schedgroup</a> 是一个和时间相关的处理一组 goroutine 的并发原语，是 Matt Layher 开发的 worker pool，可以指定任务在某个时间或者某个时间之后执行。他在 GopherCon Europe 2020 大会上专门介绍了这个并发原语：<a href="https://talks.godoc.org/github.com/mdlayher/talks/conferences/2020/gopherconeu/schedgroup.slide" target="_blank" rel="external">schedgroup: a timer-based goroutine concurrency primitive</a> </p>
<p>schedgroup 包含的方法如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">type</span> Group</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(ctx context.Context)</span> *<span class="title">Group</span></span></div><div class="line"><span class="function">  <span class="title">func</span> <span class="params">(g *Group)</span> <span class="title">Delay</span><span class="params">(delay time.Duration, fn <span class="keyword">func</span>()</span>)</span></div><div class="line"><span class="function">  <span class="title">func</span> <span class="params">(g *Group)</span> <span class="title">Schedule</span><span class="params">(when time.Time, fn <span class="keyword">func</span>()</span>)</span></div><div class="line"><span class="function">  <span class="title">func</span> <span class="params">(g *Group)</span> <span class="title">Wait</span><span class="params">()</span> <span class="title">error</span></span></div></pre></td></tr></table></figure>
<ol>
<li>Delay 和 Schedule: 功能其实是一样的，都是用来指定在某个时间或者之后执行一个函数。</li>
<li>Wait: 会阻塞调用者，直到之前安排的所有子任务都执行完才返回。如果 Context 被取消，那么，Wait 方法会返回这个 cancel error<ul>
<li>如果调用了 Wait 方法，你就不能再调用它的 Delay 和 Schedule 方法，否则会 panic。</li>
<li>Wait 方法只能调用一次，如果多次调用的话，就会 panic</li>
</ul>
</li>
</ol>
<p>你可能认为，简单地使用 timer 就可以实现这个功能。其实，如果只有几个子任务，使用 timer 不是问题，但一旦有大量的子任务，而且还要能够 cancel，那么，使用 timer 的话，CPU 资源消耗就比较大了。所以，schedgroup 在实现的时候，就使用 container/heap，按照子任务的执行时间进行排序，这样可以避免使用大量的 timer，从而提高性能。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">sg := schedgroup.New(context.Background())</div><div class="line"></div><div class="line"><span class="comment">// 设置子任务分别在100、200、300之后执行</span></div><div class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</div><div class="line">    n := i + <span class="number">1</span></div><div class="line">    sg.Delay(time.Duration(n)*<span class="number">100</span>*time.Millisecond, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        log.Println(n) <span class="comment">//输出任务编号</span></div><div class="line">    &#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 等待所有的子任务都完成</span></div><div class="line"><span class="keyword">if</span> err := sg.Wait(); err != <span class="literal">nil</span> &#123;</div><div class="line">    log.Fatalf(<span class="string">"failed to wait: %v"</span>, err)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-5-go-waitgroup"><a href="#3-5-go-waitgroup" class="headerlink" title="3.5 go-waitgroup"></a>3.5 go-waitgroup</h3><p><a href="https://github.com/pieterclaerhout/go-waitgroup" target="_blank" rel="external">go-waitgroup</a></p>

        </div>
        <!--  -->
        <footer class="article-footer">
            



    <a data-url="http://yoursite.com/2019/02/19/go/go_sync/go_sync_19/" data-id="ckln7ltt700czmwu9twhv2g5l" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>



                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google-plus" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-google-plus"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2019/02/20/go/go_sync/go_sync_20/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            20 分布式并发原语一
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2019/02/18/go/go_sync/go_sync_18/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">18 CyclicBarrier 循环栅栏</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/01/09/web/html_css/test/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2021/01/09/web/html_css/test/" class="title"></a></p>
                            <p class="item-date"><time datetime="2021-01-09T14:22:23.753Z" itemprop="datePublished">2021-01-09</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/01/01/go/go_design/go_design_1/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/01/01/go/go_design/go_design_1/" class="title">1 Go 设计模式</a></p>
                            <p class="item-date"><time datetime="2020-12-31T16:00:00.000Z" itemprop="datePublished">2021-01-01</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/12/01/go/go_module/go_module_1/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2020/12/01/go/go_module/go_module_1/" class="title">1 go 标准库和第三方库入门</a></p>
                            <p class="item-date"><time datetime="2020-11-30T16:00:00.000Z" itemprop="datePublished">2020-12-01</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/12/01/go/go_module/go_module_2/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2020/12/01/go/go_module/go_module_2/" class="title">2 文件 IO 和字符操作</a></p>
                            <p class="item-date"><time datetime="2020-11-30T16:00:00.000Z" itemprop="datePublished">2020-12-01</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/11/15/web/react/react_15/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/前端/">前端</a></p>
                            <p class="item-title"><a href="/2020/11/15/web/react/react_15/" class="title">15 react 项目实战</a></p>
                            <p class="item-date"><time datetime="2020-11-14T16:00:00.000Z" itemprop="datePublished">2020-11-15</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">35</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">56</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式/">分布式</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储/">存储</a><span class="category-list-count">43</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">188</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">25</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">32</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">31</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">21</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">26</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">48</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">31</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">29</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">4</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Brendan-Gregg/">Brendan Gregg</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/">ES6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML-CSS/">HTML&CSS</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript-入门/">JavaScript 入门</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8S/">K8S</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux性能调优/">Linux性能调优</a><span class="tag-list-count">49</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL实战45讲/">MySQL实战45讲</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/">React</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/">Vue</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go并发编程/">go并发编程</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go标准库及第三方库/">go标准库及第三方库</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go语言入门/">go语言入门</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wrapt/">wrapt</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/入门指南/">入门指南</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据密集型应用/">数据密集型应用</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构与算法/">数据结构与算法</a><span class="tag-list-count">39</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/极客时间/">极客时间</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马哥-Linux/">马哥 Linux</a><span class="tag-list-count">135</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马哥-MySQL-运维/">马哥 MySQL 运维</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高性能的MySQL/">高性能的MySQL</a><span class="tag-list-count">5</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/Brendan-Gregg/" style="font-size: 10px;">Brendan Gregg</a> <a href="/tags/ES6/" style="font-size: 15.38px;">ES6</a> <a href="/tags/HTML-CSS/" style="font-size: 13.08px;">HTML&CSS</a> <a href="/tags/JavaScript/" style="font-size: 14.62px;">JavaScript</a> <a href="/tags/JavaScript-入门/" style="font-size: 10px;">JavaScript 入门</a> <a href="/tags/K8S/" style="font-size: 10px;">K8S</a> <a href="/tags/Linux性能调优/" style="font-size: 19.23px;">Linux性能调优</a> <a href="/tags/MySQL实战45讲/" style="font-size: 17.69px;">MySQL实战45讲</a> <a href="/tags/React/" style="font-size: 15.38px;">React</a> <a href="/tags/Vue/" style="font-size: 15.38px;">Vue</a> <a href="/tags/go并发编程/" style="font-size: 16.92px;">go并发编程</a> <a href="/tags/go标准库及第三方库/" style="font-size: 10.77px;">go标准库及第三方库</a> <a href="/tags/go语言入门/" style="font-size: 14.62px;">go语言入门</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/python/" style="font-size: 11.54px;">python</a> <a href="/tags/wrapt/" style="font-size: 16.15px;">wrapt</a> <a href="/tags/入门指南/" style="font-size: 14.62px;">入门指南</a> <a href="/tags/数据密集型应用/" style="font-size: 15.38px;">数据密集型应用</a> <a href="/tags/数据结构与算法/" style="font-size: 18.46px;">数据结构与算法</a> <a href="/tags/极客时间/" style="font-size: 17.69px;">极客时间</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a> <a href="/tags/马哥-Linux/" style="font-size: 20px;">马哥 Linux</a> <a href="/tags/马哥-MySQL-运维/" style="font-size: 13.85px;">马哥 MySQL 运维</a> <a href="/tags/高性能的MySQL/" style="font-size: 12.31px;">高性能的MySQL</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">讨论区</h3>
        <div class="widget">
            <h4> 联系我 <h4>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2021 宋涛</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'http://yoursite.com/2019/02/19/go/go_sync/go_sync_19/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
