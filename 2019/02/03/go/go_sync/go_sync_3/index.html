<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    

    
    <title>3 Mutex 锁 | 宋涛的博客</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="go并发编程" />
    
    <meta name="description" content="Go 第一个并发原语 Mutex 互斥锁">
<meta name="keywords" content="go并发编程">
<meta property="og:type" content="article">
<meta property="og:title" content="3 Mutex 锁">
<meta property="og:url" content="http://yoursite.com/2019/02/03/go/go_sync/go_sync_3/index.html">
<meta property="og:site_name" content="宋涛的博客">
<meta property="og:description" content="Go 第一个并发原语 Mutex 互斥锁">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/go/sync/mutex_principle.jpg">
<meta property="og:updated_time" content="2020-11-28T01:13:45.476Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="3 Mutex 锁">
<meta name="twitter:description" content="Go 第一个并发原语 Mutex 互斥锁">
<meta name="twitter:image" content="http://yoursite.com/images/go/sync/mutex_principle.jpg">
    

    
        <link rel="alternate" href="/" title="宋涛的博客" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/3.3.1/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    


</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">漫步在大陆上的海龟</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Go/">Go</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Python/">Python</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/分布式/">分布式</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/前端/">前端</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/存储/">存储</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/操作系统/">操作系统</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/运维/">运维</a></li></ul>
                                    
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/Go/">Go</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-go/go_sync/go_sync_3" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        3 Mutex 锁
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2019/02/03/go/go_sync/go_sync_3/" class="article-date">
            <time datetime="2019-02-02T16:00:00.000Z" itemprop="datePublished">2019-02-03</time>
        </a>
    </div>

		

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/go并发编程/">go并发编程<span class="tag-count">21</span></a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p>Go 第一个并发原语 Mutex 互斥锁<br><a id="more"></a></p>
<h2 id="1-Mutex-的使用"><a href="#1-Mutex-的使用" class="headerlink" title="1. Mutex 的使用"></a>1. Mutex 的使用</h2><p>互斥锁是最基本的并发原语，基本上所有编程语言都会提供，Go 中互斥锁为 Mutex，Mutex 位于标准库 sync 中，其实现了 sync 中的 Locker 接口:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Locker <span class="keyword">interface</span>&#123;</div><div class="line">    Lock()</div><div class="line">    Unlock()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>简单来说，互斥锁 Mutex 就提供了这两个方法 Lock 和 Unlock：进入临界区之前调用 Lock 方法，退出临界区的时候调用 Unlock 方法。很多时候 Mutex 会嵌入到其他 struct 中，比如:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Counter <span class="keyword">struct</span>&#123;</div><div class="line">    Mutex</div><div class="line">    Count <span class="keyword">uint64</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> c Counter</div><div class="line">c.Lock()</div><div class="line">c.Unlock()</div><div class="line"></div><div class="line"><span class="comment">// 将锁封装不暴露锁</span></div><div class="line"><span class="keyword">type</span> Counter <span class="keyword">struct</span> &#123;</div><div class="line">	CounterType <span class="keyword">int</span></div><div class="line">	Name        <span class="keyword">string</span></div><div class="line">	mu          sync.Mutex</div><div class="line">	count       <span class="keyword">uint64</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Counter)</span> <span class="title">Incr</span><span class="params">()</span></span> &#123;</div><div class="line">	c.mu.Lock()</div><div class="line">	c.count++</div><div class="line">	c.mu.Unlock()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果嵌入的 struct 有多个字段，我们一般会把 Mutex 放在要控制的字段上面，然后使用空格把字段分隔开来。以便于代码更容易理解和维护。甚至，你还可以把获取锁、释放锁、计数加一的逻辑封装成一个方法，对外不需要暴露锁等。</p>
<h2 id="2-Mutex-实现"><a href="#2-Mutex-实现" class="headerlink" title="2. Mutex 实现"></a>2. Mutex 实现</h2><p>Mutex 的实现经过了一个由简单到考虑公平，性能，复杂度复杂实现过程，整个实现过程大体分成了如下四个阶段:</p>
<p><img src="/images/go/sync/mutex_principle.jpg" alt="Mutex实现原理"></p>
<p>接下来我们会一一介绍 Mutex 各个版本的实现，我觉得下面几点对理解 Mutex 的实现会有所帮助:</p>
<ol>
<li>调用 Mutext.Lock 和 Mutex.Unlock 是独立的 Goroutine，他们内部会维护一些变量来记录当前的 Goroutine 的状态，比如是被唤醒的，或者已处于饥饿状态</li>
<li>Mutex 中的字段类似于共享内存，每个 Goroutine 都会根据自身的状态更新 Mutex 的值，因此对 Mutex 的修改都需要借助原子操作，来避免数据竞争</li>
<li>阻塞在信号量上的 Goroutine 是一个先进先出队列，位于队列头部的 Goroutine 一定是暂停时间最长的 Goroutine </li>
</ol>
<h2 id="3-初版-Mutex"><a href="#3-初版-Mutex" class="headerlink" title="3. 初版 Mutex"></a>3. 初版 Mutex</h2><p>初版 Mutex 实现如下:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// CAS操作，当时还没有抽象出atomic包</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">cas</span><span class="params">(val *<span class="keyword">int32</span>, old, <span class="built_in">new</span> <span class="keyword">int32</span>)</span> <span class="title">bool</span></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">semacquire</span><span class="params">(*<span class="keyword">int32</span>)</span></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">semrelease</span><span class="params">(*<span class="keyword">int32</span>)</span></span></div><div class="line"><span class="function">// 互斥锁的结构，包含两个字段</span></div><div class="line"><span class="function"><span class="title">type</span> <span class="title">Mutex</span> <span class="title">struct</span></span> &#123;</div><div class="line">	key  <span class="keyword">int32</span> <span class="comment">// 锁是否被持有的标识</span></div><div class="line">	sema <span class="keyword">int32</span> <span class="comment">// 信号量专用，用以阻塞/唤醒goroutine</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 保证成功在val上增加delta的值</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">xadd</span><span class="params">(val *<span class="keyword">int32</span>, delta <span class="keyword">int32</span>)</span> <span class="params">(<span class="built_in">new</span> <span class="keyword">int32</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		v := *val</div><div class="line">		<span class="keyword">if</span> cas(val, v, v+delta) &#123;</div><div class="line">			<span class="keyword">return</span> v + delta</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="built_in">panic</span>(<span class="string">"unreached"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 请求锁</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Lock</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> xadd(&amp;m.key, <span class="number">1</span>) == <span class="number">1</span> &#123; <span class="comment">//标识加1，如果等于1，成功获取到锁</span></div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	semacquire(&amp;m.sema) <span class="comment">// 否则阻塞等待</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Unlock</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> xadd(&amp;m.key, <span class="number">-1</span>) == <span class="number">0</span> &#123; <span class="comment">// 将标识减去1，如果等于0，则没有其它等待者</span></div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	semrelease(&amp;m.sema) <span class="comment">// 唤醒其它阻塞的goroutine</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Mutex 结构体包含两个字段：</p>
<ol>
<li>key：<ul>
<li>是一个 flag，用来标识这个排外锁是否被某个 goroutine 所持有</li>
<li>如果 key 大于等于 1，说明这个排外锁已经被持有；</li>
<li>key 不仅仅标识了锁是否被 goroutine 所持有，还记录了当前持有和等待获取锁的 goroutine 的数量</li>
</ul>
</li>
<li>sema：是个信号量变量，用来控制等待 goroutine 的阻塞休眠和唤醒。</li>
</ol>
<p><img src="/images/go/sync/mutex_v1.jpg" alt="初版Mutex"></p>
<h3 id="3-1-如何释放锁"><a href="#3-1-如何释放锁" class="headerlink" title="3.1 如何释放锁"></a>3.1 如何释放锁</h3><p>初版Mutex 的整体设计非常简洁，但是 Unlock 方法可以被任意的 goroutine 调用释放锁，即使是没持有这个互斥锁的 goroutine，也可以进行这个操作。这是因为，Mutex 本身并没有包含持有这把锁的 goroutine 的信息，所以，Unlock 也不会对此进行检查。Mutex 的这个设计一直保持至今。</p>
<p>所以，我们在使用 Mutex 的时候，必须要保证 goroutine 尽可能不去释放自己未持有的锁，一定要遵循“谁申请，谁释放”的原则。从 1.14 版本起，Go 对 defer 做了优化，采用更有效的内联方式，取代之前的生成 defer 对象到 defer chain 中，defer 对耗时的影响微乎其微，基本上都可以将锁的释放放在 defer 中，像下面这样:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *Foo)</span> <span class="title">Bar</span><span class="params">()</span></span> &#123;</div><div class="line">    f.mu.Lock()</div><div class="line">    <span class="keyword">defer</span> f.mu.Unlock()</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">if</span> f.count &lt; <span class="number">1000</span> &#123;</div><div class="line">        f.count += <span class="number">3</span></div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    f.count++</div><div class="line">    <span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但是，如果临界区只是方法中的一部分，为了尽快释放锁，还是应该第一时间调用 Unlock，而不是一直等到方法返回时才释放。</p>
<h3 id="3-3-缺陷"><a href="#3-3-缺陷" class="headerlink" title="3.3 缺陷"></a>3.3 缺陷</h3><p>初版的 Mutex 实现有一个问题：请求锁的 goroutine 会排队等待获取互斥锁。虽然这貌似很公平，但是从性能上来看，却不是最优的。因为如果我们能够把锁交给正在占用 CPU 时间片的 goroutine 的话，那就不需要做上下文的切换，在高并发的情况下，可能会有更好的性能。</p>
<h2 id="4-给新人机会"><a href="#4-给新人机会" class="headerlink" title="4. 给新人机会"></a>4. 给新人机会</h2><h3 id="4-1-state-字段"><a href="#4-1-state-字段" class="headerlink" title="4.1 state 字段"></a>4.1 state 字段</h3><p>第一次大调整之后，Mutex 实现如下:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">type</span> Mutex <span class="keyword">struct</span> &#123;</div><div class="line">	state <span class="keyword">int32</span></div><div class="line">	sema  <span class="keyword">uint32</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">	mutexLocked = <span class="number">1</span> &lt;&lt; <span class="literal">iota</span> <span class="comment">// mutex is locked</span></div><div class="line">	mutexWoken</div><div class="line">	mutexWaiterShift = <span class="literal">iota</span></div><div class="line">)</div></pre></td></tr></table></figure>
<p>新的 Mutex 中 state 是一个复合型字段: </p>
<ul>
<li>第一位（最小的一位）来表示这个锁是否被持有</li>
<li>第二位代表是否有唤醒的 goroutine</li>
<li>剩余的位数代表的是等待此锁的 goroutine 数</li>
</ul>
<p><img src="/images/go/sync/mutex_v2.jpg" alt="初版Mutex"></p>
<h3 id="4-2-Lock"><a href="#4-2-Lock" class="headerlink" title="4.2 Lock"></a>4.2 Lock</h3><p>state 变得复杂，请求锁的方法 Lock 也变得复杂。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Lock</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// Fast path: 幸运case，能够直接获取到锁</span></div><div class="line">	<span class="comment">// 1. state 为 0，表示 如果没有 goroutine 持有锁，也没有等待持有锁的 gorutine</span></div><div class="line">	<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, <span class="number">0</span>, mutexLocked) &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 2. for 循环是不断尝试获取锁，如果获取不到，就通过 runtime.Semacquire(&amp;m.sema) 休眠，</span></div><div class="line">	<span class="comment">//    休眠醒来之后 awoke 置为 true，尝试争抢锁。</span></div><div class="line">	awoke := <span class="literal">false</span></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		old := m.state</div><div class="line">		<span class="built_in">new</span> := old | mutexLocked <span class="comment">// 新状态加锁</span></div><div class="line">		<span class="comment">// 3. 如果旧锁已经被持有，增加 waiter</span></div><div class="line">		<span class="keyword">if</span> old&amp;mutexLocked != <span class="number">0</span> &#123;</div><div class="line">			<span class="built_in">new</span> = old + <span class="number">1</span>&lt;&lt;mutexWaiterShift <span class="comment">//等待者数量加一</span></div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> awoke &#123;</div><div class="line">			<span class="comment">// goroutine是被唤醒的，</span></div><div class="line">			<span class="comment">// 4. 新状态清除唤醒标志</span></div><div class="line">			<span class="built_in">new</span> &amp;^= mutexWoken</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 5. 过 CAS 把这个新值赋予 state，尝试抢锁</span></div><div class="line">		<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="built_in">new</span>) &#123;<span class="comment">//设置新状态</span></div><div class="line">			<span class="keyword">if</span> old&amp;mutexLocked == <span class="number">0</span> &#123; <span class="comment">// 锁原状态未加锁</span></div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">// 锁原状态已经加锁，休眠</span></div><div class="line">			runtime.Semacquire(&amp;m.sema) <span class="comment">// 请求信号量</span></div><div class="line">			<span class="comment">// 唤醒后标识 goroutine 是被唤醒的</span></div><div class="line">			awoke = <span class="literal">true</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在上面的实现中:</p>
<ol>
<li>因为判断是否能获取锁只会判断最后的 mutexLocked 位，所以新的需要获取锁的 goroutine 也可以获取锁(给新人机会)，让 CPU 中正在执行的 goroutine 有更多的机会获取到锁，在一定程度上提高了程序的性能</li>
<li>所以已睡眠的 goroutine 被唤醒后并不能像先前一样直接获取到锁，还是要和正在请求锁的 goroutine 进行竞争</li>
<li>请求锁的 goroutine 有两类，一类是新来请求锁的 goroutine，另一类是被唤醒的等待请求锁的 goroutine。锁的状态也有两种：加锁和未加锁，下面是 goroutine 不同来源不同状态下的处理逻辑</li>
</ol>
<p><img src="/images/go/sync/mutex_v2_state.jpg" alt="第二版Mutex"></p>
<h3 id="4-3-Unlock"><a href="#4-3-Unlock" class="headerlink" title="4.3 Unlock"></a>4.3 Unlock</h3><p>释放锁的逻辑如下:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Unlock</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// Fast path: drop lock bit.</span></div><div class="line">	<span class="built_in">new</span> := atomic.AddInt32(&amp;m.state, -mutexLocked) <span class="comment">//去掉锁标志</span></div><div class="line">	<span class="keyword">if</span> (<span class="built_in">new</span>+mutexLocked)&amp;mutexLocked == <span class="number">0</span> &#123; <span class="comment">//本来就没有加锁</span></div><div class="line">		<span class="built_in">panic</span>(<span class="string">"sync: unlock of unlocked mutex"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	old := <span class="built_in">new</span></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="keyword">if</span> old&gt;&gt;mutexWaiterShift == <span class="number">0</span> || old&amp;(mutexLocked|mutexWoken) != <span class="number">0</span> &#123; <span class="comment">// 没有等待者，或者有唤醒的waiter，或者锁原来已加锁</span></div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		<span class="built_in">new</span> = (old - <span class="number">1</span>&lt;&lt;mutexWaiterShift) | mutexWoken <span class="comment">// 新状态，准备唤醒goroutine，并设置唤醒标志</span></div><div class="line">		<span class="comment">// 对 state 状态的更新始终通过原子操作，保证不会数据竞争</span></div><div class="line">		<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="built_in">new</span>) &#123;</div><div class="line">			runtime.Semrelease(&amp;m.sema)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">// for 循环重试必须更新 old 变量</span></div><div class="line">		old = m.state</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>将加锁置为未加锁的状态，这个方法也不能直接返回，因为还可能有一些等待这个锁的 goroutine(成为 waiter) 需要通过信号量唤醒，所以接下来的逻辑有4种种情况：</p>
<ol>
<li>如果没有其它的 waiter</li>
<li>如果有其他 waiter 并且有被唤醒的 waiter 直接返回</li>
<li>如果有其他 waiter 但此时锁已经被其他 goroutine 加锁直接返回</li>
<li>如果有等待者，并且没有唤醒的 waiter，锁仍然处于未加锁状态，需要唤醒一个等待的 waiter </li>
</ol>
<p>前三种情况就对应条件<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// // 没有等待者，或者有唤醒的 waiter，或者锁原来已加锁</span></div><div class="line"><span class="keyword">if</span> old&gt;&gt;mutexWaiterShift == <span class="number">0</span> || old&amp;(mutexLocked|mutexWoken) != <span class="number">0</span> &#123; </div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所有对 state 的操作都通过原子操作完成，保证了不会发生数据竞争，其余通过快速失败逻辑，快速结束。需要注意的是 for 循环重试必须更新 old 变量。</p>
<h3 id="4-4-改进"><a href="#4-4-改进" class="headerlink" title="4.4 改进"></a>4.4 改进</h3><p>相对于初版的设计，这次的改动主要就是，新来的 goroutine 也有机会先获取到锁，甚至一个 goroutine 可能连续获取到锁，打破了先来先得的逻辑。但是，代码复杂度也显而易见。</p>
<p>这一版的 Mutex 已经给新来请求锁的 goroutine 一些机会，让它参与竞争，没有空闲的锁或者竞争失败才加入到等待队列中。但是其实还可以进一步优化。</p>
<h2 id="5-多给些机会"><a href="#5-多给些机会" class="headerlink" title="5. 多给些机会"></a>5. 多给些机会</h2><p>在 2015 年 2 月的改动中，如果新来的 goroutine 或者是被唤醒的 goroutine 首次获取不到锁，它们就会通过自旋（spin，通过循环不断尝试，spin 的逻辑是在runtime 实现的）的方式，尝试检查锁是否被释放。在尝试一定的自旋次数后，再执行原来的逻辑。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Lock</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// Fast path: 幸运之路，正好获取到锁</span></div><div class="line">	<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, <span class="number">0</span>, mutexLocked) &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	awoke := <span class="literal">false</span></div><div class="line">	iter := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> &#123; <span class="comment">// 不管是新来的请求锁的goroutine, 还是被唤醒的goroutine，都不断尝试请求锁</span></div><div class="line">		old := m.state <span class="comment">// 先保存当前锁的状态</span></div><div class="line">		<span class="built_in">new</span> := old | mutexLocked <span class="comment">// 新状态设置加锁标志</span></div><div class="line">		<span class="comment">// ################## 新增的自旋逻辑  #######################</span></div><div class="line">		<span class="keyword">if</span> old&amp;mutexLocked != <span class="number">0</span> &#123; <span class="comment">// 锁还没被释放</span></div><div class="line">			<span class="keyword">if</span> runtime_canSpin(iter) &#123; <span class="comment">// 还可以自旋</span></div><div class="line">				<span class="keyword">if</span> !awoke &amp;&amp; old&amp;mutexWoken == <span class="number">0</span> &amp;&amp; old&gt;&gt;mutexWaiterShift != <span class="number">0</span> &amp;&amp;</div><div class="line">					atomic.CompareAndSwapInt32(&amp;m.state, old, old|mutexWoken) &#123;</div><div class="line">					awoke = <span class="literal">true</span></div><div class="line">				&#125;</div><div class="line">				runtime_doSpin()</div><div class="line">				iter++</div><div class="line">				<span class="keyword">continue</span> <span class="comment">// 自旋，再次尝试请求锁</span></div><div class="line">			&#125;</div><div class="line">		<span class="comment">// ################## 新增的自旋逻辑  #######################</span></div><div class="line">			<span class="built_in">new</span> = old + <span class="number">1</span>&lt;&lt;mutexWaiterShift</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> awoke &#123; <span class="comment">// 唤醒状态</span></div><div class="line">			<span class="keyword">if</span> <span class="built_in">new</span>&amp;mutexWoken == <span class="number">0</span> &#123;</div><div class="line">				<span class="built_in">panic</span>(<span class="string">"sync: inconsistent mutex state"</span>)</div><div class="line">			&#125;</div><div class="line">			<span class="built_in">new</span> &amp;^= mutexWoken <span class="comment">// 新状态清除唤醒标记</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="built_in">new</span>) &#123;</div><div class="line">			<span class="keyword">if</span> old&amp;mutexLocked == <span class="number">0</span> &#123; <span class="comment">// 旧状态锁已释放，新状态成功持有了锁，直接返回</span></div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			runtime_Semacquire(&amp;m.sema) <span class="comment">// 阻塞等待</span></div><div class="line">			awoke = <span class="literal">true</span> <span class="comment">// 被唤醒</span></div><div class="line">			iter = <span class="number">0</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于临界区代码执行非常短的场景来说，新增的自旋逻辑是一个非常好的优化，因为临界区的代码耗时很短，锁很快就能释放，而抢夺锁的 goroutine 不用通过休眠唤醒方式等待调度，直接 spin 几次，可能就获得了锁。</p>
<p>这里我们来详细介绍一下自旋里面的判断逻辑:</p>
<ol>
<li><code>runtime_canSpin(iter)</code>: 表示 goroutine 可以继续执行持续抢锁</li>
<li><code>!awoke &amp;&amp; old&amp;mutexWoken == 0 &amp;&amp; old&gt;&gt;mutexWaiterShift != 0</code>:<ul>
<li>当前还没有被唤醒的 waiter，锁仍处于加锁状态，等待锁的 goroutine 大于 0</li>
<li>此时将锁的 mutexWoken 和 awoke 设为 1，表示有 goroutine 处于唤醒状态</li>
</ul>
</li>
<li><code>continue</code>: 自旋，再次尝试请求锁，如果此时锁被释放，可以执行下面的抢锁逻辑</li>
<li><code>new = old + 1&lt;&lt;mutexWaiterShift</code>: 如果 goroutine 已经不能自旋，将等待的 waiter 加一，符合 mutexWaiterShift 表示的当前等待锁的 goroutine 数的含义</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> old&amp;mutexLocked != <span class="number">0</span> &#123; <span class="comment">// 锁还没被释放</span></div><div class="line">	<span class="keyword">if</span> runtime_canSpin(iter) &#123; <span class="comment">// 还可以自旋</span></div><div class="line">		<span class="keyword">if</span> !awoke &amp;&amp; old&amp;mutexWoken == <span class="number">0</span> &amp;&amp; old&gt;&gt;mutexWaiterShift != <span class="number">0</span> &amp;&amp;</div><div class="line">			atomic.CompareAndSwapInt32(&amp;m.state, old, old|mutexWoken) &#123;</div><div class="line">			awoke = <span class="literal">true</span></div><div class="line">		&#125;</div><div class="line">		runtime_doSpin()</div><div class="line">		iter++</div><div class="line">		<span class="keyword">continue</span> <span class="comment">// 自旋，再次尝试请求锁</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">// ################## 新增的自旋逻辑  #######################</span></div><div class="line">	<span class="built_in">new</span> = old + <span class="number">1</span>&lt;&lt;mutexWaiterShift</div></pre></td></tr></table></figure>
<p>因为新来的 goroutine 也参与竞争，有可能每次都会被新来的 goroutine 抢到获取锁的机会，在极端情况下，等待中的 goroutine 可能会一直获取不到锁，这就是饥饿问题。</p>
<h2 id="6-解决饥饿"><a href="#6-解决饥饿" class="headerlink" title="6. 解决饥饿"></a>6. 解决饥饿</h2><p>2016 年 Go 1.9 中 Mutex 增加了饥饿模式，让锁变得更公平，不公平的等待时间限制在 1 毫秒，并且修复了一个大 Bug：总是把唤醒的 goroutine 放在等待队列的尾部，会导致更加不公平的等待时间。之后 2018 年，Go 开发者将 fast path 和 slow path 拆成独立的方法，以便内联，提高性能。2019 年也有一个 Mutex 的优化，虽然没有对 Mutex 做修改，但是，对于 Mutex 唤醒后持有锁的那个 waiter，调度器可以有更高的优先级去执行，这已经是很细致的性能优化了。</p>
<p>当前 Mutex 代码已经复杂得接近不可读的状态了，而且代码也非常长，我们慢慢来看。整个实现的逻辑大概是: </p>
<ol>
<li>正常模式下，waiter 都是进入先入先出队列，因此阻塞在信号量中的第一个 goroutine 就是等待最久的那个。</li>
<li>所以在饥饿模式下，Mutex 的拥有者将直接把锁交给队列最前面的 waiter。新来的 goroutine 不会尝试获取锁，即使看起来锁没有被持有，它也不会去抢，也不会 spin，它会乖乖地加入到等待队列的尾部。</li>
<li>因为等待最久的 goroutine 总是处于信号量队列中的第一个，所以他总是被第一个唤醒，所以饥饿模式下，处于运行中的 goroutine 只能是新的 goroutine 和当前饥饿的 goroutine，只有处于饥饿的 goroutine 才能将锁的饥饿位设置为 1</li>
</ol>
<h3 id="6-1-state-字段"><a href="#6-1-state-字段" class="headerlink" title="6.1 state 字段"></a>6.1 state 字段</h3><p>state 在原有的基础上增加了饥饿模式:</p>
<p><img src="/images/go/sync/mutex_v3.jpg" alt="当前版本Mutex"></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Mutex <span class="keyword">struct</span> &#123;</div><div class="line">	state <span class="keyword">int32</span></div><div class="line">	sema  <span class="keyword">uint32</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">	mutexLocked = <span class="number">1</span> &lt;&lt; <span class="literal">iota</span> <span class="comment">// mutex is locked</span></div><div class="line">	mutexWoken</div><div class="line">	mutexStarving <span class="comment">// 从state字段中分出一个饥饿标记</span></div><div class="line">	mutexWaiterShift = <span class="literal">iota</span></div><div class="line"></div><div class="line">	starvationThresholdNs = <span class="number">1e6</span></div><div class="line">)</div></pre></td></tr></table></figure>
<h3 id="6-2-Lock"><a href="#6-2-Lock" class="headerlink" title="6.2 Lock"></a>6.2 Lock</h3><p>添加饥饿模式后，Lock 增加了如下逻辑:</p>
<ol>
<li>自旋部分: <code>old&amp;(mutexLocked|mutexStarving) == mutexLocked</code> 锁是非饥饿状态，锁还没被释放，才尝试自旋</li>
<li>是否去抢锁: 如果存在饥饿 goroutine ，当前 goroutine 直接等待，不抢锁<ul>
<li><code>if old&amp;(mutexLocked|mutexStarving) != 0 {new += 1 &lt;&lt; mutexWaiterShift}</code></li>
<li><code>if old&amp;(mutexLocked|mutexStarving) == 0 {break}</code></li>
</ul>
</li>
<li>保持等待最久的 goroutine 始终处于信号量队列的队首: <code>runtime_SemacquireMutex(&amp;m.sema, queueLifo, 1)</code><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Lock</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// Fast path: 幸运之路，一下就获取到了锁</span></div><div class="line">	<span class="comment">// 1. 1. state 为 0，表示 如果没有 goroutine 持有锁，也没有等待持有锁的 gorutine，直接加锁</span></div><div class="line">	<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, <span class="number">0</span>, mutexLocked) &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Slow path：缓慢之路，尝试自旋竞争或饥饿状态下饥饿goroutine竞争</span></div><div class="line">	m.lockSlow()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">lockSlow</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> waitStartTime <span class="keyword">int64</span></div><div class="line">	starving := <span class="literal">false</span> <span class="comment">// 此goroutine的饥饿标记</span></div><div class="line">	awoke := <span class="literal">false</span> <span class="comment">// 唤醒标记</span></div><div class="line">	iter := <span class="number">0</span> <span class="comment">// 自旋次数</span></div><div class="line">	old := m.state <span class="comment">// 当前的锁的状态</span></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="comment">// 锁是非饥饿状态，锁还没被释放，尝试自旋</span></div><div class="line">		<span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) == mutexLocked &amp;&amp; runtime_canSpin(iter) &#123;</div><div class="line">			<span class="keyword">if</span> !awoke &amp;&amp; old&amp;mutexWoken == <span class="number">0</span> &amp;&amp; old&gt;&gt;mutexWaiterShift != <span class="number">0</span> &amp;&amp;</div><div class="line">				atomic.CompareAndSwapInt32(&amp;m.state, old, old|mutexWoken) &#123;</div><div class="line">				awoke = <span class="literal">true</span></div><div class="line">			&#125;</div><div class="line">			runtime_doSpin()</div><div class="line">			iter++</div><div class="line">			old = m.state <span class="comment">// 再次获取锁的状态，之后会检查是否锁被释放了</span></div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="built_in">new</span> := old</div><div class="line">		<span class="keyword">if</span> old&amp;mutexStarving == <span class="number">0</span> &#123;</div><div class="line">			<span class="built_in">new</span> |= mutexLocked <span class="comment">// 非饥饿状态，加锁</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 如果存在饥饿 goroutine ，当前 goroutine 直接等待，不抢锁</span></div><div class="line">		<span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) != <span class="number">0</span> &#123;</div><div class="line">			<span class="built_in">new</span> += <span class="number">1</span> &lt;&lt; mutexWaiterShift <span class="comment">// waiter数量加1</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> starving &amp;&amp; old&amp;mutexLocked != <span class="number">0</span> &#123;</div><div class="line">			<span class="built_in">new</span> |= mutexStarving <span class="comment">// 设置饥饿状态</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> awoke &#123;</div><div class="line">			<span class="keyword">if</span> <span class="built_in">new</span>&amp;mutexWoken == <span class="number">0</span> &#123;</div><div class="line">				throw(<span class="string">"sync: inconsistent mutex state"</span>)</div><div class="line">			&#125;</div><div class="line">			<span class="built_in">new</span> &amp;^= mutexWoken <span class="comment">// 新状态清除唤醒标记</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 成功设置新状态</span></div><div class="line">		<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="built_in">new</span>) &#123;</div><div class="line">			<span class="comment">// 原来锁的状态已释放，并且不是饥饿状态，正常请求到了锁，返回</span></div><div class="line">			<span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) == <span class="number">0</span> &#123;</div><div class="line">				<span class="keyword">break</span> <span class="comment">// locked the mutex with CAS</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">// 处理饥饿状态</span></div><div class="line"></div><div class="line">			<span class="comment">// 如果以前就在队列里面，加入到队列头</span></div><div class="line">			queueLifo := waitStartTime != <span class="number">0</span></div><div class="line">			<span class="keyword">if</span> waitStartTime == <span class="number">0</span> &#123;</div><div class="line">				waitStartTime = runtime_nanotime()</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// 阻塞等待</span></div><div class="line">			runtime_SemacquireMutex(&amp;m.sema, queueLifo, <span class="number">1</span>)</div><div class="line">			<span class="comment">// 唤醒之后检查锁是否应该处于饥饿状态</span></div><div class="line">			starving = starving || runtime_nanotime()-waitStartTime &gt; starvationThresholdNs</div><div class="line">			old = m.state</div><div class="line">			<span class="comment">// 如果锁已经处于饥饿状态，直接抢到锁，返回</span></div><div class="line">			<span class="keyword">if</span> old&amp;mutexStarving != <span class="number">0</span> &#123;</div><div class="line">				<span class="keyword">if</span> old&amp;(mutexLocked|mutexWoken) != <span class="number">0</span> || old&gt;&gt;mutexWaiterShift == <span class="number">0</span> &#123;</div><div class="line">					throw(<span class="string">"sync: inconsistent mutex state"</span>)</div><div class="line">				&#125;</div><div class="line">				<span class="comment">// 有点绕，加锁并且将waiter数减1</span></div><div class="line">				<span class="comment">// - 1&lt;&lt;mutexWaiterShift 表示 waiter 减去 1</span></div><div class="line">				<span class="comment">// mutexLocked 表示加锁</span></div><div class="line">				delta := <span class="keyword">int32</span>(mutexLocked - <span class="number">1</span>&lt;&lt;mutexWaiterShift)</div><div class="line">				<span class="keyword">if</span> !starving || old&gt;&gt;mutexWaiterShift == <span class="number">1</span> &#123;</div><div class="line">					delta -= mutexStarving <span class="comment">// 最后一个waiter或者已经不饥饿了，清除饥饿标记</span></div><div class="line">				&#125;</div><div class="line">				atomic.AddInt32(&amp;m.state, delta)</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			awoke = <span class="literal">true</span></div><div class="line">			iter = <span class="number">0</span></div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			old = m.state</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="6-3-Unlock"><a href="#6-3-Unlock" class="headerlink" title="6.3 Unlock"></a>6.3 Unlock</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Unlock</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// Fast path: drop lock bit.</span></div><div class="line">	<span class="built_in">new</span> := atomic.AddInt32(&amp;m.state, -mutexLocked)</div><div class="line">	<span class="keyword">if</span> <span class="built_in">new</span> != <span class="number">0</span> &#123;</div><div class="line">		m.unlockSlow(<span class="built_in">new</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">unlockSlow</span><span class="params">(<span class="built_in">new</span> <span class="keyword">int32</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> (<span class="built_in">new</span>+mutexLocked)&amp;mutexLocked == <span class="number">0</span> &#123;</div><div class="line">		throw(<span class="string">"sync: unlock of unlocked mutex"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">new</span>&amp;mutexStarving == <span class="number">0</span> &#123;</div><div class="line">		old := <span class="built_in">new</span></div><div class="line">		<span class="keyword">for</span> &#123;</div><div class="line">			<span class="keyword">if</span> old&gt;&gt;mutexWaiterShift == <span class="number">0</span> || old&amp;(mutexLocked|mutexWoken|mutexStarving) != <span class="number">0</span> &#123;</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">			<span class="built_in">new</span> = (old - <span class="number">1</span>&lt;&lt;mutexWaiterShift) | mutexWoken</div><div class="line">			<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="built_in">new</span>) &#123;</div><div class="line">				runtime_Semrelease(&amp;m.sema, <span class="literal">false</span>, <span class="number">1</span>)</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">			old = m.state</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		runtime_Semrelease(&amp;m.sema, <span class="literal">true</span>, <span class="number">1</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="7-Mutex-采坑记录"><a href="#7-Mutex-采坑记录" class="headerlink" title="7. Mutex 采坑记录"></a>7. Mutex 采坑记录</h2><p>使用 Mutex 常见的错误场景有 4 类，分别是 </p>
<ol>
<li>Lock/Unlock 不是成对出现</li>
<li>Copy 已使用的 Mutex</li>
<li>重入</li>
<li>死锁<br>手误和重入导致的死锁，是最常见的使用 Mutex 的 Bug。</li>
</ol>
<h3 id="7-1-Lock-Unlock-不是成对出现"><a href="#7-1-Lock-Unlock-不是成对出现" class="headerlink" title="7.1 Lock/Unlock 不是成对出现"></a>7.1 Lock/Unlock 不是成对出现</h3><p>Lock/Unlock 不是成对出现Lock/Unlock 没有成对出现，就意味着会出现死锁，或者是因为 Unlock 一个未加锁的 Mutex 而导致 panic。证 Lock/Unlock 成对出现，尽可能采用 defer mutex.Unlock 的方式，把它们成对、紧凑地写在一起。</p>
<h3 id="7-2-Copy-已使用的-Mutex"><a href="#7-2-Copy-已使用的-Mutex" class="headerlink" title="7.2 Copy 已使用的 Mutex"></a>7.2 Copy 已使用的 Mutex</h3><p>Package sync 的同步原语在使用后是不能复制的。原因在于，Mutex 是一个有状态的对象，它的 state 字段记录这个锁的状态。如果你要复制一个已经加锁的 Mutex 给一个新的变量，那么新的刚初始化的变量居然被加锁了，这显然不符合你的期望，因为你期望的是一个零值的 Mutex。关键是在并发环境下，你根本不知道要复制的 Mutex 状态是什么，因为要复制的 Mutex 是由其它 goroutine 并发访问的，状态可能总是在变化。</p>
<p>Go 在运行时，有死锁的检查机制（checkdead()  方法），它能够发现死锁的 goroutine。但是显然我们不想运行的时候才发现这个因为复制 Mutex 导致的死锁问题。我们可以使用 vet 工具: <code>go vet counter.go</code>，把检查写在 Makefile 文件中，在持续集成的时候跑一跑，这样可以及时发现问题，及时修复。</p>
<h4 id="vet-检查原理"><a href="#vet-检查原理" class="headerlink" title="vet 检查原理"></a>vet 检查原理</h4><p>vet 检查是通过<a href="https://github.com/golang/tools/blob/master/go/analysis/passes/copylock/copylock.go" target="_blank" rel="external">copylock</a>分析器静态分析实现的。这个分析器会分析函数调用、range 遍历、复制、声明、函数返回值等位置，有没有锁的值 copy 的情景，以此来判断有没有问题。可以说，只要是实现了 Locker 接口，就会被分析。</p>
<h3 id="7-3-重入"><a href="#7-3-重入" class="headerlink" title="7.3 重入"></a>7.3 重入</h3><p>Mutex 不是可重入的锁，因为 Mutex 的实现中没有记录哪个 goroutine 拥有这把锁。理论上，任何 goroutine 都可以随意地 Unlock 这把锁，所以没办法计算重入条件。所以，一旦误用 Mutex 的重入，就会导致报错。下一节我们将介绍如何基于 Mutex 实现一个可重入锁。</p>
<h3 id="7-4-死锁"><a href="#7-4-死锁" class="headerlink" title="7.4 死锁"></a>7.4 死锁</h3><p>要产生死锁必须具备以下几个条件：</p>
<ol>
<li>互斥： 至少一个资源是被排他性独享的，其他线程必须处于等待状态，直到资源被释放</li>
<li>持有和等待：goroutine 持有一个资源，并且还在请求其它 goroutine 持有的资源</li>
<li>不可剥夺：资源只能由持有它的 goroutine 来释放</li>
<li>环路等待：一般来说，存在一组等待进程，P={P1，P2，…，PN}，P1 等待 P2 持有的资源，P2 等待 P3 持有的资源，依此类推，最后是 PN 等待 P1 持有的资源，这就形成了一个环路等待的死结</li>
</ol>
<p>Go 死锁探测工具只能探测整个程序是否因为死锁而冻结了，不能检测出一组 goroutine 死锁导致的某一块业务冻结的情况。你还可以通过 Go 运行时自带的死锁检测工具，或者是第三方的工具（比如go-deadlock、go-tools）进行检查，这样可以尽早发现一些死锁的问题。不过，有些时候，死锁在某些特定情况下才会被触发，所以，如果你的测试或者短时间的运行没问题，不代表程序一定不会有死锁问题。</p>
<p>如果发现线上可能出现了死锁，我们可以通过 Go pprof 工具进行分析，它提供了一个 block profiler 监控阻塞的 goroutine。除此之外，我们还可以查看全部的 goroutine 的堆栈信息，通过它，你可以查看阻塞的 groutine 究竟阻塞在哪一行哪一个对象上了。</p>

        </div>
        <!--  -->
        <footer class="article-footer">
            



    <a data-url="http://yoursite.com/2019/02/03/go/go_sync/go_sync_3/" data-id="ckvgqi85j00gyh0u9z0r9iq8z" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>



                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google-plus" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-google-plus"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2019/02/04/go/go_sync/go_sync_4/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            4 Mutex 扩展
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2019/02/02/go/go_sync/go_sync_2/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">2 Go 并发调试工具</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/10/17/assembley/link/link_01/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/操作系统/">操作系统</a></p>
                            <p class="item-title"><a href="/2021/10/17/assembley/link/link_01/" class="title">1. 《程序员的自我修养》读书笔记</a></p>
                            <p class="item-date"><time datetime="2021-10-16T16:00:00.000Z" itemprop="datePublished">2021-10-17</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/05/assembley/x86/x86_05/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/memery_stack.png)" alt="5. x86 实模式(一)" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/05/assembley/x86/x86_05/" class="title">5. x86 实模式(一)</a></p>
                            <p class="item-date"><time datetime="2021-07-04T16:00:00.000Z" itemprop="datePublished">2021-07-05</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/04/assembley/x86/x86_04/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/video.png)" alt="4. x86 实模式(一)" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/04/assembley/x86/x86_04/" class="title">4. x86 实模式(一)</a></p>
                            <p class="item-date"><time datetime="2021-07-03T16:00:00.000Z" itemprop="datePublished">2021-07-04</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/03/assembley/x86/x86_03/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/cpu_structure.png)" alt="3. x86 汇编环境准备" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/03/assembley/x86/x86_03/" class="title">3. x86 汇编环境准备</a></p>
                            <p class="item-date"><time datetime="2021-07-02T16:00:00.000Z" itemprop="datePublished">2021-07-03</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/02/assembley/x86/x86_02/" class="thumbnail">
    
    
        <span style="background-image:url(/images/assembly/cpu_ram_rom.jpg)" alt="2. 硬件系统的结构" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Go/">Go</a></p>
                            <p class="item-title"><a href="/2021/07/02/assembley/x86/x86_02/" class="title">2. 硬件系统的结构</a></p>
                            <p class="item-date"><time datetime="2021-07-01T16:00:00.000Z" itemprop="datePublished">2021-07-02</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">61</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式/">分布式</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储/">存储</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/">操作系统</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">198</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">25</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">32</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">31</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">21</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">26</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">48</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">31</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">29</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">4</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Brendan-Gregg/">Brendan Gregg</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/">ES6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML-CSS/">HTML&CSS</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8S/">K8S</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/">Kafka</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux性能调优/">Linux性能调优</a><span class="tag-list-count">49</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL实战45讲/">MySQL实战45讲</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openstack/">Openstack</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/">React</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/">Vue</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go并发编程/">go并发编程</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go标准库及第三方库/">go标准库及第三方库</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go语言入门/">go语言入门</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wrapt/">wrapt</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/x86-汇编/">x86 汇编</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/入门指南/">入门指南</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/好玩的数据结构与算法/">好玩的数据结构与算法</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据密集型应用/">数据密集型应用</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构与算法/">数据结构与算法</a><span class="tag-list-count">39</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/极客时间/">极客时间</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/程序员的自我修养/">程序员的自我修养</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马哥-Linux/">马哥 Linux</a><span class="tag-list-count">135</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马哥-MySQL-运维/">马哥 MySQL 运维</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高性能的MySQL/">高性能的MySQL</a><span class="tag-list-count">5</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/Brendan-Gregg/" style="font-size: 10px;">Brendan Gregg</a> <a href="/tags/ES6/" style="font-size: 15.63px;">ES6</a> <a href="/tags/HTML-CSS/" style="font-size: 12.5px;">HTML&CSS</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/K8S/" style="font-size: 10px;">K8S</a> <a href="/tags/Kafka/" style="font-size: 16.25px;">Kafka</a> <a href="/tags/Linux性能调优/" style="font-size: 19.38px;">Linux性能调优</a> <a href="/tags/MySQL实战45讲/" style="font-size: 18.13px;">MySQL实战45讲</a> <a href="/tags/Openstack/" style="font-size: 13.75px;">Openstack</a> <a href="/tags/React/" style="font-size: 15.63px;">React</a> <a href="/tags/Vue/" style="font-size: 15.63px;">Vue</a> <a href="/tags/go并发编程/" style="font-size: 17.5px;">go并发编程</a> <a href="/tags/go标准库及第三方库/" style="font-size: 10.63px;">go标准库及第三方库</a> <a href="/tags/go语言入门/" style="font-size: 14.38px;">go语言入门</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/python/" style="font-size: 11.25px;">python</a> <a href="/tags/wrapt/" style="font-size: 16.88px;">wrapt</a> <a href="/tags/x86-汇编/" style="font-size: 11.88px;">x86 汇编</a> <a href="/tags/入门指南/" style="font-size: 16.25px;">入门指南</a> <a href="/tags/好玩的数据结构与算法/" style="font-size: 11.88px;">好玩的数据结构与算法</a> <a href="/tags/数据密集型应用/" style="font-size: 15.63px;">数据密集型应用</a> <a href="/tags/数据结构与算法/" style="font-size: 18.75px;">数据结构与算法</a> <a href="/tags/极客时间/" style="font-size: 18.13px;">极客时间</a> <a href="/tags/程序员的自我修养/" style="font-size: 10px;">程序员的自我修养</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a> <a href="/tags/马哥-Linux/" style="font-size: 20px;">马哥 Linux</a> <a href="/tags/马哥-MySQL-运维/" style="font-size: 13.13px;">马哥 MySQL 运维</a> <a href="/tags/高性能的MySQL/" style="font-size: 11.88px;">高性能的MySQL</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">讨论区</h3>
        <div class="widget">
            <h4> 联系我 <h4>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2021 宋涛</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'http://yoursite.com/2019/02/03/go/go_sync/go_sync_3/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
