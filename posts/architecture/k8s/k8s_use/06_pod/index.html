<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Pod - LoveIt</title><meta name="Description" content="什么是 Pod"><meta property="og:title" content="Pod" />
<meta property="og:description" content="什么是 Pod" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hotttao.github.io/posts/architecture/k8s/k8s_use/06_pod/" /><meta property="og:image" content="https://hotttao.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-08-03T22:00:00+08:00" />
<meta property="article:modified_time" content="2023-03-02T19:16:18+08:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://hotttao.github.io/logo.png"/>

<meta name="twitter:title" content="Pod"/>
<meta name="twitter:description" content="什么是 Pod"/>
<meta name="application-name" content="宋涛的个人博客">
<meta name="apple-mobile-web-app-title" content="宋涛的个人博客"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://hotttao.github.io/posts/architecture/k8s/k8s_use/06_pod/" /><link rel="prev" href="https://hotttao.github.io/posts/architecture/k8s/k8s_use/05_k8s_tools/" /><link rel="next" href="https://hotttao.github.io/posts/architecture/k8s/k8s_use/07_secret/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Pod",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/hotttao.github.io\/posts\/architecture\/k8s\/k8s_use\/06_pod\/"
        },"image": ["https:\/\/hotttao.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "k8s","wordcount":  13577 ,
        "url": "https:\/\/hotttao.github.io\/posts\/architecture\/k8s\/k8s_use\/06_pod\/","datePublished": "2020-08-03T22:00:00+08:00","dateModified": "2023-03-02T19:16:18+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": {
                    "@type": "ImageObject",
                    "url": "https:\/\/hotttao.github.io\/images\/hugo\/avatar.png",
                    "width":  528 ,
                    "height":  560 
                }},"author": {
                "@type": "Person",
                "name": "宋涛"
            },"description": "什么是 Pod"
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="LoveIt"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>宋涛的博客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/categories/go/"> Go </a><a class="menu-item" href="/categories/linux/"> Linux </a><a class="menu-item" href="/categories/distributed/"> 分布式 </a><a class="menu-item" href="/categories/distributed/"> 架构 </a><a class="menu-item" href="/posts/about/"> 关于 </a><a class="menu-item" href="https://github.com/hotttao/" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="LoveIt"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>宋涛的博客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/categories/go/" title="">Go</a><a class="menu-item" href="/categories/linux/" title="">Linux</a><a class="menu-item" href="/categories/distributed/" title="">分布式</a><a class="menu-item" href="/categories/distributed/" title="">架构</a><a class="menu-item" href="/posts/about/" title="">关于</a><a class="menu-item" href="https://github.com/hotttao/" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Pod</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://hotttao.github.io/" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>宋涛</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/architecture/"><i class="far fa-folder fa-fw"></i>architecture</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2020-08-03">2020-08-03</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 13577 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 28 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-为什么我们需要-pod">1. 为什么我们需要 Pod</a>
      <ul>
        <li><a href="#11-成组调度">1.1 成组调度</a></li>
        <li><a href="#12-pod-的实现原理">1.2 Pod 的实现原理</a></li>
        <li><a href="#13-容器设计模式">1.3 容器设计模式</a></li>
        <li><a href="#24-pod-的本质">2.4 pod 的本质</a></li>
      </ul>
    </li>
    <li><a href="#2-如何定义一个-pod">2. 如何定义一个 Pod</a>
      <ul>
        <li><a href="#21-k8s-中的对象定义">2.1 k8s 中的对象定义</a></li>
        <li><a href="#22-pod-定义">2.2 Pod 定义</a>
          <ul>
            <li>
              <ul>
                <li><a href="#typemeta">TypeMeta</a></li>
              </ul>
            </li>
            <li><a href="#objectmeta">ObjectMeta</a></li>
            <li><a href="#podspec">PodSpec</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#3-pod-重要字段">3. Pod 重要字段</a>
      <ul>
        <li><a href="#21-调度相关">2.1 调度相关</a></li>
        <li><a href="#22-网络配置">2.2 网络配置</a></li>
        <li><a href="#23-linux-namespace-相关">2.3 Linux Namespace 相关</a></li>
        <li><a href="#24-pod-恢复机制">2.4 Pod 恢复机制</a>
          <ul>
            <li><a href="#restartpolicy-与容器状态的关系">restartPolicy 与容器状态的关系</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#3-container-定义">3. Container 定义</a></li>
    <li><a href="#4-container-重要字段">4. Container 重要字段</a>
      <ul>
        <li><a href="#41-docker-常规字段">4.1 Docker 常规字段</a>
          <ul>
            <li><a href="#imagepullpolicy">ImagePullPolicy</a></li>
          </ul>
        </li>
        <li><a href="#42-容器健康检查">4.2 容器健康检查</a>
          <ul>
            <li><a href="#livenessprobe">livenessProbe</a></li>
            <li><a href="#readinessprobe">readinessProbe</a></li>
          </ul>
        </li>
        <li><a href="#43-hook">4.3 Hook</a></li>
      </ul>
    </li>
    <li><a href="#5-pod-生命周期">5. Pod 生命周期</a></li>
    <li><a href="#6podpreset">6.PodPreset</a>
      <ul>
        <li><a href="#61-podpreset-定义">6.1 PodPreset 定义</a></li>
        <li><a href="#62-podpreset">6.2 PodPreset</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>Pod 是 k8s 中最基础的 API 对象，关于 Pod 我们需要重点关注以下几点:</p>
<ol>
<li>为什么我们需要 Pod</li>
<li>如何定义一个 Pod</li>
</ol>
<h2 id="1-为什么我们需要-pod">1. 为什么我们需要 Pod</h2>
<h3 id="11-成组调度">1.1 成组调度</h3>
<p>如果我们把物理机与云环境做一个对比:</p>
<ol>
<li>容器的本质是进程，是未来云计算系统中的进程</li>
<li>容器镜像就是这个系统里的“.exe”安装包</li>
<li>Kubernetes 则是未来云计算的操作系统</li>
<li>在操作系统里进程是以进程组的方式组织在一起，Pod 就是将“进程组”的概念映射到了容器技术中</li>
</ol>
<p>之所以需要 Pod 是因为应用往往都存在着类似于“进程和进程组”的关系，更具体地说，就是这些应用之间有着密切的协作关系，使得它们必须部署在同一台机器上。像这样容器间的紧密协作，我们可以称为“超亲密关系”。这些具有“超亲密关系”容器的典型特征包括但不限于：</p>
<ol>
<li>互相之间会发生直接的文件交换</li>
<li>使用 localhost 或者 Socket 文件进行本地通信</li>
<li>会发生非常频繁的远程调用</li>
<li>需要共享某些 Linux Namespace(比如，一个容器要加入另一个容器的 Network Namespace)等等。</li>
</ol>
<p>所以 Pod 的存在就是为了解决成组调度(gang scheduling)的问题。Pod 是 Kubernetes 里的原子调度单位。这就意味着，Kubernetes 项目的调度器，是统一按照 Pod 而非容器的资源需求进行计算的。</p>
<p>注:再次强调一下：容器的“单进程模型”，并不是指容器里只能运行“一个”进程，而是指容器没有管理多个进程的能力。这是因为容器里 PID=1 的进程就是应用本身，其他的进程都是这个 PID=1 进程的子进程。可是，用户编写的应用，并不能够像正常操作系统里的 init 进程或者 systemd 那样拥有进程管理的功能。</p>
<h3 id="12-pod-的实现原理">1.2 Pod 的实现原理</h3>
<p>Pod 只是一个逻辑概念，本质上 Pod，其实是一组共享了某些资源的容器。具体的说：<strong>Pod 里的所有容器，共享的是同一个 Network Namespace，并且可以声明共享同一个 Volume。</strong></p>
<p>而为了避免使用 <code>docker run --net=B --volumes-from=B --name=A image-A ...</code> 让 Pod 内的容器引入不对等关系，Pod 的实现使用了一个中间容器，这个容器叫作 Infra 容器。Infra 容器使用的是一个非常特殊的镜像，叫作：k8s.gcr.io/paus,占用极少的资源。这个镜像是一个用汇编语言编写的、永远处于“暂停”状态的容器，解压后的大小也只有 100~200 KB 左右。</p>
<p>在容器的启动过程中:</p>
<ol>
<li>Infra 容器永远都是第一个被创建的容器，而其他用户定义的容器，则通过 Join Network Namespace 的方式，与 Infra 容器关联在一起，这样的组织关系，可以用下面这样一个示意图来表达</li>
<li>Pod 的生命周期只跟 Infra 容器一致，而与容器 A 和 B 无关。因为共享了 Network Namespace，Pod 里的容器可以直接使用 localhost 进行通信，并共享相同的网络设备</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/k8s/k8s_use/infra.png"
        data-srcset="/images/k8s/k8s_use/infra.png, /images/k8s/k8s_use/infra.png 1.5x, /images/k8s/k8s_use/infra.png 2x"
        data-sizes="auto"
        alt="/images/k8s/k8s_use/infra.png"
        title="rootfs" /></p>
<p>共享 Network/Volume 意味着:</p>
<ol>
<li>对于同一个 Pod 里面的所有用户容器来说，它们的进出流量，也可以认为都是通过 Infra 容器完成的。这一点很重要，因为将来如果你要为 Kubernetes 开发一个网络插件时，应该重点考虑的是如何配置这个 Pod 的 Network Namespace，而不是每一个用户容器如何使用你的网络配置，这是没有意义的。</li>
<li>共享 Volume 就简单多了：Kubernetes 项目只要把所有 <strong>Volume 的定义都设计在 Pod 层级</strong> 即可。一个 Volume 对应的宿主机目录对于 Pod 来说就只有一个，Pod 里的容器只要声明挂载这个 Volume，就一定可以共享这个 Volume 对应的宿主机目录。</li>
</ol>
<h3 id="13-容器设计模式">1.3 容器设计模式</h3>
<p>前面说了 Pod 存在的一个重要原因是成组调度，而另一个原因就是容器设计模式。容器设计模式，实际上就是希望，当用户想在一个容器里跑多个功能并不相关的应用时，应该优先考虑它们是不是更应该被描述成一个 Pod 里的多个容器。</p>
<p>第一个最典型的例子是：WAR 包与 Web 服务器:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">javaweb-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">initContainers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">geektime/sample:v2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">war</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;cp&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;/sample.war&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;/app&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">geektime/tomcat:7.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tomcat</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;sh&#34;</span><span class="p">,</span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="s2">&#34;/root/apache-tomcat-7.0.42-v2/bin/start.sh&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/root/apache-tomcat-7.0.42-v2/webapps</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="m">8001</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在 Pod 中，所有 Init Container 定义的容器，都会比 spec.containers 定义的用户容器先启动。并且，Init Container 容器会按顺序逐一启动，而直到它们都启动并且退出了，用户容器才会启动。</p>
<p>在上面的 Pod 中，使用的是容器设计模式里最常用的一种模式：sidecar。sidecar 指的就是我们可以在一个 Pod 中，启动一个辅助容器，来完成一些独立于主进程(主容器)之外的工作。这个例子中的 sidecar 的主要工作是使用 <strong>共享的 Volume</strong> 将 Jar 包从 InitContainer 拷贝到 Tomcat 容器中，从而解耦 Tomcat 与 Jar 包的发布。</p>
<p>但不要忘记，Pod 的另一个重要特性是，它的所有容器都共享同一个 Network Namespace。这就使得很多与 Pod 网络相关的配置和管理，也都可以交给 sidecar 完成，而完全无须干涉用户容器。这里最典型的例子莫过于 Istio 这个微服务治理项目了。</p>
<p>Kubernetes 社区曾经把“容器设计模式”这个理论，整理成了一篇<a href="https://www.usenix.org/conference/hotcloud16/workshop-program/presentation/burns" target="_blank" rel="noopener noreffer">小论文</a></p>
<h3 id="24-pod-的本质">2.4 pod 的本质</h3>
<p>你现在可以这么理解 Pod 的本质：Pod，实际上是在扮演传统基础设施里“虚拟机”的角色；而容器，则是这个虚拟机里运行的用户程序。当你需要把一个运行在虚拟机里的应用迁移到 Docker 容器中时，一定要仔细分析到底有哪些进程(组件)运行在这个虚拟机里。然后，你就可以把整个虚拟机想象成为一个 Pod，把这些进程分别做成容器镜像，把有顺序关系的容器，定义为 Init Container。这才是更加合理的、松耦合的容器编排诀窍，也是从传统应用架构，到“微服务架构”最自然的过渡方式。</p>
<p>Pod 这个概念，提供的是一种编排思想，而不是具体的技术方案。所以，如果愿意的话，你完全可以使用虚拟机来作为 Pod 的实现，然后把用户容器都运行在这个虚拟机里。比如，Mirantis 公司的virtlet 项目。甚至，你可以去实现一个带有 Init 进程的容器项目，来模拟传统应用的运行方式。这些工作，在 Kubernetes 中都是非常轻松的，也是我们后面讲解 CRI 时会提到的内容。</p>
<h2 id="2-如何定义一个-pod">2. 如何定义一个 Pod</h2>
<h3 id="21-k8s-中的对象定义">2.1 k8s 中的对象定义</h3>
<p>定义一个 Pod 首先我们要面对的问题就是: 到底哪些属性属于 Pod 对象，而又有哪些属性属于 Container 呢？。一个原则是:</p>
<ol>
<li>Pod 对标的是虚拟机所以在 Pod 的配置中，所以凡是调度、网络、存储，以及安全相关的属性，基本上是 Pod 级别的。这些属性的共同特征是，它们描述的是“机器”这个整体，而不是里面运行的“程序”</li>
<li>其他的与进程相关的配置则属于 Container。</li>
</ol>
<p>k8s api 对象的定义存放在源码目录下的 ./staging/src/k8s.io/api 内</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// kubernetes go.mod
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">require</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="nx">k8s</span><span class="p">.</span><span class="nx">io</span><span class="o">/</span><span class="nx">api</span> <span class="nx">v0</span><span class="mf">.0.0</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">replace</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">k8s</span><span class="p">.</span><span class="nx">io</span><span class="o">/</span><span class="nx">api</span> <span class="p">=&gt;</span> <span class="p">.</span><span class="o">/</span><span class="nx">staging</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">k8s</span><span class="p">.</span><span class="nx">io</span><span class="o">/</span><span class="nx">api</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 k8s.io/api/core/v1/ 内:</p>
<ol>
<li>generated.proto 是所有 API 对象的 pb 定义文件</li>
<li>type.go 则是由 generated.proto 生成的 go struct 定义。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>tao@master kubernetes<span class="o">]</span>$ <span class="nb">cd</span> staging/src/k8s.io/api/core/v1/
</span></span><span class="line"><span class="cl"><span class="o">[</span>tao@master v1<span class="o">]</span>$ ll
</span></span><span class="line"><span class="cl">总用量 <span class="m">2796</span>
</span></span><span class="line"><span class="cl">-rw-rw-r--. <span class="m">1</span> tao tao    <span class="m">8345</span> 2月  <span class="m">28</span> 20:32 annotation_key_constants.go
</span></span><span class="line"><span class="cl">-rw-rw-r--. <span class="m">1</span> tao tao     <span class="m">746</span> 2月  <span class="m">28</span> 20:32 doc.go
</span></span><span class="line"><span class="cl">-rw-rw-r--. <span class="m">1</span> tao tao <span class="m">1755761</span> 2月  <span class="m">28</span> 20:32 generated.pb.go
</span></span><span class="line"><span class="cl">-rw-rw-r--. <span class="m">1</span> tao tao  <span class="m">259908</span> 2月  <span class="m">28</span> 20:32 generated.proto
</span></span><span class="line"><span class="cl">-rw-rw-r--. <span class="m">1</span> tao tao    <span class="m">1514</span> 2月  <span class="m">28</span> 20:32 lifecycle.go
</span></span><span class="line"><span class="cl">-rw-rw-r--. <span class="m">1</span> tao tao    <span class="m">1194</span> 2月  <span class="m">28</span> 20:32 objectreference.go
</span></span><span class="line"><span class="cl">-rw-rw-r--. <span class="m">1</span> tao tao    <span class="m">2713</span> 2月  <span class="m">28</span> 20:32 register.go
</span></span><span class="line"><span class="cl">-rw-rw-r--. <span class="m">1</span> tao tao    <span class="m">1857</span> 2月  <span class="m">28</span> 20:32 resource.go
</span></span><span class="line"><span class="cl">-rw-rw-r--. <span class="m">1</span> tao tao    <span class="m">1323</span> 2月  <span class="m">28</span> 20:32 taint.go
</span></span><span class="line"><span class="cl">-rw-rw-r--. <span class="m">1</span> tao tao    <span class="m">3002</span> 2月  <span class="m">28</span> 20:32 taint_test.go
</span></span><span class="line"><span class="cl">-rw-rw-r--. <span class="m">1</span> tao tao    <span class="m">2086</span> 2月  <span class="m">28</span> 20:32 toleration.go
</span></span><span class="line"><span class="cl">-rw-rw-r--. <span class="m">1</span> tao tao    <span class="m">3465</span> 2月  <span class="m">28</span> 20:32 toleration_test.go
</span></span><span class="line"><span class="cl">-rw-rw-r--. <span class="m">1</span> tao tao  <span class="m">362124</span> 2月  <span class="m">28</span> 20:32 types.go
</span></span><span class="line"><span class="cl">-rw-rw-r--. <span class="m">1</span> tao tao  <span class="m">238544</span> 2月  <span class="m">28</span> 20:32 types_swagger_doc_generated.go
</span></span><span class="line"><span class="cl">-rw-rw-r--. <span class="m">1</span> tao tao    <span class="m">2188</span> 2月  <span class="m">28</span> 20:32 types_test.go
</span></span><span class="line"><span class="cl">-rw-rw-r--. <span class="m">1</span> tao tao    <span class="m">3625</span> 2月  <span class="m">28</span> 20:32 well_known_labels.go
</span></span><span class="line"><span class="cl">-rw-rw-r--. <span class="m">1</span> tao tao    <span class="m">2076</span> 2月  <span class="m">28</span> 20:32 well_known_taints.go
</span></span><span class="line"><span class="cl">-rw-rw-r--. <span class="m">1</span> tao tao  <span class="m">175985</span> 2月  <span class="m">28</span> 20:32 zz_generated.deepcopy.go
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="22-pod-定义">2.2 Pod 定义</h3>
<p><a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api/core/v1/types.go#L4177" target="_blank" rel="noopener noreffer">Pod 的定义</a>如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Pod</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span> <span class="s">`json:&#34;,inline&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Standard object&#39;s metadata.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span> <span class="s">`json:&#34;metadata,omitempty&#34; protobuf:&#34;bytes,1,opt,name=metadata&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Specification of the desired behavior of the pod.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Spec</span> <span class="nx">PodSpec</span> <span class="s">`json:&#34;spec,omitempty&#34; protobuf:&#34;bytes,2,opt,name=spec&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Most recently observed status of the pod.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This data may not be up to date.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Populated by the system.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Read-only.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Status</span> <span class="nx">PodStatus</span> <span class="s">`json:&#34;status,omitempty&#34; protobuf:&#34;bytes,3,opt,name=status&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中:</p>
<ol>
<li>TypeMeta: 定义了 API 对象的类型以及其发布的版本</li>
<li>ObjectMeta: 定义了对象的元数据，这个是用户必须定义的</li>
<li>PodSpec: 定义 Pod 包含哪些字段</li>
<li>PodStatus: Pod 当前状态字段，由系统定义</li>
</ol>
<p>TypeMeta、ObjectMeta 是通用字段，所有的 API 对象都有这两个属性。</p>
<h5 id="typemeta">TypeMeta</h5>
<p>TypeMeta 只包含了，两个属性</p>
<ol>
<li>name: API 对象名称</li>
<li>apiVersion: API 对象版本</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">message</span> <span class="nx">TypeMeta</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">  <span class="c1">// Kind is a string value representing the REST resource this object represents.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Servers may infer this from the endpoint the client submits requests to.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Cannot be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// In CamelCase.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">optional</span> <span class="kt">string</span> <span class="nx">kind</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// APIVersion defines the versioned schema of this representation of an object.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Servers should convert recognized schemas to the latest internal value, and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// may reject unrecognized values.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">optional</span> <span class="kt">string</span> <span class="nx">apiVersion</span> <span class="p">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="objectmeta">ObjectMeta</h4>
<p>ObjectMeta 的定义<a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apimachinery/pkg/apis/meta/v1/types.go#L111" target="_blank" rel="noopener noreffer">github</a>，比较重要的是以下几个:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ObjectMeta</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Name</span> <span class="kt">string</span> <span class="s">`json:&#34;name,omitempty&#34; protobuf:&#34;bytes,1,opt,name=name&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">GenerateName</span> <span class="kt">string</span> <span class="s">`json:&#34;generateName,omitempty&#34; protobuf:&#34;bytes,2,opt,name=generateName&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Namespace</span> <span class="kt">string</span> <span class="s">`json:&#34;namespace,omitempty&#34; protobuf:&#34;bytes,3,opt,name=namespace&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Deprecated: selfLink is a legacy read-only field that is no longer populated by the system.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">SelfLink</span> <span class="kt">string</span> <span class="s">`json:&#34;selfLink,omitempty&#34; protobuf:&#34;bytes,4,opt,name=selfLink&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// UID is the unique in time and space value for this object. It is typically generated by
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// the server on successful creation of a resource and is not allowed to change on PUT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// operations.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">UID</span> <span class="nx">types</span><span class="p">.</span><span class="nx">UID</span> <span class="s">`json:&#34;uid,omitempty&#34; protobuf:&#34;bytes,5,opt,name=uid,casttype=k8s.io/kubernetes/pkg/types.UID&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// An opaque value that represents the internal version of this object that can
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// be used by clients to determine when objects have changed. May be used for optimistic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// concurrency, change detection, and the watch operation on a resource or set of resources.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Clients must treat these values as opaque and passed unmodified back to the server.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// They may only be valid for a particular resource or set of resources.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Populated by the system.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Read-only.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Value must be treated as opaque by clients and .
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#concurrency-control-and-consistency
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ResourceVersion</span> <span class="kt">string</span> <span class="s">`json:&#34;resourceVersion,omitempty&#34; protobuf:&#34;bytes,6,opt,name=resourceVersion&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// A sequence number representing a specific generation of the desired state.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Populated by the system. Read-only.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Generation</span> <span class="kt">int64</span> <span class="s">`json:&#34;generation,omitempty&#34; protobuf:&#34;varint,7,opt,name=generation&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// CreationTimestamp is a timestamp representing the server time when this object was
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// created. It is not guaranteed to be set in happens-before order across separate operations.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Clients may not set this value. It is represented in RFC3339 form and is in UTC.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Populated by the system.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Read-only.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Null for lists.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">CreationTimestamp</span> <span class="nx">Time</span> <span class="s">`json:&#34;creationTimestamp,omitempty&#34; protobuf:&#34;bytes,8,opt,name=creationTimestamp&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// DeletionTimestamp is RFC 3339 date and time at which this resource will be deleted. This
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// field is set by the server when a graceful deletion is requested by the user, and is not
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// directly settable by a client. The resource is expected to be deleted (no longer visible
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// from resource lists, and not reachable by name) after the time in this field, once the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// finalizers list is empty. As long as the finalizers list contains items, deletion is blocked.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Once the deletionTimestamp is set, this value may not be unset or be set further into the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// future, although it may be shortened or the resource may be deleted prior to this time.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// For example, a user may request that a pod is deleted in 30 seconds. The Kubelet will react
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// by sending a graceful termination signal to the containers in the pod. After that 30 seconds,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// the Kubelet will send a hard termination signal (SIGKILL) to the container and after cleanup,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// remove the pod from the API. In the presence of network partitions, this object may still
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// exist after this timestamp, until an administrator or automated process can determine the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// resource is fully terminated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If not set, graceful deletion of the object has not been requested.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Populated by the system when a graceful deletion is requested.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Read-only.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">DeletionTimestamp</span> <span class="o">*</span><span class="nx">Time</span> <span class="s">`json:&#34;deletionTimestamp,omitempty&#34; protobuf:&#34;bytes,9,opt,name=deletionTimestamp&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Number of seconds allowed for this object to gracefully terminate before
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// it will be removed from the system. Only set when deletionTimestamp is also set.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// May only be shortened.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Read-only.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">DeletionGracePeriodSeconds</span> <span class="o">*</span><span class="kt">int64</span> <span class="s">`json:&#34;deletionGracePeriodSeconds,omitempty&#34; protobuf:&#34;varint,10,opt,name=deletionGracePeriodSeconds&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Map of string keys and values that can be used to organize and categorize
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// (scope and select) objects. May match selectors of replication controllers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// and services.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: http://kubernetes.io/docs/user-guide/labels
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Labels</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span> <span class="s">`json:&#34;labels,omitempty&#34; protobuf:&#34;bytes,11,rep,name=labels&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Annotations is an unstructured key value map stored with a resource that may be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// set by external tools to store and retrieve arbitrary metadata. They are not
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// queryable and should be preserved when modifying objects.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: http://kubernetes.io/docs/user-guide/annotations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Annotations</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span> <span class="s">`json:&#34;annotations,omitempty&#34; protobuf:&#34;bytes,12,rep,name=annotations&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// List of objects depended by this object. If ALL objects in the list have
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// been deleted, this object will be garbage collected. If this object is managed by a controller,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// then an entry in this list will point to this controller, with the controller field set to true.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// There cannot be more than one managing controller.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchMergeKey=uid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchStrategy=merge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">OwnerReferences</span> <span class="p">[]</span><span class="nx">OwnerReference</span> <span class="s">`json:&#34;ownerReferences,omitempty&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;uid&#34; protobuf:&#34;bytes,13,rep,name=ownerReferences&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Must be empty before the object is deleted from the registry. Each entry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// is an identifier for the responsible component that will remove the entry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// from the list. If the deletionTimestamp of the object is non-nil, entries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// in this list can only be removed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Finalizers may be processed and removed in any order.  Order is NOT enforced
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// because it introduces significant risk of stuck finalizers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// finalizers is a shared field, any actor with permission can reorder it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If the finalizer list is processed in order, then this can lead to a situation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// in which the component responsible for the first finalizer in the list is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// waiting for a signal (field value, external system, or other) produced by a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// component responsible for a finalizer later in the list, resulting in a deadlock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Without enforced ordering finalizers are free to order amongst themselves and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// are not vulnerable to ordering changes in the list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchStrategy=merge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Finalizers</span> <span class="p">[]</span><span class="kt">string</span> <span class="s">`json:&#34;finalizers,omitempty&#34; patchStrategy:&#34;merge&#34; protobuf:&#34;bytes,14,rep,name=finalizers&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Tombstone: ClusterName was a legacy field that was always cleared by
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// the system and never used.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ClusterName string `json:&#34;clusterName,omitempty&#34; protobuf:&#34;bytes,15,opt,name=clusterName&#34;`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ManagedFields maps workflow-id and version to the set of fields
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// that are managed by that workflow. This is mostly for internal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// housekeeping, and users typically shouldn&#39;t need to set or
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// understand this field. A workflow can be the user&#39;s name, a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// controller&#39;s name, or the name of a specific apply path like
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// &#34;ci-cd&#34;. The set of fields is always in the version that the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// workflow used when modifying the object.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ManagedFields</span> <span class="p">[]</span><span class="nx">ManagedFieldsEntry</span> <span class="s">`json:&#34;managedFields,omitempty&#34; protobuf:&#34;bytes,17,rep,name=managedFields&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>Name: API 对象的实例名称</li>
<li>Namespace: 实例存放的 namespace</li>
<li>Labels: 实例的标签，通过 label Selector 可以实现对实例的筛选</li>
<li>Annotations: 携带 key-value 格式的内部信息</li>
</ol>
<h4 id="podspec">PodSpec</h4>
<p><a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api/core/v1/types.go#L3181" target="_blank" rel="noopener noreffer">PodSpec</a> 是为 Pod 定义的结构体</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">PodSpec</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Volumes</span> <span class="p">[]</span><span class="nx">Volume</span> <span class="s">`json:&#34;volumes,omitempty&#34; patchStrategy:&#34;merge,retainKeys&#34; patchMergeKey:&#34;name&#34; protobuf:&#34;bytes,1,rep,name=volumes&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">InitContainers</span> <span class="p">[]</span><span class="nx">Container</span> <span class="s">`json:&#34;initContainers,omitempty&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;name&#34; protobuf:&#34;bytes,20,rep,name=initContainers&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Containers</span> <span class="p">[]</span><span class="nx">Container</span> <span class="s">`json:&#34;containers&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;name&#34; protobuf:&#34;bytes,2,rep,name=containers&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// List of ephemeral containers run in this pod. Ephemeral containers may be run in an existing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// pod to perform user-initiated actions such as debugging. This list cannot be specified when
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// creating a pod, and it cannot be modified by updating the pod spec. In order to add an
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ephemeral container to an existing pod, use the pod&#39;s ephemeralcontainers subresource.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchMergeKey=name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchStrategy=merge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">EphemeralContainers</span> <span class="p">[]</span><span class="nx">EphemeralContainer</span> <span class="s">`json:&#34;ephemeralContainers,omitempty&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;name&#34; protobuf:&#34;bytes,34,rep,name=ephemeralContainers&#34;`</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// 重启策略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">RestartPolicy</span> <span class="nx">RestartPolicy</span> <span class="s">`json:&#34;restartPolicy,omitempty&#34; protobuf:&#34;bytes,3,opt,name=restartPolicy,casttype=RestartPolicy&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Optional duration in seconds the pod needs to terminate gracefully. May be decreased in delete request.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Value must be non-negative integer. The value zero indicates stop immediately via
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// the kill signal (no opportunity to shut down).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If this value is nil, the default grace period will be used instead.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// The grace period is the duration in seconds after the processes running in the pod are sent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// a termination signal and the time when the processes are forcibly halted with a kill signal.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Set this value longer than the expected cleanup time for your process.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Defaults to 30 seconds.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">TerminationGracePeriodSeconds</span> <span class="o">*</span><span class="kt">int64</span> <span class="s">`json:&#34;terminationGracePeriodSeconds,omitempty&#34; protobuf:&#34;varint,4,opt,name=terminationGracePeriodSeconds&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Optional duration in seconds the pod may be active on the node relative to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// StartTime before the system will actively try to mark it failed and kill associated containers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Value must be a positive integer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ActiveDeadlineSeconds</span> <span class="o">*</span><span class="kt">int64</span> <span class="s">`json:&#34;activeDeadlineSeconds,omitempty&#34; protobuf:&#34;varint,5,opt,name=activeDeadlineSeconds&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Set DNS policy for the pod.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Defaults to &#34;ClusterFirst&#34;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Valid values are &#39;ClusterFirstWithHostNet&#39;, &#39;ClusterFirst&#39;, &#39;Default&#39; or &#39;None&#39;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// DNS parameters given in DNSConfig will be merged with the policy selected with DNSPolicy.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// To have DNS options set along with hostNetwork, you have to specify DNS policy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// explicitly to &#39;ClusterFirstWithHostNet&#39;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">DNSPolicy</span> <span class="nx">DNSPolicy</span> <span class="s">`json:&#34;dnsPolicy,omitempty&#34; protobuf:&#34;bytes,6,opt,name=dnsPolicy,casttype=DNSPolicy&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// NodeSelector is a selector which must be true for the pod to fit on a node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Selector which must match a node&#39;s labels for the pod to be scheduled on that node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +mapType=atomic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">NodeSelector</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span> <span class="s">`json:&#34;nodeSelector,omitempty&#34; protobuf:&#34;bytes,7,rep,name=nodeSelector&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ServiceAccountName is the name of the ServiceAccount to use to run this pod.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ServiceAccountName</span> <span class="kt">string</span> <span class="s">`json:&#34;serviceAccountName,omitempty&#34; protobuf:&#34;bytes,8,opt,name=serviceAccountName&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// DeprecatedServiceAccount is a depreciated alias for ServiceAccountName.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Deprecated: Use serviceAccountName instead.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +k8s:conversion-gen=false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">DeprecatedServiceAccount</span> <span class="kt">string</span> <span class="s">`json:&#34;serviceAccount,omitempty&#34; protobuf:&#34;bytes,9,opt,name=serviceAccount&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// AutomountServiceAccountToken indicates whether a service account token should be automatically mounted.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">AutomountServiceAccountToken</span> <span class="o">*</span><span class="kt">bool</span> <span class="s">`json:&#34;automountServiceAccountToken,omitempty&#34; protobuf:&#34;varint,21,opt,name=automountServiceAccountToken&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// NodeName is a request to schedule this pod onto a specific node. If it is non-empty,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// the scheduler simply schedules this pod onto that node, assuming that it fits resource
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// requirements.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">NodeName</span> <span class="kt">string</span> <span class="s">`json:&#34;nodeName,omitempty&#34; protobuf:&#34;bytes,10,opt,name=nodeName&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Host networking requested for this pod. Use the host&#39;s network namespace.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If this option is set, the ports that will be used must be specified.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Default to false.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +k8s:conversion-gen=false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">HostNetwork</span> <span class="kt">bool</span> <span class="s">`json:&#34;hostNetwork,omitempty&#34; protobuf:&#34;varint,11,opt,name=hostNetwork&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Use the host&#39;s pid namespace.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Optional: Default to false.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +k8s:conversion-gen=false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">HostPID</span> <span class="kt">bool</span> <span class="s">`json:&#34;hostPID,omitempty&#34; protobuf:&#34;varint,12,opt,name=hostPID&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Use the host&#39;s ipc namespace.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Optional: Default to false.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +k8s:conversion-gen=false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">HostIPC</span> <span class="kt">bool</span> <span class="s">`json:&#34;hostIPC,omitempty&#34; protobuf:&#34;varint,13,opt,name=hostIPC&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Share a single process namespace between all of the containers in a pod.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// When this is set containers will be able to view and signal processes from other containers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// in the same pod, and the first process in each container will not be assigned PID 1.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// HostPID and ShareProcessNamespace cannot both be set.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Optional: Default to false.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +k8s:conversion-gen=false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ShareProcessNamespace</span> <span class="o">*</span><span class="kt">bool</span> <span class="s">`json:&#34;shareProcessNamespace,omitempty&#34; protobuf:&#34;varint,27,opt,name=shareProcessNamespace&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SecurityContext holds pod-level security attributes and common container settings.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Optional: Defaults to empty.  See type description for default values of each field.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">SecurityContext</span> <span class="o">*</span><span class="nx">PodSecurityContext</span> <span class="s">`json:&#34;securityContext,omitempty&#34; protobuf:&#34;bytes,14,opt,name=securityContext&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ImagePullSecrets is an optional list of references to secrets in the same namespace to use for pulling any of the images used by this PodSpec.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If specified, these secrets will be passed to individual puller implementations for them to use.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/concepts/containers/images#specifying-imagepullsecrets-on-a-pod
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchMergeKey=name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchStrategy=merge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ImagePullSecrets</span> <span class="p">[]</span><span class="nx">LocalObjectReference</span> <span class="s">`json:&#34;imagePullSecrets,omitempty&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;name&#34; protobuf:&#34;bytes,15,rep,name=imagePullSecrets&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Specifies the hostname of the Pod
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If not specified, the pod&#39;s hostname will be set to a system-defined value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Hostname</span> <span class="kt">string</span> <span class="s">`json:&#34;hostname,omitempty&#34; protobuf:&#34;bytes,16,opt,name=hostname&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// If specified, the fully qualified Pod hostname will be &#34;&lt;hostname&gt;.&lt;subdomain&gt;.&lt;pod namespace&gt;.svc.&lt;cluster domain&gt;&#34;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If not specified, the pod will not have a domainname at all.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Subdomain</span> <span class="kt">string</span> <span class="s">`json:&#34;subdomain,omitempty&#34; protobuf:&#34;bytes,17,opt,name=subdomain&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// If specified, the pod&#39;s scheduling constraints
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Affinity</span> <span class="o">*</span><span class="nx">Affinity</span> <span class="s">`json:&#34;affinity,omitempty&#34; protobuf:&#34;bytes,18,opt,name=affinity&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// If specified, the pod will be dispatched by specified scheduler.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If not specified, the pod will be dispatched by default scheduler.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">SchedulerName</span> <span class="kt">string</span> <span class="s">`json:&#34;schedulerName,omitempty&#34; protobuf:&#34;bytes,19,opt,name=schedulerName&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// If specified, the pod&#39;s tolerations.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Tolerations</span> <span class="p">[]</span><span class="nx">Toleration</span> <span class="s">`json:&#34;tolerations,omitempty&#34; protobuf:&#34;bytes,22,opt,name=tolerations&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// HostAliases is an optional list of hosts and IPs that will be injected into the pod&#39;s hosts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// file if specified. This is only valid for non-hostNetwork pods.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchMergeKey=ip
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchStrategy=merge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">HostAliases</span> <span class="p">[]</span><span class="nx">HostAlias</span> <span class="s">`json:&#34;hostAliases,omitempty&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;ip&#34; protobuf:&#34;bytes,23,rep,name=hostAliases&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// If specified, indicates the pod&#39;s priority. &#34;system-node-critical&#34; and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// &#34;system-cluster-critical&#34; are two special keywords which indicate the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// highest priorities with the former being the highest priority. Any other
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// name must be defined by creating a PriorityClass object with that name.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If not specified, the pod priority will be default or zero if there is no
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// default.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">PriorityClassName</span> <span class="kt">string</span> <span class="s">`json:&#34;priorityClassName,omitempty&#34; protobuf:&#34;bytes,24,opt,name=priorityClassName&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// The priority value. Various system components use this field to find the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// priority of the pod. When Priority Admission Controller is enabled, it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// prevents users from setting this field. The admission controller populates
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// this field from PriorityClassName.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// The higher the value, the higher the priority.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Priority</span> <span class="o">*</span><span class="kt">int32</span> <span class="s">`json:&#34;priority,omitempty&#34; protobuf:&#34;bytes,25,opt,name=priority&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Specifies the DNS parameters of a pod.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Parameters specified here will be merged to the generated DNS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// configuration based on DNSPolicy.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">DNSConfig</span> <span class="o">*</span><span class="nx">PodDNSConfig</span> <span class="s">`json:&#34;dnsConfig,omitempty&#34; protobuf:&#34;bytes,26,opt,name=dnsConfig&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// If specified, all readiness gates will be evaluated for pod readiness.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// A pod is ready when all its containers are ready AND
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// all conditions specified in the readiness gates have status equal to &#34;True&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://git.k8s.io/enhancements/keps/sig-network/580-pod-readiness-gates
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ReadinessGates</span> <span class="p">[]</span><span class="nx">PodReadinessGate</span> <span class="s">`json:&#34;readinessGates,omitempty&#34; protobuf:&#34;bytes,28,opt,name=readinessGates&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// RuntimeClassName refers to a RuntimeClass object in the node.k8s.io group, which should be used
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// to run this pod.  If no RuntimeClass resource matches the named class, the pod will not be run.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If unset or empty, the &#34;legacy&#34; RuntimeClass will be used, which is an implicit class with an
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// empty definition that uses the default runtime handler.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://git.k8s.io/enhancements/keps/sig-node/585-runtime-class
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">RuntimeClassName</span> <span class="o">*</span><span class="kt">string</span> <span class="s">`json:&#34;runtimeClassName,omitempty&#34; protobuf:&#34;bytes,29,opt,name=runtimeClassName&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// EnableServiceLinks indicates whether information about services should be injected into pod&#39;s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// environment variables, matching the syntax of Docker links.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Optional: Defaults to true.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">EnableServiceLinks</span> <span class="o">*</span><span class="kt">bool</span> <span class="s">`json:&#34;enableServiceLinks,omitempty&#34; protobuf:&#34;varint,30,opt,name=enableServiceLinks&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// PreemptionPolicy is the Policy for preempting pods with lower priority.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// One of Never, PreemptLowerPriority.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Defaults to PreemptLowerPriority if unset.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">PreemptionPolicy</span> <span class="o">*</span><span class="nx">PreemptionPolicy</span> <span class="s">`json:&#34;preemptionPolicy,omitempty&#34; protobuf:&#34;bytes,31,opt,name=preemptionPolicy&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Overhead represents the resource overhead associated with running a pod for a given RuntimeClass.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This field will be autopopulated at admission time by the RuntimeClass admission controller. If
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// the RuntimeClass admission controller is enabled, overhead must not be set in Pod create requests.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// The RuntimeClass admission controller will reject Pod create requests which have the overhead already
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// set. If RuntimeClass is configured and selected in the PodSpec, Overhead will be set to the value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// defined in the corresponding RuntimeClass, otherwise it will remain unset and treated as zero.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://git.k8s.io/enhancements/keps/sig-node/688-pod-overhead/README.md
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Overhead</span> <span class="nx">ResourceList</span> <span class="s">`json:&#34;overhead,omitempty&#34; protobuf:&#34;bytes,32,opt,name=overhead&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// TopologySpreadConstraints describes how a group of pods ought to spread across topology
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// domains. Scheduler will schedule pods in a way which abides by the constraints.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// All topologySpreadConstraints are ANDed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchMergeKey=topologyKey
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchStrategy=merge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +listType=map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +listMapKey=topologyKey
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +listMapKey=whenUnsatisfiable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">TopologySpreadConstraints</span> <span class="p">[]</span><span class="nx">TopologySpreadConstraint</span> <span class="s">`json:&#34;topologySpreadConstraints,omitempty&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;topologyKey&#34; protobuf:&#34;bytes,33,opt,name=topologySpreadConstraints&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// If true the pod&#39;s hostname will be configured as the pod&#39;s FQDN, rather than the leaf name (the default).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// In Linux containers, this means setting the FQDN in the hostname field of the kernel (the nodename field of struct utsname).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// In Windows containers, this means setting the registry value of hostname for the registry key HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\Tcpip\\Parameters to FQDN.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If a pod does not have FQDN, this has no effect.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Default to false.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">SetHostnameAsFQDN</span> <span class="o">*</span><span class="kt">bool</span> <span class="s">`json:&#34;setHostnameAsFQDN,omitempty&#34; protobuf:&#34;varint,35,opt,name=setHostnameAsFQDN&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Specifies the OS of the containers in the pod.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Some pod and container fields are restricted if this is set.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If the OS field is set to linux, the following fields must be unset:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// -securityContext.windowsOptions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If the OS field is set to windows, following fields must be unset:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.hostPID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.hostIPC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.hostUsers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.securityContext.seLinuxOptions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.securityContext.seccompProfile
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.securityContext.fsGroup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.securityContext.fsGroupChangePolicy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.securityContext.sysctls
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.shareProcessNamespace
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.securityContext.runAsUser
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.securityContext.runAsGroup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.securityContext.supplementalGroups
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.containers[*].securityContext.seLinuxOptions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.containers[*].securityContext.seccompProfile
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.containers[*].securityContext.capabilities
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.containers[*].securityContext.readOnlyRootFilesystem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.containers[*].securityContext.privileged
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.containers[*].securityContext.allowPrivilegeEscalation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.containers[*].securityContext.procMount
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.containers[*].securityContext.runAsUser
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// - spec.containers[*].securityContext.runAsGroup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">OS</span> <span class="o">*</span><span class="nx">PodOS</span> <span class="s">`json:&#34;os,omitempty&#34; protobuf:&#34;bytes,36,opt,name=os&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Use the host&#39;s user namespace.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Optional: Default to true.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If set to true or not present, the pod will be run in the host user namespace, useful
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// for when the pod needs a feature only available to the host user namespace, such as
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// loading a kernel module with CAP_SYS_MODULE.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// When set to false, a new userns is created for the pod. Setting false is useful for
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// mitigating container breakout vulnerabilities even allowing users to run their
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// containers as root without actually having root privileges on the host.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This field is alpha-level and is only honored by servers that enable the UserNamespacesSupport feature.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +k8s:conversion-gen=false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">HostUsers</span> <span class="o">*</span><span class="kt">bool</span> <span class="s">`json:&#34;hostUsers,omitempty&#34; protobuf:&#34;bytes,37,opt,name=hostUsers&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// SchedulingGates is an opaque list of values that if specified will block scheduling the pod.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If schedulingGates is not empty, the pod will stay in the SchedulingGated state and the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// scheduler will not attempt to schedule the pod.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// SchedulingGates can only be set at pod creation time, and be removed only afterwards.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This is a beta feature enabled by the PodSchedulingReadiness feature gate.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchMergeKey=name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchStrategy=merge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +listType=map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +listMapKey=name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +featureGate=PodSchedulingReadiness
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">SchedulingGates</span> <span class="p">[]</span><span class="nx">PodSchedulingGate</span> <span class="s">`json:&#34;schedulingGates,omitempty&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;name&#34; protobuf:&#34;bytes,38,opt,name=schedulingGates&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">ResourceClaims</span> <span class="p">[]</span><span class="nx">PodResourceClaim</span> <span class="s">`json:&#34;resourceClaims,omitempty&#34; patchStrategy:&#34;merge,retainKeys&#34; patchMergeKey:&#34;name&#34; protobuf:&#34;bytes,39,rep,name=resourceClaims&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><a href="https://kubernetes.io/zh-cn/docs/reference/kubernetes-api/workload-resources/pod-v1/#containers" target="_blank" rel="noopener noreffer">PodSpec的字段</a> 包括:</p>
<table>
<thead>
<tr>
<th style="text-align:left">分类</th>
<th style="text-align:left">字段</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">容器定义</td>
<td style="text-align:left">Container ([]Container)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">InitContainers ([]Container)</td>
<td style="text-align:left">Init Containers 的生命周期，会先于所有的 Containers，并且严格按照定义的顺序执行</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">EphemeralContainers ([]EphemeralContainer)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">ImagePullSecrets ([]LocalObjectReference)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">EnableServiceLinks (boolean)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Os (PodOS)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Volumes ([]Volume)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">调度</td>
<td style="text-align:left">NodeSelector (map[string]string)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">NodeName (string)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Affinity (Affinity)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Tolerations ([]Toleration)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">SchedulerName (string)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">RuntimeClassName (string)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">PriorityClassName (string)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Priority (int32)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">PreemptionPolicy (string)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">TopologySpreadConstraints ([]TopologySpreadConstraint)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">生命周期</td>
<td style="text-align:left">restartPolicy (string)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">TerminationGracePeriodSeconds (int64)</td>
<td style="text-align:left">Pod 优雅退出的时间，</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">ActiveDeadlineSeconds (int64)</td>
<td style="text-align:left">在系统将主动尝试将此 Pod 标记为已失败并杀死相关容器之前，Pod 可能在节点上活跃的时长</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">ReadinessGate ([]PodReadinessGate)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">主机名</td>
<td style="text-align:left">Hostname (string)</td>
<td style="text-align:left">指定 Pod 的主机名</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">SetHostnameAsFQDN (boolean)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Subdomain (string)</td>
<td style="text-align:left">如果设置了此字段，则完全限定的 Pod 主机名将是 <code>&lt;hostname&gt;.&lt;subdomain&gt;.&lt;Pod 名字空间&gt;.svc.&lt;集群域名&gt;</code>。 如果未设置此字段，则该 Pod 将没有域名。</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">HostAliases ([]HostAlias)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">DNS</td>
<td style="text-align:left">DnsConfig (PodDNSConfig)</td>
<td style="text-align:left">指定 Pod 的 DNS 参数</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">DnsPolicy (string)</td>
<td style="text-align:left">为 Pod 设置 DNS 策略</td>
</tr>
<tr>
<td style="text-align:left">Namespace</td>
<td style="text-align:left">HostNetwork (boolean)</td>
<td style="text-align:left">为此 Pod 请求主机层面联网支持。使用主机的 host namespace</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">HostPID (boolean)</td>
<td style="text-align:left">使用主机的 PID 名字空间</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">HostIPC (boolean)</td>
<td style="text-align:left">使用主机的 IPC 名字空间</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">HostUsers (boolean)</td>
<td style="text-align:left">使用主机的用户名字空间</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">ShareProcessNamespace (boolean)</td>
<td style="text-align:left">Pod 里的容器要共享 PID Namespace</td>
</tr>
<tr>
<td style="text-align:left">认证</td>
<td style="text-align:left">ServiceAccountName (string)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">AutomountServiceAccountToken (boolean)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">安全控制</td>
<td style="text-align:left">securityContext (PodSecurityContext)</td>
<td style="text-align:left">Pod 级别的安全属性和常见的容器设置</td>
</tr>
</tbody>
</table>
<h2 id="3-pod-重要字段">3. Pod 重要字段</h2>
<h3 id="21-调度相关">2.1 调度相关</h3>
<p>与调度有关的字段包括:</p>
<ol>
<li>NodeName：</li>
</ol>
<ul>
<li>一旦 Pod 的这个字段被赋值，Kubernetes 项目就会被认为这个 Pod 已经经过了调度，调度的结果就是赋值的节点名字</li>
<li>所以，这个字段一般由调度器负责设置，但用户也可以设置它来“骗过”调度器，当然这个做法一般是在测试或者调试的时候才会用到</li>
</ul>
<ol start="2">
<li>NodeSelector：通过 label 选择特定范围的 Node</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">disktype</span><span class="p">:</span><span class="w"> </span><span class="l">ssd</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这样的一个配置，意味着这个 Pod 永远只能运行在携带了“disktype: ssd”标签(Label)的节点上；否则，它将调度失败。</p>
<h3 id="22-网络配置">2.2 网络配置</h3>
<p>与网络配置有关的字段包括:</p>
<ol>
<li>HostAliases：定义了 Pod 的 hosts 文件(比如 /etc/hosts)里的内容</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hostAliases</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.1.2.3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostnames</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s2">&#34;foo.remote&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s2">&#34;bar.remote&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>上面配置的 Pod 启动后，/etc/hosts 文件的内容将如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cat /etc/hosts
</span></span><span class="line"><span class="cl"># Kubernetes-managed hosts file.
</span></span><span class="line"><span class="cl">127.0.0.1 localhost
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">10.244.135.10 hostaliases-pod
</span></span><span class="line"><span class="cl"># 通过 HostAliases 字段为 Pod 设置的
</span></span><span class="line"><span class="cl">10.1.2.3 foo.remote
</span></span><span class="line"><span class="cl">10.1.2.3 bar.remote
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="23-linux-namespace-相关">2.3 Linux Namespace 相关</h3>
<p>与 Namespace 配置有关的字段包括:</p>
<ol>
<li><code>shareProcessNamespace: true</code>: Pod 里的容器要共享 PID Namespace</li>
<li><code>hostNetwork: true</code>: 共享宿主机的 Network Namespace</li>
<li><code>hostIPC: true</code>: 共享宿主机的 IPC Namespace</li>
<li><code>hostPID: true</code>: 共享宿主机的 PID Namespace</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">shareProcessNamespace</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">shell</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stdin</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tty</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 可以直接认为 tty 就是 Linux 给用户提供的一个常驻小程序，用于接收用户的标准输入，返回操作系统的标准输出。</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 为了能够在 tty 中输入信息，你还需要同时开启 stdin(标准输入流)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 连接到 shell 容器的 tty 上</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># kubectl attach -it nginx -c shell</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hostNetwork</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hostIPC</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hostPID</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="24-pod-恢复机制">2.4 Pod 恢复机制</h3>
<p>RestartPolicy 定义了 Pod 的恢复机制，默认值是 Always，即：任何时候这个容器发生了异常，它一定会被重新创建。</p>
<p>需要强调的是，Pod 的恢复过程，永远都是发生在当前节点上，而不会跑到别的节点上去。事实上，一旦一个 Pod 与一个节点（Node）绑定，除非这个绑定发生了变化（pod.spec.node 字段被修改），否则它永远都不会离开这个节点。这也就意味着，如果这个宿主机宕机了，这个 Pod 也不会主动迁移到其他节点上去。而如果你想让 Pod 出现在其他的可用节点上，就必须使用 Deployment 这样的“控制器”来管理 Pod。</p>
<p>restartPolicy 的可选值包括：</p>
<ol>
<li>Always：在任何情况下，只要容器不在运行状态，就自动重启容器；</li>
<li>OnFailure: 只在容器 异常时才自动重启容器；</li>
<li>Never: 从来不重启容器。</li>
</ol>
<p>在实际使用时，我们需要根据应用运行的特性，合理设置这三种恢复策略。如果 Pod 执行的是一个一次性的 job 任务，就不要设置成 Always 了。如果你要关心这个容器退出后的上下文环境，比如容器退出后的日志、文件和目录，就需要将 restartPolicy 设置为 Never。因为一旦容器被自动重新创建，这些内容就有可能丢失掉了（被垃圾回收了）。</p>
<h4 id="restartpolicy-与容器状态的关系">restartPolicy 与容器状态的关系</h4>
<p>Kubernetes 的官方文档，把 restartPolicy 和 Pod 里容器的状态，以及 Pod 状态的对应关系，<a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#example-states" target="_blank" rel="noopener noreffer">总结了非常复杂的一大堆情况</a>。但总体的设计原则是:</p>
<ol>
<li>只要 Pod 的 restartPolicy 指定的策略允许重启异常的容器（比如：Always），那么这个 Pod 就会保持 Running 状态，并进行容器重启。否则，Pod 就会进入 Failed 状态 。</li>
<li>对于包含多个容器的 Pod，只有它里面所有的容器都进入异常状态后，Pod 才会进入 Failed 状态。在此之前，Pod 都是 Running 状态。此时，Pod 的 READY 字段会显示正常容器的个数</li>
</ol>
<p>所以，假如一个 Pod 里只有一个容器，然后这个容器异常退出了。那么，只有当 restartPolicy=Never 时，这个 Pod 才会进入 Failed 状态。而其他情况下，由于 Kubernetes 都可以重启这个容器，所以 Pod 的状态保持 Running 不变。</p>
<p>而如果这个 Pod 有多个容器，仅有一个容器异常退出，它就始终保持 Running 状态，哪怕即使 restartPolicy=Never。只有当所有容器也异常退出之后，这个 Pod 才会进入 Failed 状态。</p>
<h2 id="3-container-定义">3. Container 定义</h2>
<p><a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api/core/v1/types.go#L2372" target="_blank" rel="noopener noreffer">Container</a> 的结构体定义如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Container</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Name of the container specified as a DNS_LABEL.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Each container in a pod must have a unique name (DNS_LABEL).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Cannot be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Name</span> <span class="kt">string</span> <span class="s">`json:&#34;name&#34; protobuf:&#34;bytes,1,opt,name=name&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Container image name.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/concepts/containers/images
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This field is optional to allow higher level config management to default or override
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// container images in workload controllers like Deployments and StatefulSets.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Image</span> <span class="kt">string</span> <span class="s">`json:&#34;image,omitempty&#34; protobuf:&#34;bytes,2,opt,name=image&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Entrypoint array. Not executed within a shell.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// The container image&#39;s ENTRYPOINT is used if this is not provided.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Variable references $(VAR_NAME) are expanded using the container&#39;s environment. If a variable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// cannot be resolved, the reference in the input string will be unchanged. Double $$ are reduced
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// to a single $, which allows for escaping the $(VAR_NAME) syntax: i.e. &#34;$$(VAR_NAME)&#34; will
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// produce the string literal &#34;$(VAR_NAME)&#34;. Escaped references will never be expanded, regardless
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// of whether the variable exists or not. Cannot be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container/#running-a-command-in-a-shell
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Command</span> <span class="p">[]</span><span class="kt">string</span> <span class="s">`json:&#34;command,omitempty&#34; protobuf:&#34;bytes,3,rep,name=command&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Arguments to the entrypoint.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// The container image&#39;s CMD is used if this is not provided.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Variable references $(VAR_NAME) are expanded using the container&#39;s environment. If a variable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// cannot be resolved, the reference in the input string will be unchanged. Double $$ are reduced
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// to a single $, which allows for escaping the $(VAR_NAME) syntax: i.e. &#34;$$(VAR_NAME)&#34; will
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// produce the string literal &#34;$(VAR_NAME)&#34;. Escaped references will never be expanded, regardless
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// of whether the variable exists or not. Cannot be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container/#running-a-command-in-a-shell
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Args</span> <span class="p">[]</span><span class="kt">string</span> <span class="s">`json:&#34;args,omitempty&#34; protobuf:&#34;bytes,4,rep,name=args&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Container&#39;s working directory.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If not specified, the container runtime&#39;s default will be used, which
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// might be configured in the container image.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Cannot be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">WorkingDir</span> <span class="kt">string</span> <span class="s">`json:&#34;workingDir,omitempty&#34; protobuf:&#34;bytes,5,opt,name=workingDir&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// List of ports to expose from the container. Not specifying a port here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// DOES NOT prevent that port from being exposed. Any port which is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// listening on the default &#34;0.0.0.0&#34; address inside a container will be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// accessible from the network.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Modifying this array with strategic merge patch may corrupt the data.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// For more information See https://github.com/kubernetes/kubernetes/issues/108255.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Cannot be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchMergeKey=containerPort
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchStrategy=merge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +listType=map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +listMapKey=containerPort
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +listMapKey=protocol
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Ports</span> <span class="p">[]</span><span class="nx">ContainerPort</span> <span class="s">`json:&#34;ports,omitempty&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;containerPort&#34; protobuf:&#34;bytes,6,rep,name=ports&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// List of sources to populate environment variables in the container.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// The keys defined within a source must be a C_IDENTIFIER. All invalid keys
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// will be reported as an event when the container is starting. When a key exists in multiple
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// sources, the value associated with the last source will take precedence.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Values defined by an Env with a duplicate key will take precedence.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Cannot be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">EnvFrom</span> <span class="p">[]</span><span class="nx">EnvFromSource</span> <span class="s">`json:&#34;envFrom,omitempty&#34; protobuf:&#34;bytes,19,rep,name=envFrom&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// List of environment variables to set in the container.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Cannot be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchMergeKey=name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchStrategy=merge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Env</span> <span class="p">[]</span><span class="nx">EnvVar</span> <span class="s">`json:&#34;env,omitempty&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;name&#34; protobuf:&#34;bytes,7,rep,name=env&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Compute Resources required by this container.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Cannot be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Resources</span> <span class="nx">ResourceRequirements</span> <span class="s">`json:&#34;resources,omitempty&#34; protobuf:&#34;bytes,8,opt,name=resources&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Pod volumes to mount into the container&#39;s filesystem.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Cannot be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchMergeKey=mountPath
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchStrategy=merge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">VolumeMounts</span> <span class="p">[]</span><span class="nx">VolumeMount</span> <span class="s">`json:&#34;volumeMounts,omitempty&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;mountPath&#34; protobuf:&#34;bytes,9,rep,name=volumeMounts&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// volumeDevices is the list of block devices to be used by the container.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchMergeKey=devicePath
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchStrategy=merge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">VolumeDevices</span> <span class="p">[]</span><span class="nx">VolumeDevice</span> <span class="s">`json:&#34;volumeDevices,omitempty&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;devicePath&#34; protobuf:&#34;bytes,21,rep,name=volumeDevices&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Periodic probe of container liveness.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Container will be restarted if the probe fails.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Cannot be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle#container-probes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">LivenessProbe</span> <span class="o">*</span><span class="nx">Probe</span> <span class="s">`json:&#34;livenessProbe,omitempty&#34; protobuf:&#34;bytes,10,opt,name=livenessProbe&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Periodic probe of container service readiness.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Container will be removed from service endpoints if the probe fails.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Cannot be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle#container-probes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ReadinessProbe</span> <span class="o">*</span><span class="nx">Probe</span> <span class="s">`json:&#34;readinessProbe,omitempty&#34; protobuf:&#34;bytes,11,opt,name=readinessProbe&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// StartupProbe indicates that the Pod has successfully initialized.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If specified, no other probes are executed until this completes successfully.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If this probe fails, the Pod will be restarted, just as if the livenessProbe failed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This can be used to provide different probe parameters at the beginning of a Pod&#39;s lifecycle,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// when it might take a long time to load data or warm a cache, than during steady-state operation.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This cannot be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle#container-probes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">StartupProbe</span> <span class="o">*</span><span class="nx">Probe</span> <span class="s">`json:&#34;startupProbe,omitempty&#34; protobuf:&#34;bytes,22,opt,name=startupProbe&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Actions that the management system should take in response to container lifecycle events.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Cannot be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Lifecycle</span> <span class="o">*</span><span class="nx">Lifecycle</span> <span class="s">`json:&#34;lifecycle,omitempty&#34; protobuf:&#34;bytes,12,opt,name=lifecycle&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Optional: Path at which the file to which the container&#39;s termination message
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// will be written is mounted into the container&#39;s filesystem.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Message written is intended to be brief final status, such as an assertion failure message.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Will be truncated by the node if greater than 4096 bytes. The total message length across
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// all containers will be limited to 12kb.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Defaults to /dev/termination-log.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Cannot be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">TerminationMessagePath</span> <span class="kt">string</span> <span class="s">`json:&#34;terminationMessagePath,omitempty&#34; protobuf:&#34;bytes,13,opt,name=terminationMessagePath&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Indicate how the termination message should be populated. File will use the contents of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// terminationMessagePath to populate the container status message on both success and failure.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// FallbackToLogsOnError will use the last chunk of container log output if the termination
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// message file is empty and the container exited with an error.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// The log output is limited to 2048 bytes or 80 lines, whichever is smaller.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Defaults to File.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Cannot be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">TerminationMessagePolicy</span> <span class="nx">TerminationMessagePolicy</span> <span class="s">`json:&#34;terminationMessagePolicy,omitempty&#34; protobuf:&#34;bytes,20,opt,name=terminationMessagePolicy,casttype=TerminationMessagePolicy&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Image pull policy.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// One of Always, Never, IfNotPresent.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Defaults to Always if :latest tag is specified, or IfNotPresent otherwise.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Cannot be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/concepts/containers/images#updating-images
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ImagePullPolicy</span> <span class="nx">PullPolicy</span> <span class="s">`json:&#34;imagePullPolicy,omitempty&#34; protobuf:&#34;bytes,14,opt,name=imagePullPolicy,casttype=PullPolicy&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SecurityContext defines the security options the container should be run with.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If set, the fields of SecurityContext override the equivalent fields of PodSecurityContext.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/tasks/configure-pod-container/security-context/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">SecurityContext</span> <span class="o">*</span><span class="nx">SecurityContext</span> <span class="s">`json:&#34;securityContext,omitempty&#34; protobuf:&#34;bytes,15,opt,name=securityContext&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Variables for interactive containers, these have very specialized use-cases (e.g. debugging)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// and shouldn&#39;t be used for general purpose containers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Whether this container should allocate a buffer for stdin in the container runtime. If this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// is not set, reads from stdin in the container will always result in EOF.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Default is false.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Stdin</span> <span class="kt">bool</span> <span class="s">`json:&#34;stdin,omitempty&#34; protobuf:&#34;varint,16,opt,name=stdin&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Whether the container runtime should close the stdin channel after it has been opened by
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// a single attach. When stdin is true the stdin stream will remain open across multiple attach
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// sessions. If stdinOnce is set to true, stdin is opened on container start, is empty until the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// first client attaches to stdin, and then remains open and accepts data until the client disconnects,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// at which time stdin is closed and remains closed until the container is restarted. If this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// flag is false, a container processes that reads from stdin will never receive an EOF.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Default is false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">StdinOnce</span> <span class="kt">bool</span> <span class="s">`json:&#34;stdinOnce,omitempty&#34; protobuf:&#34;varint,17,opt,name=stdinOnce&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Whether this container should allocate a TTY for itself, also requires &#39;stdin&#39; to be true.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Default is false.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">TTY</span> <span class="kt">bool</span> <span class="s">`json:&#34;tty,omitempty&#34; protobuf:&#34;varint,18,opt,name=tty&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><a href="https://kubernetes.io/zh-cn/docs/reference/kubernetes-api/workload-resources/pod-v1/#Container" target="_blank" rel="noopener noreffer">Container的字段</a> 包括:</p>
<table>
<thead>
<tr>
<th style="text-align:left">分类</th>
<th style="text-align:left">字段</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Docker</td>
<td style="text-align:left">name (string)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">image (string)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">imagePullPolicy (string)</td>
<td style="text-align:left">镜像拉取策略</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">command ([]string)</td>
<td style="text-align:left">entrypoint array，默认使用容器内的 ENTRYPOINT</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">args ([]string)</td>
<td style="text-align:left">entrypoint 的参数，默认使用容器镜像的 CMD</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">workingDir (string)</td>
<td style="text-align:left">容器的工作目录</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">ports([]ContainerPort)</td>
<td style="text-align:left">容器暴露的端口列表，不指定端口不会阻止该端口被暴露</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">env([]EnvVar)</td>
<td style="text-align:left">在容器中设置的环境变量列表，无法更新</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">envFrom ([]EnvFromSource)</td>
<td style="text-align:left">容器中填充环境变量的数据源列表</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">volumeMounts ([]VolumeMount)</td>
<td style="text-align:left">挂载到容器文件系统中的 Pod 卷</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">volumeDevices ([]VolumeDevice)</td>
<td style="text-align:left">容器要使用的块设备列表</td>
</tr>
<tr>
<td style="text-align:left">资源限制</td>
<td style="text-align:left">resources(ResourceRequirements)</td>
<td style="text-align:left">容器所需的计算资源</td>
</tr>
<tr>
<td style="text-align:left">Hook</td>
<td style="text-align:left">lifecycle (Lifecycle)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">terminationMessagePath (string)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">terminationMessagePolicy (string)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">健康检查</td>
<td style="text-align:left">livenessProbe (Probe)</td>
<td style="text-align:left">定期探针容器活跃度。如果探针失败，容器将重新启动</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">readinessProbe (Probe)</td>
<td style="text-align:left">定期探测容器服务就绪情况。如果探针失败，容器将被从服务端点中删除</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">startupProbe (Probe)</td>
<td style="text-align:left">startupProbe 表示 Pod 已成功初始化。如果设置了此字段，则此探针成功完成之前不会执行其他探针。如果这个探针失败，Pod 会重新启动，就像存活态探针失败一样</td>
</tr>
<tr>
<td style="text-align:left">安全控制</td>
<td style="text-align:left">securityContext (SecurityContext)</td>
<td style="text-align:left">定义了容器应该运行的安全选项，将覆盖Pod SecurityContext 的同名字段</td>
</tr>
<tr>
<td style="text-align:left">调试</td>
<td style="text-align:left">stdin(boolean)</td>
<td style="text-align:left">此容器是否应在容器运行时为 stdin 分配缓冲区。如果未设置，从容器中的 stdin 读取将始终导致 EOF。 默认为 false</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">stdinOnce(boolean)</td>
<td style="text-align:left">stdin 是否在第一链接后就关闭</td>
</tr>
</tbody>
</table>
<h2 id="4-container-重要字段">4. Container 重要字段</h2>
<h3 id="41-docker-常规字段">4.1 Docker 常规字段</h3>
<p>Docker 常规字段包括定义容器运行的相关参数，常用的字段包括:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 常规字段</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">geektime/tomcat:7.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">workingDir</span><span class="p">:</span><span class="w"> </span><span class="l">/root</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tomcat</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;sh&#34;</span><span class="p">,</span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="s2">&#34;/root/apache-tomcat-7.0.42-v2/bin/start.sh&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="m">8001</span><span class="w"> 
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="imagepullpolicy">ImagePullPolicy</h4>
<p>ImagePullPolicy 定义了镜像拉取的策略</p>
<ul>
<li>Always: 默认值，每次创建 Pod 都重新拉取一次镜像。另外，当容器的镜像是类似于 nginx 或者 nginx:latest 这样的名字时，ImagePullPolicy 也会被认为 Always</li>
<li>Never 或者 IfNotPresent，则意味着 Pod 永远不会主动拉取这个镜像，或者只在宿主机上不存在这个镜像时才拉取</li>
</ul>
<h3 id="42-容器健康检查">4.2 容器健康检查</h3>
<p>在 Kubernetes 中，你可以为 Pod 里的容器定义各种探针(Probe) kubelet 会根据这些 Probe 的返回值决定容器的可用性。</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api/core/v1/types.go#L2215" target="_blank" rel="noopener noreffer">Probe</a> 的定义如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Probe</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// The action taken to determine the health of a container
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ProbeHandler</span> <span class="s">`json:&#34;,inline&#34; protobuf:&#34;bytes,1,opt,name=handler&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Number of seconds after the container has started before liveness probes are initiated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle#container-probes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">InitialDelaySeconds</span> <span class="kt">int32</span> <span class="s">`json:&#34;initialDelaySeconds,omitempty&#34; protobuf:&#34;varint,2,opt,name=initialDelaySeconds&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Number of seconds after which the probe times out.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Defaults to 1 second. Minimum value is 1.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle#container-probes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">TimeoutSeconds</span> <span class="kt">int32</span> <span class="s">`json:&#34;timeoutSeconds,omitempty&#34; protobuf:&#34;varint,3,opt,name=timeoutSeconds&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// How often (in seconds) to perform the probe.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Default to 10 seconds. Minimum value is 1.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">PeriodSeconds</span> <span class="kt">int32</span> <span class="s">`json:&#34;periodSeconds,omitempty&#34; protobuf:&#34;varint,4,opt,name=periodSeconds&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Minimum consecutive successes for the probe to be considered successful after having failed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Defaults to 1. Must be 1 for liveness and startup. Minimum value is 1.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">SuccessThreshold</span> <span class="kt">int32</span> <span class="s">`json:&#34;successThreshold,omitempty&#34; protobuf:&#34;varint,5,opt,name=successThreshold&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Minimum consecutive failures for the probe to be considered failed after having succeeded.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Defaults to 3. Minimum value is 1.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">FailureThreshold</span> <span class="kt">int32</span> <span class="s">`json:&#34;failureThreshold,omitempty&#34; protobuf:&#34;varint,6,opt,name=failureThreshold&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Optional duration in seconds the pod needs to terminate gracefully upon probe failure.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// The grace period is the duration in seconds after the processes running in the pod are sent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// a termination signal and the time when the processes are forcibly halted with a kill signal.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Set this value longer than the expected cleanup time for your process.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If this value is nil, the pod&#39;s terminationGracePeriodSeconds will be used. Otherwise, this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// value overrides the value provided by the pod spec.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Value must be non-negative integer. The value zero indicates stop immediately via
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// the kill signal (no opportunity to shut down).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This is a beta field and requires enabling ProbeTerminationGracePeriod feature gate.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Minimum value is 1. spec.terminationGracePeriodSeconds is used if unset.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">TerminationGracePeriodSeconds</span> <span class="o">*</span><span class="kt">int64</span> <span class="s">`json:&#34;terminationGracePeriodSeconds,omitempty&#34; protobuf:&#34;varint,7,opt,name=terminationGracePeriodSeconds&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>|字段|含义|
|TimeoutSeconds (int32)|容器启动后启动存活态探针之前的秒数|
|terminationGracePeriodSeconds （int64）|Pod 需要在探针失败时体面终止所需的时间长度，Pod 优雅终止需要的时间|
|periodSeconds (int32)|探针的执行周期|
|timeoutSeconds (int32)|探针超时的秒数|
|failureThreshold (int32)|探针成功后的最小连续失败次数，超出此阈值则认为探针失败|
|successThreshold (int32)|探针失败后最小连续成功次数，超过此阈值才会被视为探针成功|
|ProbeHandler|定义探针的类型|</p>
<p>ProbeHandler 包含的探针有如下几种类型:</p>
<ol>
<li>Exec: 在容器启动后，在容器里面执行一条的命令</li>
<li>HTTPGet: 在容器启动后，发送一个 get 请求</li>
<li>TCPSocket: 在容器启动后，尝试一次 Tcp 连接</li>
<li>GRPCAction: 在容器启动后，发送一个 Grpc 请求</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ProbeHandler</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Exec specifies the action to take.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Exec</span> <span class="o">*</span><span class="nx">ExecAction</span> <span class="s">`json:&#34;exec,omitempty&#34; protobuf:&#34;bytes,1,opt,name=exec&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// HTTPGet specifies the http request to perform.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">HTTPGet</span> <span class="o">*</span><span class="nx">HTTPGetAction</span> <span class="s">`json:&#34;httpGet,omitempty&#34; protobuf:&#34;bytes,2,opt,name=httpGet&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// TCPSocket specifies an action involving a TCP port.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">TCPSocket</span> <span class="o">*</span><span class="nx">TCPSocketAction</span> <span class="s">`json:&#34;tcpSocket,omitempty&#34; protobuf:&#34;bytes,3,opt,name=tcpSocket&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// GRPC specifies an action involving a GRPC port.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This is a beta field and requires enabling GRPCContainerProbe feature gate.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +featureGate=GRPCContainerProbe
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">GRPC</span> <span class="o">*</span><span class="nx">GRPCAction</span> <span class="s">`json:&#34;grpc,omitempty&#34; protobuf:&#34;bytes,4,opt,name=grpc&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// TCPSocketAction describes an action based on opening a socket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">TCPSocketAction</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Number or name of the port to access on the container.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Number must be in the range 1 to 65535.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Name must be an IANA_SVC_NAME.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Port</span> <span class="nx">intstr</span><span class="p">.</span><span class="nx">IntOrString</span> <span class="s">`json:&#34;port&#34; protobuf:&#34;bytes,1,opt,name=port&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Optional: Host name to connect to, defaults to the pod IP.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Host</span> <span class="kt">string</span> <span class="s">`json:&#34;host,omitempty&#34; protobuf:&#34;bytes,2,opt,name=host&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">GRPCAction</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Port number of the gRPC service. Number must be in the range 1 to 65535.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Port</span> <span class="kt">int32</span> <span class="s">`json:&#34;port&#34; protobuf:&#34;bytes,1,opt,name=port&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Service is the name of the service to place in the gRPC HealthCheckRequest
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// (see https://github.com/grpc/grpc/blob/master/doc/health-checking.md).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If this is not specified, the default behavior is defined by gRPC.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +default=&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Service</span> <span class="o">*</span><span class="kt">string</span> <span class="s">`json:&#34;service&#34; protobuf:&#34;bytes,2,opt,name=service&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ExecAction describes a &#34;run in container&#34; action.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">ExecAction</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Command is the command line to execute inside the container, the working directory for the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// command  is root (&#39;/&#39;) in the container&#39;s filesystem. The command is simply exec&#39;d, it is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// not run inside a shell, so traditional shell instructions (&#39;|&#39;, etc) won&#39;t work. To use
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// a shell, you need to explicitly call out to that shell.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Exit status of 0 is treated as live/healthy and non-zero is unhealthy.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Command</span> <span class="p">[]</span><span class="kt">string</span> <span class="s">`json:&#34;command,omitempty&#34; protobuf:&#34;bytes,1,rep,name=command&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HTTPGetAction describes an action based on HTTP Get requests.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">HTTPGetAction</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Path to access on the HTTP server.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Path</span> <span class="kt">string</span> <span class="s">`json:&#34;path,omitempty&#34; protobuf:&#34;bytes,1,opt,name=path&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Name or number of the port to access on the container.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Number must be in the range 1 to 65535.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Name must be an IANA_SVC_NAME.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Port</span> <span class="nx">intstr</span><span class="p">.</span><span class="nx">IntOrString</span> <span class="s">`json:&#34;port&#34; protobuf:&#34;bytes,2,opt,name=port&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Host name to connect to, defaults to the pod IP. You probably want to set
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// &#34;Host&#34; in httpHeaders instead.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Host</span> <span class="kt">string</span> <span class="s">`json:&#34;host,omitempty&#34; protobuf:&#34;bytes,3,opt,name=host&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Scheme to use for connecting to the host.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Defaults to HTTP.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Scheme</span> <span class="nx">URIScheme</span> <span class="s">`json:&#34;scheme,omitempty&#34; protobuf:&#34;bytes,4,opt,name=scheme,casttype=URIScheme&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Custom headers to set in the request. HTTP allows repeated headers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">HTTPHeaders</span> <span class="p">[]</span><span class="nx">HTTPHeader</span> <span class="s">`json:&#34;httpHeaders,omitempty&#34; protobuf:&#34;bytes,5,rep,name=httpHeaders&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">HTTPHeader</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// The header field name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Name</span> <span class="kt">string</span> <span class="s">`json:&#34;name&#34; protobuf:&#34;bytes,1,opt,name=name&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// The header field value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Value</span> <span class="kt">string</span> <span class="s">`json:&#34;value&#34; protobuf:&#34;bytes,2,opt,name=value&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="livenessprobe">livenessProbe</h4>
<p>livenessProbe 定义一个健康检查“探针”（Probe）。kubelet 会根据这个 Probe 的返回值决定这个容器的状态，而不是直接以容器镜像是否运行（来自 Docker 返回的信息）作为依据。这种机制，是生产环境中保证应用健康存活的重要手段。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="l">liveness</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-liveness-exec</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">liveness</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">/bin/sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- -<span class="l">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">cat</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">/tmp/healthy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/healthz</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="nt">httpHeaders</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">X-Custom-Header</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">Awesome</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">tcpSocket</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">15</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="readinessprobe">readinessProbe</h4>
<p>readinessProbe 用法与 livenessProbe 类似，但作用却大不一样。readinessProbe 检查结果的成功与否，决定的这个 Pod 是不是能被通过 Service 的方式访问到，而并不影响 Pod 的生命周期。</p>
<h3 id="43-hook">4.3 Hook</h3>
<p>Lifecycle 定义的是 Container Lifecycle Hooks。顾名思义，Container Lifecycle Hooks 就是在容器状态发生变化时触发一系列“钩子”。</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api/core/v1/types.go#L2559" target="_blank" rel="noopener noreffer">LifecycleHandler</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// LifecycleHandler defines a specific action that should be taken in a lifecycle
</span></span></span><span class="line"><span class="cl"><span class="c1">// hook. One and only one of the fields, except TCPSocket must be specified.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">LifecycleHandler</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Exec specifies the action to take.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Exec</span> <span class="o">*</span><span class="nx">ExecAction</span> <span class="s">`json:&#34;exec,omitempty&#34; protobuf:&#34;bytes,1,opt,name=exec&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// HTTPGet specifies the http request to perform.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">HTTPGet</span> <span class="o">*</span><span class="nx">HTTPGetAction</span> <span class="s">`json:&#34;httpGet,omitempty&#34; protobuf:&#34;bytes,2,opt,name=httpGet&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Deprecated. TCPSocket is NOT supported as a LifecycleHandler and kept
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// for the backward compatibility. There are no validation of this field and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// lifecycle hooks will fail in runtime when tcp handler is specified.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">TCPSocket</span> <span class="o">*</span><span class="nx">TCPSocketAction</span> <span class="s">`json:&#34;tcpSocket,omitempty&#34; protobuf:&#34;bytes,3,opt,name=tcpSocket&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Lifecycle describes actions that the management system should take in response to container lifecycle
</span></span></span><span class="line"><span class="cl"><span class="c1">// events. For the PostStart and PreStop lifecycle handlers, management of the container blocks
</span></span></span><span class="line"><span class="cl"><span class="c1">// until the action is complete, unless the container process fails, in which case the handler is aborted.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Lifecycle</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// PostStart is called immediately after a container is created. If the handler fails,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// the container is terminated and restarted according to its restart policy.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Other management of the container blocks until the hook completes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#container-hooks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">PostStart</span> <span class="o">*</span><span class="nx">LifecycleHandler</span> <span class="s">`json:&#34;postStart,omitempty&#34; protobuf:&#34;bytes,1,opt,name=postStart&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// PreStop is called immediately before a container is terminated due to an
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// API request or management event such as liveness/startup probe failure,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// preemption, resource contention, etc. The handler is not called if the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// container crashes or exits. The Pod&#39;s termination grace period countdown begins before the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// PreStop hook is executed. Regardless of the outcome of the handler, the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// container will eventually terminate within the Pod&#39;s termination grace
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// period (unless delayed by finalizers). Other management of the container blocks until the hook completes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// or until the termination grace period is reached.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#container-hooks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">PreStop</span> <span class="o">*</span><span class="nx">LifecycleHandler</span> <span class="s">`json:&#34;preStop,omitempty&#34; protobuf:&#34;bytes,2,opt,name=preStop&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中:</p>
<ol>
<li>postStart:</li>
</ol>
<ul>
<li>指的是，在容器启动后，立刻执行一个指定的操作。</li>
<li>需要明确的是，postStart 定义的操作，虽然是在 Docker 容器 ENTRYPOINT 执行之后，但它并不严格保证顺序。</li>
<li>也就是说，在 postStart 启动时，ENTRYPOINT 有可能还没有结束。</li>
<li>如果 postStart 执行超时或者错误，Kubernetes 会在该 Pod 的 Events 中报出该容器启动失败的错误信息，导致 Pod 也处于失败的状态</li>
</ul>
<ol start="2">
<li>preStop:</li>
</ol>
<ul>
<li>发生的时机，则是容器被杀死之前</li>
<li>preStop 操作的执行是同步的。所以，它会阻塞当前的容器杀死流程，直到这个 Hook 定义操作完成之后，才允许容器被杀死，这跟 postStart 不一样</li>
</ul>
<p>LifecycleHandler 包含的 Handler 与 ProbeHandler 基本一直，只是少了 GRPCAction</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">lifecycle-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">lifecycle-demo-container</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">postStart</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;echo Hello from the postStart handler &gt; /usr/share/message&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">preStop</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/usr/sbin/nginx&#34;</span><span class="p">,</span><span class="s2">&#34;-s&#34;</span><span class="p">,</span><span class="s2">&#34;quit&#34;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="5-pod-生命周期">5. Pod 生命周期</h2>
<p><a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api/core/v1/types.go#L4061" target="_blank" rel="noopener noreffer">PodStatus</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">PodStatus</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Phase</span> <span class="nx">PodPhase</span> <span class="s">`json:&#34;phase,omitempty&#34; protobuf:&#34;bytes,1,opt,name=phase,casttype=PodPhase&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Current service state of pod.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle#pod-conditions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchMergeKey=type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchStrategy=merge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Conditions</span> <span class="p">[]</span><span class="nx">PodCondition</span> <span class="s">`json:&#34;conditions,omitempty&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;type&#34; protobuf:&#34;bytes,2,rep,name=conditions&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// A human readable message indicating details about why the pod is in this condition.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Message</span> <span class="kt">string</span> <span class="s">`json:&#34;message,omitempty&#34; protobuf:&#34;bytes,3,opt,name=message&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// A brief CamelCase message indicating details about why the pod is in this state.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// e.g. &#39;Evicted&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Reason</span> <span class="kt">string</span> <span class="s">`json:&#34;reason,omitempty&#34; protobuf:&#34;bytes,4,opt,name=reason&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// nominatedNodeName is set only when this pod preempts other pods on the node, but it cannot be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// scheduled right away as preemption victims receive their graceful termination periods.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This field does not guarantee that the pod will be scheduled on this node. Scheduler may decide
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// to place the pod elsewhere if other nodes become available sooner. Scheduler may also decide to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// give the resources on this node to a higher priority pod that is created after preemption.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// As a result, this field may be different than PodSpec.nodeName when the pod is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// scheduled.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">NominatedNodeName</span> <span class="kt">string</span> <span class="s">`json:&#34;nominatedNodeName,omitempty&#34; protobuf:&#34;bytes,11,opt,name=nominatedNodeName&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// IP address of the host to which the pod is assigned. Empty if not yet scheduled.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">HostIP</span> <span class="kt">string</span> <span class="s">`json:&#34;hostIP,omitempty&#34; protobuf:&#34;bytes,5,opt,name=hostIP&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// IP address allocated to the pod. Routable at least within the cluster.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Empty if not yet allocated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">PodIP</span> <span class="kt">string</span> <span class="s">`json:&#34;podIP,omitempty&#34; protobuf:&#34;bytes,6,opt,name=podIP&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// podIPs holds the IP addresses allocated to the pod. If this field is specified, the 0th entry must
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// match the podIP field. Pods may be allocated at most 1 value for each of IPv4 and IPv6. This list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// is empty if no IPs have been allocated yet.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchStrategy=merge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +patchMergeKey=ip
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">PodIPs</span> <span class="p">[]</span><span class="nx">PodIP</span> <span class="s">`json:&#34;podIPs,omitempty&#34; protobuf:&#34;bytes,12,rep,name=podIPs&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;ip&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// RFC 3339 date and time at which the object was acknowledged by the Kubelet.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This is before the Kubelet pulled the container image(s) for the pod.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">StartTime</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">Time</span> <span class="s">`json:&#34;startTime,omitempty&#34; protobuf:&#34;bytes,7,opt,name=startTime&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// The list has one entry per init container in the manifest. The most recent successful
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// init container will have ready = true, the most recently started container will have
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// startTime set.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle#pod-and-container-status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">InitContainerStatuses</span> <span class="p">[]</span><span class="nx">ContainerStatus</span> <span class="s">`json:&#34;initContainerStatuses,omitempty&#34; protobuf:&#34;bytes,10,rep,name=initContainerStatuses&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// The list has one entry per container in the manifest.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle#pod-and-container-status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ContainerStatuses</span> <span class="p">[]</span><span class="nx">ContainerStatus</span> <span class="s">`json:&#34;containerStatuses,omitempty&#34; protobuf:&#34;bytes,8,rep,name=containerStatuses&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// The Quality of Service (QOS) classification assigned to the pod based on resource requirements
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// See PodQOSClass type for available QOS classes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// More info: https://kubernetes.io/docs/concepts/workloads/pods/pod-qos/#quality-of-service-classes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">QOSClass</span> <span class="nx">PodQOSClass</span> <span class="s">`json:&#34;qosClass,omitempty&#34; protobuf:&#34;bytes,9,rep,name=qosClass&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Status for any ephemeral containers that have run in this pod.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">EphemeralContainerStatuses</span> <span class="p">[]</span><span class="nx">ContainerStatus</span> <span class="s">`json:&#34;ephemeralContainerStatuses,omitempty&#34; protobuf:&#34;bytes,13,rep,name=ephemeralContainerStatuses&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Status of resources resize desired for pod&#39;s containers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// It is empty if no resources resize is pending.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Any changes to container resources will automatically set this to &#34;Proposed&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +featureGate=InPlacePodVerticalScaling
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Resize</span> <span class="nx">PodResizeStatus</span> <span class="s">`json:&#34;resize,omitempty&#34; protobuf:&#34;bytes,14,opt,name=resize,casttype=PodResizeStatus&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Pod 生命周期的变化，主要体现在 Pod API 对象的 Status 部分，其中，<strong>pod.status.phase</strong>，就是 Pod 的当前状态，它有如下几种可能的情况：</p>
<ol>
<li>Pending: API 对象已经被创建并保存在 Etcd 当中。但是，这个 Pod 里有些容器因为某种原因而不能被顺利创建。比如，调度不成功</li>
<li>Running: Pod 已经调度成功，跟一个具体的节点绑定。它包含的容器都已经创建成功，并且至少有一个正在运行中</li>
<li>Succeeded: Pod 里的所有容器都正常运行完毕，并且已经退出了，运行一次性任务时最为常见</li>
<li>Failed: Pod 里至少有一个容器以不正常的状态(非 0 的返回码)退出</li>
<li>Unknown: 这是一个异常状态，意味着 Pod 的状态不能持续地被 kubelet 汇报给 kube-apiserver，这很有可能是主从节点(Master 和 Kubelet)间的通信出现了问题</li>
</ol>
<p>更进一步地，Pod 对象的 Status 字段，还可以再细分出一组 <strong>Conditions</strong>。这些细分状态的值包括：PodScheduled、Ready、Initialized，以及 Unschedulable。它们主要用于描述造成当前 Status 的具体原因是什么。比如，Pod 当前的 Status 是 Pending，对应的 Condition 是 Unschedulable，这就意味着它的调度出现了问题。</p>
<p>而其中，Ready 这个细分状态非常值得我们关注：它意味着 Pod 不仅已经正常启动(Running 状态)，而且已经可以对外提供服务了。这两者之间(Running 和 Ready)是有区别的。</p>
<h2 id="6podpreset">6.PodPreset</h2>
<p>PodPreset 可以自动给对应的 Pod 对象填充字段。</p>
<h3 id="61-podpreset-定义">6.1 PodPreset 定义</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"></code></pre></td></tr></table>
</div>
</div><h3 id="62-podpreset">6.2 PodPreset</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">settings.k8s.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PodPreset</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">allow-database</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">frontend </span><span class="w"> </span><span class="c"># 目标 Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">DB_PORT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;6379&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/cache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cache-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cache-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这个 PodPreset 会作用于 selector 所定义的、带有“role: frontend”标签的 Pod 对象。</p>
<p>PodPreset 里定义的内容，只会在 Pod API 对象被创建之前追加在这个对象本身上，而不会影响任何 Pod 的控制器的定义。比如，我们现在提交的是一个 nginx-deployment，那么这个 Deployment 对象本身是永远不会被 PodPreset 改变的，被修改的只是这个 Deployment 创建出来的所有 Pod。</p>
<p>如果你定义了同时作用于一个 Pod 对象的多个 PodPreset，Kubernetes 会帮你合并（Merge）这两个 PodPreset 要做的修改。而如果它们要做的修改有冲突的话，这些冲突字段就不会被修改。</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2023-03-02&nbsp;<a class="git-hash" href="https://github.com/dillonzq/LoveIt/commit/71d9577b3005190aab29e3c9ab7ed7c9150234f5" target="_blank" title="commit by tao(tao@example.com) 71d9577b3005190aab29e3c9ab7ed7c9150234f5: pod volume">
                                    <i class="fas fa-hashtag fa-fw"></i>71d9577</a></span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/posts/architecture/k8s/k8s_use/06_pod/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://hotttao.github.io/posts/architecture/k8s/k8s_use/06_pod/" data-title="Pod" data-hashtags="k8s"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://hotttao.github.io/posts/architecture/k8s/k8s_use/06_pod/" data-hashtag="k8s"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://hotttao.github.io/posts/architecture/k8s/k8s_use/06_pod/" data-title="Pod"><i class="fab fa-hacker-news fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://hotttao.github.io/posts/architecture/k8s/k8s_use/06_pod/" data-title="Pod"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://hotttao.github.io/posts/architecture/k8s/k8s_use/06_pod/" data-title="Pod" data-ralateuid="xxxx"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/k8s/">k8s</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/architecture/k8s/k8s_use/05_k8s_tools/" class="prev" rel="prev" title="k8s 使用工具"><i class="fas fa-angle-left fa-fw"></i>k8s 使用工具</a>
            <a href="/posts/architecture/k8s/k8s_use/07_secret/" class="next" rel="next" title="Secret/ConfigMap/RBAC">Secret/ConfigMap/RBAC<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.111.3">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">宋涛</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.8/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":30},"comment":{"gitalk":{"admin":["hotttao"],"clientID":"7b48df1b81d23057c798","clientSecret":"65c6f9e6ca6ae4d8105f757578b6b594e3668e61","id":"2020-08-03T22:00:00+08:00","owner":"hotttao","repo":"hotttao.github.io","title":"Pod"}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
