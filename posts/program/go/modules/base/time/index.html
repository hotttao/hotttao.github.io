<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>go time - LoveIt</title><meta name="Description" content="go 的文件 I/O"><meta property="og:title" content="go time" />
<meta property="og:description" content="go 的文件 I/O" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hotttao.github.io/posts/program/go/modules/base/time/" /><meta property="og:image" content="https://hotttao.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-01T22:00:00+08:00" />
<meta property="article:modified_time" content="2023-03-11T14:42:47+08:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://hotttao.github.io/logo.png"/>

<meta name="twitter:title" content="go time"/>
<meta name="twitter:description" content="go 的文件 I/O"/>
<meta name="application-name" content="宋涛的个人博客">
<meta name="apple-mobile-web-app-title" content="宋涛的个人博客"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://hotttao.github.io/posts/program/go/modules/base/time/" /><link rel="prev" href="https://hotttao.github.io/posts/program/go/modules/base/io/" /><link rel="next" href="https://hotttao.github.io/posts/program/go/modules/base/strings/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "go time",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/hotttao.github.io\/posts\/program\/go\/modules\/base\/time\/"
        },"image": ["https:\/\/hotttao.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "go 库","wordcount":  4854 ,
        "url": "https:\/\/hotttao.github.io\/posts\/program\/go\/modules\/base\/time\/","datePublished": "2021-06-01T22:00:00+08:00","dateModified": "2023-03-11T14:42:47+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": {
                    "@type": "ImageObject",
                    "url": "https:\/\/hotttao.github.io\/images\/hugo\/avatar.png",
                    "width":  528 ,
                    "height":  560 
                }},"author": {
                "@type": "Person",
                "name": "宋涛"
            },"description": "go 的文件 I/O"
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="LoveIt"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>宋涛的博客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/categories/go/"> Go </a><a class="menu-item" href="/categories/linux/"> Linux </a><a class="menu-item" href="/categories/distributed/"> 分布式 </a><a class="menu-item" href="/categories/distributed/"> 架构 </a><a class="menu-item" href="/posts/about/"> 关于 </a><a class="menu-item" href="https://github.com/hotttao/" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="LoveIt"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>宋涛的博客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/categories/go/" title="">Go</a><a class="menu-item" href="/categories/linux/" title="">Linux</a><a class="menu-item" href="/categories/distributed/" title="">分布式</a><a class="menu-item" href="/categories/distributed/" title="">架构</a><a class="menu-item" href="/posts/about/" title="">关于</a><a class="menu-item" href="https://github.com/hotttao/" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">go time</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://hotttao.github.io/" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>宋涛</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/go/"><i class="far fa-folder fa-fw"></i>Go</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-06-01">2021-06-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 4854 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 10 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-时间基础操作">1. 时间基础操作</a>
      <ul>
        <li><a href="#11-时间的表示">1.1 时间的表示</a>
          <ul>
            <li><a href="#hasmonotonic-为-1-时-time-结构">hasMonotonic 为 1 时 Time 结构</a></li>
            <li><a href="#hasmonotonic-为-0-时-time-结构">hasMonotonic 为 0 时 Time 结构</a></li>
            <li><a href="#now-函数调用流程">Now 函数调用流程</a></li>
          </ul>
        </li>
        <li><a href="#12-获取特定时区的当前时间">1.2 获取特定时区的当前时间</a></li>
        <li><a href="#13-时间的比较与运算">1.3 时间的比较与运算</a></li>
        <li><a href="#14-时间的格式化输出">1.4 时间的格式化输出</a></li>
      </ul>
    </li>
    <li><a href="#2-定时器">2. 定时器</a>
      <ul>
        <li><a href="#21-timer的创建">2.1 Timer的创建</a></li>
        <li><a href="#22-timer-触发流程">2.2 Timer 触发流程</a></li>
        <li><a href="#23-停止timer">2.3 停止Timer</a></li>
        <li><a href="#24-重用timer">2.4 重用Timer</a>
          <ul>
            <li><a href="#重用timer时存在的竞态条件">重用Timer时存在的竞态条件</a></li>
          </ul>
        </li>
        <li><a href="#25-timer的资源释放">2.5 Timer的资源释放</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="1-时间基础操作">1. 时间基础操作</h2>
<h3 id="11-时间的表示">1.1 时间的表示</h3>
<p>获取当前时间可以使用 <code>time.Now()</code>，Now 返回的是 Time 结构的结构，Time 是对即时时间的抽象。time.Time的结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// $GOROOT/src/time.go(go1.14)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Time</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">wall</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ext</span>  <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">    <span class="nx">loc</span> <span class="o">*</span><span class="nx">Location</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Time 由三个字段组成:</p>
<ol>
<li>walle:
<ul>
<li>挂钟时间（wall time）</li>
<li>连续两次通过Now函数获取的挂钟时间之间的差值不一定都是正值</li>
</ul>
</li>
<li>ext:
<ul>
<li>单调时间（monotonic time），精度级为纳秒</li>
<li>单调时间表示的是程序进程启动之后流逝的时间，两次采集的单调时间之差永远不可能为负数</li>
<li>单调时间常被用于两个即时时间之间的比较和间隔计算</li>
</ul>
</li>
<li>loc:
<ul>
<li>时区信息，Now函数获取的即时时间是时区相关的</li>
<li>未显式指定时区，则默认使用系统时区。在Linux/macOS上，默认使用的是/etc/localtime指向的时区数据</li>
</ul>
</li>
</ol>
<p>wall的最高比特位是一个名为 hasMonotonic 的标志比特位。hasMonotonic 是否为 1，Time 的结构有所区别</p>
<h4 id="hasmonotonic-为-1-时-time-结构">hasMonotonic 为 1 时 Time 结构</h4>
<p>当hasMonotonic被置为1时，time.Time表示的即时时间中既包含挂钟时间，也包含单调时间。此时 Time 的结构如下:</p>
<ol>
<li>walle 是一个64位无符号整型，内部又被分成三段，分别表示
<ul>
<li>hasMonotonic（1bit）</li>
<li>秒数（33bit，挂钟时间的整秒数，距1885年1月1日的秒数）</li>
<li>纳秒数（30bit，挂钟时间的非整秒数）</li>
</ul>
</li>
<li>ext字段表示程序进程启动后的单调流逝时间，以纳秒为单位</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/go/expert/time_struct.png"
        data-srcset="/images/go/expert/time_struct.png, /images/go/expert/time_struct.png 1.5x, /images/go/expert/time_struct.png 2x"
        data-sizes="auto"
        alt="/images/go/expert/time_struct.png"
        title="当hasMonotonic为1时，time.Time表示时间的原理" /></p>
<h4 id="hasmonotonic-为-0-时-time-结构">hasMonotonic 为 0 时 Time 结构</h4>
<p>当hasMonotonic为0时，time.Time结构体仅表示挂钟时间:</p>
<ol>
<li>wall字段:
<ul>
<li>hasMonotonic（1bit）和秒数（33bit）两部分均被置为0</li>
<li>纳秒数（30bit）依旧用于表示挂钟时间的非整数秒部分</li>
</ul>
</li>
<li>ext字段整个用于表示挂钟时间的整秒部分，其含义为距公元元年1月1日的秒数</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/go/expert/time_struct1.png"
        data-srcset="/images/go/expert/time_struct1.png, /images/go/expert/time_struct1.png 1.5x, /images/go/expert/time_struct1.png 2x"
        data-sizes="auto"
        alt="/images/go/expert/time_struct1.png"
        title="当hasMonotonic为0时，time.Time表示时间的原理" /></p>
<p>通过time.Parse、time.Date或time.Unix构建的time.Time结构体，其中的hasMonotonic均为 0。</p>
<h4 id="now-函数调用流程">Now 函数调用流程</h4>
<p>time.Now函数调用now函数，但在time包中now函数仅有一个原型声明，并没有函数体：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// $GOROOT/src/time/time.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">now</span><span class="p">()</span> <span class="p">(</span><span class="nx">sec</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">nsec</span> <span class="kt">int32</span><span class="p">,</span> <span class="nx">mono</span> <span class="kt">int64</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>now 函数的真正实现是 runtime 包的 time_now 函数，Go 链接器会将 time_now 链接为 time.now：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// $GOROOT/src/runtime/timestub.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="c1">//go:linkname time_now time.now
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">time_now</span><span class="p">()</span> <span class="p">(</span><span class="nx">sec</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">nsec</span> <span class="kt">int32</span><span class="p">,</span> <span class="nx">mono</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sec</span><span class="p">,</span> <span class="nx">nsec</span> <span class="p">=</span> <span class="nf">walltime</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">sec</span><span class="p">,</span> <span class="nx">nsec</span><span class="p">,</span> <span class="nf">nanotime</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// walltime和nanotime函数也都是“过渡”函数：
</span></span></span><span class="line"><span class="cl"><span class="c1">// $GOROOT/src/runtime/time_nofake.go
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">nanotime</span><span class="p">()</span> <span class="kt">int64</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">nanotime1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">walltime</span><span class="p">()</span> <span class="p">(</span><span class="nx">sec</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">nsec</span> <span class="kt">int32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">walltime1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>真正获取系统时间的操作是在下面的汇编代码中通过系统调用（system call）实现的（以Linux为例）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="o">/</span> <span class="err">$</span><span class="nx">GOROOT</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">runtime</span><span class="o">/</span><span class="nx">sys_linux_amd64</span><span class="p">.</span><span class="nx">s</span>
</span></span><span class="line"><span class="cl"><span class="nx">TEXT</span> <span class="nx">runtime</span><span class="err">·</span><span class="nf">walltime1</span><span class="p">(</span><span class="nx">SB</span><span class="p">),</span><span class="nx">NOSPLIT</span><span class="p">,</span><span class="err">$</span><span class="mi">8</span><span class="o">-</span><span class="mi">12</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">noswitch</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SUBQ</span>    <span class="err">$</span><span class="mi">16</span><span class="p">,</span> <span class="nx">SP</span>         <span class="c1">// 为结果预留空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ANDQ</span>    <span class="err">$~</span><span class="mi">15</span><span class="p">,</span> <span class="nx">SP</span>        <span class="c1">// 为C代码进行对齐
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">MOVQ</span>    <span class="nx">runtime</span><span class="err">·</span><span class="nf">vdsoClockgettimeSym</span><span class="p">(</span><span class="nx">SB</span><span class="p">),</span> <span class="nx">AX</span>
</span></span><span class="line"><span class="cl">    <span class="nx">CMPQ</span>    <span class="nx">AX</span><span class="p">,</span> <span class="err">$</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">JEQ</span>     <span class="nx">fallback</span>
</span></span><span class="line"><span class="cl">    <span class="nx">MOVL</span>    <span class="err">$</span><span class="mi">0</span><span class="p">,</span> <span class="nx">DI</span> <span class="c1">// CLOCK_REALTIME
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">LEAQ</span>    <span class="mi">0</span><span class="p">(</span><span class="nx">SP</span><span class="p">),</span> <span class="nx">SI</span>
</span></span><span class="line"><span class="cl">    <span class="nx">CALL</span>    <span class="nx">AX</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">TEXT</span> <span class="nx">runtime</span><span class="err">·</span><span class="nf">nanotime1</span><span class="p">(</span><span class="nx">SB</span><span class="p">),</span><span class="nx">NOSPLIT</span><span class="p">,</span><span class="err">$</span><span class="mi">8</span><span class="o">-</span><span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="nx">noswitch</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SUBQ</span>    <span class="err">$</span><span class="mi">16</span><span class="p">,</span> <span class="nx">SP</span>         <span class="c1">// 为结果预留空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ANDQ</span>    <span class="err">$~</span><span class="mi">15</span><span class="p">,</span> <span class="nx">SP</span>        <span class="c1">// 为C代码进行对齐
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">MOVQ</span>    <span class="nx">runtime</span><span class="err">·</span><span class="nf">vdsoClockgettimeSym</span><span class="p">(</span><span class="nx">SB</span><span class="p">),</span> <span class="nx">AX</span>
</span></span><span class="line"><span class="cl">    <span class="nx">CMPQ</span>    <span class="nx">AX</span><span class="p">,</span> <span class="err">$</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">JEQ</span>     <span class="nx">fallback</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="12-获取特定时区的当前时间">1.2 获取特定时区的当前时间</h3>
<p>如果要获取特定时区（而不是本地时区）的当前时间，可以使用下面几种方法。</p>
<ol>
<li>设置TZ环境变量
<ul>
<li>方法: <code>$TZ=America/New_York go run get_current_time.go</code></li>
<li>如果TZ环境变量提供的时区信息有误或显式设置为&quot;&quot;，time.Now根据其值在时区数据库中找不到对应的时区信息，那么它将使用UTC时间（Coordinated Universal Time，国际协调时间）：</li>
</ul>
</li>
<li>显式加载时区信息</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 显式加载时区信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="c1">//北京时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nx">loc</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">LoadLocation</span><span class="p">(</span><span class="s">&#34;America/New_York&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;load time location failed:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">t1</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">In</span><span class="p">(</span><span class="nx">loc</span><span class="p">)</span> <span class="c1">// 转换成美国东部纽约时间表示
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">t1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 通过 Date 构建带时区时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">t2</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mo">06</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">loc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">t2</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="13-时间的比较与运算">1.3 时间的比较与运算</h3>
<p>由 time.Time 类型表示即时时间的原理可知，如果直接用==和!=来比较两个Time类型示例，那么参与比较的不仅有挂钟时间，还有单调时间和时区信息，这样就会出现在不同时区表示地球上同一时刻的两个Time实例是不相等的情况，这违背了人的一贯认知。因此直接用==和!=来做比较是不适宜的，这也是time.Time类型不应被用作map类型的key值的原因。</p>
<p>time.Time提供了Equal方法，该方法专用于对两个Time实例的比较：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// $GOROOT/src/time/time.go (go 1.14)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="nx">Time</span><span class="p">)</span> <span class="nf">Equal</span><span class="p">(</span><span class="nx">u</span> <span class="nx">Time</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">wall</span><span class="o">&amp;</span><span class="nx">u</span><span class="p">.</span><span class="nx">wall</span><span class="o">&amp;</span><span class="nx">hasMonotonic</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">ext</span> <span class="o">==</span> <span class="nx">u</span><span class="p">.</span><span class="nx">ext</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nf">sec</span><span class="p">()</span> <span class="o">==</span> <span class="nx">u</span><span class="p">.</span><span class="nf">sec</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">.</span><span class="nf">nsec</span><span class="p">()</span> <span class="o">==</span> <span class="nx">u</span><span class="p">.</span><span class="nf">nsec</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Time类型还提供了Before和After方法，用于判断两个即时时间的先后关系:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="o">/</span> <span class="err">$</span><span class="nx">GOROOT</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">time</span><span class="o">/</span><span class="nx">time</span><span class="p">.</span><span class="k">go</span> <span class="p">(</span><span class="k">go</span> <span class="mf">1.14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="nx">Time</span><span class="p">)</span> <span class="nf">After</span><span class="p">(</span><span class="nx">u</span> <span class="nx">Time</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">wall</span><span class="o">&amp;</span><span class="nx">u</span><span class="p">.</span><span class="nx">wall</span><span class="o">&amp;</span><span class="nx">hasMonotonic</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">ext</span> <span class="p">&gt;</span> <span class="nx">u</span><span class="p">.</span><span class="nx">ext</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ts</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">sec</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">us</span> <span class="o">:=</span> <span class="nx">u</span><span class="p">.</span><span class="nf">sec</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ts</span> <span class="p">&gt;</span> <span class="nx">us</span> <span class="o">||</span> <span class="nx">ts</span> <span class="o">==</span> <span class="nx">us</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">.</span><span class="nf">nsec</span><span class="p">()</span> <span class="p">&gt;</span> <span class="nx">u</span><span class="p">.</span><span class="nf">nsec</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="nx">Time</span><span class="p">)</span> <span class="nf">Before</span><span class="p">(</span><span class="nx">u</span> <span class="nx">Time</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">wall</span><span class="o">&amp;</span><span class="nx">u</span><span class="p">.</span><span class="nx">wall</span><span class="o">&amp;</span><span class="nx">hasMonotonic</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">ext</span> <span class="p">&lt;</span> <span class="nx">u</span><span class="p">.</span><span class="nx">ext</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nf">sec</span><span class="p">()</span> <span class="p">&lt;</span> <span class="nx">u</span><span class="p">.</span><span class="nf">sec</span><span class="p">()</span> <span class="o">||</span> <span class="nx">t</span><span class="p">.</span><span class="nf">sec</span><span class="p">()</span> <span class="o">==</span> <span class="nx">u</span><span class="p">.</span><span class="nf">sec</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">.</span><span class="nf">nsec</span><span class="p">()</span> <span class="p">&lt;</span> <span class="nx">u</span><span class="p">.</span><span class="nf">nsec</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>time包还可以用来对两个即时时间进行时间运算，其中最主要的运算就是由Sub方法提供的差值运算:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">t1</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">t2</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nx">diff</span> <span class="o">:=</span> <span class="nx">t2</span><span class="p">.</span><span class="nf">Sub</span><span class="p">(</span><span class="nx">t1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Sub方法的返回值是time.Duration类型，这是一个纳秒值。和上面Equal的逻辑相似，Sub方法对两个Time实例的差值处理也分为两种情况：如果两个实例都含有单调时间信息（hasMonotonic=1），那么Sub方法直接返回两个实例的ext字段的差；否则，分别算出整秒部分的差与非整秒部分的差，然后加和后返回。</p>
<h3 id="14-时间的格式化输出">1.4 时间的格式化输出</h3>
<p>Go 采用了不同于strftime的时间格式化输出方案，采用了更为直观的参考时间（reference time）替代strftime的各种标准占位符:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Format</span><span class="p">(</span><span class="s">&#34;2006年01月02日 15时04分05秒&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Go文档中给出的标准的参考时间如下：<code>2006-01-02 15:04:05 PM -07:00 Jan Mon MST</code>。下图形象地展示了参考时间、格式串与最终格式化的输出结果之间的关系:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/go/expert/time_format.png"
        data-srcset="/images/go/expert/time_format.png, /images/go/expert/time_format.png 1.5x, /images/go/expert/time_format.png 2x"
        data-sizes="auto"
        alt="/images/go/expert/time_format.png"
        title="参考时间、格式串与最终格式化的输出结果之间的关系" /></p>
<p>下面是一个格式化字符串与实际输出结果的速查表，速查表的第一列为含义，第二列为格式串写法，第三列为对应格式串写法下的输出结果（取当前时间）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">2020-06-19 14:44:58 PM +08:00 Jun Fri CST
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Year            | 2006         | 2020
</span></span><span class="line"><span class="cl">Year            | 06           | 20
</span></span><span class="line"><span class="cl">Month           | 01           | 06
</span></span><span class="line"><span class="cl">Month           | 1            | 6
</span></span><span class="line"><span class="cl">Month           | Jan          | Jun
</span></span><span class="line"><span class="cl">Month           | January      | June
</span></span><span class="line"><span class="cl">Day             | 02           | 19
</span></span><span class="line"><span class="cl">Day             | 2            | 19
</span></span><span class="line"><span class="cl">Week day        | Mon          | Fri
</span></span><span class="line"><span class="cl">Week day        | Monday       | Friday
</span></span><span class="line"><span class="cl">Hours           | 03           | 02
</span></span><span class="line"><span class="cl">Hours           | 3            | 2
</span></span><span class="line"><span class="cl">Hours           | 15           | 14
</span></span><span class="line"><span class="cl">Minutes         | 04           | 44
</span></span><span class="line"><span class="cl">Minutes         | 4            | 44
</span></span><span class="line"><span class="cl">Seconds         | 05           | 58
</span></span><span class="line"><span class="cl">Seconds         | 5            | 58
</span></span><span class="line"><span class="cl">AM or PM        | PM           | PM
</span></span><span class="line"><span class="cl">Miliseconds     | .000         | .906
</span></span><span class="line"><span class="cl">Microseconds    | .000000      | .906783
</span></span><span class="line"><span class="cl">Nanoseconds     | .000000000   | .906783000
</span></span><span class="line"><span class="cl">Timezone offset | -0700        | +0800
</span></span><span class="line"><span class="cl">Timezone offset | -07:00       | +08:00
</span></span><span class="line"><span class="cl">Timezone offset | Z0700        | +0800
</span></span><span class="line"><span class="cl">Timezone offset | Z07:00       | +08:00
</span></span><span class="line"><span class="cl">Timezone        | MST          | CST
</span></span><span class="line"><span class="cl">--------------- + ------------ + ------------
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="2-定时器">2. 定时器</h2>
<p>time包提供了两类定时器：一次性定时器Timer和重复定时器Ticker。</p>
<h3 id="21-timer的创建">2.1 Timer的创建</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">create_timer_by_afterfunc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// time.AfterFunc 创建一次性定时器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">AfterFunc</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;timer created by afterfunc fired!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">create_timer_by_newtimer</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// time.NewTimer 创建一次性定时器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">timer</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTimer</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">timer</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;timer created by newtimer fired!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">create_timer_by_after</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// time.After 创建一次性定时器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nf">After</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;timer created by after fired!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">create_ticker_by_after</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建重复定时器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Tick</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">next</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v %s\n&#34;</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nf">statusUpdate</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="22-timer-触发流程">2.2 Timer 触发流程</h3>
<p>Timer的四种创建方式：NewTimer、AfterFunc和After、Tick，本质上都是在用户层实例化一个time.Timer结构体：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// $GOROOT/src/time/sleep.go (go 1.14)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Timer</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">C</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">Time</span>   <span class="c1">// C是用户层用户接收定时器触发事件的channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">r</span> <span class="nx">runtimeTimer</span>  <span class="c1">// r则是一个与runtime.timer（runtime/time.go）对应且要保持一致的结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewTimer</span><span class="p">(</span><span class="nx">d</span> <span class="nx">Duration</span><span class="p">)</span> <span class="o">*</span><span class="nx">Timer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">Time</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1">// C 是一个带缓冲的 channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">t</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Timer</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">C</span><span class="p">:</span> <span class="nx">c</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">r</span><span class="p">:</span> <span class="nx">runtimeTimer</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">when</span><span class="p">:</span> <span class="nf">when</span><span class="p">(</span><span class="nx">d</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">f</span><span class="p">:</span>    <span class="nx">sendTime</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">arg</span><span class="p">:</span>  <span class="nx">c</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">startTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">t</span><span class="p">.</span><span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">t</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Timer创建及触发原理的过程如下图所示:</p>
<ol>
<li>被实例化后的Timer将交给运行时层的 startTimer 函数 <code>startTimer(&amp;t.r)</code></li>
<li>Timer.r 是一个与runtime.timer（runtime/time.go）对应且要保持一致的结构，startTimer 使用 Timer.r 初始化一个运行时层面的runtime.timer结构，并将runtime.timer加入为每个P分配的定时器最小堆中进行管理</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/go/expert/timer.png"
        data-srcset="/images/go/expert/timer.png, /images/go/expert/timer.png 1.5x, /images/go/expert/timer.png 2x"
        data-sizes="auto"
        alt="/images/go/expert/timer.png"
        title="Timer创建与触发" /></p>
<p>老版本的Go中（Go 1.9版本之前），运行时维护一个由互斥锁保护的全局最小堆（minheap），定时器最小堆的维护操作都要对其互斥锁进行加解锁操作，导致其性能和伸缩性很差。最新的定时器管理调度方案（Go 1.14）抛弃了全局唯一最小堆方案，而是为每个P（goroutine调度器中的那个P）创建一个定时器最小堆，并通过网络轮询器（net poller）在运行时调度的协助下对各个定时器最小堆进行统一管理和调度</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// $GOROOT/src/runtime/runtime2.go (go 1.14)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">p</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">timersLock</span> <span class="nx">mutex</span>
</span></span><span class="line"><span class="cl">    <span class="nx">timers</span> <span class="p">[]</span><span class="o">*</span><span class="nx">timer</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行时调度时发现某个定时器的时间已到，就会将该定时器从其所在最小堆中移除，并在runtime.runOneTimer中调用相应runtime.timer的触发函数f，即上面的 time.sendTime</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// $GOROOT/src/time/sleep.go (go 1.14)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">sendTime</span><span class="p">(</span><span class="nx">c</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">seq</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">c</span><span class="p">.(</span><span class="kd">chan</span> <span class="nx">Time</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">Now</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>time.Timer.C是一个带缓冲的channel，目的就是防止运行时在执行sendTime时被阻塞在该channel上。我们看到sendTime还加了双保险：通过一个select判断channel c的缓冲区是否已满，一旦满了，则会执行default分支而直接退出。</p>
<h3 id="23-停止timer">2.3 停止Timer</h3>
<p>Timer提供了Stop方法来将尚未触发的定时器从P中的最小堆中移除，使之失效，这样可以减小最小堆管理和垃圾回收的压力。因此，使用定时器时及时调用Stop方法是一个很好的Go语言实践。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">consume</span><span class="p">(</span><span class="nx">c</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">timer</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTimer</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">timer</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="24-重用timer">2.4 重用Timer</h3>
<p>Go官方文档建议只对如下两种定时器调用Reset方法：</p>
<ol>
<li>已经停止了的定时器（Stopped）；</li>
<li>已经触发过且Timer.C中的数据已经被读空。</li>
</ol>
<p>重用 Timer 推荐使用下面的模式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">!</span><span class="nx">t</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">timer</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">t</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="重用timer时存在的竞态条件">重用Timer时存在的竞态条件</h4>
<p>当一个定时器触发时，运行时会调用runtime.runOneTimer调用定时器关联的触发函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// $GOROOT/src/runtime/time.go (Go 1.14)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">runOneTimer</span><span class="p">(</span><span class="nx">pp</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">t</span> <span class="o">*</span><span class="nx">timer</span><span class="p">,</span> <span class="nx">now</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pp</span><span class="p">.</span><span class="nx">timersLock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">f</span><span class="p">(</span><span class="nx">arg</span><span class="p">,</span> <span class="nx">seq</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pp</span><span class="p">.</span><span class="nx">timersLock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们看到在runOneTimer<strong>执行f(arg, seq)函数前，runOneTimer对p的timersLock进行了解锁操作</strong>，也就是说f的执行并不在锁内。f执行的是什么呢？</p>
<ol>
<li>对于通过AfterFunc创建的定时器来说，就是启动一个新goroutine，并在这个新goroutine中执行用户传入的函数；</li>
<li>对于通过After或NewTimer创建的定时器而言，f的执行就是time.sendTime函数，也就是将当前时间写入定时器的通知channel中。</li>
</ol>
<p>这个时候会有一个竞态条件出现：定时器触发的过程中，<strong>f函数的执行与用户层重置定时器前抽干channel的操作是分别在两个goroutine中执行的，谁先谁后，完全依靠运行时调度</strong>。于是重用模式中的看似没有问题的代码，也可能存在问题（当然需要时间粒度足够小，比如毫秒级的定时器）。以通过After或NewTimer创建的定时器为例（即f函数为time.sendTime）。</p>
<ol>
<li>如果sendTime的执行发生在抽干channel动作之前，那么就是重用模式中的执行结果：Stop方法返回false（因为定时器已经触发了），显式抽干channel的动作是可以读出数据的。后续定时器重置后，定时器将继续正常运行。</li>
<li>如果<strong>sendTime 的执行发生在抽干channel动作之后，那么就有问题了</strong>。虽然Stop方法返回false（因为定时器已经触发了），但抽干channel的动作并没有读出任何数据。之后，sendTime将数据写到channel中。这样定时器重置后的定时器channel中实际上已经有了数据，于是当消费者进入下面的select语句中时，case &lt;-timer.C这一分支因有数据而被直接选中，没有起到超时等待的作用。也就是说定时器被重置之后居然又立即触发了。</li>
</ol>
<p>目前这个竞态问题尚无理想解决方案，详细请见这个 <a href="http://github.com/golang/go/issues/11513" target="_blank" rel="noopener noreffer">issue</a></p>
<h3 id="25-timer的资源释放">2.5 Timer的资源释放</h3>
<p>作为Timer的使用者，我们要做的就是尽量减少在使用 Timer 时对最小堆管理和垃圾回收的压力，即及时调用定时器的 Stop 方法从最小堆删除定时器或重用（Reset）处于活跃状态的定时器。</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2023-03-11&nbsp;<a class="git-hash" href="https://github.com/dillonzq/LoveIt/commit/0ff1084247fc3dd97ab99fdb9377fbb968b4ef19" target="_blank" title="commit by tao(tao@example.com) 0ff1084247fc3dd97ab99fdb9377fbb968b4ef19: go module">
                                    <i class="fas fa-hashtag fa-fw"></i>0ff1084</a></span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/posts/program/go/modules/base/time/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://hotttao.github.io/posts/program/go/modules/base/time/" data-title="go time" data-hashtags="go 库"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://hotttao.github.io/posts/program/go/modules/base/time/" data-hashtag="go 库"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://hotttao.github.io/posts/program/go/modules/base/time/" data-title="go time"><i class="fab fa-hacker-news fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://hotttao.github.io/posts/program/go/modules/base/time/" data-title="go time"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://hotttao.github.io/posts/program/go/modules/base/time/" data-title="go time" data-ralateuid="xxxx"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/go-%E5%BA%93/">go 库</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/program/go/modules/base/io/" class="prev" rel="prev" title="go 的文件 IO"><i class="fas fa-angle-left fa-fw"></i>go 的文件 IO</a>
            <a href="/posts/program/go/modules/base/strings/" class="next" rel="next" title="go 文本操作">go 文本操作<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.111.2">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">宋涛</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.8/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":30},"comment":{"gitalk":{"admin":["hotttao"],"clientID":"7b48df1b81d23057c798","clientSecret":"65c6f9e6ca6ae4d8105f757578b6b594e3668e61","id":"2021-06-01T22:00:00+08:00","owner":"hotttao","repo":"hotttao.github.io","title":"go time"}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
