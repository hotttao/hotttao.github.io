<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Go 常用工具 - LoveIt</title><meta name="Description" content="这个系列我们开始学习 go 语言的第二部分-go语言进阶"><meta property="og:title" content="Go 常用工具" />
<meta property="og:description" content="这个系列我们开始学习 go 语言的第二部分-go语言进阶" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hotttao.github.io/posts/program/go/expert/go_export/expert_27/" /><meta property="og:image" content="https://hotttao.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-12T22:00:00+08:00" />
<meta property="article:modified_time" content="2023-02-23T08:19:00+08:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://hotttao.github.io/logo.png"/>

<meta name="twitter:title" content="Go 常用工具"/>
<meta name="twitter:description" content="这个系列我们开始学习 go 语言的第二部分-go语言进阶"/>
<meta name="application-name" content="宋涛的个人博客">
<meta name="apple-mobile-web-app-title" content="宋涛的个人博客"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://hotttao.github.io/posts/program/go/expert/go_export/expert_27/" /><link rel="prev" href="https://hotttao.github.io/posts/program/go/expert/go_export/expert_19/" /><link rel="next" href="https://hotttao.github.io/posts/program/go/expert/go_export/expert_26/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Go 常用工具",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/hotttao.github.io\/posts\/program\/go\/expert\/go_export\/expert_27\/"
        },"image": ["https:\/\/hotttao.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "go 进阶","wordcount":  10913 ,
        "url": "https:\/\/hotttao.github.io\/posts\/program\/go\/expert\/go_export\/expert_27\/","datePublished": "2023-01-12T22:00:00+08:00","dateModified": "2023-02-23T08:19:00+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": {
                    "@type": "ImageObject",
                    "url": "https:\/\/hotttao.github.io\/images\/hugo\/avatar.png",
                    "width":  528 ,
                    "height":  560 
                }},"author": {
                "@type": "Person",
                "name": "宋涛"
            },"description": "这个系列我们开始学习 go 语言的第二部分-go语言进阶"
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="LoveIt"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>宋涛的博客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/categories/go/"> Go </a><a class="menu-item" href="/categories/linux/"> Linux </a><a class="menu-item" href="/categories/distributed/"> 分布式 </a><a class="menu-item" href="/categories/distributed/"> 架构 </a><a class="menu-item" href="/posts/about/"> 关于 </a><a class="menu-item" href="https://github.com/hotttao/" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="LoveIt"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>宋涛的博客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/categories/go/" title="">Go</a><a class="menu-item" href="/categories/linux/" title="">Linux</a><a class="menu-item" href="/categories/distributed/" title="">分布式</a><a class="menu-item" href="/categories/distributed/" title="">架构</a><a class="menu-item" href="/posts/about/" title="">关于</a><a class="menu-item" href="https://github.com/hotttao/" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Go 常用工具</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://hotttao.github.io/" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>宋涛</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/go/"><i class="far fa-folder fa-fw"></i>Go</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-01-12">2023-01-12</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 10913 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 22 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-go-get">1. go get</a>
      <ul>
        <li><a href="#11-go-get--d">1.1 go get -d</a></li>
        <li><a href="#12-go-get">1.2 go get</a></li>
        <li><a href="#13-go-get--u">1.3 go get -u</a></li>
        <li><a href="#14-go-get--t">1.4 go get -t</a></li>
        <li><a href="#15-行为对比">1.5 行为对比</a></li>
      </ul>
    </li>
    <li><a href="#2-go-install">2. go install</a></li>
    <li><a href="#3-go-list">3. go list</a>
      <ul>
        <li><a href="#31-搜索范围">3.1 搜索范围</a></li>
        <li><a href="#32-输出内容">3.2 输出内容</a>
          <ul>
            <li><a href="#go-list--m">go list -m</a></li>
            <li><a href="#go-list--f">go list -f</a></li>
            <li><a href="#go-list--json">go list -json</a></li>
            <li><a href="#go-list--m--u">go list -m -u</a></li>
            <li><a href="#go-list-常用命令">go list 常用命令</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#4-go-build">4. go build</a>
      <ul>
        <li><a href="#41-go-build--x--v">4.1 go build -x -v</a>
          <ul>
            <li><a href="#42-go-build--a">4.2 go build -a</a></li>
          </ul>
        </li>
        <li><a href="#43-go-build--race">4.3 go build -race</a></li>
        <li><a href="#44-go-build--gcflags">4.4 go build -gcflags</a>
          <ul>
            <li><a href="#编译选项参数集合">编译选项参数集合</a></li>
          </ul>
        </li>
        <li><a href="#45-go-build--ldflags">4.5 go build -ldflags</a>
          <ul>
            <li><a href="#-x">-X</a></li>
            <li><a href="#链接选项参数集合">链接选项参数集合</a></li>
          </ul>
        </li>
        <li><a href="#45-go-build--tags">4.5 go build -tags</a></li>
      </ul>
    </li>
    <li><a href="#5-运行与诊断">5. 运行与诊断</a>
      <ul>
        <li><a href="#51-gomaxprocs">5.1 GOMAXPROCS</a></li>
        <li><a href="#52-gogc">5.2 GOGC</a>
          <ul>
            <li><a href="#stw垃圾回收器">STW垃圾回收器</a></li>
            <li><a href="#三色标记圾回收器">三色标记圾回收器</a></li>
          </ul>
        </li>
        <li><a href="#52-godebuggctrace1">5.2 GODEBUG=gctrace=1</a></li>
        <li><a href="#53-godebugschedtrace1000">5.3 GODEBUG=schedtrace=1000</a></li>
        <li><a href="#54-godebugasyncpreemptoff1">5.4 GODEBUG=asyncpreemptoff=1</a></li>
      </ul>
    </li>
    <li><a href="#6-go-vet">6. go vet</a>
      <ul>
        <li><a href="#61-第三方linter聚合golangci-lint">6.1 第三方linter聚合：golangci-lint</a></li>
      </ul>
    </li>
    <li><a href="#7-重构">7. 重构</a></li>
    <li><a href="#8-go-doc">8. go doc</a>
      <ul>
        <li><a href="#81-go-doc-命令">8.1 go doc 命令</a></li>
        <li><a href="#61-godoc-的web化的文档中心">6.1 godoc 的Web化的文档中心</a></li>
        <li><a href="#83-查看-go-官方博客">8.3 查看 go 官方博客</a></li>
        <li><a href="#84-查看present格式文档">8.4 查看present格式文档</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>go 原生提供的工具，在 gopath 和 module-ware 两种模式上存在一些行为差异。接下来我们会分别介绍 go 原生工具在这两种模式下的使用。</p>
<h2 id="1-go-get">1. go get</h2>
<p>go get 用于获取 Go 包及其依赖包</p>
<p>常用命令如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 1. 仅下载源码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">go</span> <span class="nx">get</span> <span class="o">-</span><span class="nx">d</span> <span class="nx">A</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 下载 A的特定版本，仅在 module-ware 模式下可用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">go</span> <span class="nx">get</span> <span class="o">-</span><span class="nx">d</span> <span class="nx">A</span><span class="err">@</span><span class="nx">version</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 2. 下载源码并编译安装
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">go</span> <span class="nx">get</span> <span class="nx">A</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 3. 更新依赖版本
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">go</span> <span class="nx">get</span> <span class="o">-</span><span class="nx">u</span> <span class="nx">A</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 4. 获取测试代码依赖的包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">go</span> <span class="nx">get</span> <span class="o">-</span><span class="nx">t</span> <span class="nx">A</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="11-go-get--d">1.1 go get -d</h3>
<p>go get的标准行为是将Go包及依赖包下载到本地，并编译和安装目标Go包。传入-d 选项，go get仅会将源码下载到本地，不会对目标包进行编译和安装。</p>
<table>
<thead>
<tr>
<th style="text-align:left">区别</th>
<th style="text-align:left">gopath</th>
<th style="text-align:left">module-ware</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">下载位置</td>
<td style="text-align:left"><code>$GOPATH/src</code></td>
<td style="text-align:left"><code>GOPATH[0]/pkg/mod</code></td>
</tr>
<tr>
<td style="text-align:left">依赖判定</td>
<td style="text-align:left">只下载目标包及其依赖包的当前最新版本</td>
<td style="text-align:left">分析目标module的依赖以决定下载依赖的版本</td>
</tr>
<tr>
<td style="text-align:left">指定版本</td>
<td style="text-align:left">不支持</td>
<td style="text-align:left"><code>go get -d A@version</code></td>
</tr>
</tbody>
</table>
<h3 id="12-go-get">1.2 go get</h3>
<p>标准go get（无命令行标志选项）不仅要下载项目及其依赖的源码，还要对下载的源码进行编译和安装。</p>
<table>
<thead>
<tr>
<th style="text-align:left">区别</th>
<th style="text-align:left">gopath</th>
<th style="text-align:left">module-ware</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">二进制文件</td>
<td style="text-align:left">安装到 <code>$GOBIN</code>或<code>$GOPATH/bin</code></td>
<td style="text-align:left">安装到 <code>$GOBIN</code>或<code>$GOPATH/bin</code></td>
</tr>
<tr>
<td style="text-align:left">库文件</td>
<td style="text-align:left">以.a文件的形式被安装到<code>$GOPATH/pkg/$GOOS_$GOARCH</code>下</td>
<td style="text-align:left">只编译并将编译结果缓存下来（Linux系统下缓存默认在<code>~/.cache/go-build</code>下），而不安装</td>
</tr>
</tbody>
</table>
<h3 id="13-go-get--u">1.3 go get -u</h3>
<p>默认情况下 go get 会检查目标包及其依赖包在本地是否存在</p>
<ol>
<li>不存在才会从远程获取。</li>
<li>如果存在，那么即便远程仓库中的目标包及其依赖包的版本发生了更新，go get 也会直接跳过</li>
</ol>
<p>如果想要go get更新目标包及其依赖包的版本，需要给它传入-u命令行标志选项。</p>
<table>
<thead>
<tr>
<th style="text-align:left">区别</th>
<th style="text-align:left">gopath</th>
<th style="text-align:left">module-ware</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">依赖判定</td>
<td style="text-align:left">只是单纯地下载包的最新版本，如果包存在不兼容，将导致编译问题</td>
<td style="text-align:left">根据 go.mod 的依赖关系，获取满足要求的、依赖module的minor版本或patch版本进行更新</td>
</tr>
</tbody>
</table>
<p>module-aware模式下，存在一个特殊情况:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/go/expert/go_get_u.png"
        data-srcset="/images/go/expert/go_get_u.png, /images/go/expert/go_get_u.png 1.5x, /images/go/expert/go_get_u.png 2x"
        data-sizes="auto"
        alt="/images/go/expert/go_get_u.png"
        title="module s、t、u和w之间的依赖关系" /></p>
<p>module s的直接依赖 module t中的包t1 并未直接参与module s的构建(即 s 没有 import t/t1)，这时如果采用go get -u更新module s的依赖版本，go get -u仅会将t更新到最新的兼容版本（v1.1.0），而module t中未直接参与构建s包的t1包所依赖的module w并不会被更新。</p>
<h3 id="14-go-get--t">1.4 go get -t</h3>
<p>-t命令行标志选项是一个辅助选项，它通常与-d或-u组合使用，用来指示go get在仅下载源码或构建安装时要考虑测试代码的依赖，将测试代码的依赖包一并获取。</p>
<h3 id="15-行为对比">1.5 行为对比</h3>
<p>gopath模式和module-aware模式下的go get行为对比:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/go/expert/go_get.png"
        data-srcset="/images/go/expert/go_get.png, /images/go/expert/go_get.png 1.5x, /images/go/expert/go_get.png 2x"
        data-sizes="auto"
        alt="/images/go/expert/go_get.png"
        title="go get命令在gopath模式和module-aware模式下的对比" /></p>
<h2 id="2-go-install">2. go install</h2>
<p>go install 会对包进行编译，并将构建出的可执行文件安装到 <code>$GOBIN</code> 或 <code>$GOPATH/bin</code>下。注意 go get 会拉取代码，然后在执行 go install。</p>
<p>go install 常用的命令如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// -x -v选项，go install会输出大量日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">$</span><span class="k">go</span> <span class="nx">install</span> <span class="o">-</span><span class="nx">x</span> <span class="o">-</span><span class="nx">v</span> <span class="nx">bitbucket</span><span class="p">.</span><span class="nx">org</span><span class="o">/</span><span class="nx">bigwhite</span><span class="o">/</span><span class="nx">p</span>
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th style="text-align:left">go module之前的gopath模式</th>
<th style="text-align:left">go module之后的gopath模式</th>
<th style="text-align:left">module-ware</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">二进制文件被安装到 <code>$GOBIN</code> 或 <code>$GOPATH/bin</code>下</td>
<td style="text-align:left">同</td>
<td style="text-align:left">同</td>
</tr>
<tr>
<td style="text-align:left">目标文件（.a）被安装到$GOPATH/pkg/linux_amd64下</td>
<td style="text-align:left">不会安装，会复制一份放到$GOCACHE下，需要单独安装，添加 -i 选项</td>
<td style="text-align:left">仅会被缓存到$GOCACHE下</td>
</tr>
<tr>
<td style="text-align:left">go clean可以清理掉当前目录下编译构建得到的 p</td>
<td style="text-align:left">同</td>
<td style="text-align:left">同</td>
</tr>
<tr>
<td style="text-align:left">go clean -i会清理掉$GOBIN下的可执行文件 p</td>
<td style="text-align:left">同</td>
<td style="text-align:left">同</td>
</tr>
<tr>
<td style="text-align:left">go clean -i bitbucket.org/bigwhite/q 会清理掉目标文件</td>
<td style="text-align:left">无</td>
<td style="text-align:left">无</td>
</tr>
</tbody>
</table>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/go/expert/go_install.png"
        data-srcset="/images/go/expert/go_install.png, /images/go/expert/go_install.png 1.5x, /images/go/expert/go_install.png 2x"
        data-sizes="auto"
        alt="/images/go/expert/go_install.png"
        title="go install命令在GOPATH模式和module-aware模式下的对比" /></p>
<h2 id="3-go-list">3. go list</h2>
<p>go list 用于列出(检视)关于包/module的各类信息。go list 命令行选项如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">go list  --help
</span></span><span class="line"><span class="cl">usage: go list <span class="o">[</span>-f format<span class="o">]</span> <span class="o">[</span>-json<span class="o">]</span> <span class="o">[</span>-m<span class="o">]</span> <span class="o">[</span>list flags<span class="o">]</span> <span class="o">[</span>build flags<span class="o">]</span> <span class="o">[</span>packages<span class="o">]</span>
</span></span><span class="line"><span class="cl">Run <span class="s1">&#39;go help list&#39;</span> <span class="k">for</span> details.
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="31-搜索范围">3.1 搜索范围</h3>
<p>package 用于确定搜索的范围:</p>
<ol>
<li>默认: 在当前路径下寻找 go.mod，如果当前路径下没有go.mod文件，go list会报错</li>
<li>./&hellip;:</li>
</ol>
<ul>
<li>列出当前路径及其子路径（递归）下的所有包</li>
<li>在module-aware模式下，如果当前目录不是module根目录，使用module根路径+&hellip;的方式列举包会导致go list无法匹配到包</li>
</ul>
<ol start="3">
<li>main：表示独立可执行程序的顶层包</li>
<li>all：</li>
</ol>
<ul>
<li>在gopath模式下，它可以展开为标准库和GOPATH路径下的所有包；</li>
<li>在module-aware模式下，它展开为主module（当前路径下的module）下的所有包及其所有依赖包，包括测试代码的依赖包。</li>
</ul>
<ol start="5">
<li>std：代表标准库所有包的集合</li>
<li>cmd：代码Go语言自身项目仓库下的src/cmd下的所有包及internal包。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 1. 搜索路径</span>
</span></span><span class="line"><span class="cl"><span class="nv">$go</span> list
</span></span><span class="line"><span class="cl"><span class="nv">$go</span> list ./...
</span></span><span class="line"><span class="cl"><span class="nv">$go</span> list bitbucket.org/bigwhite/...
</span></span><span class="line"><span class="cl"><span class="c1">#  Go原生保留了几个代表特定包或包集合的路径关键字：main、all、cmd和std</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  这些保留的路径关键字不要用于Go包的构建中</span>
</span></span><span class="line"><span class="cl"><span class="nv">$go</span> list all
</span></span><span class="line"><span class="cl"><span class="nv">$go</span> list std
</span></span><span class="line"><span class="cl"><span class="nv">$go</span> list cmd
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="32-输出内容">3.2 输出内容</h3>
<h4 id="go-list--m">go list -m</h4>
<p>默认情况下，go list输出的都是包的导入路径信息，如果要列出module信息，可以为list命令传入-m命令行标志选项。</p>
<h4 id="go-list--f">go list -f</h4>
<p>go list提供了一个 -f 的命令行标志选项，用于定制其输出内容的格式。-f标志选项的值是一个格式字符串，采用的是Go template包的语法。go list的默认输出等价于：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">$go</span> list -f <span class="s1">&#39;{{.ImportPath}}&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>go list 可以输出内容来自<code>$GOROOT/src/cmd/go/internal/pkg.go</code>文件中的结构体类型PackagePublic，其结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">PackagePublic</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Dir</span>           <span class="kt">string</span> <span class="s">`json:&#34;,omitempty&#34;`</span>  <span class="c1">// 包含包源码的目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ImportPath</span>    <span class="kt">string</span> <span class="s">`json:&#34;,omitempty&#34;`</span>  <span class="c1">// dir下包的导入路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ImportComment</span> <span class="kt">string</span> <span class="s">`json:&#34;,omitempty&#34;`</span>  <span class="c1">// 包声明语句后面的注释中的路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Name</span>          <span class="kt">string</span> <span class="s">`json:&#34;,omitempty&#34;`</span>  <span class="c1">// 包名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Doc</span>           <span class="kt">string</span> <span class="s">`json:&#34;,omitempty&#34;`</span>  <span class="c1">// 包文档字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Target</span>        <span class="kt">string</span> <span class="s">`json:&#34;,omitempty&#34;`</span>  <span class="c1">// 该软件包的安装目标（可以是可执行的）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">TestGoFiles</span>  <span class="p">[]</span><span class="kt">string</span> <span class="s">`json:&#34;,omitempty&#34;`</span> <span class="c1">// 包中的_test.go文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">TestImports</span>  <span class="p">[]</span><span class="kt">string</span> <span class="s">`json:&#34;,omitempty&#34;`</span> <span class="c1">// TestGoFiles导入的包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">XTestGoFiles</span> <span class="p">[]</span><span class="kt">string</span> <span class="s">`json:&#34;,omitempty&#34;`</span> <span class="c1">// 包外的_test.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">XTestImports</span> <span class="p">[]</span><span class="kt">string</span> <span class="s">`json:&#34;,omitempty&#34;`</span> <span class="c1">// XTestGoFiles导入的包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th style="text-align:left">字段</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ImportPath</td>
<td style="text-align:left">ImportPath表示当前路径下的包的导入路径，该字段唯一标识一个包</td>
</tr>
<tr>
<td style="text-align:left">Target</td>
<td style="text-align:left">Target表示包的安装路径，该字段采用绝对路径形式</td>
</tr>
<tr>
<td style="text-align:left">Root</td>
<td style="text-align:left">Root表示包所在的GOROOT或GOPATH顶层路径，或者包含该包的module根路径</td>
</tr>
<tr>
<td style="text-align:left">GoFiles</td>
<td style="text-align:left">GoFiles表示当前包包含的Go源文件列表，不包含导入“C”的cgo文件、测试代码源文件</td>
</tr>
<tr>
<td style="text-align:left">CgoFiles</td>
<td style="text-align:left">CgoFiles表示当前包下导入了“C”的cgo文件</td>
</tr>
<tr>
<td style="text-align:left">IgnoredGoFiles</td>
<td style="text-align:left">IgnoredGoFiles表示当前包中在当前构建上下文约束条件下被忽略的Go源文件</td>
</tr>
<tr>
<td style="text-align:left">Imports</td>
<td style="text-align:left">Imports表示当前包导入的依赖包的导入路径集合</td>
</tr>
<tr>
<td style="text-align:left">Deps</td>
<td style="text-align:left">Deps表示当前包的所有依赖包导入路径集合。和Imports不同的是，Deps是递归查询当前包的所有依赖包</td>
</tr>
<tr>
<td style="text-align:left">TestGoFiles</td>
<td style="text-align:left">TestGoFiles表示当前包的包内测试代码的文件集合</td>
</tr>
<tr>
<td style="text-align:left">XTestGoFiles</td>
<td style="text-align:left">XTestGoFiles表示当前包的包外测试代码的文件集合</td>
</tr>
</tbody>
</table>
<h4 id="go-list--json">go list -json</h4>
<p>-f 外，传入 -json 选项，可以将包的全部信息以JSON格式输出。</p>
<h4 id="go-list--m--u">go list -m -u</h4>
<p>通过 -m 标志选项，可以让go list列出module信息，-m就像是一个从包到module的转换开关。基于该开关，我们还可以通过传入其他标志选项来获得更多有关module的信息。比如：通过传入-u标志选项，我们可以获取到可用的module升级版本。</p>
<h4 id="go-list-常用命令">go list 常用命令</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 2. 输出详细信息</span>
</span></span><span class="line"><span class="cl"><span class="nv">$go</span> list -m    <span class="c1"># 输出导出包的详细信息      </span>
</span></span><span class="line"><span class="cl"><span class="nv">$go</span> list -f <span class="s1">&#39;{{.ImportPath}}&#39;</span>
</span></span><span class="line"><span class="cl">$ go list -json
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 3. 有关module的可用升级版本信息</span>
</span></span><span class="line"><span class="cl">$ go list -m -u all
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4-go-build">4. go build</h2>
<p>go build命令用于Go源码构建。go build 还提供了很多命令行标志选项，这些标志选项可用于</p>
<ol>
<li>对构建过程出现的问题进行辅助诊断</li>
<li>定制构建</li>
<li>向编译器/链接器传递参数</li>
</ol>
<h3 id="41-go-build--x--v">4.1 go build -x -v</h3>
<p>-v 用于输出当前正在编译的包，-x 用于输出go build执行的每一个命令。</p>
<p>go build执行命令的顺序大致如下：</p>
<ol>
<li>创建用于构建的临时目录；</li>
<li>下载构建module s依赖的module t和u；</li>
<li>分别编译module t和u，将编译后的结果存储到临时目录及GOCACHE目录下；</li>
<li>编译module s；</li>
<li>定位和汇总module s的各个依赖包构建后的目标文件（.a文件）的位置，形成importcfg.link文件，供后续链接器使用；</li>
<li>链接成可执行文件；</li>
<li>清理临时构建环境。</li>
</ol>
<p>go build 过程会调用</p>
<ol>
<li><code>go tool compile</code>: <code>$GOROOT/pkg/tool/linux_amd64/compile</code>) 包编译</li>
<li><code>go tool link</code>: <code>$GOROOT/pkg/tool/linux_amd64/link</code> 最终的链接</li>
</ol>
<p>编译及链接命令中的每个标志选项都会对最终结果产生影响，比如：-goversion的值会影响Go编译器的行为，而这个值可能来自go.mod中的Go版本指示标记。</p>
<h4 id="42-go-build--a">4.2 go build -a</h4>
<p>-a 强制重新构建所有包。传入-a选项后，go build就会忽略掉所有缓存机制，忽略掉已经安装到$GOPATH/pkg下的依赖包库文件（.a）从头构建。</p>
<p>go build 在 gopath 模式下比较常用，在module-aware模式下，go module 支持可重建，并且缓存由 go 工具自动管理，很少有人去改动，所以 go build -a变得很少用。</p>
<h3 id="43-go-build--race">4.3 go build -race</h3>
<p>-race命令行选项会在构建的结果中加入竞态检测的代码。在程序运行过程中，如果发现对数据的并发竞态访问，这些代码会给出警告，这些警告信息可以用来辅助后续查找和解决竞态问题。不过由于插入竞态检测的代码这个动作，带有-race的构建过程会比标准构建略慢一些。</p>
<p>Go社区的一个最佳实践是在正式发布到生产环境之前的调试、测试环节使用带有-race构建选项构建出的程序，以便于在正式发布到生产环境之前尽可能多地发现程序中潜在的并发竞态问题并快速将其解决。</p>
<h3 id="44-go-build--gcflags">4.4 go build -gcflags</h3>
<p>go build 实质上是通过调用Go自带的compile工具（以Linux系统为例，该工具对应的是<code>$GOROOT/pkg/tool/linux_amd64/compile</code>）对Go代码进行编译的。</p>
<p>go build可以经由<code>-gcflags</code>向compile工具传递编译所需的命令行标志选项集合。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">go build -gcflags<span class="o">[=</span>标志应用的包范围<span class="o">]=</span><span class="s1">&#39;空格分隔的标志选项列表&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">go build -gcflags<span class="o">=</span><span class="s1">&#39;-N -l&#39;</span>      <span class="c1"># 仅将传递的编译选项应用于当前包</span>
</span></span><span class="line"><span class="cl">go build -gcflags<span class="o">=</span><span class="nv">all</span><span class="o">=</span><span class="s1">&#39;-N -l&#39;</span>  <span class="c1"># 将传递的编译选项应用于当前包及其所有依赖包</span>
</span></span><span class="line"><span class="cl">go build -gcflags<span class="o">=</span><span class="nv">std</span><span class="o">=</span><span class="s1">&#39;-N -l&#39;</span>  <span class="c1"># 仅将传递的编译选项应用于标准库包</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 一些选项还具有级别属性，即支持设定选项的作用级别或输出信息内容的详尽级别</span>
</span></span><span class="line"><span class="cl">go build -gcflags<span class="o">=</span><span class="s1">&#39;-m&#39;</span>
</span></span><span class="line"><span class="cl">go build -gcflags<span class="o">=</span><span class="s1">&#39;-m -m&#39;</span>      // 输出比上一条命令更为详尽的逃逸分析过程信息
</span></span><span class="line"><span class="cl">go build -gcflags<span class="o">=</span><span class="s1">&#39;-m=2&#39;</span>       // 与上一条命令等价
</span></span><span class="line"><span class="cl">go build -gcflags<span class="o">=</span><span class="s1">&#39;-m -m -m&#39;</span>   // 输出最为详尽的逃逸分析过程信息
</span></span><span class="line"><span class="cl">go build -gcflags<span class="o">=</span><span class="s1">&#39;-m=3&#39;</span>       // 与上一条命令等价
</span></span></code></pre></td></tr></table>
</div>
</div><p>“标志应用的包范围”是可选项</p>
<ol>
<li>如果不显式填写，那么Go编译器仅将通过gcflags传递的编译选项应用在当前包；</li>
<li>如果显式指定了包范围，则通过gcflags传递的编译选项不仅会应用在当前包的编译上，还会应用于包范围指定的包上。</li>
</ol>
<p>命令行标志选项是传递给Go编译器的，比较重要的是</p>
<ol>
<li>-l：关闭内联。</li>
<li>-N：关闭代码优化。</li>
<li>-m：输出逃逸分析（决定哪些对象在栈上分配，哪些对象在堆上分配）的分析决策过程。</li>
<li>-S：输出汇编代码。</li>
</ol>
<h4 id="编译选项参数集合">编译选项参数集合</h4>
<p>执行 <code>go tool compile -help</code> 可以查看所有能传递给编译器的选项集合:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ go tool compile -help
</span></span><span class="line"><span class="cl">usage: compile <span class="o">[</span>options<span class="o">]</span> file.go...
</span></span><span class="line"><span class="cl">  -% int
</span></span><span class="line"><span class="cl">    	debug non-static initializers
</span></span><span class="line"><span class="cl">  -+	compiling runtime
</span></span><span class="line"><span class="cl">  -B	disable bounds checking
</span></span><span class="line"><span class="cl">  -C	disable printing of columns in error messages
</span></span><span class="line"><span class="cl">  -D path
</span></span><span class="line"><span class="cl">    	<span class="nb">set</span> relative path <span class="k">for</span> <span class="nb">local</span> imports
</span></span><span class="line"><span class="cl">  -E	debug symbol <span class="nb">export</span>
</span></span><span class="line"><span class="cl">  -G	accept generic code <span class="o">(</span>default 3<span class="o">)</span>
</span></span><span class="line"><span class="cl">  -I directory
</span></span><span class="line"><span class="cl">    	add directory to import search path
</span></span><span class="line"><span class="cl">  -K	debug missing line numbers
</span></span><span class="line"><span class="cl">  -L	show full file names in error messages
</span></span><span class="line"><span class="cl">  -N	disable optimizations
</span></span><span class="line"><span class="cl">  -S	print assembly listing
</span></span><span class="line"><span class="cl">  -V	print version and <span class="nb">exit</span>
</span></span><span class="line"><span class="cl">  -W	debug parse tree after <span class="nb">type</span> checking
</span></span><span class="line"><span class="cl">  -asan
</span></span><span class="line"><span class="cl">    	build code compatible with C/C++ address sanitizer
</span></span><span class="line"><span class="cl">  -asmhdr file
</span></span><span class="line"><span class="cl">    	write assembly header to file
</span></span><span class="line"><span class="cl">  -bench file
</span></span><span class="line"><span class="cl">    	append benchmark <span class="nb">times</span> to file
</span></span><span class="line"><span class="cl">  -blockprofile file
</span></span><span class="line"><span class="cl">    	write block profile to file
</span></span><span class="line"><span class="cl">  -buildid id
</span></span><span class="line"><span class="cl">    	record id as the build id in the <span class="nb">export</span> metadata
</span></span><span class="line"><span class="cl">  -c int
</span></span><span class="line"><span class="cl">    	concurrency during compilation <span class="o">(</span><span class="m">1</span> means no concurrency<span class="o">)</span> <span class="o">(</span>default 1<span class="o">)</span>
</span></span><span class="line"><span class="cl">  -clobberdead
</span></span><span class="line"><span class="cl">    	clobber dead stack slots <span class="o">(</span><span class="k">for</span> debugging<span class="o">)</span>
</span></span><span class="line"><span class="cl">  -clobberdeadreg
</span></span><span class="line"><span class="cl">    	clobber dead registers <span class="o">(</span><span class="k">for</span> debugging<span class="o">)</span>
</span></span><span class="line"><span class="cl">  -complete
</span></span><span class="line"><span class="cl">    	compiling <span class="nb">complete</span> package <span class="o">(</span>no C or assembly<span class="o">)</span>
</span></span><span class="line"><span class="cl">  -cpuprofile file
</span></span><span class="line"><span class="cl">    	write cpu profile to file
</span></span><span class="line"><span class="cl">  -d value
</span></span><span class="line"><span class="cl">    	<span class="nb">enable</span> debugging settings<span class="p">;</span> try -d <span class="nb">help</span>
</span></span><span class="line"><span class="cl">  -dwarf
</span></span><span class="line"><span class="cl">    	generate DWARF symbols <span class="o">(</span>default <span class="nb">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  -dwarfbasentries
</span></span><span class="line"><span class="cl">    	use base address selection entries in DWARF <span class="o">(</span>default <span class="nb">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  -dwarflocationlists
</span></span><span class="line"><span class="cl">    	add location lists to DWARF in optimized mode <span class="o">(</span>default <span class="nb">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  -dynlink
</span></span><span class="line"><span class="cl">    	support references to Go symbols defined in other shared libraries
</span></span><span class="line"><span class="cl">  -e	no limit on number of errors reported
</span></span><span class="line"><span class="cl">  -embedcfg file
</span></span><span class="line"><span class="cl">    	<span class="nb">read</span> go:embed configuration from file
</span></span><span class="line"><span class="cl">  -gendwarfinl int
</span></span><span class="line"><span class="cl">    	generate DWARF inline info records <span class="o">(</span>default 2<span class="o">)</span>
</span></span><span class="line"><span class="cl">  -goversion string
</span></span><span class="line"><span class="cl">    	required version of the runtime
</span></span><span class="line"><span class="cl">  -h	halt on error
</span></span><span class="line"><span class="cl">  -importcfg file
</span></span><span class="line"><span class="cl">    	<span class="nb">read</span> import configuration from file
</span></span><span class="line"><span class="cl">  -importmap definition
</span></span><span class="line"><span class="cl">    	add definition of the form <span class="nv">source</span><span class="o">=</span>actual to import map
</span></span><span class="line"><span class="cl">  -installsuffix suffix
</span></span><span class="line"><span class="cl">    	<span class="nb">set</span> pkg directory suffix
</span></span><span class="line"><span class="cl">  -j	debug runtime-initialized variables
</span></span><span class="line"><span class="cl">  -json string
</span></span><span class="line"><span class="cl">    	version,file <span class="k">for</span> JSON compiler/optimizer detail output
</span></span><span class="line"><span class="cl">  -l	disable inlining
</span></span><span class="line"><span class="cl">  -lang string
</span></span><span class="line"><span class="cl">    	Go language version <span class="nb">source</span> code expects
</span></span><span class="line"><span class="cl">  -linkobj file
</span></span><span class="line"><span class="cl">    	write linker-specific object to file
</span></span><span class="line"><span class="cl">  -linkshared
</span></span><span class="line"><span class="cl">    	generate code that will be linked against Go shared libraries
</span></span><span class="line"><span class="cl">  -live
</span></span><span class="line"><span class="cl">    	debug liveness analysis
</span></span><span class="line"><span class="cl">  -m	print optimization decisions
</span></span><span class="line"><span class="cl">  -memprofile file
</span></span><span class="line"><span class="cl">    	write memory profile to file
</span></span><span class="line"><span class="cl">  -memprofilerate rate
</span></span><span class="line"><span class="cl">    	<span class="nb">set</span> runtime.MemProfileRate to rate
</span></span><span class="line"><span class="cl">  -msan
</span></span><span class="line"><span class="cl">    	build code compatible with C/C++ memory sanitizer
</span></span><span class="line"><span class="cl">  -mutexprofile file
</span></span><span class="line"><span class="cl">    	write mutex profile to file
</span></span><span class="line"><span class="cl">  -nolocalimports
</span></span><span class="line"><span class="cl">    	reject <span class="nb">local</span> <span class="o">(</span>relative<span class="o">)</span> imports
</span></span><span class="line"><span class="cl">  -o file
</span></span><span class="line"><span class="cl">    	write output to file
</span></span><span class="line"><span class="cl">  -p path
</span></span><span class="line"><span class="cl">    	<span class="nb">set</span> expected package import path
</span></span><span class="line"><span class="cl">  -pack
</span></span><span class="line"><span class="cl">    	write to file.a instead of file.o
</span></span><span class="line"><span class="cl">  -r	debug generated wrappers
</span></span><span class="line"><span class="cl">  -race
</span></span><span class="line"><span class="cl">    	<span class="nb">enable</span> race detector
</span></span><span class="line"><span class="cl">  -shared
</span></span><span class="line"><span class="cl">    	generate code that can be linked into a shared library
</span></span><span class="line"><span class="cl">  -smallframes
</span></span><span class="line"><span class="cl">    	reduce the size limit <span class="k">for</span> stack allocated objects
</span></span><span class="line"><span class="cl">  -spectre list
</span></span><span class="line"><span class="cl">    	<span class="nb">enable</span> spectre mitigations in list <span class="o">(</span>all, index, ret<span class="o">)</span>
</span></span><span class="line"><span class="cl">  -std
</span></span><span class="line"><span class="cl">    	compiling standard library
</span></span><span class="line"><span class="cl">  -symabis file
</span></span><span class="line"><span class="cl">    	<span class="nb">read</span> symbol ABIs from file
</span></span><span class="line"><span class="cl">  -t	<span class="nb">enable</span> tracing <span class="k">for</span> debugging the compiler
</span></span><span class="line"><span class="cl">  -traceprofile file
</span></span><span class="line"><span class="cl">    	write an execution trace to file
</span></span><span class="line"><span class="cl">  -trimpath prefix
</span></span><span class="line"><span class="cl">    	remove prefix from recorded <span class="nb">source</span> file paths
</span></span><span class="line"><span class="cl">  -v	increase debug verbosity
</span></span><span class="line"><span class="cl">  -w	debug <span class="nb">type</span> checking
</span></span><span class="line"><span class="cl">  -wb
</span></span><span class="line"><span class="cl">    	<span class="nb">enable</span> write barrier <span class="o">(</span>default <span class="nb">true</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="45-go-build--ldflags">4.5 go build -ldflags</h3>
<p>go build 也支持通过-ldflags 为链接器（以Linux系统为例，该工具对应的是<code>$GOROOT/pkg/tool/linux_amd64/link</code>）传递链接选项集合。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">go build -ldflags<span class="o">=</span><span class="s1">&#39;空格分隔的标志选项列表&#39;</span>
</span></span><span class="line"><span class="cl">go build -ldflags <span class="s2">&#34;-X main.version=v0.7.0 -s -w&#34;</span> -o linker_x_flag_without_symboltable_and_dwarf linker_x_flag.go
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中比较常用的有:</p>
<ol>
<li>-X: 设定包中string类型变量的值（仅支持string类型变量）</li>
<li>-s：不生成符号表（symbol table）</li>
<li>-w：不生成DWARF（Debugging With Attributed Record Formats）调试信息</li>
</ol>
<p>默认情况下，go build构建出的可执行二进制文件中都是包含符号表和DWARF格式的调试信息的，这虽然让最终二进制文件的体积增加了，但是符号表和调试信息对于生产环境下程序异常时的现场保存和在线调试都有着重要意义。但如果你不在意这些信息或者对应用的大小十分敏感，那么可以通过-s和-w选项将符号表和调试信息从最终的二进制文件中剔除。</p>
<h4 id="-x">-X</h4>
<p>通过-X选项，我们可以在编译链接期间动态地为程序中的字符串变量进行赋值，这个选项的一个典型应用就是在构建脚本中设定程序的版本值。</p>
<p>我们通常会为应用程序添加version命令行标志选项，用来输出当前程序的版本信息，就像Go自身那样：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">$go</span> version
</span></span><span class="line"><span class="cl">go version go1.14 darwin/amd64
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果将版本信息写死到程序代码中，显然不够灵活，耦合太紧。而将版本信息在程序构建时注入则是一个不错的方案。-X选项就可以用来实现这个方案：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">version</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;version&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;version:&#34;</span><span class="p">,</span> <span class="nx">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 构建这个程序，在构建时为version这个string类型变量动态地注入新值：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">$</span><span class="k">go</span> <span class="nx">build</span> <span class="o">-</span><span class="nx">ldflags</span> <span class="s">&#34;-X main.version=v0.7.0&#34;</span> <span class="nx">linker_x_flag</span><span class="p">.</span><span class="k">go</span>
</span></span><span class="line"><span class="cl"><span class="err">$</span><span class="p">.</span><span class="o">/</span><span class="nx">linker_x_flag</span> <span class="nx">version</span>
</span></span><span class="line"><span class="cl"><span class="nx">version</span><span class="p">:</span> <span class="nx">v0</span><span class="mf">.7.0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="链接选项参数集合">链接选项参数集合</h4>
<p>执行 <code>go tool link -help</code> 可以查看所有能传递给链接的选项集合:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ go tool link -help
</span></span><span class="line"><span class="cl">usage: link <span class="o">[</span>options<span class="o">]</span> main.o
</span></span><span class="line"><span class="cl">  -B note
</span></span><span class="line"><span class="cl">    	add an ELF NT_GNU_BUILD_ID note when using ELF
</span></span><span class="line"><span class="cl">  -E entry
</span></span><span class="line"><span class="cl">    	<span class="nb">set</span> entry symbol name
</span></span><span class="line"><span class="cl">  -H <span class="nb">type</span>
</span></span><span class="line"><span class="cl">    	<span class="nb">set</span> header <span class="nb">type</span>
</span></span><span class="line"><span class="cl">  -I linker
</span></span><span class="line"><span class="cl">    	use linker as ELF dynamic linker
</span></span><span class="line"><span class="cl">  -L directory
</span></span><span class="line"><span class="cl">    	add specified directory to library path
</span></span><span class="line"><span class="cl">  -R quantum
</span></span><span class="line"><span class="cl">    	<span class="nb">set</span> address rounding quantum <span class="o">(</span>default -1<span class="o">)</span>
</span></span><span class="line"><span class="cl">  -T address
</span></span><span class="line"><span class="cl">    	<span class="nb">set</span> text segment address <span class="o">(</span>default -1<span class="o">)</span>
</span></span><span class="line"><span class="cl">  -V	print version and <span class="nb">exit</span>
</span></span><span class="line"><span class="cl">  -X definition
</span></span><span class="line"><span class="cl">    	add string value definition of the form importpath.name<span class="o">=</span>value
</span></span><span class="line"><span class="cl">  -a	no-op <span class="o">(</span>deprecated<span class="o">)</span>
</span></span><span class="line"><span class="cl">  -asan
</span></span><span class="line"><span class="cl">    	<span class="nb">enable</span> ASan interface
</span></span><span class="line"><span class="cl">  -aslr
</span></span><span class="line"><span class="cl">    	<span class="nb">enable</span> ASLR <span class="k">for</span> <span class="nv">buildmode</span><span class="o">=</span>c-shared on windows <span class="o">(</span>default <span class="nb">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  -benchmark string
</span></span><span class="line"><span class="cl">    	<span class="nb">set</span> to <span class="s1">&#39;mem&#39;</span> or <span class="s1">&#39;cpu&#39;</span> to <span class="nb">enable</span> phase benchmarking
</span></span><span class="line"><span class="cl">  -benchmarkprofile base
</span></span><span class="line"><span class="cl">    	emit phase profiles to base_phase.<span class="o">{</span>cpu,mem<span class="o">}</span>prof
</span></span><span class="line"><span class="cl">  -buildid id
</span></span><span class="line"><span class="cl">    	record id as Go toolchain build id
</span></span><span class="line"><span class="cl">  -buildmode mode
</span></span><span class="line"><span class="cl">    	<span class="nb">set</span> build mode
</span></span><span class="line"><span class="cl">  -c	dump call graph
</span></span><span class="line"><span class="cl">  -compressdwarf
</span></span><span class="line"><span class="cl">    	compress DWARF <span class="k">if</span> possible <span class="o">(</span>default <span class="nb">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  -cpuprofile file
</span></span><span class="line"><span class="cl">    	write cpu profile to file
</span></span><span class="line"><span class="cl">  -d	disable dynamic executable
</span></span><span class="line"><span class="cl">  -debugtextsize int
</span></span><span class="line"><span class="cl">    	debug text section max size
</span></span><span class="line"><span class="cl">  -debugtramp int
</span></span><span class="line"><span class="cl">    	debug trampolines
</span></span><span class="line"><span class="cl">  -dumpdep
</span></span><span class="line"><span class="cl">    	dump symbol dependency graph
</span></span><span class="line"><span class="cl">  -extar string
</span></span><span class="line"><span class="cl">    	archive program <span class="k">for</span> <span class="nv">buildmode</span><span class="o">=</span>c-archive
</span></span><span class="line"><span class="cl">  -extld linker
</span></span><span class="line"><span class="cl">    	use linker when linking in external mode
</span></span><span class="line"><span class="cl">  -extldflags flags
</span></span><span class="line"><span class="cl">    	pass flags to external linker
</span></span><span class="line"><span class="cl">  -f	ignore version mismatch
</span></span><span class="line"><span class="cl">  -g	disable go package data checks
</span></span><span class="line"><span class="cl">  -h	halt on error
</span></span><span class="line"><span class="cl">  -importcfg file
</span></span><span class="line"><span class="cl">    	<span class="nb">read</span> import configuration from file
</span></span><span class="line"><span class="cl">  -installsuffix suffix
</span></span><span class="line"><span class="cl">    	<span class="nb">set</span> package directory suffix
</span></span><span class="line"><span class="cl">  -k symbol
</span></span><span class="line"><span class="cl">    	<span class="nb">set</span> field tracking symbol
</span></span><span class="line"><span class="cl">  -libgcc string
</span></span><span class="line"><span class="cl">    	compiler support lib <span class="k">for</span> internal linking<span class="p">;</span> use <span class="s2">&#34;none&#34;</span> to disable
</span></span><span class="line"><span class="cl">  -linkmode mode
</span></span><span class="line"><span class="cl">    	<span class="nb">set</span> link mode
</span></span><span class="line"><span class="cl">  -linkshared
</span></span><span class="line"><span class="cl">    	link against installed Go shared libraries
</span></span><span class="line"><span class="cl">  -memprofile file
</span></span><span class="line"><span class="cl">    	write memory profile to file
</span></span><span class="line"><span class="cl">  -memprofilerate rate
</span></span><span class="line"><span class="cl">    	<span class="nb">set</span> runtime.MemProfileRate to rate
</span></span><span class="line"><span class="cl">  -msan
</span></span><span class="line"><span class="cl">    	<span class="nb">enable</span> MSan interface
</span></span><span class="line"><span class="cl">  -n	dump symbol table
</span></span><span class="line"><span class="cl">  -o file
</span></span><span class="line"><span class="cl">    	write output to file
</span></span><span class="line"><span class="cl">  -pluginpath string
</span></span><span class="line"><span class="cl">    	full path name <span class="k">for</span> plugin
</span></span><span class="line"><span class="cl">  -r path
</span></span><span class="line"><span class="cl">    	<span class="nb">set</span> the ELF dynamic linker search path to dir1:dir2:...
</span></span><span class="line"><span class="cl">  -race
</span></span><span class="line"><span class="cl">    	<span class="nb">enable</span> race detector
</span></span><span class="line"><span class="cl">  -s	disable symbol table
</span></span><span class="line"><span class="cl">  -strictdups int
</span></span><span class="line"><span class="cl">    	sanity check duplicate symbol contents during object file reading <span class="o">(</span><span class="nv">1</span><span class="o">=</span>warn <span class="nv">2</span><span class="o">=</span>err<span class="o">)</span>.
</span></span><span class="line"><span class="cl">  -tmpdir directory
</span></span><span class="line"><span class="cl">    	use directory <span class="k">for</span> temporary files
</span></span><span class="line"><span class="cl">  -v	print link trace
</span></span><span class="line"><span class="cl">  -w	disable DWARF generation
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="45-go-build--tags">4.5 go build -tags</h3>
<p>go build 可以通过 -tags 指定构建的约束条件，以决定哪些源文件被包含在包内进行构建。tags的值为一组逗号分隔（老版本为空格分隔）的值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">$go</span> build -tags<span class="o">=</span><span class="s2">&#34;tag1,tag2,...&#34;</span> ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>与tags值列表中的tag1、tag2等呼应的则是 <strong>Go源文件中的build tag（亦称为build constraint）</strong>，下面是标准库os包的file_unix.go源文件中build tag的格式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// +build aix darwin dragonfly freebsd js,wasm linux netbsd openbsd solaris
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">os</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到Go源文件中的build tag实际上就是某种特殊形式的注释:</p>
<ol>
<li>它通常放在Go源文件的顶部区域，以一行注释或连续的（中间无空行）多行注释形式存在。</li>
<li>build tag与前后的包注释或包声明语句的中间要有一行空行。</li>
<li>build tag 以+build作为起始标记，与前面的注释符号//中间有一个空格</li>
<li>+build后面就是约束标记字符串，比如上面例子中的aix、darwin等。每一行的build tag实质上会被求值为一个布尔表达式。</li>
</ol>
<p>下图是 Go 源文件中 build tag 布尔表达式的求值规则</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/go/expert/go_build_tag.png"
        data-srcset="/images/go/expert/go_build_tag.png, /images/go/expert/go_build_tag.png 1.5x, /images/go/expert/go_build_tag.png 2x"
        data-sizes="auto"
        alt="/images/go/expert/go_build_tag.png"
        title="Go 源文件中 build tag 布尔表达式的求值规则" /></p>
<p>当一个Go源文件带有build tag时()，只有当该组tag被求值为true时，该源文件才会被包含入对应的包中参与构建。如果文件没有带 build tag 不会走这个判断逻辑，默认即包含。</p>
<h2 id="5-运行与诊断">5. 运行与诊断</h2>
<p>Go 原生提供了一些环境变量，这些环境变量可以影响Go程序运行时的行为并输出Go运行时的一些信息以辅助在线诊断Go程序的问题。这也可以算作性能剖析（profiling）、调试（debug）手段之外的程序诊断辅助手段。我们来看看其中几个重要的环境变量:</p>
<h3 id="51-gomaxprocs">5.1 GOMAXPROCS</h3>
<ul>
<li>作用: 可用于设置Go程序启动后的逻辑处理器P的数量，如果每个P都绑定一个操作内核线程，那么该值将决定有多少个内核线程一起并行承载该Go程序的业务运行</li>
<li>默认: Go 1.5版本将GOMAXPROCS默认值调整为CPU核数，通常无需调整</li>
</ul>
<h3 id="52-gogc">5.2 GOGC</h3>
<p>除了显式调用 <code>runtime.GC</code> 强制运行GC，Go还提供了一个可以调节GC触发时机的环境变量：GOGC。</p>
<p>GOGC是一个整数值</p>
<ol>
<li>默认为100。这个值代表一个比例值，100表示100%。</li>
<li>这个比例值的分子是<strong>上一次GC结束后到当前时刻新分配的堆内存大小（设为M）</strong></li>
<li>分母则是<strong>上一次GC结束后堆内存上的活动对象内存数据（live data，可达内存）的大小（设为N）</strong>。</li>
<li>Go运行时实时监控当前堆内存状态，如果当前堆内存的N/M的值等于GOGC/100，则会再次触发运行GC</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/go/expert/gc.png"
        data-srcset="/images/go/expert/gc.png, /images/go/expert/gc.png 1.5x, /images/go/expert/gc.png 2x"
        data-sizes="auto"
        alt="/images/go/expert/gc.png"
        title="GC触发条件之一" /></p>
<h4 id="stw垃圾回收器">STW垃圾回收器</h4>
<p>在早期版本中，Go使用的是STW垃圾回收器，即每次触发GC后，都要先停止程序（Stop The World），然后GC进行标记（mark）和清除（sweep）操作，GC完成后再恢复程序的运行。每次GC完成后堆上的内存都是标记的活动对象，Go 运行可以准确的计算出 N/M 的比值。</p>
<h4 id="三色标记圾回收器">三色标记圾回收器</h4>
<p>在1.5版本中，Go抛弃了GC延迟过大且无法扩展的STW垃圾回收器，引入了基于三色标记清除的并发垃圾回收器。并发垃圾回收器与用户程序一起执行带来了GC延迟的大幅下降，但也导致了Go运行时无法精确控制堆内存大小，因为在并发标记过程中，只要没有停止程序，用户程序就可以继续分配内存。</p>
<p>计算新分配内存时不仅要考虑<strong>两次GC之间用户程序请求分配的内存</strong>，还要考虑新一轮GC开始后的<strong>并发标记过程中</strong>用户新分配的内存:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/go/expert/gc_tree.png"
        data-srcset="/images/go/expert/gc_tree.png, /images/go/expert/gc_tree.png 1.5x, /images/go/expert/gc_tree.png 2x"
        data-sizes="auto"
        alt="/images/go/expert/gc_tree.png"
        title="并发垃圾回收器触发新一轮GC的条件" /></p>
<p>于是新一轮GC被提前启动了，而启动的新一轮GC的目标值（goal）为：</p>
<p>goal = 上一轮GC后的堆活动内存大小×(GOGC/100+1)</p>
<p>显然一轮GC结束时的堆大小与该轮GC的目标期望值goal越接近说明GC启动的时机越好，对并发标记过程内存分配的估计越准确。那么究竟该提前多久启动新一轮GC呢？这是由Go并发垃圾回收的Pacing算法决定的。</p>
<h3 id="52-godebuggctrace1">5.2 GODEBUG=gctrace=1</h3>
<p>设置环境变量 GODEBUG=&lsquo;gctrace=1&rsquo; 可以让 GO 运行时在每次GC执行时输出此次GC相关的跟踪信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">$go</span> build -o gctrace gctrace.go
</span></span><span class="line"><span class="cl"><span class="nv">$GODEBUG</span><span class="o">=</span><span class="s1">&#39;gctrace=1&#39;</span> <span class="nv">GOGC</span><span class="o">=</span><span class="m">100</span> ./gctrace
</span></span><span class="line"><span class="cl">gc <span class="m">1</span> @0.008s 3%: 0.005+2.7+0.017 ms clock, 0.042+0.056/3.6/3.7+0.14 ms cpu, 5-&gt;5-&gt;4 MB, <span class="m">6</span> MB goal, <span class="m">8</span> P
</span></span><span class="line"><span class="cl">gc <span class="m">2</span> @0.028s 5%: 0.007+8.4+0.024 ms clock, 0.057+0.074/11/11+0.19 ms cpu, 9-&gt;9-&gt;8 MB, <span class="m">10</span> MB goal, <span class="m">8</span> P
</span></span><span class="line"><span class="cl">gc <span class="m">3</span> @0.067s 5%: 0.005+14+0.023 ms clock, 0.040+0.38/19/18+0.18 ms cpu, 19-&gt;19-&gt;16 MB, <span class="m">20</span> MB goal, <span class="m">8</span> P
</span></span><span class="line"><span class="cl">gc <span class="m">4</span> @0.141s 6%: 0.011+25+0.021 ms clock, 0.093+0.26/46/82+0.17 ms cpu, 38-&gt;38-&gt;33 MB, <span class="m">39</span> MB goal, <span class="m">8</span> P
</span></span><span class="line"><span class="cl">gc <span class="m">5</span> @0.256s 6%: 0.003+34+0.016 ms clock, 0.031+0.40/67/61+0.13 ms cpu, 77-&gt;77-&gt;66 MB, <span class="m">78</span> MB goal, <span class="m">8</span> P
</span></span><span class="line"><span class="cl">gc <span class="m">6</span> @0.448s 6%: 0.004+58+0.017 ms clock, 0.033+0.49/113/185+0.14 ms cpu, 154-&gt;154-&gt;133 MB, <span class="m">155</span> MB goal, <span class="m">8</span> P
</span></span><span class="line"><span class="cl">gc <span class="m">7</span> @0.868s 6%: 0.004+116+0.017 ms clock, 0.032+0.64/231/574+0.13 ms cpu, 307-&gt;308-&gt;266 MB, <span class="m">308</span> MB goal, <span class="m">8</span> P
</span></span><span class="line"><span class="cl">gc <span class="m">8</span> @1.793s 7%: 0.003+368+0.016 ms clock, 0.025+0.95/734/1812+0.13 ms cpu, 615-&gt;616-&gt;533 MB, <span class="m">616</span> MB goal, <span class="m">8</span> P
</span></span><span class="line"><span class="cl">gc <span class="m">9</span> @3.715s 7%: 0.003+692+0.021 ms clock, 0.028+34/1384/3436+0.17 ms cpu, 1231-&gt;1232-&gt;1066 MB, <span class="m">1232</span> MB goal, <span class="m">8</span> P
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="53-godebugschedtrace1000">5.3 GODEBUG=schedtrace=1000</h3>
<p>Go提供了调度器当前状态的查看方法：使用Go运行时环境变量GODEBUG。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ <span class="nv">GODEBUG</span><span class="o">=</span><span class="nv">schedtrace</span><span class="o">=</span><span class="m">1000</span> godoc -http<span class="o">=</span>:6060
</span></span><span class="line"><span class="cl">SCHED 0ms: <span class="nv">gomaxprocs</span><span class="o">=</span><span class="m">4</span> <span class="nv">idleprocs</span><span class="o">=</span><span class="m">3</span> <span class="nv">threads</span><span class="o">=</span><span class="m">3</span> <span class="nv">spinningthreads</span><span class="o">=</span><span class="m">0</span> <span class="nv">idlethreads</span><span class="o">=</span><span class="m">0</span> <span class="nv">runqueue</span><span class="o">=</span><span class="m">0</span> <span class="o">[</span><span class="m">0</span> <span class="m">0</span> <span class="m">0</span> 0<span class="o">]</span>
</span></span><span class="line"><span class="cl">SCHED 1001ms: <span class="nv">gomaxprocs</span><span class="o">=</span><span class="m">4</span> <span class="nv">idleprocs</span><span class="o">=</span><span class="m">0</span> <span class="nv">threads</span><span class="o">=</span><span class="m">9</span> <span class="nv">spinningthreads</span><span class="o">=</span><span class="m">0</span> <span class="nv">idlethreads</span><span class="o">=</span><span class="m">3</span> <span class="nv">runqueue</span><span class="o">=</span><span class="m">2</span> <span class="o">[</span><span class="m">8</span> <span class="m">14</span> <span class="m">5</span> 2<span class="o">]</span>
</span></span><span class="line"><span class="cl">SCHED 2006ms: <span class="nv">gomaxprocs</span><span class="o">=</span><span class="m">4</span> <span class="nv">idleprocs</span><span class="o">=</span><span class="m">0</span> <span class="nv">threads</span><span class="o">=</span><span class="m">25</span> <span class="nv">spinningthreads</span><span class="o">=</span><span class="m">0</span> <span class="nv">idlethreads</span><span class="o">=</span><span class="m">19</span> <span class="nv">runqueue</span><span class="o">=</span><span class="m">12</span> <span class="o">[</span><span class="m">0</span> <span class="m">0</span> <span class="m">4</span> 0<span class="o">]</span>
</span></span><span class="line"><span class="cl">SCHED 3006ms: <span class="nv">gomaxprocs</span><span class="o">=</span><span class="m">4</span> <span class="nv">idleprocs</span><span class="o">=</span><span class="m">0</span> <span class="nv">threads</span><span class="o">=</span><span class="m">26</span> <span class="nv">spinningthreads</span><span class="o">=</span><span class="m">0</span> <span class="nv">idlethreads</span><span class="o">=</span><span class="m">8</span> <span class="nv">runqueue</span><span class="o">=</span><span class="m">2</span> <span class="o">[</span><span class="m">0</span> <span class="m">1</span> <span class="m">1</span> 0<span class="o">]</span>
</span></span><span class="line"><span class="cl">SCHED 4010ms: <span class="nv">gomaxprocs</span><span class="o">=</span><span class="m">4</span> <span class="nv">idleprocs</span><span class="o">=</span><span class="m">0</span> <span class="nv">threads</span><span class="o">=</span><span class="m">26</span> <span class="nv">spinningthreads</span><span class="o">=</span><span class="m">0</span> <span class="nv">idlethreads</span><span class="o">=</span><span class="m">20</span> <span class="nv">runqueue</span><span class="o">=</span><span class="m">12</span> <span class="o">[</span><span class="m">6</span> <span class="m">3</span> <span class="m">1</span> 0<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>GODEBUG 通过给其传入不同的key1=value1, key2=value2, …组合，Go的运行时会输出不同的调试信息，比如在这里我们给GODEBUG传入了&quot;schedtrace=1000&quot;，其含义就是每1000ms打印输出一次goroutine调度器的状态，每次一行。以上面例子中最后一行为例，每一行各字段含义如下：</p>
<ol>
<li>SCHED：调试信息输出标志字符串，代表本行是goroutine调度器相关信息的输出。</li>
<li>6016ms：从程序启动到输出这行日志经过的时间。</li>
<li>gomaxprocs：P的数量。</li>
<li>idleprocs：处于空闲状态的P的数量。通过gomaxprocs和idleprocs的差值，我们就可以知道当前正在执行Go代码的P的数量。</li>
<li>threads：操作系统线程的数量，包含调度器使用的M数量，加上运行时自用的类似sysmon这样的线程的数量。</li>
<li>spinningthreads：处于自旋（spin）状态的操作系统数量。</li>
<li>idlethread：处于空闲状态的操作系统线程的数量。</li>
<li>runqueue=1：Go调度器全局运行队列中G的数量。</li>
<li>[3 4 0 10]：分别为4个P的本地运行队列中的G的数量。</li>
</ol>
<p>还可以输出每个goroutine、M和P的详细调度信息（对于Gopher来说，在大多数情况下这是不必要的）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nv">GODEBUG</span><span class="o">=</span><span class="nv">schedtrace</span><span class="o">=</span>1000,scheddetail<span class="o">=</span><span class="m">1</span> godoc -http<span class="o">=</span>:6060
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="54-godebugasyncpreemptoff1">5.4 GODEBUG=asyncpreemptoff=1</h3>
<p>Go长期以来不支持真正的抢占式调度，下面的代码是一个典型例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">deadloop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">runtime</span><span class="p">.</span><span class="nf">GOMAXPROCS</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="nf">deadloop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;I got scheduled!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在只有一个P（GOMAXPROCS=1）的情况下，上面代码中deadloop函数所在的goroutine将持续占据该P，使得main goroutine中的代码得不到调度，我们无法看到“I got scheduled!”字样输出。这是因为<strong>Go 1.13及以前版本的抢占是协作式的，只在有函数调用的地方才能插入抢占代码（埋点）</strong>，而deadloop没有给编译器插入抢占代码的机会。Go 1.14版本增加了基于系统信号的异步抢占调度，这样上面的deadloop所在的goroutine也可以被抢占了。</p>
<p>由于系统信号可能在代码执行到任意地方发生，在Go运行时能顾及的地方，Go运行时自然会处理好这些系统信号。<strong>但如果你是通过syscall包或golang.org/x/sys/unix在Unix/Linux/macOS上直接进行系统调用，那么一旦在系统调用执行过程中进程收到系统中断信号，这些系统调用就会失败，并以EINTR错误返回，尤其是低速系统调用，包括读写特定类型文件（管道、终端设备、网络设备）、进程间通信等。在这样的情况下，我们就需要自己处理EINTR错误。最常见的错误处理方式是重试。对于可重入的系统调用来说，在收到EINTR信号后的重试是安全的。如果你没有自己调用syscall包，那么异步抢占调度对你已有的代码几乎无影响</strong>。</p>
<p>相反，当异步抢占调度对你的代码有影响，并且你还没法及时修正时，可以通过GODEBUG= asyncpreemptoff=1关闭这一新增的特性。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="err">$</span><span class="nx">GODEBUG</span><span class="p">=</span><span class="nx">asyncpreemptoff</span><span class="p">=</span><span class="mi">1</span> <span class="k">go</span> <span class="nx">run</span> <span class="nx">preemption_scheduler</span><span class="p">.</span><span class="k">go</span> <span class="c1">// 这里不会输出I got scheduled!
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>随着Go的演进，GODEBUG的取值还在增加和变化中，其最新更新可参见<a href="https://tip.golang.org/pkg/runtime/#hdr-Environment_Variables" target="_blank" rel="noopener noreffer">GODEBUG 取值</a>。</p>
<h2 id="6-go-vet">6. go vet</h2>
<p>go vet是官方Go工具链提供的静态代码检查工具，相比于编译器关注语法层面的正确性，go vet 在语义层面尝试发现潜在问题。</p>
<p>go vet 内置了多条静态代码检查规则:</p>
<ol>
<li>assign规则：检查代码中是否有无用的赋值操作m，比如 x = x</li>
<li>atomic规则：检查代码中是否有对sync.atomic包中函数的误用情况</li>
<li>bools规则：检查代码中是否存在对布尔操作符的误用情况</li>
<li>buildtag规则：检查源文件中+build tag是否正确定义</li>
<li>composites规则：检查源文件中是否有未使用“field:value”格式的复合字面值形式对struct类型变量进行值构造的问题</li>
<li>copylocks规则：检查源文件中是否存在lock类型变量的按值传递问题</li>
<li>loopclosure规则：检查源文件中是否存在循环内的匿名函数引用循环变量的问题。</li>
<li>unmarshal规则：检查源码中是否有将非指针或非接口类型值传给unmarshal的问题</li>
<li>unsafeptr规则：检查源码中是否有非法将uintptr转换为unsafe.Pointer的问题</li>
</ol>
<p>可以通过<code>go tool vet help</code>查看更多检查规则。默认情况下，go vet内置的所有检查规则均开启：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># go tool vet help</span>
</span></span><span class="line"><span class="cl">vet is a tool <span class="k">for</span> static analysis of Go programs.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">vet examines Go <span class="nb">source</span> code and reports suspicious constructs,
</span></span><span class="line"><span class="cl">such as Printf calls whose arguments <span class="k">do</span> not align with the format
</span></span><span class="line"><span class="cl">string. It uses heuristics that <span class="k">do</span> not guarantee all reports are
</span></span><span class="line"><span class="cl">genuine problems, but it can find errors not caught by the compilers.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Registered analyzers:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    asmdecl      report mismatches between assembly files and Go declarations
</span></span><span class="line"><span class="cl">    assign       check <span class="k">for</span> useless assignments
</span></span><span class="line"><span class="cl">    atomic       check <span class="k">for</span> common mistakes using the sync/atomic package
</span></span><span class="line"><span class="cl">    bools        check <span class="k">for</span> common mistakes involving boolean operators
</span></span><span class="line"><span class="cl">    buildtag     check that +build tags are well-formed and correctly located
</span></span><span class="line"><span class="cl">    cgocall      detect some violations of the cgo pointer passing rules
</span></span><span class="line"><span class="cl">    composites   check <span class="k">for</span> unkeyed composite literals
</span></span><span class="line"><span class="cl">    copylocks    check <span class="k">for</span> locks erroneously passed by value
</span></span><span class="line"><span class="cl">    errorsas     report passing non-pointer or non-error values to errors.As
</span></span><span class="line"><span class="cl">    framepointer report assembly that clobbers the frame pointer before saving it
</span></span><span class="line"><span class="cl">    httpresponse check <span class="k">for</span> mistakes using HTTP responses
</span></span><span class="line"><span class="cl">    ifaceassert  detect impossible interface-to-interface <span class="nb">type</span> assertions
</span></span><span class="line"><span class="cl">    loopclosure  check references to loop variables from within nested functions
</span></span><span class="line"><span class="cl">    lostcancel   check cancel func returned by context.WithCancel is called
</span></span><span class="line"><span class="cl">    nilfunc      check <span class="k">for</span> useless comparisons between functions and nil
</span></span><span class="line"><span class="cl">    <span class="nb">printf</span>       check consistency of Printf format strings and arguments
</span></span><span class="line"><span class="cl">    <span class="nb">shift</span>        check <span class="k">for</span> shifts that equal or exceed the width of the integer
</span></span><span class="line"><span class="cl">    sigchanyzer  check <span class="k">for</span> unbuffered channel of os.Signal
</span></span><span class="line"><span class="cl">    stdmethods   check signature of methods of well-known interfaces
</span></span><span class="line"><span class="cl">    stringintconv check <span class="k">for</span> string<span class="o">(</span>int<span class="o">)</span> conversions
</span></span><span class="line"><span class="cl">    structtag    check that struct field tags conform to reflect.StructTag.Get
</span></span><span class="line"><span class="cl">    testinggoroutine report calls to <span class="o">(</span>*testing.T<span class="o">)</span>.Fatal from goroutines started by a test.
</span></span><span class="line"><span class="cl">    tests        check <span class="k">for</span> common mistaken usages of tests and examples
</span></span><span class="line"><span class="cl">    unmarshal    report passing non-pointer or non-interface values to unmarshal
</span></span><span class="line"><span class="cl">    unreachable  check <span class="k">for</span> unreachable code
</span></span><span class="line"><span class="cl">    unsafeptr    check <span class="k">for</span> invalid conversions of uintptr to unsafe.Pointer
</span></span><span class="line"><span class="cl">    unusedresult check <span class="k">for</span> unused results of calls to some functions
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 手动关闭其中一个或几个规则</span>
</span></span><span class="line"><span class="cl"><span class="nv">$go</span> vet -printf<span class="o">=</span><span class="nb">false</span> -buildtag<span class="o">=</span><span class="nb">false</span> vet_printf.go
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 如果显式开启某些检查，则其他检查规则将不生效</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 仅开启 buildtag 检查，其他检查均不开启</span>
</span></span><span class="line"><span class="cl"><span class="nv">$go</span> vet -buildtag<span class="o">=</span><span class="nb">true</span> vet_printf.go
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="61-第三方linter聚合golangci-lint">6.1 第三方linter聚合：golangci-lint</h3>
<p>第三方lint工具是对官方go vet工具的一个很好的补充。golangci-lint聚合了几十种Go lint工具，但默认仅开启如下几种。</p>
<ol>
<li>deadcode：查找代码中的未用代码。</li>
<li>errcheck：检查代码中是否存在未处理的错误。</li>
<li>gosimple：专注于发现可以进一步简化的代码的lint工具。</li>
<li>govet：go官方工具链中的vet工具。</li>
<li>ineffassign：检查源码中是否存在无效赋值的情况（赋值了，但没有使用）。</li>
<li>staticcheck：通用型lint工具，增强的“go vet”，对代码进行很多go vet尚未进行的静态检查。</li>
<li>structcheck：查找未使用的结构体字段。</li>
<li>typecheck：像Go编译器前端那样去解析Go代码并进行类型检查。</li>
<li>unused：检查源码中是否存在未使用的常量、变量、函数和类型。</li>
<li>varcheck：检查源码中是否存在未使用的全局变量和常量。</li>
</ol>
<p>除了上述默认开启的lint工具，我们还可以通过golangci-lint linters命令查看所有内置lint工具列表，包括默认不开启的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 1. 安装</span>
</span></span><span class="line"><span class="cl">go install  github.com/golangci/golangci-lint/cmd/golangci-lint@latest
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 2. 开启或关闭特定检查</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 仅开启staticcheck</span>
</span></span><span class="line"><span class="cl"><span class="nv">$golangci</span>-lint linters --disable-all -E staticcheck
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 在默认开启的lint工具集合的基础上，再额外开启bodyclose和dupl</span>
</span></span><span class="line"><span class="cl"><span class="nv">$golangci</span>-lint linters -E bodyclose,dupl 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 关闭unused和varcheck</span>
</span></span><span class="line"><span class="cl"><span class="nv">$golangci</span>-lint linters -D unused,varcheck
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 3. 执行检查</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 仅对当前目录下的vet_assign.go源文件进行staticcheck检查</span>
</span></span><span class="line"><span class="cl"><span class="nv">$golangci</span>-lint run --disable-all -E staticcheck vet_assign.go
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 对当前路径下的Go包进行默认lint工具集合的检查</span>
</span></span><span class="line"><span class="cl"><span class="nv">$golangci</span>-lint run
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 对当前路径及其子路径（递归）下的所有Go包进行默认开启的lint工具集合检查以及额外的dupl工具检查</span>
</span></span><span class="line"><span class="cl"><span class="nv">$golangci</span>-lint run -E dupl ./...
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="7-重构">7. 重构</h2>
<h2 id="8-go-doc">8. go doc</h2>
<h3 id="81-go-doc-命令">8.1 go doc 命令</h3>
<p>go doc在命令行上接受的参数使用了Go语法的格式:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">go</span> <span class="nx">doc</span> <span class="p">&lt;</span><span class="nx">pkg</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">go</span> <span class="nx">doc</span> <span class="p">&lt;</span><span class="nx">sym</span><span class="p">&gt;[.&lt;</span><span class="nx">methodOrField</span><span class="p">&gt;]</span>
</span></span><span class="line"><span class="cl"><span class="k">go</span> <span class="nx">doc</span> <span class="p">[&lt;</span><span class="nx">pkg</span><span class="p">&gt;.]&lt;</span><span class="nx">sym</span><span class="p">&gt;[.&lt;</span><span class="nx">methodOrField</span><span class="p">&gt;]</span>
</span></span><span class="line"><span class="cl"><span class="k">go</span> <span class="nx">doc</span> <span class="p">[&lt;</span><span class="nx">pkg</span><span class="p">&gt;.][&lt;</span><span class="nx">sym</span><span class="p">&gt;.]&lt;</span><span class="nx">methodOrField</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 查看标准库文档
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">go</span> <span class="nx">doc</span> <span class="nx">net</span><span class="o">/</span><span class="nx">http</span>
</span></span><span class="line"><span class="cl"><span class="k">go</span> <span class="nx">doc</span> <span class="nx">net</span><span class="o">/</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Form</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 查看当前路径下的包的文档：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">$</span><span class="k">go</span> <span class="nx">doc</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 查看当前路径下包的导出元素的文档：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">$</span><span class="k">go</span> <span class="nx">doc</span> <span class="nx">CmppActiveTestReqPktLen</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 通过-u选项，我们也可以查看当前路径下包的非导出元素的文档：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">$</span><span class="k">go</span> <span class="nx">doc</span> <span class="o">-</span><span class="nx">u</span> <span class="nx">newPacketWriter</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 查看源码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">go</span> <span class="nx">doc</span> <span class="o">-</span><span class="nx">src</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="61-godoc-的web化的文档中心">6.1 godoc 的Web化的文档中心</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 查看当前版本文档
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">$</span><span class="nx">godoc</span> <span class="o">-</span><span class="nx">http</span><span class="p">=</span><span class="nx">localhost</span><span class="p">:</span><span class="mi">6060</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 查看旧版本 go 文档
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">$</span><span class="nx">godoc</span> <span class="o">-</span><span class="nx">goroot</span> <span class="o">/</span><span class="nx">Users</span><span class="o">/</span><span class="nx">tonybai</span><span class="o">/</span><span class="p">.</span><span class="nx">bin</span><span class="o">/</span><span class="nx">go1</span><span class="mf">.9</span> <span class="o">-</span><span class="nx">http</span><span class="p">=</span><span class="nx">localhost</span><span class="p">:</span><span class="mi">6060</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="83-查看-go-官方博客">8.3 查看 go 官方博客</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="err">$</span><span class="k">go</span> <span class="nx">get</span> <span class="nx">golang</span><span class="p">.</span><span class="nx">org</span><span class="o">/</span><span class="nx">x</span><span class="o">/</span><span class="nx">blog</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Go官方博客单独存放在github.com/golang/blog仓库下，需要先将该仓库下载到本地，再切换到该路径下来启动blog服务程序
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">$</span><span class="nx">git</span> <span class="nx">clone</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//github.com/golang/blog.git
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">$</span><span class="nx">cd</span> <span class="nx">blog</span>
</span></span><span class="line"><span class="cl"><span class="err">$</span><span class="nx">blog</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">2020</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">31</span> <span class="mo">05</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">47</span> <span class="nx">Listening</span> <span class="nx">on</span> <span class="nx">addr</span> <span class="nx">localhost</span><span class="p">:</span><span class="mi">8080</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="84-查看present格式文档">8.4 查看present格式文档</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">go</span> <span class="nx">get</span> <span class="nx">golang</span><span class="p">.</span><span class="nx">org</span><span class="o">/</span><span class="nx">x</span><span class="o">/</span><span class="nx">tools</span><span class="o">/</span><span class="nx">cmd</span><span class="o">/</span><span class="nx">present</span>
</span></span><span class="line"><span class="cl"><span class="err">$</span><span class="nx">git</span> <span class="nx">clone</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//github.com/golang/talks.git
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">$</span><span class="nx">cd</span> <span class="nx">talks</span>
</span></span><span class="line"><span class="cl"><span class="err">$</span><span class="nx">present</span>
</span></span></code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2023-02-23&nbsp;<a class="git-hash" href="https://github.com/dillonzq/LoveIt/commit/df195bc1b2efd86375c32da16436d7c1a654dbbe" target="_blank" title="commit by tao(tao@example.com) df195bc1b2efd86375c32da16436d7c1a654dbbe: go 底层实现开篇">
                                    <i class="fas fa-hashtag fa-fw"></i>df195bc</a></span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/posts/program/go/expert/go_export/expert_27/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://hotttao.github.io/posts/program/go/expert/go_export/expert_27/" data-title="Go 常用工具" data-hashtags="go 进阶"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://hotttao.github.io/posts/program/go/expert/go_export/expert_27/" data-hashtag="go 进阶"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://hotttao.github.io/posts/program/go/expert/go_export/expert_27/" data-title="Go 常用工具"><i class="fab fa-hacker-news fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://hotttao.github.io/posts/program/go/expert/go_export/expert_27/" data-title="Go 常用工具"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://hotttao.github.io/posts/program/go/expert/go_export/expert_27/" data-title="Go 常用工具" data-ralateuid="xxxx"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/go-%E8%BF%9B%E9%98%B6/">go 进阶</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/program/go/expert/go_export/expert_19/" class="prev" rel="prev" title="Go cgo"><i class="fas fa-angle-left fa-fw"></i>Go cgo</a>
            <a href="/posts/program/go/expert/go_export/expert_26/" class="next" rel="next" title="Go generate">Go generate<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.111.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">宋涛</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.8/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":30},"comment":{"gitalk":{"admin":["hotttao"],"clientID":"7b48df1b81d23057c798","clientSecret":"65c6f9e6ca6ae4d8105f757578b6b594e3668e61","id":"2023-01-12T22:00:00+08:00","owner":"hotttao","repo":"hotttao.github.io","title":"Go 常用工具"}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
