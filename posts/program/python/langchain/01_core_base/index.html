<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>langchain-core æ ¸å¿ƒå¯¹è±¡ - LoveIt</title><meta name="Description" content="langchain çš„æ ¸å¿ƒæŠ½è±¡"><meta property="og:title" content="langchain-core æ ¸å¿ƒå¯¹è±¡" />
<meta property="og:description" content="langchain çš„æ ¸å¿ƒæŠ½è±¡" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hotttao.github.io/posts/program/python/langchain/01_core_base/" /><meta property="og:image" content="https://hotttao.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-07-20T22:00:00+08:00" />
<meta property="article:modified_time" content="2025-07-25T00:08:49+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://hotttao.github.io/logo.png"/>

<meta name="twitter:title" content="langchain-core æ ¸å¿ƒå¯¹è±¡"/>
<meta name="twitter:description" content="langchain çš„æ ¸å¿ƒæŠ½è±¡"/>
<meta name="application-name" content="å®‹æ¶›çš„ä¸ªäººåšå®¢">
<meta name="apple-mobile-web-app-title" content="å®‹æ¶›çš„ä¸ªäººåšå®¢"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://hotttao.github.io/posts/program/python/langchain/01_core_base/" /><link rel="prev" href="https://hotttao.github.io/posts/program/java/grammar/01_vars/" /><link rel="next" href="https://hotttao.github.io/posts/program/python/langchain/02_context_config/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "langchain-core æ ¸å¿ƒå¯¹è±¡",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/hotttao.github.io\/posts\/program\/python\/langchain\/01_core_base\/"
        },"image": ["https:\/\/hotttao.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "langchain æºç ","wordcount":  4391 ,
        "url": "https:\/\/hotttao.github.io\/posts\/program\/python\/langchain\/01_core_base\/","datePublished": "2025-07-20T22:00:00+08:00","dateModified": "2025-07-25T00:08:49+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": {
                    "@type": "ImageObject",
                    "url": "https:\/\/hotttao.github.io\/images\/hugo\/avatar.png",
                    "width":  528 ,
                    "height":  560 
                }},"author": {
                "@type": "Person",
                "name": "å®‹æ¶›"
            },"description": "langchain çš„æ ¸å¿ƒæŠ½è±¡"
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="LoveIt"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>å®‹æ¶›çš„åšå®¢</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> æ‰€æœ‰æ–‡ç«  </a><a class="menu-item" href="/tags/"> æ ‡ç­¾ </a><a class="menu-item" href="/categories/"> åˆ†ç±» </a><a class="menu-item" href="/categories/go/"> Go </a><a class="menu-item" href="/categories/linux/"> Linux </a><a class="menu-item" href="/categories/distributed/"> åˆ†å¸ƒå¼ </a><a class="menu-item" href="/categories/distributed/"> æ¶æ„ </a><a class="menu-item" href="/posts/about/"> å…³äº </a><a class="menu-item" href="https://github.com/hotttao/" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="æœç´¢">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="LoveIt"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>å®‹æ¶›çš„åšå®¢</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="æœç´¢">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        å–æ¶ˆ
                    </a>
                </div><a class="menu-item" href="/posts/" title="">æ‰€æœ‰æ–‡ç« </a><a class="menu-item" href="/tags/" title="">æ ‡ç­¾</a><a class="menu-item" href="/categories/" title="">åˆ†ç±»</a><a class="menu-item" href="/categories/go/" title="">Go</a><a class="menu-item" href="/categories/linux/" title="">Linux</a><a class="menu-item" href="/categories/distributed/" title="">åˆ†å¸ƒå¼</a><a class="menu-item" href="/categories/distributed/" title="">æ¶æ„</a><a class="menu-item" href="/posts/about/" title="">å…³äº</a><a class="menu-item" href="https://github.com/hotttao/" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">ç›®å½•</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">langchain-core æ ¸å¿ƒå¯¹è±¡</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://hotttao.github.io/" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>å®‹æ¶›</a></span>&nbsp;<span class="post-category">æ”¶å½•äº <a href="/categories/langchain/"><i class="far fa-folder fa-fw"></i>langchain</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2025-07-20">2025-07-20</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;çº¦ 4391 å­—&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;é¢„è®¡é˜…è¯» 9 åˆ†é’Ÿ&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>ç›®å½•</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-langchain-ä»£ç ç»“æ„">1. langchain ä»£ç ç»“æ„</a>
      <ul>
        <li><a href="#11-runnables">1.1 runnables</a></li>
        <li><a href="#12-callbacks">1.2 callbacks</a></li>
        <li><a href="#13-tracer">1.3 tracer</a></li>
        <li><a href="#14-messages">1.4 messages</a></li>
        <li><a href="#15-prompts">1.5 prompts</a></li>
        <li><a href="#16-vectorstores">1.6 vectorstores</a></li>
        <li><a href="#17-æ€»ç»“">1.7 æ€»ç»“</a></li>
      </ul>
    </li>
    <li><a href="#2-lcel-çš„ç®€åŒ–å®ç°">2. LCEL çš„ç®€åŒ–å®ç°</a>
      <ul>
        <li><a href="#21-ç®€åŒ–ç‰ˆ-lcel-æ ¸å¿ƒç»„ä»¶">2.1ğŸ§© ç®€åŒ–ç‰ˆ LCEL æ ¸å¿ƒç»„ä»¶</a>
          <ul>
            <li><a href="#runnable-å¯è¿è¡Œå¯¹è±¡çš„æŠ½è±¡"><code>Runnable</code>: å¯è¿è¡Œå¯¹è±¡çš„æŠ½è±¡</a></li>
            <li><a href="#runnableconfig-æ§åˆ¶è¿è¡Œçš„é…ç½®å¯¹è±¡"><code>RunnableConfig</code>: æ§åˆ¶è¿è¡Œçš„é…ç½®å¯¹è±¡</a></li>
            <li><a href="#basecallbackhandler-å›è°ƒé’©å­å®šä¹‰"><code>BaseCallbackHandler</code>: å›è°ƒé’©å­å®šä¹‰</a></li>
            <li><a href="#basecallbackmanager-ç®¡ç†å¤šä¸ª-callbackhandler"><code>BaseCallbackManager</code>: ç®¡ç†å¤šä¸ª CallbackHandler</a></li>
            <li><a href="#baserunmanager-ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨"><code>BaseRunManager</code>: ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨</a></li>
          </ul>
        </li>
        <li><a href="#22--ç¤ºä¾‹å®ç°ä¸€ä¸ªç®€å•çš„-echorunnable">2.2 âœ… ç¤ºä¾‹ï¼šå®ç°ä¸€ä¸ªç®€å•çš„ EchoRunnable</a></li>
        <li><a href="#23-è¿½é—®">2.3 è¿½é—®</a>
          <ul>
            <li><a href="#-1-å®šä¹‰-lcel-event-å¯¹è±¡">âœ… 1. å®šä¹‰ LCEL Event å¯¹è±¡</a></li>
            <li><a href="#-2-æ”¹é€ -basecallbackhandler-æ”¯æŒäº‹ä»¶é’©å­">âœ… 2. æ”¹é€  <code>BaseCallbackHandler</code> æ”¯æŒäº‹ä»¶é’©å­</a></li>
            <li><a href="#-3-æ”¹é€ -baserunmanager-è§¦å‘äº‹ä»¶æœºåˆ¶">âœ… 3. æ”¹é€  <code>BaseRunManager</code> è§¦å‘äº‹ä»¶æœºåˆ¶</a></li>
            <li><a href="#-4-æ”¯æŒç»„åˆç»“æ„runnablesequence">âœ… 4. æ”¯æŒç»„åˆç»“æ„ï¼š<code>RunnableSequence</code></a></li>
            <li><a href="#-5-æ”¯æŒåŠ¨æ€è¡¨è¾¾å¼runnablelambda">âœ… 5. æ”¯æŒåŠ¨æ€è¡¨è¾¾å¼ï¼š<code>RunnableLambda</code></a></li>
            <li><a href="#-6-ç¤ºä¾‹-callbackhandlerç›‘å¬äº‹ä»¶">âœ… 6. ç¤ºä¾‹ CallbackHandlerï¼šç›‘å¬äº‹ä»¶</a></li>
            <li><a href="#-7-ç»„åˆè°ƒç”¨ç¤ºä¾‹å®Œæ•´é“¾">âœ… 7. ç»„åˆè°ƒç”¨ç¤ºä¾‹ï¼ˆå®Œæ•´é“¾ï¼‰</a></li>
          </ul>
        </li>
        <li><a href="#24-è¡¥å……æé—®">2.4 è¡¥å……æé—®</a>
          <ul>
            <li><a href="#-æ­£ç¡®ç†è§£-lcel-ä¸­äº‹ä»¶è§¦å‘æœºåˆ¶">ğŸ” æ­£ç¡®ç†è§£ LCEL ä¸­äº‹ä»¶è§¦å‘æœºåˆ¶</a></li>
            <li><a href="#-customrunnable">ğŸ§© <code>CustomRunnable</code></a></li>
            <li><a href="#-ç®€å•çš„é“¾ç»„åˆç±»runnablesequence">âœ… ç®€å•çš„é“¾ç»„åˆç±»ï¼š<code>RunnableSequence</code></a></li>
            <li><a href="#-å®Œæ•´è¿è¡Œç¤ºä¾‹ä¸å†ä½¿ç”¨-runnablelambda">âœ… å®Œæ•´è¿è¡Œç¤ºä¾‹ï¼ˆä¸å†ä½¿ç”¨ RunnableLambdaï¼‰</a></li>
          </ul>
        </li>
        <li><a href="#25-æ€»ç»“">2.5 æ€»ç»“</a></li>
      </ul>
    </li>
    <li><a href="#3-runnable-æºç æ¡†æ¶">3. runnable æºç æ¡†æ¶</a>
      <ul>
        <li><a href="#31-runnable-ç±»">3.1 Runnable ç±»</a></li>
        <li><a href="#32-runnablesequence">3.2 RunnableSequence</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>æœ¬å‘¨å¼€å§‹å­¦ä¹  langchainï¼Œå¤§çº¦ç»å†äº†å¦‚ä¸‹çš„è¿‡ç¨‹:</p>
<ol>
<li>ç®€å•é˜…è¯»äº† langchain æ–‡æ¡£ï¼Œå­¦ä¹ äº† LCELï¼ŒLCEL çš„åŸºæœ¬æ¥å£æ˜¯ Runnable</li>
<li>è¯»åˆ° astream_log æ–¹æ³•æ—¶å€™ï¼Œæ„Ÿè§‰æ¨¡æ£±ä¸¤å¯ï¼Œçœ‹ langchain-core çš„ä»£ç </li>
<li>çœ‹åˆ° RunnableSequence invoke æ–¹æ³•æ—¶ï¼Œé‡Œé¢æ¶‰åŠçš„å¯¹è±¡é€æ¸å˜å¤šï¼Œå¼€å§‹æœ‰ç‚¹è¿·å¤±åœ¨ä»£ç ç»†èŠ‚ï¼Œæ— æ³•æŒæ¡æ•´ä½“çš„è°ƒç”¨æµç¨‹</li>
<li>ä½¿ç”¨ pycharm Diagrams æŸ¥çœ‹äº†ä¸é€šæ¨¡å—æ ¸å¿ƒç±»çš„ç»§æ‰¿å…³ç³»</li>
</ol>
<p>ä¸‹é¢æ˜¯ langchain-core æ ¸å¿ƒç»“æ„è®°å½•ã€‚æŸ¥çœ‹ç±»ç»§æ‰¿å…³ç³»æ—¶ï¼Œç”¨è¿‡ pyreverseã€pyan3 éƒ½ä¸å¤ªå¥½ç”¨ï¼Œpyreverse æ— æ³•è§£ææ³›å‹ï¼Œpyan3 ä¸€ç›´æŠ¥é”™ï¼Œè¿™é‡Œåšä¸€ä¸‹è®°å½•ã€‚</p>
<h2 id="1-langchain-ä»£ç ç»“æ„">1. langchain ä»£ç ç»“æ„</h2>
<p>langchain-core åŒ…å«å¦‚ä¸‹å‡ ä¸ªæ¨¡å—ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">tree -L <span class="m">1</span> -d  langchain_core/
</span></span><span class="line"><span class="cl">langchain_core/
</span></span><span class="line"><span class="cl">â”œâ”€â”€ _api
</span></span><span class="line"><span class="cl">â”œâ”€â”€ beta
</span></span><span class="line"><span class="cl">â”œâ”€â”€ callbacks
</span></span><span class="line"><span class="cl">â”œâ”€â”€ document_loaders
</span></span><span class="line"><span class="cl">â”œâ”€â”€ documents
</span></span><span class="line"><span class="cl">â”œâ”€â”€ embeddings
</span></span><span class="line"><span class="cl">â”œâ”€â”€ example_selectors
</span></span><span class="line"><span class="cl">â”œâ”€â”€ indexing
</span></span><span class="line"><span class="cl">â”œâ”€â”€ language_models
</span></span><span class="line"><span class="cl">â”œâ”€â”€ load
</span></span><span class="line"><span class="cl">â”œâ”€â”€ messages
</span></span><span class="line"><span class="cl">â”œâ”€â”€ output_parsers
</span></span><span class="line"><span class="cl">â”œâ”€â”€ outputs
</span></span><span class="line"><span class="cl">â”œâ”€â”€ prompts
</span></span><span class="line"><span class="cl">â”œâ”€â”€ pydantic_v1
</span></span><span class="line"><span class="cl">â”œâ”€â”€ runnables
</span></span><span class="line"><span class="cl">â”œâ”€â”€ tools
</span></span><span class="line"><span class="cl">â”œâ”€â”€ tracers
</span></span><span class="line"><span class="cl">â”œâ”€â”€ utils
</span></span><span class="line"><span class="cl">â””â”€â”€ vectorstores
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="11-runnables">1.1 runnables</h3>
<p>Runnable å®šä¹‰åœ¨ runnables æ¨¡å—ï¼Œæ˜¯ langchain æ ¸å¿ƒçš„æŠ½è±¡ç±»ã€‚</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/langchain/runnable-all.svg"
        data-srcset="/images/langchain/runnable-all.svg, /images/langchain/runnable-all.svg 1.5x, /images/langchain/runnable-all.svg 2x"
        data-sizes="auto"
        alt="/images/langchain/runnable-all.svg"
        title="runnables ç±»å›¾" /></p>
<p>å¯ä»¥çœ‹åˆ°:</p>
<ol>
<li>Runnable æ˜¯æœ€åŸºç¡€çš„æŠ½è±¡ç±»ï¼Œä½†æ˜¯å¤§å¤šæ•°å¯¹è±¡éƒ½æ˜¯ç»§æ‰¿è‡ª RunnableSerializable</li>
<li>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ª RunnableConfig ç±»ã€‚è™½ç„¶ç±»å›¾ä¸­æ²¡æœ‰æ˜¾ç¤ºï¼Œä½†æ˜¯è¿™ä¸ªå¯¹è±¡ä¹Ÿå¾ˆé‡è¦ï¼ŒRunnableConfig ç”¨äºåœ¨æ•´ä¸ª LCEL ä¸­ä¼ é€’é…ç½®å’Œå‚æ•°ã€‚</li>
</ol>
<p>å…·ä½“æ¯ä¸ªç±»æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œæˆ‘ä»¬å…ˆæ”¾ä¸€æ”¾ï¼Œåé¢å†è¯¦ç»†ä»‹ç»ã€‚</p>
<h3 id="12-callbacks">1.2 callbacks</h3>
<p>callbacks ç±»å›¾å¦‚ä¸‹ï¼Œç±»éå¸¸å¤šï¼Œçœ‹èµ·æ¥ä¹Ÿæ¯”è¾ƒæ··ä¹±ã€‚
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/langchain/callbacks-all.svg"
        data-srcset="/images/langchain/callbacks-all.svg, /images/langchain/callbacks-all.svg 1.5x, /images/langchain/callbacks-all.svg 2x"
        data-sizes="auto"
        alt="/images/langchain/callbacks-all.svg"
        title="callback ç±»å›¾" /></p>
<p>ç®€å•æµè§ˆä¸€ä¸‹ä»£ç ï¼Œcallbacks çš„å®ç°ç”¨æœ‰è®¸å¤š Mixin æ··åˆç±»ï¼Œè¿™äº›ç±»çš„ç›®çš„æ˜¯æä¾›ä¸€äº›æ–¹æ³•çš„é»˜è®¤å®ç°ã€‚æŠŠè¿™äº›ç±»åˆ é™¤ä¹‹åï¼Œå¾—åˆ°å¦‚ä¸‹çš„ç±»å›¾:
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/langchain/callbacks.svg"
        data-srcset="/images/langchain/callbacks.svg, /images/langchain/callbacks.svg 1.5x, /images/langchain/callbacks.svg 2x"
        data-sizes="auto"
        alt="/images/langchain/callbacks.svg"
        title="callback ç®€åŒ–ç±»å›¾" /></p>
<p>å¯ä»¥çœ‹åˆ° callbacks æä¾›äº†ä¸‰ä¸ªæ ¸å¿ƒçš„åŸºç¡€æŠ½è±¡:</p>
<ol>
<li>BaseCallbackHandler</li>
<li>BaseCallbackManager</li>
<li>BaseRunManager</li>
</ol>
<h3 id="13-tracer">1.3 tracer</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/langchain/tracer.svg"
        data-srcset="/images/langchain/tracer.svg, /images/langchain/tracer.svg 1.5x, /images/langchain/tracer.svg 2x"
        data-sizes="auto"
        alt="/images/langchain/tracer.svg"
        title="tracer ç±»å›¾" /></p>
<p>tracer æ¨¡å—ä¸­çš„ç±»ä¹Ÿå¾ˆå¤šã€‚ä½†æ˜¯å¯ä»¥çœ‹åˆ°:</p>
<ol>
<li>æ‰€æœ‰çš„ tracer ç±»éƒ½ç»§æ‰¿è‡ª callbacks çš„ BaseCallbackHandler</li>
<li>_TracerCore å’Œ BaseModelV1 åº”è¯¥æ˜¯ä¸ºç›‘æ§æ‰€åšçš„åŸºæœ¬æŠ½è±¡ï¼Œè¿™ä¸ªå¯¹æˆ‘ä»¬ç†è§£çœŸä¸ª LCEL æ¥è¯´æš‚æ—¶ä¸é‡è¦ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¿½ç•¥ã€‚</li>
</ol>
<h3 id="14-messages">1.4 messages</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/langchain/messages.svg"
        data-srcset="/images/langchain/messages.svg, /images/langchain/messages.svg 1.5x, /images/langchain/messages.svg 2x"
        data-sizes="auto"
        alt="/images/langchain/messages.svg"
        title="messages ç±»å›¾" /></p>
<p>messages æ¨¡å—æä¾›äº†ä¸€ä¸ª BaseMessage çš„æŠ½è±¡ã€‚</p>
<h3 id="15-prompts">1.5 prompts</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/langchain/prompts.svg"
        data-srcset="/images/langchain/prompts.svg, /images/langchain/prompts.svg 1.5x, /images/langchain/prompts.svg 2x"
        data-sizes="auto"
        alt="/images/langchain/prompts.svg"
        title="prompts ç±»å›¾" /></p>
<p>prompts æ¨¡å—æä¾›çš„æŠ½è±¡ç»§æ‰¿è‡ª runnables.RunnableSerializable</p>
<h3 id="16-vectorstores">1.6 vectorstores</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/langchain/vectorstores.svg"
        data-srcset="/images/langchain/vectorstores.svg, /images/langchain/vectorstores.svg 1.5x, /images/langchain/vectorstores.svg 2x"
        data-sizes="auto"
        alt="/images/langchain/vectorstores.svg"
        title="vectorstores ç±»å›¾" /></p>
<p>vectorstores æ¨¡å—æä¾›çš„BaseRetriever æŠ½è±¡ä¹Ÿç»§æ‰¿è‡ª runnables.RunnableSerializableã€‚</p>
<h3 id="17-æ€»ç»“">1.7 æ€»ç»“</h3>
<p>åˆ°è¿™é‡Œè™½ç„¶æˆ‘ä»¬è¿˜ä¸çŸ¥é“ä¸Šé¢è¿™äº›ç±»æ˜¯åšä»€ä¹ˆçš„ï¼Œä½†æ˜¯æˆ‘ä»¬å·²ç»å¯ä»¥ç†è§£ langchain æ–‡æ¡£æ‰€è¯´çš„ &ldquo;Runnable åè®®å·²ä¸ºå¤§å¤šæ•°ç»„ä»¶å®ç°&rdquo;ã€‚è€Œä¸”æˆ‘ä»¬ä¹ŸçŸ¥é“åœ¨ langchain-core çš„æŠ½è±¡ä¸­ï¼Œæœ‰ä»¥ä¸‹æ ¸å¿ƒçš„å¯¹è±¡:</p>
<ol>
<li>Runnable</li>
<li>RunnableConfig</li>
<li>BaseCallbackHandler</li>
<li>BaseCallbackManager</li>
<li>BaseRunManager</li>
</ol>
<h2 id="2-lcel-çš„ç®€åŒ–å®ç°">2. LCEL çš„ç®€åŒ–å®ç°</h2>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å€ŸåŠ©å¤§æ¨¡å‹çš„èƒ½åŠ›ï¼Œæ¥å®ç°ä¸€ä¸ªç®€å•çš„ LCEL åº”ç”¨ï¼Œæ¥å¸®åŠ©æˆ‘ä»¬ç†è§£ LCEL çš„å®ç°åŸç†ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">æé—®:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">æˆ‘æ˜¯ä¸€ä¸ªåç«¯å¼€å‘å·¥ç¨‹å¸ˆï¼Œæˆ‘æ­£åœ¨é˜…è¯»langchain çš„æºç ï¼Œæˆ‘ä¸å¤ªæ¸…æ¥š langchain LCEL å®ç°çš„åŸç†ã€‚è¯·ä½ å®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬çš„  LCEL çš„ python å®ç°ã€‚è®²æ¸…æ¥šå¦‚ä¸‹å¯¹è±¡:
</span></span><span class="line"><span class="cl">1. Runnable
</span></span><span class="line"><span class="cl">2. RunnableConfig
</span></span><span class="line"><span class="cl">3. BaseCallbackHandler
</span></span><span class="line"><span class="cl">4. BaseCallbackManager
</span></span><span class="line"><span class="cl">5. BaseRunManager
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸‹é¢æ˜¯ ChatGpt ç»™æˆ‘çš„å›ç­”:</p>
<h3 id="21-ç®€åŒ–ç‰ˆ-lcel-æ ¸å¿ƒç»„ä»¶">2.1ğŸ§© ç®€åŒ–ç‰ˆ LCEL æ ¸å¿ƒç»„ä»¶</h3>
<h4 id="runnable-å¯è¿è¡Œå¯¹è±¡çš„æŠ½è±¡"><code>Runnable</code>: å¯è¿è¡Œå¯¹è±¡çš„æŠ½è±¡</h4>
<p>è¿™æ˜¯ LCEL çš„æ ¸å¿ƒæ¥å£ï¼Œå®šä¹‰äº†è°ƒç”¨æ¨¡å‹çš„è¡Œä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Runnable</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@abstractmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="s2">&#34;RunnableConfig&#34;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h4 id="runnableconfig-æ§åˆ¶è¿è¡Œçš„é…ç½®å¯¹è±¡"><code>RunnableConfig</code>: æ§åˆ¶è¿è¡Œçš„é…ç½®å¯¹è±¡</h4>
<p>å®ƒåœ¨ LCEL ä¸­ä½œä¸ºâ€œè°ƒç”¨ä¸Šä¸‹æ–‡â€ï¼Œæ§åˆ¶ callbackã€tagsã€metadata ç­‰ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RunnableConfig</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span> <span class="ow">or</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="n">callbacks</span> <span class="ow">or</span> <span class="p">[]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h4 id="basecallbackhandler-å›è°ƒé’©å­å®šä¹‰"><code>BaseCallbackHandler</code>: å›è°ƒé’©å­å®šä¹‰</h4>
<p>ç”¨äºåœ¨æ¯ä¸ªè°ƒç”¨è¿‡ç¨‹ä¸­æ’å…¥è‡ªå®šä¹‰é€»è¾‘ï¼ˆå¦‚æ—¥å¿—ã€é“¾è·¯è¿½è¸ªç­‰ï¼‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BaseCallbackHandler</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h4 id="basecallbackmanager-ç®¡ç†å¤šä¸ª-callbackhandler"><code>BaseCallbackManager</code>: ç®¡ç†å¤šä¸ª CallbackHandler</h4>
<p>ç”¨äºèšåˆå’Œè°ƒç”¨æ‰€æœ‰çš„å›è°ƒå¤„ç†å™¨ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BaseCallbackManager</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="n">handlers</span> <span class="ow">or</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">BaseCallbackHandler</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">h</span><span class="o">.</span><span class="n">on_start</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">h</span><span class="o">.</span><span class="n">on_end</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">h</span><span class="o">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h4 id="baserunmanager-ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨"><code>BaseRunManager</code>: ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨</h4>
<p>å®ƒåœ¨ <code>Runnable.invoke()</code> æ‰§è¡Œä¸­ç”Ÿæˆã€è·Ÿè¸ªå¹¶ç®¡ç†å›è°ƒç”Ÿå‘½å‘¨æœŸï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">uuid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BaseRunManager</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback_manager</span><span class="p">:</span> <span class="n">BaseCallbackManager</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">callback_manager</span> <span class="o">=</span> <span class="n">callback_manager</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">run_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">callback_manager</span><span class="o">.</span><span class="n">on_start</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">callback_manager</span><span class="o">.</span><span class="n">on_end</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">output</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">callback_manager</span><span class="o">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="22--ç¤ºä¾‹å®ç°ä¸€ä¸ªç®€å•çš„-echorunnable">2.2 âœ… ç¤ºä¾‹ï¼šå®ç°ä¸€ä¸ªç®€å•çš„ EchoRunnable</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">EchoRunnable</span><span class="p">(</span><span class="n">Runnable</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">RunnableConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">manager</span> <span class="o">=</span> <span class="n">BaseRunManager</span><span class="p">(</span><span class="n">BaseCallbackManager</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">callbacks</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;Echo: </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## âœ… ç¤ºä¾‹ï¼šè‡ªå®šä¹‰ CallbackHandler</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PrintCallbackHandler</span><span class="p">(</span><span class="n">BaseCallbackHandler</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">] Start with input: </span><span class="si">{</span><span class="nb">input</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">] End with output: </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">] Error: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## âœ… è¿è¡Œç¤ºä¾‹</span>
</span></span><span class="line"><span class="cl"><span class="n">handler</span> <span class="o">=</span> <span class="n">PrintCallbackHandler</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span> <span class="o">=</span> <span class="n">RunnableConfig</span><span class="p">(</span><span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">handler</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">runnable</span> <span class="o">=</span> <span class="n">EchoRunnable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">runnable</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&#34;Hello LCEL&#34;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># è¾“å‡ºï¼š</span>
</span></span><span class="line"><span class="cl"><span class="c1"># [&lt;uuid&gt;] Start with input: Hello LCEL</span>
</span></span><span class="line"><span class="cl"><span class="c1"># [&lt;uuid&gt;] End with output: Echo: Hello LCEL</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœä½ æƒ³æˆ‘ç»§ç»­å®ç° <code>RunnableSequence</code>ã€<code>RunnableLambda</code> ç­‰ç»„åˆå¼ç»“æ„ï¼ˆæ›´æ¥è¿‘ LCELï¼‰ï¼Œä¹Ÿå¯ä»¥å‘Šè¯‰æˆ‘ï¼Œæˆ‘æ¥å¸®ä½ æ‰©å±•ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ</p>
<h3 id="23-è¿½é—®">2.3 è¿½é—®</h3>
<p>ç°åœ¨çš„ AI çœŸæ˜¯å¤ªå¼ºå¤§äº†ï¼Œå›ç­”ç»“æŸè¿˜ç»™äº†æˆ‘ä»¬è¿›ä¸€æ­¥çš„æç¤ºã€‚æˆ‘ä»¬å¯ä»¥ç»§ç»­è¿½é—®ã€‚å› ä¸ºæˆ‘ä¹‹å‰å·²ç»ç®€å•çœ‹è¿‡ Runnable çš„æºç ï¼ŒçŸ¥é“ Runnable æœ‰ä¸€ä¸ª astream_events æ–¹æ³•ï¼Œç”¨äºå¼‚æ­¥æµå¼è¿”å›é“¾ä¸­å‘ç”Ÿçš„äº‹ä»¶ã€‚æˆ‘æƒ³äº†è§£ LCEL ä¸­äº‹ä»¶çš„è§¦å‘æµç¨‹ï¼Œæ‰€ä»¥è¿™ä¸€æ¬¡æˆ‘ä»¬åœ¨æé—®ä¸­åŠ ä¸Šæœ‰å…³ event çš„å†…å®¹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">æé—®: 
</span></span><span class="line"><span class="cl">ç»§ç»­ï¼Œè¯·åœ¨æ‰©å±•ä¸­åŒ…å« LCEL event çš„å†…å®¹ï¼Œæˆ‘æƒ³äº†è§£åˆ° event æ˜¯å¦‚ä½•è¢«å®šä¹‰ï¼Œè§¦å‘æ•è·çš„ã€‚
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="-1-å®šä¹‰-lcel-event-å¯¹è±¡">âœ… 1. å®šä¹‰ LCEL Event å¯¹è±¡</h4>
<p>LCEL ä¸­çš„äº‹ä»¶æ˜¯é€šè¿‡ callback handler æœºåˆ¶å‘å‡ºçš„ã€‚æˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸ªç®€å•çš„äº‹ä»¶ç³»ç»Ÿï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Event</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h4 id="-2-æ”¹é€ -basecallbackhandler-æ”¯æŒäº‹ä»¶é’©å­">âœ… 2. æ”¹é€  <code>BaseCallbackHandler</code> æ”¯æŒäº‹ä»¶é’©å­</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BaseCallbackHandler</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">):</span> <span class="k">pass</span>  <span class="c1"># æ–°å¢</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h4 id="-3-æ”¹é€ -baserunmanager-è§¦å‘äº‹ä»¶æœºåˆ¶">âœ… 3. æ”¹é€  <code>BaseRunManager</code> è§¦å‘äº‹ä»¶æœºåˆ¶</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BaseRunManager</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback_manager</span><span class="p">:</span> <span class="n">BaseCallbackManager</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">callback_manager</span> <span class="o">=</span> <span class="n">callback_manager</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">run_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">callback_manager</span><span class="o">.</span><span class="n">on_start</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># ğŸ‘‰ ä¸­é—´è‡ªå®šä¹‰äº‹ä»¶</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">callback_manager</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">Event</span><span class="p">(</span><span class="s2">&#34;custom_event_before&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&#34;input&#34;</span><span class="p">:</span> <span class="nb">input</span><span class="p">}))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">output</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">callback_manager</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">Event</span><span class="p">(</span><span class="s2">&#34;custom_event_after&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&#34;output&#34;</span><span class="p">:</span> <span class="n">output</span><span class="p">}))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">callback_manager</span><span class="o">.</span><span class="n">on_end</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">output</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">callback_manager</span><span class="o">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h4 id="-4-æ”¯æŒç»„åˆç»“æ„runnablesequence">âœ… 4. æ”¯æŒç»„åˆç»“æ„ï¼š<code>RunnableSequence</code></h4>
<p>å…è®¸ç»„åˆå¤šä¸ª <code>Runnable</code> é¡ºåºæ‰§è¡Œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RunnableSequence</span><span class="p">(</span><span class="n">Runnable</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span>  <span class="c1"># List[Runnable]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># RunnableConfig åœ¨ Runnable ä¹‹é—´è¿›è¡Œä¼ é€’</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">RunnableConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">current</span> <span class="o">=</span> <span class="nb">input</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">current</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">current</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h4 id="-5-æ”¯æŒåŠ¨æ€è¡¨è¾¾å¼runnablelambda">âœ… 5. æ”¯æŒåŠ¨æ€è¡¨è¾¾å¼ï¼š<code>RunnableLambda</code></h4>
<p>ç”¨äºåŒ…è£…ä¸€ä¸ªä»»æ„å‡½æ•°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RunnableLambda</span><span class="p">(</span><span class="n">Runnable</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">RunnableConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">manager</span> <span class="o">=</span> <span class="n">BaseRunManager</span><span class="p">(</span><span class="n">BaseCallbackManager</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">callbacks</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h4 id="-6-ç¤ºä¾‹-callbackhandlerç›‘å¬äº‹ä»¶">âœ… 6. ç¤ºä¾‹ CallbackHandlerï¼šç›‘å¬äº‹ä»¶</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PrintCallbackHandler</span><span class="p">(</span><span class="n">BaseCallbackHandler</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">] Start with input: </span><span class="si">{</span><span class="nb">input</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">] End with output: </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">] Error: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">] Event `</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">` triggered with: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h4 id="-7-ç»„åˆè°ƒç”¨ç¤ºä¾‹å®Œæ•´é“¾">âœ… 7. ç»„åˆè°ƒç”¨ç¤ºä¾‹ï¼ˆå®Œæ•´é“¾ï¼‰</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Step1: lowercase input</span>
</span></span><span class="line"><span class="cl"><span class="n">lowercase</span> <span class="o">=</span> <span class="n">RunnableLambda</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Step2: add prefix</span>
</span></span><span class="line"><span class="cl"><span class="n">add_prefix</span> <span class="o">=</span> <span class="n">RunnableLambda</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;Echo: </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Step3: sequence</span>
</span></span><span class="line"><span class="cl"><span class="n">pipeline</span> <span class="o">=</span> <span class="n">RunnableSequence</span><span class="p">([</span><span class="n">lowercase</span><span class="p">,</span> <span class="n">add_prefix</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Run with callback</span>
</span></span><span class="line"><span class="cl"><span class="n">handler</span> <span class="o">=</span> <span class="n">PrintCallbackHandler</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span> <span class="o">=</span> <span class="n">RunnableConfig</span><span class="p">(</span><span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">handler</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&#34;HELLO LangChain&#34;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="24-è¡¥å……æé—®">2.4 è¡¥å……æé—®</h3>
<p>è¿™ä¸€æ¬¡æé—®å›ç­”çš„å…¶å®ä¸æ˜¯å¾ˆå¥½ï¼Œæ‰€ä»¥æˆ‘è¿½åŠ äº†ä¸€æ¬¡æé—®:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">æé—®:
</span></span><span class="line"><span class="cl">event éƒ½æ˜¯åœ¨ BaseRunManager ä¸­è§¦å‘çš„ä¹ˆï¼Ÿæˆ‘ç†è§£ä¸­å¥½åƒä¸æ˜¯ï¼Œå¦å¤–è¯·åˆ é™¤ RunnableLambdaï¼Œä½¿ç”¨è‡ªå®šä¹‰çš„ Runnableï¼Œè¿™æ ·æˆ‘æ›´å®¹æ˜“ç†è§£æ•´ä¸ªæµç¨‹
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="-æ­£ç¡®ç†è§£-lcel-ä¸­äº‹ä»¶è§¦å‘æœºåˆ¶">ğŸ” æ­£ç¡®ç†è§£ LCEL ä¸­äº‹ä»¶è§¦å‘æœºåˆ¶</h4>
<p>ä½ æåˆ°çš„éå¸¸å‡†ç¡®ï¼š
<strong>LCEL ä¸­çš„äº‹ä»¶å¹¶ä¸éƒ½æ˜¯åœ¨ <code>BaseRunManager</code> ä¸­è§¦å‘çš„ã€‚</strong></p>
<p>åœ¨ LangChain çš„è®¾è®¡ä¸­ï¼š</p>
<ul>
<li><strong>äº‹ä»¶çš„è§¦å‘ä¸»è¦ä¾èµ–äºæ¯ä¸ª <code>Runnable</code> çš„å®ç°è€…</strong>ï¼Œæ¯”å¦‚ <code>RunnableMap</code>, <code>RunnableSequence</code>, <code>RunnableLambda</code>, <code>RunnablePassthrough</code> ç­‰ã€‚</li>
<li><code>BaseRunManager</code> çš„èŒè´£æ˜¯æä¾›é€šç”¨çš„ callback è°ƒç”¨ï¼Œæ¯”å¦‚ <code>on_start</code>, <code>on_end</code>, <code>on_error</code>ï¼Œæœ‰æ—¶ä¹Ÿæä¾› <code>on_event</code> çš„å¿«æ·æ–¹æ³•ã€‚</li>
<li><strong>ä½†çœŸæ­£è§¦å‘æŸä¸ªä¸šåŠ¡ç›¸å…³çš„ eventï¼Œæ¯”å¦‚ <code>on_chat_model_start</code>, <code>on_tool_start</code>, <code>on_chain_end</code>ï¼Œé€šå¸¸æ˜¯åœ¨æ¯ä¸ª Runnable çš„å®ç°å†…éƒ¨æ˜¾å¼è§¦å‘çš„</strong>ã€‚</li>
</ul>
<p>ä½ å¯ä»¥æŠŠ <code>BaseRunManager</code> ç†è§£ä¸ºæä¾›äº†â€œäº‹ä»¶è½¬å‘çš„ç®¡é“â€ï¼Œä½† <strong>å…·ä½“â€œä»€ä¹ˆæ—¶å€™å‘å‡ºå“ªä¸ªäº‹ä»¶â€æ˜¯åœ¨ Runnable é€»è¾‘å†…éƒ¨å†³å®šçš„ã€‚</strong></p>
<h4 id="-customrunnable">ğŸ§© <code>CustomRunnable</code></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CustomRunnable</span><span class="p">(</span><span class="n">Runnable</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">RunnableConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">callback_manager</span> <span class="o">=</span> <span class="n">BaseCallbackManager</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">callbacks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">run_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">callback_manager</span><span class="o">.</span><span class="n">on_start</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># â›³ï¸ æ˜ç¡®åœ¨è¿™é‡Œè§¦å‘ä¸€ä¸ªâ€œä¸šåŠ¡å«ä¹‰â€äº‹ä»¶</span>
</span></span><span class="line"><span class="cl">            <span class="n">callback_manager</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">Event</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_before&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&#34;input&#34;</span><span class="p">:</span> <span class="nb">input</span><span class="p">}))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">callback_manager</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">Event</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_after&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&#34;output&#34;</span><span class="p">:</span> <span class="n">output</span><span class="p">}))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">callback_manager</span><span class="o">.</span><span class="n">on_end</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">output</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">callback_manager</span><span class="o">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="-ç®€å•çš„é“¾ç»„åˆç±»runnablesequence">âœ… ç®€å•çš„é“¾ç»„åˆç±»ï¼š<code>RunnableSequence</code></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RunnableSequence</span><span class="p">(</span><span class="n">Runnable</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">RunnableConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">current</span> <span class="o">=</span> <span class="nb">input</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">current</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">current</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h4 id="-å®Œæ•´è¿è¡Œç¤ºä¾‹ä¸å†ä½¿ç”¨-runnablelambda">âœ… å®Œæ•´è¿è¡Œç¤ºä¾‹ï¼ˆä¸å†ä½¿ç”¨ RunnableLambdaï¼‰</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># å®šä¹‰ä¸¤ä¸ªä¸šåŠ¡æ­¥éª¤ runnable</span>
</span></span><span class="line"><span class="cl"><span class="n">step1</span> <span class="o">=</span> <span class="n">CustomRunnable</span><span class="p">(</span><span class="s2">&#34;lowercase&#34;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">step2</span> <span class="o">=</span> <span class="n">CustomRunnable</span><span class="p">(</span><span class="s2">&#34;add_prefix&#34;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;Echo: </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ç»„åˆä¸º pipeline</span>
</span></span><span class="line"><span class="cl"><span class="n">pipeline</span> <span class="o">=</span> <span class="n">RunnableSequence</span><span class="p">([</span><span class="n">step1</span><span class="p">,</span> <span class="n">step2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ä½¿ç”¨æ‰“å°å›è°ƒ</span>
</span></span><span class="line"><span class="cl"><span class="n">handler</span> <span class="o">=</span> <span class="n">PrintCallbackHandler</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span> <span class="o">=</span> <span class="n">RunnableConfig</span><span class="p">(</span><span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">handler</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># è¿è¡Œ</span>
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&#34;HELLO LCEL&#34;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="25-æ€»ç»“">2.5 æ€»ç»“</h3>
<p>æœ€æ–°çš„ç¤ºä¾‹æ²¡æœ‰ç”¨åˆ° BaseRunManagerï¼Œæ‰€ä»¥ BaseRunManager çš„ä½œç”¨éœ€è¦è¿›ä¸€æ­¥æŸ¥çœ‹æºç ã€‚ä½†æ˜¯è¿™ä¸ªä¸å¦¨ç¢æˆ‘ä»¬å¯¹ LCEL æœ‰ä¸ªæ„Ÿæ€§çš„ç†è§£ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹ Runnable çš„æºç ã€‚</p>
<h2 id="3-runnable-æºç æ¡†æ¶">3. runnable æºç æ¡†æ¶</h2>
<h3 id="31-runnable-ç±»">3.1 Runnable ç±»</h3>
<p>Runnable ç±»çš„æ ¸å¿ƒæ–¹æ³•å°±æ˜¯ invokeï¼Œè¿™ä¸ªæ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼ŒåŸºäºè¿™ä¸ªæ–¹æ³•ï¼ŒRunnable æä¾›å¼‚æ­¥ã€æ‰¹æ¬¡è°ƒç”¨çš„ invoke çš„å…¶ä»–æ–¹æ³•ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Runnable</span><span class="p">(</span><span class="n">ABC</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">Input</span><span class="p">,</span> <span class="n">Output</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;The name of the Runnable. Used for debugging and tracing.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">config_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">ConfigurableFieldSpec</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;List configurable fields for this Runnable.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RunnableConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Graph</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Return a graph representation of this Runnable.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">input_node</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_input_schema</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">input_node</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">create_model_v2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="s2">&#34;Input&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="n">runnable_node</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;metadata&#34;</span><span class="p">)</span> <span class="k">if</span> <span class="n">config</span> <span class="k">else</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output_node</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_output_schema</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output_node</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">create_model_v2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="s2">&#34;Output&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">input_node</span><span class="p">,</span> <span class="n">runnable_node</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">runnable_node</span><span class="p">,</span> <span class="n">output_node</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">graph</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="fm">__or__</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">Runnable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Other</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">Callable</span><span class="p">[[</span><span class="n">Iterator</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Other</span><span class="p">]],</span>
</span></span><span class="line"><span class="cl">            <span class="n">Callable</span><span class="p">[[</span><span class="n">AsyncIterator</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">Other</span><span class="p">]],</span>
</span></span><span class="line"><span class="cl">            <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Other</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Runnable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Other</span><span class="p">],</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Other</span><span class="p">],</span> <span class="n">Any</span><span class="p">]],</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RunnableSerializable</span><span class="p">[</span><span class="n">Input</span><span class="p">,</span> <span class="n">Other</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Compose this Runnable with another object to create a RunnableSequence.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">RunnableSequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coerce_to_runnable</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@abstractmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">input</span><span class="p">:</span> <span class="n">Input</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RunnableConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Output</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Transform a single input into an output.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">            input: The input to the Runnable.
</span></span></span><span class="line"><span class="cl"><span class="s2">            config: A config to use when invoking the Runnable.
</span></span></span><span class="line"><span class="cl"><span class="s2">               The config supports standard keys like &#39;tags&#39;, &#39;metadata&#39; for tracing
</span></span></span><span class="line"><span class="cl"><span class="s2">               purposes, &#39;max_concurrency&#39; for controlling how much work to do
</span></span></span><span class="line"><span class="cl"><span class="s2">               in parallel, and other keys. Please refer to the RunnableConfig
</span></span></span><span class="line"><span class="cl"><span class="s2">               for more details.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">            The output of the Runnable.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">def</span> <span class="nf">ainvoke</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">input</span><span class="p">:</span> <span class="n">Input</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RunnableConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Output</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Default implementation of ainvoke, calls invoke from a thread.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        The default implementation allows usage of async code even if
</span></span></span><span class="line"><span class="cl"><span class="s2">        the Runnable did not implement a native async version of invoke.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Subclasses should override this method if they can run asynchronously.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">await</span> <span class="n">run_in_executor</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoke</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">def</span> <span class="nf">astream_log</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">input</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RunnableConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">diff</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">with_streamed_output_list</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">include_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">include_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">include_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">exclude_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">exclude_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">exclude_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">AsyncIterator</span><span class="p">[</span><span class="n">RunLogPatch</span><span class="p">],</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">RunLog</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">def</span> <span class="nf">astream_events</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">input</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RunnableConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">version</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&#34;v1&#34;</span><span class="p">,</span> <span class="s2">&#34;v2&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;v2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">include_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">include_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">include_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">exclude_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">exclude_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">exclude_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">StreamEvent</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">input</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Input</span><span class="p">],</span>  <span class="c1"># noqa: A002</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RunnableConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Output</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">with_config</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RunnableConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Sadly Unpack is not well-supported by mypy so this will have to be untyped</span>
</span></span><span class="line"><span class="cl">        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Runnable</span><span class="p">[</span><span class="n">Input</span><span class="p">,</span> <span class="n">Output</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Bind config to a Runnable, returning a new Runnable.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">            config: The config to bind to the Runnable.
</span></span></span><span class="line"><span class="cl"><span class="s2">            kwargs: Additional keyword arguments to pass to the Runnable.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">            A new Runnable with the config bound.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">RunnableBinding</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">bound</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">config</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;RunnableConfig&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span><span class="o">**</span><span class="p">(</span><span class="n">config</span> <span class="ow">or</span> <span class="p">{}),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">kwargs</span><span class="o">=</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘åˆ—ä¸¾äº† Runnable çš„ä¸€äº›æ–¹æ³•:</p>
<ol>
<li><code>__or__</code>: <code>|</code> ç®¡é“ç¬¦è¯­æ³•çš„å®ç°ï¼Œå†…éƒ¨è°ƒç”¨ RunnableSequence</li>
<li>config_specs: ä¸ç¨‹åºè‡ªå®šä¹‰é…ç½®æœ‰å…³</li>
<li>astream_log: å¼‚æ­¥æµå¼æ—¥å¿—ï¼Œéœ€è¦é‡ç‚¹ç†è§£</li>
<li>astream_events: å¼‚æ­¥æµå¼äº‹ä»¶ï¼Œéœ€è¦é‡ç‚¹ç†è§£</li>
<li>with_ çš„æ–¹æ³•ï¼Œéƒ½æ˜¯ä¸€äº›ä¾¿æºæ–¹æ³•ï¼Œæ¯”å¦‚ with_configã€with_retry ç­‰</li>
</ol>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ RunnableSequence çš„ invoke æ–¹æ³•ï¼Œè¿™æ˜¯æˆ‘ä»¬ç†è§£ LCEL çš„å…³é”®æ–¹æ³•ã€‚</p>
<h3 id="32-runnablesequence">3.2 RunnableSequence</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RunnableSequence</span><span class="p">(</span><span class="n">RunnableSerializable</span><span class="p">[</span><span class="n">Input</span><span class="p">,</span> <span class="n">Output</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">    <span class="n">first</span><span class="p">:</span> <span class="n">Runnable</span><span class="p">[</span><span class="n">Input</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;The first Runnable in the sequence.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">middle</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Runnable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;The middle Runnables in the sequence.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">last</span><span class="p">:</span> <span class="n">Runnable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Output</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;The last Runnable in the sequence.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">steps</span><span class="p">:</span> <span class="n">RunnableLike</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">first</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Runnable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">middle</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Runnable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">last</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Runnable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Create a new RunnableSequence.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">            steps: The steps to include in the sequence.
</span></span></span><span class="line"><span class="cl"><span class="s2">            name: The name of the Runnable. Defaults to None.
</span></span></span><span class="line"><span class="cl"><span class="s2">            first: The first Runnable in the sequence. Defaults to None.
</span></span></span><span class="line"><span class="cl"><span class="s2">            middle: The middle Runnables in the sequence. Defaults to None.
</span></span></span><span class="line"><span class="cl"><span class="s2">            last: The last Runnable in the sequence. Defaults to None.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Raises:
</span></span></span><span class="line"><span class="cl"><span class="s2">            ValueError: If the sequence has less than 2 steps.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">steps_flat</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Runnable</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">steps</span> <span class="ow">and</span> <span class="n">first</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">steps_flat</span> <span class="o">=</span> <span class="p">[</span><span class="n">first</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">middle</span> <span class="ow">or</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">last</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">RunnableSequence</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">steps_flat</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">steps_flat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coerce_to_runnable</span><span class="p">(</span><span class="n">step</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">steps_flat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;RunnableSequence must have at least 2 steps, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">steps_flat</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># type: ignore[call-arg]</span>
</span></span><span class="line"><span class="cl">            <span class="n">first</span><span class="o">=</span><span class="n">steps_flat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">middle</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">steps_flat</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">            <span class="n">last</span><span class="o">=</span><span class="n">steps_flat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">steps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Runnable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;All the Runnables that make up the sequence in order.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">            A list of Runnables.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">first</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">middle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@override</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">Input</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RunnableConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Output</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 1. langchain å¼•å…¥çš„ context</span>
</span></span><span class="line"><span class="cl">        <span class="kn">from</span> <span class="nn">langchain_core.beta.runnables.context</span> <span class="kn">import</span> <span class="n">config_with_context</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># setup callbacks and context</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span> <span class="o">=</span> <span class="n">config_with_context</span><span class="p">(</span><span class="n">ensure_config</span><span class="p">(</span><span class="n">config</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 2. è·å– BaseCallBackManager</span>
</span></span><span class="line"><span class="cl">        <span class="n">callback_manager</span> <span class="o">=</span> <span class="n">get_callback_manager_for_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># start the root run</span>
</span></span><span class="line"><span class="cl">        <span class="n">run_manager</span> <span class="o">=</span> <span class="n">callback_manager</span><span class="o">.</span><span class="n">on_chain_start</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nb">input</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;run_name&#34;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">run_id</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&#34;run_id&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">input_</span> <span class="o">=</span> <span class="nb">input</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># invoke all steps in sequence</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># mark each step as a child run</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 3. ä¸ºæ¯ä¸ª step é…ç½® callback</span>
</span></span><span class="line"><span class="cl">                <span class="n">config</span> <span class="o">=</span> <span class="n">patch_config</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">config</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="n">run_manager</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;seq:step:</span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 4. ç®¡ç†åç¨‹ä¸Šä¸‹æ–‡</span>
</span></span><span class="line"><span class="cl">                <span class="k">with</span> <span class="n">set_config_context</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="k">as</span> <span class="n">context</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">input_</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">invoke</span><span class="p">,</span> <span class="n">input_</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">input_</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">invoke</span><span class="p">,</span> <span class="n">input_</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># finish the root run</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">run_manager</span><span class="o">.</span><span class="n">on_chain_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">run_manager</span><span class="o">.</span><span class="n">on_chain_end</span><span class="p">(</span><span class="n">input_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&#34;Output&#34;</span><span class="p">,</span> <span class="n">input_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_callback_manager_for_config</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CallbackManager</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Get a callback manager for a config.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        config (RunnableConfig): The config.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        CallbackManager: The callback manager.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">langchain_core.callbacks.manager</span> <span class="kn">import</span> <span class="n">CallbackManager</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ä» config ä¸­æå– callback</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">CallbackManager</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">inheritable_callbacks</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;callbacks&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">inheritable_tags</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;tags&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">inheritable_metadata</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;metadata&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸‹é¢æ˜¯ä¸€ä¸ª LCEL çš„ç®€å•ä½¿ç”¨ç¤ºä¾‹:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_core.runnables</span> <span class="kn">import</span> <span class="n">Runnable</span><span class="p">,</span> <span class="n">RunnableLambda</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_core.callbacks</span> <span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">BaseCallbackHandler</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_core.runnables</span> <span class="kn">import</span> <span class="n">RunnableConfig</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">uuid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># è‡ªå®šä¹‰ CallbackHandler</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PrintCallbackHandler</span><span class="p">(</span><span class="n">BaseCallbackHandler</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_chain_end</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">run_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">parent_run_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">] ğŸŸ¢ End with output: </span><span class="si">{</span><span class="n">outputs</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># å®šä¹‰ä¸¤ä¸ª RunnableLambda èŠ‚ç‚¹</span>
</span></span><span class="line"><span class="cl"><span class="n">lowercase</span> <span class="o">=</span> <span class="n">RunnableLambda</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add_prefix</span> <span class="o">=</span> <span class="n">RunnableLambda</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;Echo: </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ç”¨ RunnableSequence ç»„åˆæˆ pipeline</span>
</span></span><span class="line"><span class="cl"><span class="n">pipeline</span><span class="p">:</span> <span class="n">Runnable</span> <span class="o">=</span> <span class="n">lowercase</span> <span class="o">|</span> <span class="n">add_prefix</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># å®šä¹‰é…ç½®ï¼ŒåŒ…æ‹¬ callback handler</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span> <span class="o">=</span> <span class="n">RunnableConfig</span><span class="p">(</span><span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">PrintCallbackHandler</span><span class="p">()])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># è°ƒç”¨é“¾</span>
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&#34;HELLO LangChain&#34;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Final Result:&#34;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°åŸºæœ¬ä¸Šä¸ ChatGpt ç»™æˆ‘ä»¬çš„ demo å®ç°ä¸€è‡´ã€‚ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†è¯¦ç»†ä»‹ç» RunnableSequence invoke æ–¹æ³•çš„å®ç°ã€‚</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>æ›´æ–°äº 2025-07-25&nbsp;<a class="git-hash" href="https://github.com/dillonzq/LoveIt/commit/83df9363cc662fd7eda4fabbf699998881e2e003" target="_blank" title="commit by tao(tao@example.com) 83df9363cc662fd7eda4fabbf699998881e2e003: langchain context and config">
                                    <i class="fas fa-hashtag fa-fw"></i>83df936</a></span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/posts/program/python/langchain/01_core_base/index.md" target="_blank">é˜…è¯»åŸå§‹æ–‡æ¡£</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="åˆ†äº«åˆ° Twitter" data-sharer="twitter" data-url="https://hotttao.github.io/posts/program/python/langchain/01_core_base/" data-title="langchain-core æ ¸å¿ƒå¯¹è±¡" data-hashtags="langchain æºç "><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Facebook" data-sharer="facebook" data-url="https://hotttao.github.io/posts/program/python/langchain/01_core_base/" data-hashtag="langchain æºç "><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Hacker News" data-sharer="hackernews" data-url="https://hotttao.github.io/posts/program/python/langchain/01_core_base/" data-title="langchain-core æ ¸å¿ƒå¯¹è±¡"><i class="fab fa-hacker-news fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Line" data-sharer="line" data-url="https://hotttao.github.io/posts/program/python/langchain/01_core_base/" data-title="langchain-core æ ¸å¿ƒå¯¹è±¡"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° å¾®åš" data-sharer="weibo" data-url="https://hotttao.github.io/posts/program/python/langchain/01_core_base/" data-title="langchain-core æ ¸å¿ƒå¯¹è±¡" data-ralateuid="xxxx"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/langchain-%E6%BA%90%E7%A0%81/">langchain æºç </a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">è¿”å›</a></span>&nbsp;|&nbsp;<span><a href="/">ä¸»é¡µ</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/program/java/grammar/01_vars/" class="prev" rel="prev" title="Java å˜é‡ã€æµç¨‹æ§åˆ¶ä¸æ•°æ®ç±»å‹"><i class="fas fa-angle-left fa-fw"></i>Java å˜é‡ã€æµç¨‹æ§åˆ¶ä¸æ•°æ®ç±»å‹</a>
            <a href="/posts/program/python/langchain/02_context_config/" class="next" rel="next" title="LangChain Context å’Œ RunnableConfig">LangChain Context å’Œ RunnableConfig<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">ç”± <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.120.2">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">å®‹æ¶›</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="å›åˆ°é¡¶éƒ¨">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="æŸ¥çœ‹è¯„è®º">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.8/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"å¤åˆ¶åˆ°å‰ªè´´æ¿","maxShownLines":30},"comment":{"gitalk":{"admin":["hotttao"],"clientID":"7b48df1b81d23057c798","clientSecret":"65c6f9e6ca6ae4d8105f757578b6b594e3668e61","id":"2025-07-20T22:00:00+08:00","owner":"hotttao","repo":"hotttao.github.io","title":"langchain-core æ ¸å¿ƒå¯¹è±¡"}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"æ²¡æœ‰æ‰¾åˆ°ç»“æœ","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
