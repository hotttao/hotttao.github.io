<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>asyncio - LoveIt</title><meta name="Description" content="Python asyncio 处理并发"><meta property="og:title" content="asyncio" />
<meta property="og:description" content="Python asyncio 处理并发" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hotttao.github.io/posts/program/python/grammar/fluent-python/18_asyncio/" /><meta property="og:image" content="https://hotttao.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-01-18T22:00:00+08:00" />
<meta property="article:modified_time" content="2022-03-10T13:09:11+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://hotttao.github.io/logo.png"/>

<meta name="twitter:title" content="asyncio"/>
<meta name="twitter:description" content="Python asyncio 处理并发"/>
<meta name="application-name" content="宋涛的个人博客">
<meta name="apple-mobile-web-app-title" content="宋涛的个人博客"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://hotttao.github.io/posts/program/python/grammar/fluent-python/18_asyncio/" /><link rel="prev" href="https://hotttao.github.io/posts/linux/linux_mt/06-shell%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/bash%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/" /><link rel="next" href="https://hotttao.github.io/posts/linux/linux_mt/06-shell%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/%E8%84%9A%E6%9C%AC%E7%A4%BA%E4%BE%8B%E4%B8%8E%E7%BB%83%E4%B9%A0/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "asyncio",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/hotttao.github.io\/posts\/program\/python\/grammar\/fluent-python\/18_asyncio\/"
        },"image": ["https:\/\/hotttao.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "python 进阶","wordcount":  7863 ,
        "url": "https:\/\/hotttao.github.io\/posts\/program\/python\/grammar\/fluent-python\/18_asyncio\/","datePublished": "2018-01-18T22:00:00+08:00","dateModified": "2022-03-10T13:09:11+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": {
                    "@type": "ImageObject",
                    "url": "https:\/\/hotttao.github.io\/images\/hugo\/avatar.png",
                    "width":  528 ,
                    "height":  560 
                }},"author": {
                "@type": "Person",
                "name": "宋涛"
            },"description": "Python asyncio 处理并发"
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="LoveIt"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>宋涛的博客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/categories/go/"> Go </a><a class="menu-item" href="/categories/linux/"> Linux </a><a class="menu-item" href="/categories/distributed/"> 分布式 </a><a class="menu-item" href="/categories/distributed/"> 架构 </a><a class="menu-item" href="/posts/about/"> 关于 </a><a class="menu-item" href="https://github.com/hotttao/" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="LoveIt"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>宋涛的博客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/categories/go/" title="">Go</a><a class="menu-item" href="/categories/linux/" title="">Linux</a><a class="menu-item" href="/categories/distributed/" title="">分布式</a><a class="menu-item" href="/categories/distributed/" title="">架构</a><a class="menu-item" href="/posts/about/" title="">关于</a><a class="menu-item" href="https://github.com/hotttao/" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">asyncio</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://hotttao.github.io/" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>宋涛</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/python/"><i class="far fa-folder fa-fw"></i>Python</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2018-01-18">2018-01-18</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 7863 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 16 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-操作系统知识">1. 操作系统知识</a>
      <ul>
        <li><a href="#11-并发与并行">1.1 并发与并行</a></li>
        <li><a href="#12-io-模型">1.2 I/O 模型</a></li>
        <li><a href="#io模型对比">I/O模型对比</a></li>
        <li><a href="#13-协程与线程">1.3 协程与线程</a></li>
      </ul>
    </li>
    <li><a href="#2-asyncio">2. asyncio</a>
      <ul>
        <li><a href="#21-asyncio-简介">2.1 asyncio 简介</a></li>
        <li><a href="#22-异步原理">2.2 异步原理:</a></li>
        <li><a href="#23-语法">2.3 语法:</a></li>
        <li><a href="#24-调用过程">2.4 调用过程:</a></li>
      </ul>
    </li>
    <li><a href="#3-asyncio-api">3. asyncio API</a>
      <ul>
        <li><a href="#31-asyncio-主要对象">3.1 asyncio 主要对象</a></li>
        <li><a href="#32-asynciofuture">3.2 asyncio.Future</a>
          <ul>
            <li><a href="#使用方式">使用方式:</a></li>
          </ul>
        </li>
        <li><a href="#33-asynciotask">3.3 asyncio.Task</a>
          <ul>
            <li><a href="#实例化方式">实例化方式</a></li>
          </ul>
        </li>
        <li><a href="#34-baseeventloop">3.4 BaseEventLoop</a></li>
        <li><a href="#35-其他函数和对象">3.5 其他函数和对象</a></li>
        <li><a href="#36-使用executor对象">3.6 使用Executor对象</a></li>
        <li><a href="#37-asyncio-使用示例">3.7 asyncio 使用示例</a>
          <ul>
            <li><a href="#aiohttp">aiohttp</a></li>
            <li><a href="#run_in_executor">run_in_executor</a></li>
            <li><a href="#as_completed-semaphore">as_completed, Semaphore</a></li>
            <li><a href="#run_until_complete">run_until_complete</a></li>
          </ul>
        </li>
        <li><a href="#38-协程与线程对比">3.8 协程与线程对比</a></li>
      </ul>
    </li>
    <li><a href="#4-使用asyncio包编写服务器">4. 使用asyncio包编写服务器</a>
      <ul>
        <li><a href="#41-编写tcp服务器">4.1 编写TCP服务器</a></li>
        <li><a href="#42-编写web服务器">4.2 编写Web服务器</a></li>
        <li><a href="#43-服务器设计可用工具">4.3 服务器设计可用工具</a></li>
      </ul>
    </li>
    <li><a href="#延伸阅读">延伸阅读</a>
      <ul>
        <li><a href="#python">Python:</a></li>
        <li><a href="#blog">blog:</a></li>
        <li><a href="#实用工具">实用工具</a></li>
        <li><a href="#文章">文章:</a></li>
      </ul>
    </li>
    <li><a href="#附注">附注</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="1-操作系统知识">1. 操作系统知识</h2>
<h3 id="11-并发与并行">1.1 并发与并行</h3>
<p>并行: 在某一时间点, 存在多于一个进程在运行</p>
<p>并发: 在某一段时间, 存在多于一个进程在运行</p>
<h3 id="12-io-模型">1.2 I/O 模型</h3>
<ol>
<li>同步阻塞I/O</li>
<li>同步非阻塞I/O</li>
<li>异步阻塞I/O &ndash; I/O多路复用</li>
<li>异步非阻塞I/O &ndash; I/O操作在操作系统内核中完成, 完成后通过应用程序</li>
<li>信号驱动I/O - 向程序发送信号, I/O操作在用户空间完成</li>
<li>epoll - I/O多路复用的改进版本, 又称为事件驱动模型</li>
</ol>
<p>附注:</p>
<ul>
<li>普通文件的读写不支持 epoll, 基于 epoll的 tornado 不适合大量的
文件系统I/O, 耗时的任务只能通过采用异步 httpclient 交给后端server处理</li>
<li>asyncio 也不支持异步文件系统I/O, 只能通过多线程解决普通文件读写导致的阻塞</li>
</ul>
<h3 id="io模型对比">I/O模型对比</h3>
<blockquote>
<p>详细见 18.5节</p>
</blockquote>
<p><strong>信号驱动I/O</strong></p>
<ul>
<li>实现：通过sigaction系统调用注册一个SIGIO信号处理程序</li>
<li>特点：
<ul>
<li>通常，在UDP编程中使用信号驱动I/O，此时SIGIO信号产生于下面两种情况：
<ul>
<li>套接字收到一个数据报</li>
<li>套接字上发生了异步错误</li>
</ul>
</li>
<li>对于TCP编程，信号驱动I/O没有太大意义
<ul>
<li>因为对于流式套接字而言，有很多情况都可以导致SIGIO产生</li>
<li>而应用又无法区分是什么具体情况导致该信号产生的</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>基于回调的事件驱动模型</strong>：</p>
<ul>
<li>缺点:
<ul>
<li>执行分成多步的异步任务时丢失上下文，共享状态管理困难
<ul>
<li>不等待响应, 而是注册一个函数, 在发生某件事时调用</li>
<li>每个函数做一部分工作, 设置下一个回调, 然后返回, 让事件循环继续运行, 所有本地的上下文都会丢失</li>
</ul>
</li>
<li>缺少处理错误所需的上下文，错误处理困难</li>
<li>一连串的回调构成一个完整的调用链,其中任意一个异常整个调用链断掉，接力传递的状态也会丢失</li>
<li>为了防止栈撕裂，异常必须以数据的形式返回，而不是直接抛出异常，
然后每个回调中需要检查上次调用的返回值，以防错误吞没</li>
</ul>
</li>
</ul>
<p><strong>基于协程的事件驱动模型</strong>：</p>
<ul>
<li>协程：
<ul>
<li>是协作式的例程</li>
<li>是非抢占式的多任务子例程的概括，允许有多个入口点在例程中确定的位置来控制程序的暂停与恢复执行</li>
<li>例程是编程语言定义的可被调用的代码段，为了完成某个特定功能而封装在一起的一系列指令</li>
</ul>
</li>
<li>特点：
<ul>
<li>每个协程具有自己的栈帧，保留了程序执行的上下文</li>
<li>协程之间相互合作，相互通知，能将程序状态在不同的回调之间延续下去</li>
</ul>
</li>
<li>运行过程：
<ul>
<li>所有I/O操作都是异步的，并在 yield 处暂停</li>
<li>事件循环监听所有I/O事件，并在I/O事件发生时，调用send方法激活暂停协程继续运行</li>
<li><strong>总结</strong>: <strong>两种模型都是基于回调，只不过协程中的事件循环回调的是 send 方法，激活暂停的协程</strong></li>
</ul>
</li>
</ul>
<p><strong>应用</strong>：</p>
<ul>
<li>Node.js 是基于回调的事件
<ul>
<li>Node.js 不支持使用 JavaScript 编写的用户级线程,</li>
<li>但是在背后却借助 libeio 库使用 C 语言实现了线程池, 以此提供基于回调的文件 API</li>
<li>从 2014 年起, 大多数操作系统都不提供稳定且便携的异步文件处理 API 了，
Node 提供了异步文件系统 API</li>
</ul>
</li>
<li>asyncio 是基于协程的</li>
</ul>
<h3 id="13-协程与线程">1.3 协程与线程</h3>
<ul>
<li>线程：
<ul>
<li>因为调度程序任何时候都能中断线程。</li>
<li>所以必须保留锁，保护程序中的重要部分，防止多步操作在执行的过程中中断，导致数据处于无效状态</li>
</ul>
</li>
<li>协程：
<ul>
<li>协程默认会做好全方位保护，以防止中断，必须显式产出才能让程序的余下部分运行</li>
<li>对协程来说，无需保留锁，协程自身就会同步，因为在任意时刻只有一个协程运行</li>
<li>想交出控制权时，可以使用 yield 或 yield from 把控制权交还调度程序</li>
<li>协程只能在暂停的 yield 处取消，因此可以处理 CancelledError 异常，执行清理操作，
这就是能够安全地取消协程的原因</li>
</ul>
</li>
</ul>
<h2 id="2-asyncio">2. asyncio</h2>
<h3 id="21-asyncio-简介">2.1 asyncio 简介</h3>
<p>asyncio:</p>
<ul>
<li>实现: 使用 <strong>事件循环驱动</strong> 的协程实现并发, 注意不是实现并行</li>
<li>版本:
<ul>
<li>python3: asyncio - <a href="http://docs.python.org/3/library/asyncio.html" target="_blank" rel="noopener noreffer">http://docs.python.org/3/library/asyncio.html</a></li>
<li>python2: trollius - <a href="http://trollius.readthedocs.io/using.html" target="_blank" rel="noopener noreffer">http://trollius.readthedocs.io/using.html</a>
<ul>
<li>import asyncio 替换成 import trollius as asyncio</li>
<li>yield from &hellip; 替换成 yield From(&hellip;)</li>
<li>yield from []  替换成 yield From(None)</li>
<li>协程需要返回结果, return result 替换成 raise Return(result)</li>
</ul>
</li>
</ul>
</li>
<li>讨论组: <a href="http://groups.google.com/forum/#!forum/python-tulip" target="_blank" rel="noopener noreffer">http://groups.google.com/forum/#!forum/python-tulip</a></li>
</ul>
<h3 id="22-异步原理">2.2 异步原理:</h3>
<ul>
<li>事件循环基于 I/O 多路复用</li>
<li>委派链的底端是可以被 I/O 多路复用监听的 I/O 操作</li>
<li>yield from foo 能防止阻塞, 因为当前协程(委派生成器)因等待I/O操作暂停后,
控制权回到事件循环手中, 再去驱动其他协程  &ndash; 异步阻塞的</li>
<li>事件循环监听期物或协程是否运行完毕, 并把结果返回给暂停的协程, 将其恢复,
即调用 send 方法发送响应重启协程</li>
</ul>
<h3 id="23-语法">2.3 语法:</h3>
<p>Python3.4:<br>
asyncio 处理的协程</p>
<ol>
<li>要使用 @asyncio.coroutine 装饰
- 这样能在一众普通的函数中把协程凸显出来，
- 有助于调试：如果还没从中产出值，协程就被垃圾回收了(意味着有操作未完成)那就可以发出警告</li>
<li>协程在定义体中必须使用 yield from, 而不能使用 yield</li>
<li>协程要由调用方驱动, 并由调用方通过 yield from 调用,
或者把协程传给 asyncio 包中的某个函数, 例如 asyncio.async(&hellip;)</li>
</ol>
<p>Python3.6<br>
新特性:</p>
<ul>
<li>添加了 async 和 await 关键字, 协程成为新的语法, 而不再是一种生成器类型</li>
</ul>
<p>async:</p>
<ul>
<li>作用: 替代 asyncio.coroutine</li>
</ul>
<p>await:</p>
<ul>
<li>作用: 替代 yield from</li>
</ul>
<p>async with</p>
<ul>
<li>作用: 异步上下文管理</li>
</ul>
<p>async for</p>
<ul>
<li>作用: 异步迭代器语法</li>
</ul>
<h3 id="24-调用过程">2.4 调用过程:</h3>
<ol>
<li>使用 asyncio.Task 对象包装协程, 排定协程的运行时间  &ndash;  <strong>获取 Task 对象</strong></li>
<li>获取一个事件循环 &ndash; 替代了操作系统的调度职能  &ndash;  <strong>获取事件循环</strong></li>
<li>asyncio 事件循环依次激活各个协程  &ndash; <strong>激活所有协程</strong></li>
<li>客户代码中的协程使用 yield from 把职责委托给库里的协程(如aiohttp.request)时,
控制权交还事件循环, 事件循环得以执行其他排定的协程 &ndash; <strong>执行底层协程</strong></li>
<li>事件循环通过基于回调的低层 API, 在阻塞的操作执行完毕后获得通知</li>
<li>获得通知后, 主循环把结果发给暂停的协程(.send()), 重启暂停的协程  &ndash; <strong>获取返回结果</strong></li>
<li>总结: 在一个单线程程序中使用主循环依次激活队列里的协程, 各个协程向前执行几步,
然后把控制权让给主循环, 主循环再激活队列里的下一个协程</li>
</ol>
<p><strong>调用方式</strong>:</p>
<ul>
<li>只有驱动协程, 协程才能做事</li>
<li>驱动协程要么使用 yield from,要么传给 asyncio包中某个参数为协程或期物的函数, 例如 run_until_complete</li>
<li>yeild from:
<ul>
<li>使用 yield from 链接的多个协程最终必须由不是协程的调用方驱动，调用方显式或隐式
（例如，在 for 循环中）在最外层委派生成器上调用 next(&hellip;) 函数或 .send(&hellip;) 方法</li>
<li>链条中最内层的子生成器必须是简单的生成器（只使用 yield）或可迭代的对象</li>
</ul>
</li>
<li>使用 asyncio 包时，我们编写的代码不通过调用 next(&hellip;) 函数或 .send(&hellip;)
方法驱动协程——这一点由 asyncio 包实现的事件循环去做</li>
</ul>
<h2 id="3-asyncio-api">3. asyncio API</h2>
<h3 id="31-asyncio-主要对象">3.1 asyncio 主要对象</h3>
<p>主要对象:</p>
<ul>
<li>asyncio.Future:
<ul>
<li>期物对象，表示异步执行的操作</li>
<li>与 concurrent.futures.Future 类似</li>
</ul>
</li>
<li>asyncio.Task: Future 对象的子类
<ul>
<li>与 threading.Thread 对象等效，Task 用于驱动协程， Thread 用于调用可调用的对象</li>
<li>像是实现协作式多任务的库(例如 gevent)中的绿色线程(green thread)</li>
</ul>
</li>
<li>BaseEventLoop: I/O 事件循环</li>
<li>其他函数</li>
</ul>
<p>期物和协程:</p>
<ul>
<li>文档： <a href="https://docs.python.org/3/library/asyncio-task.html" target="_blank" rel="noopener noreffer">https://docs.python.org/3/library/asyncio-task.html</a></li>
<li>可以使用 yield from 驱动协程，也可以使用 yield from 从 asyncio.Future对象中产出结果</li>
<li>因此如果 foo 是协程函数（调用后返回协程对象）, 抑或是返回 Future 或 Task
实例的普通函数, 都可以写成:  res = yield from foo()</li>
<li>这是asyncio 包的 API 中很多地方可以互换协程与期物的原因之一</li>
</ul>
<h3 id="32-asynciofuture">3.2 asyncio.Future</h3>
<ul>
<li>作用: 与 concurrent.futures.Future 接口基本一致</li>
<li>类似方法:
<ul>
<li>.done()</li>
<li>.add_done_callback(&hellip;)</li>
</ul>
</li>
<li>差异方法:
<ul>
<li>.result():
<ul>
<li>参数: 方法没有参数, 不能指定超时时间。</li>
<li>作用: 如果调用 .result() 方法时期物还没运行完毕, 不会阻塞去等待结果,
而是抛出 asyncio.InvalidStateError 异常</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="使用方式">使用方式:</h4>
<ul>
<li>通常使用 yield from, 获取 asyncio.Future 对象的结果</li>
<li>使用 yield from 处理期物, 等待期物运行完毕这一步无需我们关心, 而且不会阻塞事件循
环, 因为在 asyncio 包中,  yield from 的作用是把控制权还给事件循环</li>
<li>通常无需调用 my_future.add_done_callback(&hellip;), 因为
可以直接把想在期物运行结束后执行的操作放在协程中
yield from my_future 表达式的后面即可</li>
<li>通常也无需调用 my_future.result(), 因为 yield from 从期物中产出的值就是结果</li>
</ul>
<h3 id="33-asynciotask">3.3 asyncio.Task</h3>
<ul>
<li>作用: Future 的子类, 用于包装协程</li>
<li>特性:
<ul>
<li>为了执行操作，必须排定协程的运行时间，然后使用 asyncio.Task 对象包装协程</li>
<li>因此<strong>Task 实例相当于一个子线程</strong>，但已排定运行时间, 可直接运行, 无需显示使用 yeild from 驱动</li>
<li>Thread 实例则必须调用 start 方法，明确告知让它运行</li>
</ul>
</li>
<li>方法：
<ul>
<li>.cancel():
<ul>
<li>作用：终止协程, 在协程内部 yeild 处抛出 CancelledError 异常</li>
<li>附注：协程可以捕获这个异常，也可以延迟取消，甚至拒绝取消</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test_task</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span> <span class="c1"># 协程不会在此处暂停，因为相当于启动了一个新线程</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">yield from</span> <span class="k">async</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># 协程会在此处暂停</span>
</span></span><span class="line"><span class="cl">    <span class="k">yield from</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 协程会在此暂停，yield from Future() 也是同样效果</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+++++&#39;</span><span class="p">)</span> <span class="c1"># 在上一个 sleep 返回时，输出</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span> <span class="c1"># 当前协程运行完毕，a 被销毁，对应的协程也会被销毁，所以整个程序不会运行 100s</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">test_task</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>附注：</p>
<ul>
<li>如果想获取 task 实例的返回结果，必需使用 yeild from task</li>
<li>如果只是想启动另一协程，无需使用 yield from</li>
<li>Future 对象只是要执行的操作，与协程一样，必需使用 yield from 驱动</li>
</ul>
<h4 id="实例化方式">实例化方式</h4>
<ol>
<li>asyncio.async(coro_or_future,  *,  loop=None)</li>
</ol>
<ul>
<li>coro_or_future:
<ul>
<li>如果是 Future 或Task 对象, 那就原封不动地返回</li>
<li>如果是协程, 那么 async 函数会调用 loop.create_task(&hellip;) 方法创建 Task 对象</li>
</ul>
</li>
<li>loop:
<ul>
<li>关键字参数是可选的, 用于传入事件循环</li>
<li>默认,  async 函数会通过调用 asyncio.get_event_loop() 函数获取循环对象</li>
</ul>
</li>
</ul>
<ol start="2">
<li>BaseEventLoop.create_task(&hellip;)</li>
</ol>
<ul>
<li>参数: 一个协程</li>
<li>作用: 排定协程的执行时间, 返回一个 asyncio.Task 对象</li>
<li>附注: 如果在自定义的 BaseEventLoop 子类上调用, 返回的对象可以是外部库
(如 Tornado)中与 Task 类兼容的某个类的实例</li>
<li>版本：create_task(&hellip;) 方法只在 Python 3.4.2 及以上版本中可用。
如果是 Python 3.3 或 Python 3.4 的旧版，要使用 asyncio.async(&hellip;) 函数</li>
</ul>
<ol start="3">
<li>asyncio.wait(futures,  *,  loop=None,  timeout=None,  return_when=ALL_COMPLETED):</li>
</ol>
<ul>
<li>参数:
<ul>
<li>futures: 一个由期物或协程构成的可迭代对象</li>
<li>timeout, return_when 如果设定可能会返回未结束的期物</li>
</ul>
</li>
<li>作用:
<ul>
<li>把各个协程分别包装进一个 Task 对象(内部使用了 async 函数)</li>
<li>wait 是协程, 返回一个协程或生成器对象, 会等待传给它的所有协程运行完毕后结束</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">download_many</span><span class="p">(</span><span class="n">cc_list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>  <span class="c1"># 获取事件循环底层实现的引用</span>
</span></span><span class="line"><span class="cl">    <span class="n">to_do</span> <span class="o">=</span> <span class="p">[</span><span class="n">download_one</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cc_list</span><span class="p">)]</span>  <span class="c1"># &lt;9&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">wait_coro</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">to_do</span><span class="p">)</span>  <span class="c1"># &lt;10&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">res</span><span class="p">,</span>  <span class="n">_</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">wait_coro</span><span class="p">)</span> <span class="c1"># 执行事件循环, 直到 wait_coro 运行结束</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># 关闭事件循环</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>附注：</p>
<ul>
<li>run_until_complete 只接受一个欺物或协程，驱动多个协程需要先由 asyncio.wait 协程包装</li>
</ul>
<h3 id="34-baseeventloop">3.4 BaseEventLoop</h3>
<ol>
<li>asyncio.get_event_loop():</li>
</ol>
<ul>
<li>客户代码绝不会直接创建事件循环</li>
<li>而是获取事件循环的引用</li>
</ul>
<ol start="2">
<li>BaseEventLoop.run_until_complete(&hellip;)</li>
</ol>
<ul>
<li>参数: 一个期物或协程, 如果是协程, 把协程包装进一个 Task 对象中</li>
<li>作用:
<ul>
<li>事件循环运行的过程中, <strong>阻塞主线程直至传入的协程运行结束</strong></li>
<li>否则如果主线程结束，所有的协程都会被垃圾回收程序收回而提前终止</li>
</ul>
</li>
<li>返回:
<ul>
<li>返回一个元组, 第一个元素是一系列结束的期物, 第二个元素是一系列未结束的期物</li>
<li>返回值中未完成的期物受 wait 函数的 timeout, return_when 参数影响</li>
</ul>
</li>
<li>附注:
<ul>
<li>因为参数只接受一个协程，同时启动多个协程时，需要使用 wait 函数将多个协程包装进一个 Task 对象</li>
</ul>
</li>
</ul>
<h3 id="35-其他函数和对象">3.5 其他函数和对象</h3>
<p>asyncio.as_completed:</p>
<ul>
<li>参数: 一个期物列表</li>
<li>作用：获取协程运行的返回结果</li>
<li>返回值: 一个迭代器,  在期物运行结束后产出期物</li>
<li>附注:
<ul>
<li>asyncio.as_completed 函数返回的期物与传给 as_completed 函数的期物可能不同,
在 asyncio 包内部, 我们提供的期物会被替换成生成相同结果的期物，原因参见
Which other futures my come out of asyncio.as_completed?
<a href="https://groups.google.com/forum/#!msg/python-tulip/PdAEtwpaJHs/7fqbQj2zJoJ" target="_blank" rel="noopener noreffer">https://groups.google.com/forum/#!msg/python-tulip/PdAEtwpaJHs/7fqbQj2zJoJ</a></li>
<li>必须使用 yield from 获取 asyncio.as_completed 函数产出的期物的结果，
所以 as_completed 函数必须在协程中调用</li>
</ul>
</li>
</ul>
<p>asyncio.Semaphore(concur_req):</p>
<ul>
<li>参数: concur_req - 并发协程数</li>
<li>作用: 同步装置, 用于限制并发请求数量
<ul>
<li>Semaphore 对象维护着一个内部计数器,
若在对象上调用 .acquire() 协程方法, 计数器则递减;
若在对象上调用 .release() 协程方法, 计数器则递增</li>
<li>如果计数器大于零, 调用 .acquire() 方法不会阻塞; 如果计数器为零, 那.acquire() 方法
会阻塞调用此方法的协程, 直到其他协程在同一个 Semaphore 对象上调用 .release()
方法, 让计数器递增</li>
</ul>
</li>
<li>使用: 可以当作上下文管理器使用</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#  在 yield from 表达式中把 semaphore 当成上下文管理器使用</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这段代码保证, 任何时候都不会有超过 concur_req 个 get_flag 协程启动</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">semaphore</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">image</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">get_flag</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span>  <span class="n">cc</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="36-使用executor对象">3.6 使用Executor对象</h3>
<p>背景:</p>
<ul>
<li>问题:
<ul>
<li>asyncio 不支持异步文件系统I/O</li>
<li>访问本地文件系统会阻塞了客户代码与 asyncio 事件循环共用的唯一线程</li>
</ul>
</li>
<li>解决方法: 使用额外的线程进行文件系统操作</li>
</ul>
<p>loop.run_in_executor(executor,  func,  *args)</p>
<ul>
<li>loop: asyncio 的事件循环对象, 其维护着一个 ThreadPoolExecutor 对象</li>
<li>作用: 把可调用对象传递给 ThreadPoolExecutor 委托给线程池</li>
<li>参数:
<ul>
<li>executor: Executor 实例; 如果设为 None, 使用事件循环默认的 ThreadPoolExecutor 实例</li>
<li>func: 可调用对象</li>
<li>args: 传递给可调用对象的参数</li>
</ul>
</li>
<li>文档:  <a href="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.BaseEventLoop.run_in_executor" target="_blank" rel="noopener noreffer">https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.BaseEventLoop.run_in_executor</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span>  <span class="n">save_flag</span><span class="p">,</span>  <span class="n">image</span><span class="p">,</span>  <span class="n">cc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.gif&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="37-asyncio-使用示例">3.7 asyncio 使用示例</h3>
<h4 id="aiohttp">aiohttp</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">asyncio</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">collections</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">contextlib</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">aiohttp</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">aiohttp</span> <span class="kn">import</span> <span class="n">web</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tqdm</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flags2_common</span> <span class="kn">import</span> <span class="n">main</span><span class="p">,</span> <span class="n">HTTPStatus</span><span class="p">,</span> <span class="n">Result</span><span class="p">,</span> <span class="n">save_flag</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># default set low to avoid errors from remote site, such as</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 503 - Service Temporarily Unavailable</span>
</span></span><span class="line"><span class="cl"><span class="n">DEFAULT_CONCUR_REQ</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="n">MAX_CONCUR_REQ</span> <span class="o">=</span> <span class="mi">1000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FetchError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 用于包装其他 HTTP 或网络异常，并获取 country_code，以便报告错误</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">country_code</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">country_code</span> <span class="o">=</span> <span class="n">country_code</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># BEGIN FLAGS3_ASYNCIO</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@asyncio.coroutine</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="nf">http_get</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">      <span class="n">res</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="n">ctype</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="s1">&#39;json&#39;</span> <span class="ow">in</span> <span class="n">ctype</span> <span class="ow">or</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">              <span class="n">data</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>  <span class="c1"># &lt;1&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">              <span class="n">data</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">res</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  <span class="c1"># &lt;2&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="k">raise</span> <span class="n">web</span><span class="o">.</span><span class="n">HTTPNotFound</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="k">raise</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">HttpProcessingError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="n">code</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">headers</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@asyncio.coroutine</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="nf">get_country</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">cc</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">      <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{cc}</span><span class="s1">/metadata.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">cc</span><span class="o">=</span><span class="n">cc</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">      <span class="n">metadata</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">http_get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>  <span class="c1"># &lt;3&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@asyncio.coroutine</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="nf">get_flag</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">cc</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">      <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{cc}</span><span class="s1">/</span><span class="si">{cc}</span><span class="s1">.gif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">cc</span><span class="o">=</span><span class="n">cc</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 必须在外层加上括号，直接写 return yield from， Python 解析器会报告句法错误</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">http_get</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> <span class="c1"># &lt;4&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>附注:</p>
<ul>
<li>最内层的子生成器是库中真正执行 I/O 操作的函数, 而不是我们自己编写的函数</li>
<li>使用 asyncio 包时，我们编写的异步代码中包含由 asyncio 本身驱动的协程（即委派生成器），
而生成器最终把职责委托给 asyncio 包或第三方库（如 aiohttp）中的协程。
这种处理方式相当于架起了管道，让 asyncio 事件循环（通过我们编写的协程）
驱动执行低层异步 I/O 操作的库函数</li>
</ul>
<h4 id="run_in_executor">run_in_executor</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># BEGIN FLAGS2_ASYNCIO_EXECUTOR</span>
</span></span><span class="line"><span class="cl"><span class="nd">@asyncio.coroutine</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">download_one</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">semaphore</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="c1"># 如果semaphore 计数器的值是所允许的最大值，只有这个协程会阻塞</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 使用 一个 with 和使用 两个 with 有区别么？？？？</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">semaphore</span><span class="p">):</span> <span class="c1"># &lt;5&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="n">image</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">get_flag</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">semaphore</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">country</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">get_country</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="n">web</span><span class="o">.</span><span class="n">HTTPNotFound</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">not_found</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;not found&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># raise X from Y 句法链接原来的异常</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="n">FetchError</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">country</span> <span class="o">=</span> <span class="n">country</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">.gif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_flag</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">ok</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;OK&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Result</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># END FLAGS2_ASYNCIO_EXECUTOR</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="as_completed-semaphore">as_completed, Semaphore</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@asyncio.coroutine</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">downloader_coro</span><span class="p">(</span><span class="n">cc_list</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">concur_req</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">counter</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 最多允许激活 concur_req 个使用这个计数器的协程</span>
</span></span><span class="line"><span class="cl">    <span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="n">concur_req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">to_do</span> <span class="o">=</span> <span class="p">[</span><span class="n">download_one</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">semaphore</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">             <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cc_list</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#  获取一个迭代器，这个迭代器会在期物运行结束后返回期物</span>
</span></span><span class="line"><span class="cl">    <span class="n">to_do_iter</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">to_do</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">to_do_iter</span> <span class="o">=</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">to_do_iter</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">cc_list</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">to_do_iter</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 获取 asyncio.Future 对象的结果，</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 最简单的方法是使用 yield from，而不是调用future.result() 方法</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">future</span>  
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="n">FetchError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># asyncio.as_completed 函数返回的期物与传给 as_completed 函数的期物可能不同</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 因此通过 FetchError 包装网络异常，并关联相应的国家代码</span>
</span></span><span class="line"><span class="cl">            <span class="n">country_code</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">country_code</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 尝试从原来的异常（ __cause__）中获取错误消息</span>
</span></span><span class="line"><span class="cl">                <span class="n">error_msg</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">__cause__</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 如果在原来的异常中找不到错误消息，使用所链接异常的类名作为错误消息</span>
</span></span><span class="line"><span class="cl">                <span class="n">error_msg</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">__cause__</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">error_msg</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;*** Error for </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">country_code</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">status</span> <span class="o">=</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">error</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">status</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">status</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">counter</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">counter</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="run_until_complete">run_until_complete</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">download_many</span><span class="p">(</span><span class="n">cc_list</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">concur_req</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">coro</span> <span class="o">=</span> <span class="n">downloader_coro</span><span class="p">(</span><span class="n">cc_list</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">concur_req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">counts</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">counts</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="38-协程与线程对比">3.8 协程与线程对比</h3>
<p>线程版示例程序</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">slow_function</span><span class="p">():</span>   <span class="c1"># 假设这是耗时的计算</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># 调用 sleep 阻塞主线程, 一定要这么做, 以便释放 GIL, 创建从属线程</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">42</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">supervisor</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">done</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">spinner</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;thinking!&#39;</span><span class="p">,</span>  <span class="n">done</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;spinner object: &#39;</span><span class="p">,</span>  <span class="n">spinner</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">spinner</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>  <span class="c1"># Thread 实例必须调用 start 方法, 明确告知让它运行</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 相当于耗时操作阻塞了主线程。同时, 从属线程以动画形式显示旋转指针</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">slow_function</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">done</span><span class="o">.</span><span class="n">set</span><span class="p">()</span> <span class="c1"># 向子线程发送终止信号</span>
</span></span><span class="line"><span class="cl">    <span class="n">spinner</span><span class="o">.</span><span class="n">join</span><span class="p">()</span> <span class="c1"># 等待 spinner 线程结束</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>协程版示例程序</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@asyncio.coroutine</span>  <span class="c1"># &lt;1&gt;  asyncio 处理的协程要使用 @asyncio.coroutine 装饰</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">spin</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>   <span class="c1"># &lt;2&gt;      不是强制要求, 但是强烈建议这么做</span>
</span></span><span class="line"><span class="cl">    <span class="n">write</span><span class="p">,</span>  <span class="n">flush</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">,</span>  <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="s1">&#39;|/-</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="n">char</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">msg</span>
</span></span><span class="line"><span class="cl">        <span class="n">write</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x08</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield from</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>  <span class="c1"># &lt;3&gt; 休眠不会阻塞事件循环</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>   <span class="c1"># &lt;4&gt; 发出了取消请求而触发的异常</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\x08</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@asyncio.coroutine</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">slow_function</span><span class="p">():</span>   <span class="c1"># &lt;5&gt; 假装进行 I/O 操作时, 使用 yield from 继续执行事件循环</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># pretend waiting a long time for I/O</span>
</span></span><span class="line"><span class="cl">    <span class="k">yield from</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># &lt;6&gt; 控制权交给主循环, 在休眠结束后恢复这个协程</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">42</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@asyncio.coroutine</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">supervisor</span><span class="p">():</span>   <span class="c1"># &lt;7&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 排定 spin 协程的运行时间, 使用一个 Task 对象包装 spin 协程, 并立即返回</span>
</span></span><span class="line"><span class="cl">    <span class="n">spinner</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="k">async</span><span class="p">(</span><span class="n">spin</span><span class="p">(</span><span class="s1">&#39;thinking!&#39;</span><span class="p">))</span>  <span class="c1"># 获取的 Task 对象已经排定了运行时间</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;spinner object: &#39;</span><span class="p">,</span>  <span class="n">spinner</span><span class="p">)</span>  <span class="c1"># &lt;9&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 使用 yield from 驱动 slow_function 函数, 同时, 事件循环继续运行</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">slow_function</span><span class="p">()</span> <span class="c1"># &lt;10&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Task 对象可以取消; 取消后会在协程当前暂停的 yield 处抛出 asyncio.CancelledError异常</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 协程可以捕获这个异常, 也可以延迟取消, 甚至拒绝取消</span>
</span></span><span class="line"><span class="cl">    <span class="n">spinner</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>  <span class="c1"># &lt;11&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>  <span class="c1"># &lt;12&gt; 获取事件循环的引用</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 驱动 supervisor 协程, 让它运行完毕</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">supervisor</span><span class="p">())</span>  <span class="c1"># &lt;13&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Answer: &#39;</span><span class="p">,</span>  <span class="n">result</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>附注:</p>
<ul>
<li>除非想阻塞主线程, 从而冻结事件循环或整个应用, 否则不要在 asyncio 协程中使用 time.sleep(&hellip;)</li>
<li>如果协程需要在一段时间内什么也不做, 应该使用 yield from asyncio.sleep(DELAY)</li>
</ul>
<h2 id="4-使用asyncio包编写服务器">4. 使用asyncio包编写服务器</h2>
<h3 id="41-编写tcp服务器">4.1 编写TCP服务器</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># BEGIN TCP_CHARFINDER_TOP</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">asyncio</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">charfinder</span> <span class="kn">import</span> <span class="n">UnicodeNameIndex</span>  <span class="c1"># &lt;1&gt; 构建名称索引, 提供查询方法</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">CRLF</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">PROMPT</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;?&gt; &#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">index</span> <span class="o">=</span> <span class="n">UnicodeNameIndex</span><span class="p">()</span>  <span class="c1"># &lt;2&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@asyncio.coroutine</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">handle_queries</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span>  <span class="n">writer</span><span class="p">):</span>   <span class="c1"># &lt;3&gt; 要传给 asyncio.start_server 的函数</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>   <span class="c1"># &lt;4&gt; 两个参数是 asyncio.StreamReader 和 asyncio.StreamWriter 对象</span>
</span></span><span class="line"><span class="cl">        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">PROMPT</span><span class="p">)</span>  <span class="c1"># 把数据写入缓冲, 通常不会阻塞, 因此不是协程, 只是普通的函数</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield from</span> <span class="n">writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>  <span class="c1"># 刷新 writer 缓冲; 执行真正的I/O操作, 所以是协程</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">reader</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>  <span class="c1"># &lt;7&gt; 协程, 返回一个 bytes 对象。</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">query</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>   <span class="c1"># &lt;8&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">client</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">get_extra_info</span><span class="p">(</span><span class="s1">&#39;peername&#39;</span><span class="p">)</span>  <span class="c1"># &lt;9&gt; 返回与套接字连接的远程地址</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Received from </span><span class="si">{}</span><span class="s1">:  </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>  <span class="n">query</span><span class="p">))</span>  <span class="c1"># &lt;10&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">query</span><span class="p">[:</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">:</span>   <span class="c1"># &lt;11&gt; 如果收到控制字符或者空字符, 退出循环</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="n">lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">find_description_strs</span><span class="p">(</span><span class="n">query</span><span class="p">))</span> <span class="c1"># &lt;12&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">writer</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="n">CRLF</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">)</span> <span class="c1"># &lt;13&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="n">query</span><span class="p">,</span>  <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="n">CRLF</span><span class="p">)</span> <span class="c1"># &lt;14&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">yield from</span> <span class="n">writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>  <span class="c1"># &lt;15&gt; 刷新输出缓冲</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sent </span><span class="si">{}</span><span class="s1"> results&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)))</span>  <span class="c1"># &lt;16&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Close the client socket&#39;</span><span class="p">)</span>  <span class="c1"># &lt;17&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># &lt;18&gt; 关闭 StreamWriter 流</span>
</span></span><span class="line"><span class="cl"><span class="c1"># END TCP_CHARFINDER_TOP</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># BEGIN TCP_CHARFINDER_MAIN</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>  <span class="n">port</span><span class="o">=</span><span class="mi">2323</span><span class="p">):</span>   <span class="c1"># &lt;1&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 返回的协程对象是一个 asyncio.Server 实例, 即一个 TCP 套接字服务器</span>
</span></span><span class="line"><span class="cl">    <span class="n">server_coro</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">start_server</span><span class="p">(</span><span class="n">handle_queries</span><span class="p">,</span>  <span class="n">address</span><span class="p">,</span>  <span class="n">port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span> <span class="c1"># &lt;2&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 驱动 server_coro 协程, 启动服务器（ server）</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">server_coro</span><span class="p">)</span> <span class="c1"># &lt;3&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">host</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">sockets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>  <span class="c1"># &lt;4&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Serving on </span><span class="si">{}</span><span class="s1">. Hit CTRL-C to stop.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">host</span><span class="p">))</span>  <span class="c1"># &lt;5&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>  <span class="c1"># &lt;6&gt;  运行事件循环;  main 函数在这里阻塞</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>   <span class="c1"># CTRL+C pressed</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Server shutting down.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># &lt;7&gt; 关闭服务器</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># server.wait_closed() 方法返回一个期物，调用 loop.run_until_complete 方法运行期物</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">wait_closed</span><span class="p">())</span>  <span class="c1"># &lt;8&gt;  </span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># &lt;9&gt; 终止事件循环</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span> <span class="p">])</span>  <span class="c1"># &lt;10&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># END TCP_CHARFINDER_MAIN</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>控制权流动:</p>
<ul>
<li>main 函数几乎会立即显示 Serving on&hellip; 消息，然后在调用 loop.run_forever() 时阻塞</li>
<li>控制权流动到事件循环中, 而且一直待在那里</li>
<li>偶尔会回到handle_queries 协程, 这个协程需要等待网络发送或接收数据时, 控制权又交还事件循环</li>
<li>在事件循环运行期间, 只要有新客户端连接服务器就会启动一个 handle_queries 协程实例</li>
</ul>
<p>asyncio.start_server:</p>
<ul>
<li>返回: start_server 协程运行结束后，返回的协程对象返回一个 asyncio.Server实例，
即一个 TCP 套接字服务器</li>
<li>高层流 API:
<ul>
<li>asyncio 包提供了高层流 API,有现成的服务器可用</li>
<li><a href="http://docs.python.org/3/library/asyncio-stream.html" target="_blank" rel="noopener noreffer">http://docs.python.org/3/library/asyncio-stream.html</a></li>
</ul>
</li>
<li>底层流API:
<ul>
<li>asyncio 包受 Twisted 框架中抽象的传送和协议启发，还提供了低层传送和协议 API</li>
<li><a href="http://docs.python.org/3/library/asyncioprotocol.html" target="_blank" rel="noopener noreffer">http://docs.python.org/3/library/asyncioprotocol.html</a></li>
</ul>
</li>
</ul>
<p>loop.run_forever()</p>
<ul>
<li>运行事件循环； main 函数在这里阻塞，直到在服务器的控制台中按 CTRL-C 键才会关闭</li>
</ul>
<h3 id="42-编写web服务器">4.2 编写Web服务器</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">index</span> <span class="o">=</span> <span class="n">UnicodeNameIndex</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">TEMPLATE_NAME</span><span class="p">)</span> <span class="k">as</span> <span class="n">tpl</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">template</span> <span class="o">=</span> <span class="n">tpl</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">template</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{links}</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="n">LINKS_HTML</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># BEGIN HTTP_CHARFINDER_HOME</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>   <span class="c1"># 一个路由处理函数, 参数是一个 aiohttp.web.Request 实例</span>
</span></span><span class="line"><span class="cl">    <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span>  <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># 获取查询字符串, 去掉首尾的空白</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Query:  </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>  <span class="c1"># &lt;3&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">query</span><span class="p">:</span>   <span class="c1"># &lt;4&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="n">descriptions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">find_descriptions</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ROW_TPL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">descr</span><span class="o">.</span><span class="n">_asdict</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                        <span class="k">for</span> <span class="n">descr</span> <span class="ow">in</span> <span class="n">descriptions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="n">query</span><span class="p">,</span>  <span class="nb">len</span><span class="p">(</span><span class="n">descriptions</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">descriptions</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Enter words describing characters.&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">html</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>  <span class="n">result</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>   <span class="c1"># &lt;5&gt;</span>
</span></span><span class="line"><span class="cl">                           <span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sending </span><span class="si">{}</span><span class="s1"> results&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">descriptions</span><span class="p">)))</span>  <span class="c1"># &lt;6&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="n">CONTENT_TYPE</span><span class="p">,</span>  <span class="n">text</span><span class="o">=</span><span class="n">html</span><span class="p">)</span> <span class="c1"># &lt;7&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># END HTTP_CHARFINDER_HOME</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># BEGIN HTTP_CHARFINDER_SETUP</span>
</span></span><span class="line"><span class="cl"><span class="nd">@asyncio.coroutine</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span>  <span class="n">address</span><span class="p">,</span>  <span class="n">port</span><span class="p">):</span>   <span class="c1"># init 协程产出一个服务器, 交给事件循环驱动</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span>  <span class="c1">#  aiohttp.web.Application 类表示 Web 应用</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span>  <span class="s1">&#39;/&#39;</span><span class="p">,</span>  <span class="n">home</span><span class="p">)</span>  <span class="c1"># 通过路由把 URL 模式映射到处理函数上</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 返回一个 aiohttp.web.RequestHandler 实例, 根据 app 对象设置的路由处理 HTTP 请求</span>
</span></span><span class="line"><span class="cl">    <span class="n">handler</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">make_handler</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="c1"># create_server 方法创建服务器, 以 handler 为协议处理程序</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_server</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                           <span class="n">address</span><span class="p">,</span>  <span class="n">port</span><span class="p">)</span>  <span class="c1"># &lt;5&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">server</span><span class="o">.</span><span class="n">sockets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>  <span class="c1"># &lt;6&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="s2">&#34;127.0.0.1&#34;</span><span class="p">,</span>  <span class="n">port</span><span class="o">=</span><span class="mi">8888</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 运行 init 函数, 启动服务器, 获取服务器的地址和端口</span>
</span></span><span class="line"><span class="cl">    <span class="n">host</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">init</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span>  <span class="n">address</span><span class="p">,</span>  <span class="n">port</span><span class="p">))</span>  <span class="c1"># &lt;7&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Serving on </span><span class="si">{}</span><span class="s1">. Hit CTRL-C to stop.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">host</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>  <span class="c1"># &lt;8&gt; main 函数会在这里阻塞</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>   <span class="c1"># CTRL+C pressed</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Server shutting down.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># &lt;9&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Server 对象:</p>
<ul>
<li>asyncio.start_server函数和loop.create_server方法都是协程, 返回的结果都是
asyncio.Server对象</li>
<li>为了启动服务器并返回服务器的引用, 这两个协程都要由他人驱动, 完成运行
<ul>
<li>在 TCP 示例中，做法是调用 loop.run_until_complete(server_coro)，
其中 server_coro 是 asyncio.start_server 函数返回的结果</li>
<li>在 HTTP 示例中， create_server 方法在 init 协程中的一个 yield from 表达式里调用，
而 init 协程则由 main 函数中的 loop.run_until_complete(init(&hellip;)) 调用驱动</li>
</ul>
</li>
</ul>
<p>web.Application.add_route:</p>
<ul>
<li>文档: <a href="http://aiohttp.readthedocs.org/en/v0.14.4/web_reference.html#aiohttp.web.UrlDispatcher.add_route" target="_blank" rel="noopener noreffer">http://aiohttp.readthedocs.org/en/v0.14.4/web_reference.html#aiohttp.web.UrlDispatcher.add_route</a></li>
<li>附注: 如果处理程序是普通的函数, 在内部会将其转换成协程</li>
</ul>
<h3 id="43-服务器设计可用工具">4.3 服务器设计可用工具</h3>
<p>aiopg:</p>
<ul>
<li>作用:
<ul>
<li>提供了一个异步 PostgreSQL 驱动</li>
<li>与 asyncio 包兼容, 支持使用 yield from 发送查询和获取结果</li>
</ul>
</li>
<li>文档: <a href="http://aiopg.readthedocs.org/en/stable/" target="_blank" rel="noopener noreffer">http://aiopg.readthedocs.org/en/stable/</a></li>
</ul>
<h2 id="延伸阅读">延伸阅读</h2>
<h3 id="python">Python:</h3>
<p>asyncio:</p>
<ul>
<li>主页: <a href="http://www.kancloud.cn/kindjeff/asyncio-zh/217030" target="_blank" rel="noopener noreffer">http://www.kancloud.cn/kindjeff/asyncio-zh/217030</a></li>
<li>使用模式介绍: <a href="http://docs.python.org/3/library/asyncio-dev.html" target="_blank" rel="noopener noreffer">http://docs.python.org/3/library/asyncio-dev.html</a></li>
</ul>
<p>asyncio 学习资源:</p>
<ul>
<li><a href="http://haypo-notes.readthedocs.org/asyncio.html" target="_blank" rel="noopener noreffer">http://haypo-notes.readthedocs.org/asyncio.html</a></li>
<li><a href="http://asyncio.org/" target="_blank" rel="noopener noreffer">http://asyncio.org/</a></li>
<li><a href="http://github.com/aio-libs" target="_blank" rel="noopener noreffer">http://github.com/aio-libs</a>
<ul>
<li>说明: 在这两个网站中能找到 PostgreSQL、 MySQL 和多种 NoSQL 数据库的异步驱动</li>
</ul>
</li>
</ul>
<p>aiohttp:</p>
<ul>
<li>文档: <a href="http://aiohttp.readthedocs.org/en/" target="_blank" rel="noopener noreffer">http://aiohttp.readthedocs.org/en/</a></li>
</ul>
<p>Vaurien</p>
<ul>
<li>作用:
<ul>
<li>在程序与后端服务器（eg: 数据库和Web 服务提供方）之间的 TCP 流量中引入延迟和随机错误</li>
<li>为 Mozilla Services 项目开发</li>
</ul>
</li>
<li>文档: <a href="http://vaurien.readthedocs.org/en/1.8/" target="_blank" rel="noopener noreffer">http://vaurien.readthedocs.org/en/1.8/</a></li>
<li>Mozilla Services 项目:  <a href="http://mozilla-services.github.io/" target="_blank" rel="noopener noreffer">http://mozilla-services.github.io/</a></li>
</ul>
<h3 id="blog">blog:</h3>
<p>演讲视频:</p>
<ul>
<li><a href="http://speakerdeck.com/pycon2014/fan-in-and-fan-out-the-crucial-components-of-concurrency-bybrett-slatkin" target="_blank" rel="noopener noreffer">http://speakerdeck.com/pycon2014/fan-in-and-fan-out-the-crucial-components-of-concurrency-bybrett-slatkin</a></li>
<li><a href="http://www.youtube.com/watch?v=CWmq-jtkemY" target="_blank" rel="noopener noreffer">http://www.youtube.com/watch?v=CWmq-jtkemY</a></li>
<li><a href="http://pyvideo.org/video/1667/keynote-1" target="_blank" rel="noopener noreffer">http://pyvideo.org/video/1667/keynote-1</a></li>
<li><a href="http://www.youtube.com/watch?v=1coLC-MUCJc" target="_blank" rel="noopener noreffer">http://www.youtube.com/watch?v=1coLC-MUCJc</a></li>
<li><a href="http://www.youtube.com/watch?v=MS1L2RGKYyY" target="_blank" rel="noopener noreffer">http://www.youtube.com/watch?v=MS1L2RGKYyY</a>
<ul>
<li>ppt: <a href="http://www.slideshare.net/saghul/asyncio" target="_blank" rel="noopener noreffer">http://www.slideshare.net/saghul/asyncio</a></li>
</ul>
</li>
<li><a href="http://pyvideo.org/video/1762/using-futures-for-async-guiprogramming-in-python" target="_blank" rel="noopener noreffer">http://pyvideo.org/video/1762/using-futures-for-async-guiprogramming-in-python</a></li>
</ul>
<p>文章:</p>
<ul>
<li>标题: Python’s asyncio Is for Composition,  Not Raw</li>
<li>链接: <a href="http://www.onebigfluke.com/2015/02/asyncio-is-for-composition.html" target="_blank" rel="noopener noreffer">http://www.onebigfluke.com/2015/02/asyncio-is-for-composition.html</a></li>
</ul>
<p>Using futures for asyncGUI programming in Python 3.3”</p>
<ul>
<li>说明: 如何把 asyncio 包集成到 Tkinter 事件循环中</li>
<li><a href="http://pyvideo.org/video/1762/using-futures-for-async-guiprogramming-in-python" target="_blank" rel="noopener noreffer">http://pyvideo.org/video/1762/using-futures-for-async-guiprogramming-in-python</a></li>
<li><a href="http://github.com/fluentpython/asyncio-tkinter" target="_blank" rel="noopener noreffer">http://github.com/fluentpython/asyncio-tkinter</a></li>
</ul>
<h3 id="实用工具">实用工具</h3>
<h3 id="文章">文章:</h3>
<p>相关文章:</p>
<ol>
<li><a href="https://mp.weixin.qq.com/s/E-7bMIdmzerr7xpSqD0YXg" target="_blank" rel="noopener noreffer">https://mp.weixin.qq.com/s/E-7bMIdmzerr7xpSqD0YXg</a></li>
<li><a href="http://aosabook.org/en/500L/a-web-crawler-with-asyncio-coroutines.html" target="_blank" rel="noopener noreffer">http://aosabook.org/en/500L/a-web-crawler-with-asyncio-coroutines.html</a></li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="../image/async_summary.png"
        data-srcset="../image/async_summary.png, ../image/async_summary.png 1.5x, ../image/async_summary.png 2x"
        data-sizes="auto"
        alt="../image/async_summary.png"
        title="collections.abc" /></p>
<h2 id="附注">附注</h2>
<p>Python 异步库</p>
<ul>
<li>Twisted 是 Node.js 的灵感来源之一</li>
<li>Tornado 拥护使用协程做面向事件编程</li>
</ul>
<p>异步库兼容:</p>
<ul>
<li>设计 asyncio 包时考虑到了使用外部包替换自身的事件循环, 因此才有
asyncio.get_event_loop 和 set_event_loop 函数——二者是抽象的事件循环策略API <a href="http://docs.python.org/3/library/asyncio-eventloops.html#event-loop-policies-and-thedefault-policy" target="_blank" rel="noopener noreffer">http://docs.python.org/3/library/asyncio-eventloops.html#event-loop-policies-and-thedefault-policy</a></li>
<li>Tornado 已经有实现 asyncio.AbstractEventLoop 接口的类 AsyncIOMainLoop <a href="http://tornado.readthedocs.org/en/latest/asyncio.html" target="_blank" rel="noopener noreffer">http://tornado.readthedocs.org/en/latest/asyncio.html</a></li>
<li>因此在同一个事件循环中可以使用这两个库运行异步代码</li>
</ul>
<p>Quamash 项目:</p>
<ul>
<li>文档: <a href="http://pypi.python.org/pypi/Quamash/" target="_blank" rel="noopener noreffer">http://pypi.python.org/pypi/Quamash/</a></li>
<li>把 asyncio 包集成到 Qt 事件循环中, 以便使用 PyQt 或 PySide 开发 GUI 应用</li>
</ul>
<p>Django:</p>
<ul>
<li>传统框架的目的是渲染完整的 HTML 网页, 而且不支持异步访问数据库</li>
</ul>
<p>WebSockets 协议:</p>
<ul>
<li>作用是为始终连接的客户端（例如游戏和流式应用）提供实时更新</li>
<li>asyncio 包的架构能很好地支持 WebSockets, 以下包在 asyncio 基础上实现了 WebSockets
- Autobahn|Python: <a href="http://autobahn.ws/python/" target="_blank" rel="noopener noreffer">http://autobahn.ws/python/</a>
- WebSockets: <a href="http://aaugustin.github.io/websockets/" target="_blank" rel="noopener noreffer">http://aaugustin.github.io/websockets/</a></li>
</ul>
<p>异步数据库 API 3.0: <a href="http://www.python.org/dev/peps/pep-0249/" target="_blank" rel="noopener noreffer">http://www.python.org/dev/peps/pep-0249/</a></p>
<p>asyncio.Future 类与 Twisted 中的Deferred 类不同的原因:  <a href="http://groups.google.com/forum/#!msg/python-tulip/ut4vTG-08k8/PWZzUXX9HYIJ" target="_blank" rel="noopener noreffer">http://groups.google.com/forum/#!msg/python-tulip/ut4vTG-08k8/PWZzUXX9HYIJ</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-03-10&nbsp;<a class="git-hash" href="https://github.com/dillonzq/LoveIt/commit/30628257d547483ceb89c29b3683ac87ee0e5112" target="_blank" title="commit by tsong(tsong@example.com) 30628257d547483ceb89c29b3683ac87ee0e5112: python 语法和 wrapt的模块">
                                    <i class="fas fa-hashtag fa-fw"></i>3062825</a></span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/posts/program/python/grammar/fluent-python/18_asyncio/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://hotttao.github.io/posts/program/python/grammar/fluent-python/18_asyncio/" data-title="asyncio" data-hashtags="python 进阶"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://hotttao.github.io/posts/program/python/grammar/fluent-python/18_asyncio/" data-hashtag="python 进阶"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://hotttao.github.io/posts/program/python/grammar/fluent-python/18_asyncio/" data-title="asyncio"><i class="fab fa-hacker-news fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://hotttao.github.io/posts/program/python/grammar/fluent-python/18_asyncio/" data-title="asyncio"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://hotttao.github.io/posts/program/python/grammar/fluent-python/18_asyncio/" data-title="asyncio" data-ralateuid="xxxx"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/python-%E8%BF%9B%E9%98%B6/">python 进阶</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/linux/linux_mt/06-shell%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/bash%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/" class="prev" rel="prev" title="6.8 bash 配置文件"><i class="fas fa-angle-left fa-fw"></i>6.8 bash 配置文件</a>
            <a href="/posts/linux/linux_mt/06-shell%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/%E8%84%9A%E6%9C%AC%E7%A4%BA%E4%BE%8B%E4%B8%8E%E7%BB%83%E4%B9%A0/" class="next" rel="next" title="6.9 脚本示例与练习">6.9 脚本示例与练习<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.120.2">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">宋涛</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.8/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":30},"comment":{"gitalk":{"admin":["hotttao"],"clientID":"7b48df1b81d23057c798","clientSecret":"65c6f9e6ca6ae4d8105f757578b6b594e3668e61","id":"2018-01-18T22:00:00+08:00","owner":"hotttao","repo":"hotttao.github.io","title":"asyncio"}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
