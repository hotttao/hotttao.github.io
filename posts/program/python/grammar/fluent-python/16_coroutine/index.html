<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>协程 - LoveIt</title><meta name="Description" content="Python 协程"><meta property="og:title" content="协程" />
<meta property="og:description" content="Python 协程" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hotttao.github.io/posts/program/python/grammar/fluent-python/16_coroutine/" /><meta property="og:image" content="https://hotttao.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-01-16T22:00:00+08:00" />
<meta property="article:modified_time" content="2022-03-10T13:09:11+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://hotttao.github.io/logo.png"/>

<meta name="twitter:title" content="协程"/>
<meta name="twitter:description" content="Python 协程"/>
<meta name="application-name" content="宋涛的个人博客">
<meta name="apple-mobile-web-app-title" content="宋涛的个人博客"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://hotttao.github.io/posts/program/python/grammar/fluent-python/16_coroutine/" /><link rel="prev" href="https://hotttao.github.io/posts/linux/linux_mt/06-shell%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/%E5%87%BD%E6%95%B0%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/" /><link rel="next" href="https://hotttao.github.io/posts/linux/linux_mt/06-shell%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/%E7%A8%8B%E5%BA%8F%E4%BA%A4%E4%BA%92%E5%92%8C%E9%80%80%E5%87%BA%E7%8A%B6%E6%80%81/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "协程",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/hotttao.github.io\/posts\/program\/python\/grammar\/fluent-python\/16_coroutine\/"
        },"image": ["https:\/\/hotttao.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "python 进阶","wordcount":  5169 ,
        "url": "https:\/\/hotttao.github.io\/posts\/program\/python\/grammar\/fluent-python\/16_coroutine\/","datePublished": "2018-01-16T22:00:00+08:00","dateModified": "2022-03-10T13:09:11+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": {
                    "@type": "ImageObject",
                    "url": "https:\/\/hotttao.github.io\/images\/hugo\/avatar.png",
                    "width":  528 ,
                    "height":  560 
                }},"author": {
                "@type": "Person",
                "name": "宋涛"
            },"description": "Python 协程"
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="LoveIt"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>宋涛的博客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/categories/go/"> Go </a><a class="menu-item" href="/categories/linux/"> Linux </a><a class="menu-item" href="/categories/distributed/"> 分布式 </a><a class="menu-item" href="/categories/distributed/"> 架构 </a><a class="menu-item" href="/posts/about/"> 关于 </a><a class="menu-item" href="https://github.com/hotttao/" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="LoveIt"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>宋涛的博客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/categories/go/" title="">Go</a><a class="menu-item" href="/categories/linux/" title="">Linux</a><a class="menu-item" href="/categories/distributed/" title="">分布式</a><a class="menu-item" href="/categories/distributed/" title="">架构</a><a class="menu-item" href="/posts/about/" title="">关于</a><a class="menu-item" href="https://github.com/hotttao/" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">协程</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://hotttao.github.io/" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>宋涛</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/python/"><i class="far fa-folder fa-fw"></i>Python</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2018-01-16">2018-01-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 5169 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 11 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-协程的概念">1. 协程的概念</a>
      <ul>
        <li><a href="#11-对协程的理解">1.1 对协程的理解</a></li>
        <li><a href="#12-协程状态">1.2 协程状态</a></li>
      </ul>
    </li>
    <li><a href="#2-协程协议">2. 协程协议：</a>
      <ul>
        <li><a href="#21-预激协程">2.1 预激协程</a></li>
        <li><a href="#22-数据传递">2.2 数据传递</a></li>
        <li><a href="#23-异常处理">2.3 异常处理</a></li>
        <li><a href="#24-协程终止">2.4 协程终止</a></li>
        <li><a href="#25-让协程返回值">2.5 让协程返回值</a></li>
      </ul>
    </li>
    <li><a href="#3-yeild-from-新句法">3. yeild from 新句法</a>
      <ul>
        <li><a href="#31-语法">3.1 语法：</a></li>
        <li><a href="#32-控制流程">3.2 控制流程</a></li>
        <li><a href="#33-作用">3.3 作用：</a>
          <ul>
            <li><a href="#让协程更方便地返回值">让协程更方便地返回值</a></li>
            <li><a href="#职责委派">职责委派</a></li>
          </ul>
        </li>
        <li><a href="#34-示例说明">3.4 示例说明</a></li>
        <li><a href="#35-总结">3.5 总结</a></li>
      </ul>
    </li>
    <li><a href="#4-使用案例使用协程做离散事件仿真">4. 使用案例：使用协程做离散事件仿真</a>
      <ul>
        <li><a href="#41-背景介绍">4.1 背景介绍</a></li>
        <li><a href="#42-程序解析">4.2 程序解析</a></li>
      </ul>
    </li>
    <li><a href="#延伸阅读">延伸阅读</a>
      <ul>
        <li><a href="#python">Python:</a></li>
        <li><a href="#blog">blog:</a></li>
        <li><a href="#实用工具">实用工具</a></li>
        <li><a href="#书籍">书籍:</a></li>
      </ul>
    </li>
    <li><a href="#附注">附注</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="1-协程的概念">1. 协程的概念</h2>
<h3 id="11-对协程的理解">1.1 对协程的理解</h3>
<p>协程理解：</p>
<ul>
<li>协程是用户空间的线程，编程语言必需提供接口实现线程调度</li>
<li>python 中 yield 是一种流程控制工具，使用它可以实现协程</li>
</ul>
<p>生成器的编写风格：</p>
<ul>
<li>传统的拉取式 - 迭代器</li>
<li>推送式 - 协程</li>
<li>任务式 - 面向事件编程</li>
</ul>
<h3 id="12-协程状态">1.2 协程状态</h3>
<p>inspect.getgeneratorstate(gen):</p>
<ul>
<li>GEN_CREATED - 等待开始执行</li>
<li>GEN_RUNNING - 解释器正在执行</li>
<li>GEN_SUSPENDED - 在 yield 表达式处暂停</li>
<li>GEN_CLOSED - 执行结束</li>
</ul>
<h2 id="2-协程协议">2. 协程协议：</h2>
<h3 id="21-预激协程">2.1 预激协程</h3>
<p><strong>.next()</strong>:</p>
<ul>
<li>作用：预激(prime)协程</li>
<li>效果：让协程向前执行到第一个 yield 表达式，准备好作为活跃的协程使用</li>
<li>== .send(None)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">my_coro</span> <span class="o">=</span> <span class="n">simple_coroutine</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">my_coro</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="mi">1729</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">File</span> <span class="s2">&#34;&lt;stdin&gt;&#34;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="ne">TypeError</span><span class="p">:</span> <span class="n">can</span> <span class="ow">not</span> <span class="n">send</span> <span class="n">non</span><span class="o">-</span><span class="kc">None</span> <span class="n">value</span> <span class="n">to</span> <span class="n">a</span> <span class="n">just</span><span class="o">-</span><span class="n">started</span> <span class="n">generator</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>预激协程的装饰器</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">coroutine</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;装饰器：向前执行到第一个`yield`表达式，预激`func`&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">primer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="err">➊</span>
</span></span><span class="line"><span class="cl">        <span class="n">gen</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="err">➋</span>
</span></span><span class="line"><span class="cl">        <span class="nb">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span> <span class="err">➌</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">gen</span> <span class="err">➍</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">primer</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>其他预激方式</strong></p>
<p>框架：</p>
<ul>
<li>Tornado - tornado.gen 装饰器 <a href="http://tornado.readthedocs.org/en/latest/gen.html" target="_blank" rel="noopener noreffer">http://tornado.readthedocs.org/en/latest/gen.html</a></li>
</ul>
<p>yield from: 调用协程时，会自动预激</p>
<h3 id="22-数据传递">2.2 数据传递</h3>
<p><strong>.send(value)</strong>:</p>
<ul>
<li>作用：调用方向协程发送数据，value 成为生成器函数中 yield 表达式的值</li>
<li>要求：仅当协程处于暂停状态时才能调用，即必需先调用 next()方法预激协程</li>
<li>eg: b = yield a
<ul>
<li>协程向调用者返回 a，并在 yeild 处暂停</li>
<li>调用 .send(value)后，value 值被赋给 b，协程向下运行到另一个 yeild 表达式</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">simple_coro2</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">       <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&gt; Started: a =&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="n">b</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">       <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&gt; Received: b =&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="n">c</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">       <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&gt; Received: c =&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">my_coro2</span> <span class="o">=</span> <span class="n">simple_coro2</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getgeneratorstate</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">getgeneratorstate</span><span class="p">(</span><span class="n">my_coro2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;GEN_CREATED&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="nb">next</span><span class="p">(</span><span class="n">my_coro2</span><span class="p">)</span>  <span class="c1"># 预激(prime)协程</span>
</span></span><span class="line"><span class="cl">  <span class="n">Started</span><span class="p">:</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">14</span>  <span class="c1"># 协程返回 a 的值 14</span>
</span></span><span class="line"><span class="cl"><span class="mi">14</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">getgeneratorstate</span><span class="p">(</span><span class="n">my_coro2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;GEN_SUSPENDED&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">my_coro2</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span> <span class="c1"># b 被赋值 28，协程返回 a+b 的值</span>
</span></span><span class="line"><span class="cl">   <span class="n">Received</span><span class="p">:</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">28</span>   <span class="c1"># 协程暂定在 c = yeild a + b 等号的左边，等待调用者发送值</span>
</span></span><span class="line"><span class="cl"><span class="mi">42</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="23-异常处理">2.3 异常处理</h3>
<p><strong>协程中的异常</strong>：</p>
<ul>
<li>如果协程内出现未处理异常，协程会终止; 重新激活协程，会抛出StopIteration异常</li>
<li>协程中未处理的异常会向上冒泡，传给 next 函数或 send 方法的调用方</li>
<li>从 Python 2.5 开始，调用方可以通过 <strong>.throw</strong> 和 <strong>.close</strong> 方法显式地把异常发给协程</li>
<li>文档：<a href="https://docs.python.org/3/reference/expressions.html#generator-iterator-methods" target="_blank" rel="noopener noreffer">https://docs.python.org/3/reference/expressions.html#generator-iterator-methods</a></li>
</ul>
<p>.throw(exc_type[, exc_value[, traceback]])</p>
<ul>
<li>作用：显式地把异常发给协程，致使生成器在暂停的 yield 表达式处抛出指定的异常</li>
<li>效果：
<ul>
<li>如果生成器处理了抛出的异常，代码会向前执行到下一个 yield 表达式，
而产出的值会成为调用 generator.throw 方法得到的返回值</li>
<li>如果生成器没有处理抛出的异常，异常会向上冒泡，传到调用方的上下文中</li>
</ul>
</li>
<li>附注：如果不管协程如何结束都想做些清理工作，要把协程定义体中相关的代码放入 try/finally 块中</li>
</ul>
<h3 id="24-协程终止">2.4 协程终止</h3>
<p><strong>终止方式</strong></p>
<ol>
<li>发送某个哨符值，让协程发生异常退出，内置的 None 和Ellipsis 等常量经常用作哨符值，
甚至  StopIteration 类本身也可以作为哨符值</li>
<li>通过 .close() 方法协程传递 GeneratorExit 异常终止协程</li>
</ol>
<p>.close():</p>
<ul>
<li>作用：致使生成器在暂停的 yield 表达式处抛出 GeneratorExit 异常</li>
<li>效果：
<ul>
<li>如果生成器没有处理这个异常，或者抛出了 StopIteration 异常(通常是指运行到结尾)，
调用方不会报错</li>
<li>如果收到 GeneratorExit 异常，生成器一定不能产出值，否则解释器会抛出RuntimeError 异常</li>
<li>生成器抛出的其他异常会向上冒泡，传给调用方</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DemoException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;为这次演示定义的异常类型。&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">demo_exc_handling</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&gt; coroutine started&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">x</span> <span class="o">=</span> <span class="k">yield</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="n">DemoException</span><span class="p">:</span> <span class="err">➊</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*** DemoException handled. Continuing...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span> <span class="err">➋</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&gt; coroutine received: </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 最后一行代码不会执行，因为只有未处理的异常才会中止无限循环，</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 而一旦出现未处理的异常，协程会立即终止</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;This line should never run.&#39;</span><span class="p">)</span> <span class="err">➌</span>
</span></span><span class="line"><span class="cl">    <span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&gt; coroutine ending&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">exc_coro</span> <span class="o">=</span> <span class="n">demo_exc_handling</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="nb">next</span><span class="p">(</span><span class="n">exc_coro</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">coroutine</span> <span class="n">started</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">exc_coro</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">coroutine</span> <span class="n">received</span><span class="p">:</span> <span class="mi">11</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">exc_coro</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># 协程关闭</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getgeneratorstate</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">getgeneratorstate</span><span class="p">(</span><span class="n">exc_coro</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;GEN_CLOSED&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">exc_coro</span> <span class="o">=</span> <span class="n">demo_exc_handling</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="nb">next</span><span class="p">(</span><span class="n">exc_coro</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">coroutine</span> <span class="n">started</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">exc_coro</span><span class="o">.</span><span class="n">throw</span><span class="p">(</span><span class="n">DemoException</span><span class="p">)</span>  <span class="c1"># 异常管理 - 异常在协程内得到处理</span>
</span></span><span class="line"><span class="cl"><span class="n">DemoException</span> <span class="n">handled</span><span class="o">.</span> <span class="n">Continuing</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">getgeneratorstate</span><span class="p">(</span><span class="n">exc_coro</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;GEN_SUSPENDED&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">exc_coro</span> <span class="o">=</span> <span class="n">demo_exc_handling</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="nb">next</span><span class="p">(</span><span class="n">exc_coro</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">coroutine</span> <span class="n">started</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">exc_coro</span><span class="o">.</span><span class="n">throw</span><span class="p">(</span><span class="ne">ZeroDivisionError</span><span class="p">)</span> <span class="c1"># 异常管理 - 异常在协程内未处理</span>
</span></span><span class="line"><span class="cl"><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="ne">ZeroDivisionError</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">getgeneratorstate</span><span class="p">(</span><span class="n">exc_coro</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;GEN_CLOSED&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="25-让协程返回值">2.5 让协程返回值</h3>
<p>值返回方式：</p>
<ul>
<li>生成器中的 return expr 表达式会触发 StopIteration(expr)异常</li>
<li>return 表达式的值通过 StopIteration 异常的 value 属性返回给调用方</li>
<li>这样做保留了生成器对象的常规行为 —— 耗尽时抛出 StopIteration 异常</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
</span></span><span class="line"><span class="cl"><span class="n">Result</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Result&#39;</span><span class="p">,</span> <span class="s1">&#39;count average&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">averager</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
</span></span><span class="line"><span class="cl">    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">average</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">term</span> <span class="o">=</span> <span class="k">yield</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">term</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>       <span class="c1">#  为了返回值，协程必须正常终止</span>
</span></span><span class="line"><span class="cl">        <span class="n">total</span> <span class="o">+=</span> <span class="n">term</span>
</span></span><span class="line"><span class="cl">        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">average</span> <span class="o">=</span> <span class="n">total</span><span class="o">/</span><span class="n">count</span>  <span class="c1"># Python 3.3 之前，如果生成器返回值，解释器会报句法错误</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Result</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">average</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;</span> <span class="n">coro_avg</span> <span class="o">=</span> <span class="n">averager</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="nb">next</span><span class="p">(</span><span class="n">coro_avg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">coro_avg</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">coro_avg</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">coro_avg</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="mf">6.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>    <span class="n">coro_avg</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1">#  发送 None 会终止循环，导致协程结束，返回结果</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span> <span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">value</span> <span class="c1"># 生成器对象会抛出StopIteration 异常</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>                       <span class="c1"># 异常对象的 value 属性保存着返回的值</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl"><span class="n">Result</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="mf">15.5</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3-yeild-from-新句法">3. yeild from 新句法</h2>
<h3 id="31-语法">3.1 语法：</h3>
<p>yeild from</p>
<ul>
<li>只能用在函数内部，在函数外部使用（以及 yield）会导致句法出错</li>
</ul>
<p>await 关键字：</p>
<ul>
<li>文档：<a href="https://www.python.org/dev/peps/pep-0492/" target="_blank" rel="noopener noreffer">https://www.python.org/dev/peps/pep-0492/</a></li>
<li>作用：await 关键字的作用与 yield from 结构类似，不过只能在以 async def 定义的协程
（禁止使用 yield 和 yield from）中使用</li>
</ul>
<p>async 关键字：</p>
<ul>
<li>作用：async 与其他现有的关键字结合使用，用于定义新的语言结构</li>
<li>async def 用于定义协程，</li>
<li>async for 用于使用异步迭代器（实现 __aiter__ 和 __anext__ 方法，
这是协程版的 __iter__ 和 __next__方法）迭代可迭代的异步对象</li>
</ul>
<h3 id="32-控制流程">3.2 控制流程</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">gen</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="o">....</span>
</span></span><span class="line"><span class="cl">    <span class="k">yield from</span>  <span class="n">x</span>
</span></span><span class="line"><span class="cl">    <span class="o">....</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>yield from x：</p>
<ul>
<li>首先调用 iter(x)，从中获取迭代器 iter</li>
<li>yield from 会把 iter 产出的值传给 gen 的调用方，即调用方可以直接控制 iter</li>
<li>gen 会阻塞，等待 iter 终止</li>
</ul>
<p>iter(x)返回值:</p>
<ul>
<li>可以是只实现了 __next__ 方法的简单迭代器  &ndash;  让协程方便返回值</li>
<li>可以是实现了 __next__、send、 close 和 throw 方法的生成器 &ndash; 职责委托</li>
</ul>
<h3 id="33-作用">3.3 作用：</h3>
<h4 id="让协程更方便地返回值">让协程更方便地返回值</h4>
<ul>
<li>yield from 结构会在内部自动捕获 StopIteration 异常，
并把 value 属性的值变成 yield from 表达式的值</li>
<li>这种处理方式与for 循环处理 StopIteration 异常的方式一样</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Iterable</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">ignore_types</span><span class="o">=</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ignore_types</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield from</span> <span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield</span> <span class="n">x</span>    <span class="c1"># 只需实现 __next__ 方法的简单迭代器</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="mi">7</span><span class="p">],</span> <span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Produces 1 2 3 4 5 6 7 8</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">flatten</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="职责委派">职责委派</h4>
<ul>
<li>yeild from 打开了双向通道，把最外层的调用方与最内层的子生成器连接起来</li>
<li>这样二者可以直接发送和产出值，还可以直接传入异常，而不用在位于中间的协程中添加
大量处理异常的样板代码</li>
</ul>
<p>专用术语：</p>
<ul>
<li>子生成器：从 yield from 表达式中 <iterable> 部分获取的生成器</li>
<li>委派生成器：
<ul>
<li>定义：包含yield from <iterable> 表达式的生成器函数</li>
<li>使用：
<ul>
<li>因为委派生成器相当于管道，所以可以把任意数量个委派生成器连接在一起</li>
<li>这个链条要以一个只使用 yield 表达式的简单生成器结束，也能以任何可迭代的对象结束</li>
</ul>
</li>
</ul>
</li>
<li>调用方：
<ul>
<li>定义：调用委派生成器的客户端代码</li>
<li>使用：
<ul>
<li>任何 yield from 链条都必须由调用方驱动</li>
<li>在最外层委派生成器上调用 next(&hellip;) 函数或 .send(&hellip;) 方法</li>
<li>也可以隐式调用，例如使用 for 循环</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="34-示例说明">3.4 示例说明</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/fluent_python/yield_from.png"
        data-srcset="/images/fluent_python/yield_from.png, /images/fluent_python/yield_from.png 1.5x, /images/fluent_python/yield_from.png 2x"
        data-sizes="auto"
        alt="/images/fluent_python/yield_from.png"
        title="yield from职责委派详解" /></p>
<ul>
<li>委派生成器在 yield from 表达式处暂停时</li>
<li>调用方可以直接把数据发给子生成器</li>
<li>子生成器再把产出的值发给调用方</li>
<li>子生成器返回之后，解释器会抛出 StopIteration 异常，并把返回值附加到异常对象上</li>
<li>yield from 提取出异常中的返回值作为整个表达式的值，委派生成器恢复</li>
<li>如果子生成器不终止，委派生成器会在 yield from 表达式处永远暂停，
因为 yield from（与 yield 一样）把控制权转交给客户代码（即，委派生成器的调用方）</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 子生成器</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">averager</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 同上</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">Result</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">average</span><span class="p">)</span>  <span class="c1"># return 值会成为 yeild from 表达式的值</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 委派生成器</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">grouper</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># 每次迭代时会新建一个 averager 实例；每个实例都是作为协程使用的生成器对象</span>
</span></span><span class="line"><span class="cl">      <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">averager</span><span class="p">()</span> <span class="c1"># grouper 接受值，通过管道传递给 averager 实例</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 客户端代码，即调用方</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">  <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">      <span class="n">group</span> <span class="o">=</span> <span class="n">grouper</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="c1">#  group 是调用 grouper 函数得到的委派生成器对象</span>
</span></span><span class="line"><span class="cl">      <span class="nb">next</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>    <span class="c1"># 预激委派生成器 group，此时进入 while True 循环，调用子生成</span>
</span></span><span class="line"><span class="cl">                      <span class="c1"># 器 averager 后，在 yield from 表达式处暂</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="n">group</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">group</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># 重要！</span>
</span></span><span class="line"><span class="cl">  <span class="n">report</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>main 运行说明：</p>
<ul>
<li>外层 for循环每次迭代会新建一个 grouper实例，赋值给 group变量；group是委派生成器。</li>
<li>调用 next(group)，预激委派生成器 grouper，此时进入 while True 循环，调用子生成
器 averager 后，在 yield from 表达式处暂停。</li>
<li>内层 for 循环调用 group.send(value)，直接把值传给子生成器 averager。同时，当前
的 grouper 实例（ group）在 yield from 表达式处暂停。</li>
<li>内层循环结束后， group 实例依旧在 yield from 表达式处暂停，因此， grouper 函数定
义体中为 results[key] 赋值的语句还没有执行。</li>
<li>如果外层 for 循环的末尾没有 group.send(None)，那么 averager 子生成器永远不会终止，
委派生成器 group 永远不会再次激活，因此永远不会为 results[key] 赋值。</li>
<li>外层 for 循环重新迭代时会新建一个 grouper 实例，然后绑定到 group 变量上。前一个
grouper 实例（以及它创建的尚未终止的 averager 子生成器实例）被垃圾回收程序回收</li>
<li>group 内的 while 循环不是必需，作用是不让 委托生成器终止触发 StopIteration 异常</li>
</ul>
<h3 id="35-总结">3.5 总结</h3>
<ol>
<li>子生成器产出的值都直接传给委派生成器的调用方（即客户端代码）</li>
<li>使用 send() 方法发给委派生成器的值都直接传给子生成器</li>
</ol>
<ul>
<li>如果发送的值是 None，那么会调用子生成器的 __next__() 方法</li>
<li>如果发送的值不是 None，那么会调用子生成器的 send() 方法</li>
<li>如果调用的方法抛出 StopIteration 异常，那么委派生成器恢复运行</li>
<li>任何其他异常都会向上冒泡，传给委派生成器</li>
</ul>
<ol start="3">
<li>生成器退出时，生成器（或子生成器）中的 return expr 表达式会触发 StopIteration(expr)异常</li>
<li>yield from 表达式的值是子生成器终止时传给 StopIteration 异常的第一个参数</li>
<li>传入委派生成器的异常，除了 GeneratorExit 之外都传给子生成器的 throw() 方法，</li>
</ol>
<ul>
<li>如果调用 throw() 方法时抛出 StopIteration 异常，委派生成器恢复运行</li>
<li>StopIteration之外的异常会向上冒泡，传给委派生成器</li>
</ul>
<ol start="6">
<li>把 GeneratorExit 异常传入委派生成器，或者在委派生成器上调用 close() 方法</li>
</ol>
<ul>
<li>如果子生成器有 close() 方法，则调用，如果调用 close() 方法导致异常抛出，
那么异常会向上冒泡，传给委派生成器</li>
<li>子生成器没有 close()方法，或close() 正常终止，委派生成器抛出 GeneratorExit异常</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># RESULT = yield from EXPR 伪代码</span>
</span></span><span class="line"><span class="cl"><span class="n">_i</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">EXPR</span><span class="p">)</span>  <span class="c1"># &lt;1&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">_y</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">_i</span><span class="p">)</span>  <span class="c1"># &lt;2&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">_e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">_r</span> <span class="o">=</span> <span class="n">_e</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># &lt;3&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># &lt;4&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">_s</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">_y</span>  <span class="c1"># &lt;5&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">GeneratorExit</span> <span class="k">as</span> <span class="n">_e</span><span class="p">:</span>  <span class="c1"># &lt;6&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">_m</span> <span class="o">=</span> <span class="n">_i</span><span class="o">.</span><span class="n">close</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">_m</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="n">_e</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">_e</span><span class="p">:</span>  <span class="c1"># &lt;7&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="n">_x</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">_m</span> <span class="o">=</span> <span class="n">_i</span><span class="o">.</span><span class="n">throw</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span> <span class="n">_e</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>  <span class="c1"># &lt;8&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">_y</span> <span class="o">=</span> <span class="n">_m</span><span class="p">(</span><span class="o">*</span><span class="n">_x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">_e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">_r</span> <span class="o">=</span> <span class="n">_e</span><span class="o">.</span><span class="n">value</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>  <span class="c1"># &lt;9&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>  <span class="c1"># &lt;10&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">_s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># &lt;11&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">_y</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">_i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">_y</span> <span class="o">=</span> <span class="n">_i</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">_s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">_e</span><span class="p">:</span>  <span class="c1"># &lt;12&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="n">_r</span> <span class="o">=</span> <span class="n">_e</span><span class="o">.</span><span class="n">value</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">RESULT</span> <span class="o">=</span> <span class="n">_r</span>  <span class="c1"># &lt;13&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># END YIELD_FROM_EXPANSION</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4-使用案例使用协程做离散事件仿真">4. 使用案例：使用协程做离散事件仿真</h2>
<p>面向事件的编程技术:</p>
<ul>
<li>包括：
<ul>
<li>事件循环驱动的回调</li>
<li>事件循环驱动的协程</li>
</ul>
</li>
<li>基于回调
<ul>
<li>相关框架：Twisted</li>
</ul>
</li>
<li>基于协程:
<ul>
<li>相关框架：Tornado 和 asyncio</li>
<li>运作方式：在单个线程中使用一个主循环驱动协程执行并发活动</li>
<li>并发特点：协程会不断把控制权让步给主循环，激活并向前运行其他协程，从而执行各个并发活动，
这是一种协作式多任务：协程显式自主地把控制权让步给中央调度程序</li>
<li>对比：多线程实现的是抢占式多任务,调度程序可以在任何时刻暂停线程（即使在执行一个语句的过
程中），把控制权让给其他线程</li>
</ul>
</li>
</ul>
<h3 id="41-背景介绍">4.1 背景介绍</h3>
<p>事件仿真：</p>
<ol>
<li>离散事件仿真：</li>
</ol>
<ul>
<li>定义：仿真钟向前推进的量不是固定的，而是直接推进到下一个事件</li>
<li>实现：协程为实现离散事件仿真提供了合理的抽象</li>
<li>SimPy 是一个实现离散事件仿真的 Python 包</li>
</ul>
<ol start="2">
<li>连续事件仿真：</li>
</ol>
<ul>
<li>定义：仿真钟以固定的量（通常很小）不断向前推进</li>
<li>实现：为了实现连续仿真,在多个线程中处理实时并行的操作更自然</li>
</ul>
<p>示例作用：</p>
<ul>
<li>增进对使用协程管理并发操作的感性认知</li>
<li>洞悉 asyncio、 Twisted 和 Tornado 等库是如何在单个线程中管理多个并发活动的</li>
<li>说明如何在一个主循环中处理事件，以及如何通过发送数据驱动协程</li>
</ul>
<h3 id="42-程序解析">4.2 程序解析</h3>
<!-- ![出租车模拟输出](/images/fluent_python/flup_1603.png) -->
<p>辅助函数：</p>
<ul>
<li>compute_delay 函数:返回单位为分钟的时间间隔</li>
<li>Event = collections.namedtuple(&lsquo;Event&rsquo;, &rsquo;time proc action&rsquo;)
<ul>
<li>time 字段是事件发生时的仿真时间</li>
<li>proc 字段是出租车进程实例的编号</li>
<li>action 字段是描述活动的字符串</li>
</ul>
</li>
</ul>
<p>taxi_process</p>
<ul>
<li>作用：一个协程</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">taxi_process</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="n">trips</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="err">➊</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;每次改变状态时创建事件，把控制权让给仿真器&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Event</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="s1">&#39;leave garage&#39;</span><span class="p">)</span> <span class="err">➋</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trips</span><span class="p">):</span> <span class="err">➌</span>
</span></span><span class="line"><span class="cl">        <span class="n">time</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Event</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="s1">&#39;pick up passenger&#39;</span><span class="p">)</span> <span class="err">➍</span>
</span></span><span class="line"><span class="cl">        <span class="n">time</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Event</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="s1">&#39;drop off passenger&#39;</span><span class="p">)</span> <span class="err">➎</span>
</span></span><span class="line"><span class="cl">    <span class="k">yield</span> <span class="n">Event</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="s1">&#39;going home&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Simulator:</p>
<ul>
<li>.run：执行仿真主循环</li>
<li>.events:PriorityQueue 对象，保存 Event 实例,能按照时间顺序取出放入队列中的事件</li>
<li>.procs:一个字典，把出租车的编号映射到仿真过程中激活的进程</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Simulator</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">procs_map</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">PriorityQueue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">procs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">procs_map</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">end_time</span><span class="p">):</span> <span class="err">➊</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;排定并显示事件，直到时间结束&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 排定各辆出租车的第一个事件</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">proc</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span> <span class="err">➋</span>
</span></span><span class="line"><span class="cl">            <span class="n">first_event</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span> <span class="err">➌</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">first_event</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 这个仿真系统的主循环</span>
</span></span><span class="line"><span class="cl">        <span class="n">sim_time</span> <span class="o">=</span> <span class="mi">0</span> <span class="err">➎</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="n">sim_time</span> <span class="o">&lt;</span> <span class="n">end_time</span><span class="p">:</span> <span class="err">➏</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span> <span class="err">➐</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*** end of events ***&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="err">➑</span>
</span></span><span class="line"><span class="cl">            <span class="n">sim_time</span><span class="p">,</span> <span class="n">proc_id</span><span class="p">,</span> <span class="n">previous_action</span> <span class="o">=</span> <span class="n">current_event</span> <span class="err">➒</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;taxi:&#39;</span><span class="p">,</span> <span class="n">proc_id</span><span class="p">,</span> <span class="n">proc_id</span> <span class="o">*</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">current_event</span><span class="p">)</span> <span class="err">➓</span>
</span></span><span class="line"><span class="cl">            <span class="n">active_proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">[</span><span class="n">proc_id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">next_time</span> <span class="o">=</span> <span class="n">sim_time</span> <span class="o">+</span> <span class="n">compute_duration</span><span class="p">(</span><span class="n">previous_action</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">next_event</span> <span class="o">=</span> <span class="n">active_proc</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">next_time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">[</span><span class="n">proc_id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">next_event</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;*** end of simulation time: </span><span class="si">{}</span><span class="s1"> events pending ***&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">qsize</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="n">taxis</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">taxi_process</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">DEPARTURE_INTERVAL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">           <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_taxis</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="n">sim</span> <span class="o">=</span> <span class="n">Simulator</span><span class="p">(</span><span class="n">taxis</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="延伸阅读">延伸阅读</h2>
<h3 id="python">Python:</h3>
<p>标准库-协程：</p>
<ul>
<li><a href="https://www.python.org/dev/peps/pep-0380/" target="_blank" rel="noopener noreffer">https://www.python.org/dev/peps/pep-0380/</a></li>
<li><a href="https://groups.google.com/forum/#!msg/pythontulip/bmphRrryuFk/aB45sEJUomYJ" target="_blank" rel="noopener noreffer">https://groups.google.com/forum/#!msg/pythontulip/bmphRrryuFk/aB45sEJUomYJ</a></li>
<li><a href="https://mail.python.org/pipermail/python-dev/2009-March/087382.html" target="_blank" rel="noopener noreffer">https://mail.python.org/pipermail/python-dev/2009-March/087382.html</a></li>
</ul>
<p>协程示例：</p>
<ul>
<li><a href="https://mail.python.org/pipermail/tutor/2015-February/104200.html" target="_blank" rel="noopener noreffer">https://mail.python.org/pipermail/tutor/2015-February/104200.html</a></li>
<li><a href="http://nbviewer.ipython.org/github/wardi/iterables-iterators-generators/blob/master/Iterables,%20Iterators,%20Generators.ipynb" target="_blank" rel="noopener noreffer">http://nbviewer.ipython.org/github/wardi/iterables-iterators-generators/blob/master/Iterables,%20Iterators,%20Generators.ipynb</a></li>
</ul>
<p>Python3 新特性</p>
<ul>
<li>在 Python 3.3 之前，如果生成器返回值，解释器会报句法错误</li>
</ul>
<p>离散事件：</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Discrete_event_simulation" target="_blank" rel="noopener noreffer">https://en.wikipedia.org/wiki/Discrete_event_simulation</a></li>
<li><a href="http://www.cs.northwestern.edu/~agupta/_projects/networking/QueueSimulation/mm1.html" target="_blank" rel="noopener noreffer">http://www.cs.northwestern.edu/~agupta/_projects/networking/QueueSimulation/mm1.html</a></li>
<li>SimPy: <a href="https://simpy.readthedocs.org/en/latest/" target="_blank" rel="noopener noreffer">https://simpy.readthedocs.org/en/latest/</a></li>
</ul>
<h3 id="blog">blog:</h3>
<p>Beazley:</p>
<ul>
<li><a href="http://www.dabeaz.com/generators/" target="_blank" rel="noopener noreffer">http://www.dabeaz.com/generators/</a></li>
<li><a href="http://www.dabeaz.com/finalgenerator/" target="_blank" rel="noopener noreffer">http://www.dabeaz.com/finalgenerator/</a></li>
<li><a href="http://www.dabeaz.com/coroutines/" target="_blank" rel="noopener noreffer">http://www.dabeaz.com/coroutines/</a>
<ul>
<li><a href="http://pyvideo.org/video/213" target="_blank" rel="noopener noreffer">http://pyvideo.org/video/213</a></li>
<li><a href="http://pyvideo.org/video/215" target="_blank" rel="noopener noreffer">http://pyvideo.org/video/215</a></li>
<li><a href="http://pyvideo.org/video/214" target="_blank" rel="noopener noreffer">http://pyvideo.org/video/214</a></li>
</ul>
</li>
</ul>
<p>James Powell:</p>
<ul>
<li><a href="http://seriously.dontusethiscode.com/2013/05/01/greedy-coroutine.html" target="_blank" rel="noopener noreffer">http://seriously.dontusethiscode.com/2013/05/01/greedy-coroutine.html</a></li>
<li>说明：使用协程重写了经典的算法</li>
</ul>
<p>ActiveState:</p>
<ul>
<li><a href="https://code.activestate.com/recipes/" target="_blank" rel="noopener noreffer">https://code.activestate.com/recipes/</a></li>
<li><a href="https://code.activestate.com/recipes/tags/coroutine/" target="_blank" rel="noopener noreffer">https://code.activestate.com/recipes/tags/coroutine/</a></li>
<li>说明：ActiveState Code 诀窍数据库</li>
</ul>
<p>Paul Sokolovsky:</p>
<ul>
<li><a href="https://dl.dropboxusercontent.com/u/44884329/yield-from.pdf" target="_blank" rel="noopener noreffer">https://dl.dropboxusercontent.com/u/44884329/yield-from.pdf</a></li>
<li><a href="http://flupy.org/resources/yield-from.pdf" target="_blank" rel="noopener noreffer">http://flupy.org/resources/yield-from.pdf</a></li>
<li>说明：解说 yield from 结构的工作原理</li>
</ul>
<p>Greg Ewing</p>
<ul>
<li><a href="http://www.cosc.canterbury.ac.nz/greg.ewing/python/yield-from/yield_from.html" target="_blank" rel="noopener noreffer">http://www.cosc.canterbury.ac.nz/greg.ewing/python/yield-from/yield_from.html</a></li>
<li>说明： yield from 的使用示例，BinaryTree 类、 一个简单的 XML 解析器和一个任务调度程序</li>
</ul>
<p>其他：</p>
<ul>
<li><a href="https://groups.google.com/forum/#!msg/pythontulip/bmphRrryuFk/aB45sEJUomYJ" target="_blank" rel="noopener noreffer">https://groups.google.com/forum/#!msg/pythontulip/bmphRrryuFk/aB45sEJUomYJ</a></li>
<li>说明：The difference between yield and yield-from</li>
</ul>
<h3 id="实用工具">实用工具</h3>
<h3 id="书籍">书籍:</h3>
<p>Python Cookbook（第 3 版）中文版</p>
<p>Effective Python：编写高质量 Python 代码的 59 个有效方法</p>
<ul>
<li>书中的第 40 条短小精辟，题为“考虑用协程来并发地运行多个函数”</li>
<li>代码：
<ul>
<li><a href="https://github.com/bslatkin/effectivepython" target="_blank" rel="noopener noreffer">https://github.com/bslatkin/effectivepython</a></li>
<li><a href="https://github.com/bslatkin/effectivepython" target="_blank" rel="noopener noreffer">https://github.com/bslatkin/effectivepython</a></li>
<li><a href="https://gist.github.com/ramalho/da5590bc38c973408839" target="_blank" rel="noopener noreffer">https://gist.github.com/ramalho/da5590bc38c973408839</a></li>
</ul>
</li>
</ul>
<h2 id="附注">附注</h2>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-03-10&nbsp;<a class="git-hash" href="https://github.com/dillonzq/LoveIt/commit/30628257d547483ceb89c29b3683ac87ee0e5112" target="_blank" title="commit by tsong(tsong@example.com) 30628257d547483ceb89c29b3683ac87ee0e5112: python 语法和 wrapt的模块">
                                    <i class="fas fa-hashtag fa-fw"></i>3062825</a></span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/posts/program/python/grammar/fluent-python/16_coroutine/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://hotttao.github.io/posts/program/python/grammar/fluent-python/16_coroutine/" data-title="协程" data-hashtags="python 进阶"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://hotttao.github.io/posts/program/python/grammar/fluent-python/16_coroutine/" data-hashtag="python 进阶"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://hotttao.github.io/posts/program/python/grammar/fluent-python/16_coroutine/" data-title="协程"><i class="fab fa-hacker-news fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://hotttao.github.io/posts/program/python/grammar/fluent-python/16_coroutine/" data-title="协程"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://hotttao.github.io/posts/program/python/grammar/fluent-python/16_coroutine/" data-title="协程" data-ralateuid="xxxx"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/python-%E8%BF%9B%E9%98%B6/">python 进阶</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/linux/linux_mt/06-shell%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/%E5%87%BD%E6%95%B0%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/" class="prev" rel="prev" title="6.6 函数和参数传递"><i class="fas fa-angle-left fa-fw"></i>6.6 函数和参数传递</a>
            <a href="/posts/linux/linux_mt/06-shell%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/%E7%A8%8B%E5%BA%8F%E4%BA%A4%E4%BA%92%E5%92%8C%E9%80%80%E5%87%BA%E7%8A%B6%E6%80%81/" class="next" rel="next" title="6.7 程序交互与信号捕捉">6.7 程序交互与信号捕捉<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.120.2">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">宋涛</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.8/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":30},"comment":{"gitalk":{"admin":["hotttao"],"clientID":"7b48df1b81d23057c798","clientSecret":"65c6f9e6ca6ae4d8105f757578b6b594e3668e61","id":"2018-01-16T22:00:00+08:00","owner":"hotttao","repo":"hotttao.github.io","title":"协程"}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
